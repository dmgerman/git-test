macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;pack.h&quot;
DECL|function|fixup_pack_header_footer
r_void
id|fixup_pack_header_footer
c_func
(paren
r_int
id|pack_fd
comma
r_int
r_char
op_star
id|pack_file_sha1
comma
r_const
r_char
op_star
id|pack_name
comma
r_uint32
id|object_count
)paren
(brace
r_static
r_const
r_int
id|buf_sz
op_assign
l_int|128
op_star
l_int|1024
suffix:semicolon
id|SHA_CTX
id|c
suffix:semicolon
r_struct
id|pack_header
id|hdr
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|lseek
c_func
(paren
id|pack_fd
comma
l_int|0
comma
id|SEEK_SET
)paren
op_ne
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Failed seeking to start: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_in_full
c_func
(paren
id|pack_fd
comma
op_amp
id|hdr
comma
r_sizeof
(paren
id|hdr
)paren
)paren
op_ne
r_sizeof
(paren
id|hdr
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Unable to reread header of %s: %s&quot;
comma
id|pack_name
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lseek
c_func
(paren
id|pack_fd
comma
l_int|0
comma
id|SEEK_SET
)paren
op_ne
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Failed seeking to start: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|hdr.hdr_entries
op_assign
id|htonl
c_func
(paren
id|object_count
)paren
suffix:semicolon
id|write_or_die
c_func
(paren
id|pack_fd
comma
op_amp
id|hdr
comma
r_sizeof
(paren
id|hdr
)paren
)paren
suffix:semicolon
id|SHA1_Init
c_func
(paren
op_amp
id|c
)paren
suffix:semicolon
id|SHA1_Update
c_func
(paren
op_amp
id|c
comma
op_amp
id|hdr
comma
r_sizeof
(paren
id|hdr
)paren
)paren
suffix:semicolon
id|buf
op_assign
id|xmalloc
c_func
(paren
id|buf_sz
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|ssize_t
id|n
op_assign
id|xread
c_func
(paren
id|pack_fd
comma
id|buf
comma
id|buf_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Failed to checksum %s: %s&quot;
comma
id|pack_name
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|SHA1_Update
c_func
(paren
op_amp
id|c
comma
id|buf
comma
id|n
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|buf
)paren
suffix:semicolon
id|SHA1_Final
c_func
(paren
id|pack_file_sha1
comma
op_amp
id|c
)paren
suffix:semicolon
id|write_or_die
c_func
(paren
id|pack_fd
comma
id|pack_file_sha1
comma
l_int|20
)paren
suffix:semicolon
)brace
eof
