multiline_comment|/*&n; * Copyright (c) 2011, Google Inc.&n; */
macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;streaming.h&quot;
DECL|enum|input_source
r_enum
id|input_source
(brace
DECL|enumerator|stream_error
id|stream_error
op_assign
l_int|1
comma
DECL|enumerator|incore
id|incore
op_assign
l_int|0
comma
DECL|enumerator|loose
id|loose
op_assign
l_int|1
comma
DECL|enumerator|pack_non_delta
id|pack_non_delta
op_assign
l_int|2
)brace
suffix:semicolon
DECL|typedef|open_istream_fn
r_typedef
r_int
(paren
op_star
id|open_istream_fn
)paren
(paren
r_struct
id|git_istream
op_star
comma
r_struct
id|object_info
op_star
comma
r_const
r_int
r_char
op_star
comma
r_enum
id|object_type
op_star
)paren
suffix:semicolon
DECL|typedef|close_istream_fn
r_typedef
r_int
(paren
op_star
id|close_istream_fn
)paren
(paren
r_struct
id|git_istream
op_star
)paren
suffix:semicolon
DECL|typedef|read_istream_fn
r_typedef
id|ssize_t
(paren
op_star
id|read_istream_fn
)paren
(paren
r_struct
id|git_istream
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|struct|stream_vtbl
r_struct
id|stream_vtbl
(brace
DECL|member|close
id|close_istream_fn
id|close
suffix:semicolon
DECL|member|read
id|read_istream_fn
id|read
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|open_method_decl
mdefine_line|#define open_method_decl(name) &bslash;&n;&t;int open_istream_ ##name &bslash;&n;&t;(struct git_istream *st, struct object_info *oi, &bslash;&n;&t; const unsigned char *sha1, &bslash;&n;&t; enum object_type *type)
DECL|macro|close_method_decl
mdefine_line|#define close_method_decl(name) &bslash;&n;&t;int close_istream_ ##name &bslash;&n;&t;(struct git_istream *st)
DECL|macro|read_method_decl
mdefine_line|#define read_method_decl(name) &bslash;&n;&t;ssize_t read_istream_ ##name &bslash;&n;&t;(struct git_istream *st, char *buf, size_t sz)
multiline_comment|/* forward declaration */
r_static
id|open_method_decl
c_func
(paren
id|incore
)paren
suffix:semicolon
r_static
id|open_method_decl
c_func
(paren
id|loose
)paren
suffix:semicolon
r_static
id|open_method_decl
c_func
(paren
id|pack_non_delta
)paren
suffix:semicolon
DECL|variable|open_istream_tbl
r_static
id|open_istream_fn
id|open_istream_tbl
(braket
)braket
op_assign
(brace
id|open_istream_incore
comma
id|open_istream_loose
comma
id|open_istream_pack_non_delta
comma
)brace
suffix:semicolon
DECL|struct|git_istream
r_struct
id|git_istream
(brace
DECL|member|vtbl
r_const
r_struct
id|stream_vtbl
op_star
id|vtbl
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
multiline_comment|/* inflated size of full object */
DECL|member|z
id|z_stream
id|z
suffix:semicolon
DECL|enumerator|z_unused
DECL|enumerator|z_used
DECL|enumerator|z_done
DECL|enumerator|z_error
DECL|member|z_state
r_enum
(brace
id|z_unused
comma
id|z_used
comma
id|z_done
comma
id|z_error
)brace
id|z_state
suffix:semicolon
r_union
(brace
r_struct
(brace
DECL|member|buf
r_char
op_star
id|buf
suffix:semicolon
multiline_comment|/* from read_object() */
DECL|member|read_ptr
r_int
r_int
id|read_ptr
suffix:semicolon
DECL|member|incore
)brace
id|incore
suffix:semicolon
r_struct
(brace
DECL|member|fd
r_int
id|fd
suffix:semicolon
multiline_comment|/* open for reading */
multiline_comment|/* NEEDSWORK: what else? */
DECL|member|loose
)brace
id|loose
suffix:semicolon
r_struct
(brace
DECL|member|pack
r_struct
id|packed_git
op_star
id|pack
suffix:semicolon
DECL|member|pos
id|off_t
id|pos
suffix:semicolon
DECL|member|in_pack
)brace
id|in_pack
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|function|close_istream
r_int
id|close_istream
c_func
(paren
r_struct
id|git_istream
op_star
id|st
)paren
(brace
r_return
id|st-&gt;vtbl
op_member_access_from_pointer
id|close
c_func
(paren
id|st
)paren
suffix:semicolon
)brace
DECL|function|read_istream
id|ssize_t
id|read_istream
c_func
(paren
r_struct
id|git_istream
op_star
id|st
comma
r_char
op_star
id|buf
comma
r_int
id|sz
)paren
(brace
r_return
id|st-&gt;vtbl
op_member_access_from_pointer
id|read
c_func
(paren
id|st
comma
id|buf
comma
id|sz
)paren
suffix:semicolon
)brace
DECL|function|istream_source
r_static
r_enum
id|input_source
id|istream_source
c_func
(paren
r_const
r_int
r_char
op_star
id|sha1
comma
r_enum
id|object_type
op_star
id|type
comma
r_struct
id|object_info
op_star
id|oi
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
r_int
id|status
suffix:semicolon
id|oi-&gt;sizep
op_assign
op_amp
id|size
suffix:semicolon
id|status
op_assign
id|sha1_object_info_extended
c_func
(paren
id|sha1
comma
id|oi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_return
id|stream_error
suffix:semicolon
op_star
id|type
op_assign
id|status
suffix:semicolon
r_switch
c_cond
(paren
id|oi-&gt;whence
)paren
(brace
r_case
id|OI_LOOSE
suffix:colon
r_return
id|loose
suffix:semicolon
r_case
id|OI_PACKED
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|oi-&gt;u.packed.is_delta
op_logical_and
id|big_file_threshold
op_le
id|size
)paren
r_return
id|pack_non_delta
suffix:semicolon
multiline_comment|/* fallthru */
r_default
suffix:colon
r_return
id|incore
suffix:semicolon
)brace
)brace
DECL|function|open_istream
r_struct
id|git_istream
op_star
id|open_istream
c_func
(paren
r_const
r_int
r_char
op_star
id|sha1
comma
r_enum
id|object_type
op_star
id|type
comma
r_int
r_int
op_star
id|size
)paren
(brace
r_struct
id|git_istream
op_star
id|st
suffix:semicolon
r_struct
id|object_info
id|oi
suffix:semicolon
r_const
r_int
r_char
op_star
id|real
op_assign
id|lookup_replace_object
c_func
(paren
id|sha1
)paren
suffix:semicolon
r_enum
id|input_source
id|src
op_assign
id|istream_source
c_func
(paren
id|real
comma
id|type
comma
op_amp
id|oi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|src
OL
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
id|st
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|st
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|open_istream_tbl
(braket
id|src
)braket
(paren
id|st
comma
op_amp
id|oi
comma
id|real
comma
id|type
)paren
)paren
(brace
r_if
c_cond
(paren
id|open_istream_incore
c_func
(paren
id|st
comma
op_amp
id|oi
comma
id|real
comma
id|type
)paren
)paren
(brace
id|free
c_func
(paren
id|st
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
op_star
id|size
op_assign
id|st-&gt;size
suffix:semicolon
r_return
id|st
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * Common helpers&n; *&n; *****************************************************************/
DECL|function|close_deflated_stream
r_static
r_void
id|close_deflated_stream
c_func
(paren
r_struct
id|git_istream
op_star
id|st
)paren
(brace
r_if
c_cond
(paren
id|st-&gt;z_state
op_eq
id|z_used
)paren
id|git_inflate_end
c_func
(paren
op_amp
id|st-&gt;z
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * Loose object stream&n; *&n; *****************************************************************/
DECL|function|open_method_decl
r_static
id|open_method_decl
c_func
(paren
id|loose
)paren
(brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* for now */
)brace
multiline_comment|/*****************************************************************&n; *&n; * Non-delta packed object stream&n; *&n; *****************************************************************/
DECL|function|read_method_decl
r_static
id|read_method_decl
c_func
(paren
id|pack_non_delta
)paren
(brace
r_int
id|total_read
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|st-&gt;z_state
)paren
(brace
r_case
id|z_unused
suffix:colon
id|memset
c_func
(paren
op_amp
id|st-&gt;z
comma
l_int|0
comma
r_sizeof
(paren
id|st-&gt;z
)paren
)paren
suffix:semicolon
id|git_inflate_init
c_func
(paren
op_amp
id|st-&gt;z
)paren
suffix:semicolon
id|st-&gt;z_state
op_assign
id|z_used
suffix:semicolon
r_break
suffix:semicolon
r_case
id|z_done
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|z_error
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|z_used
suffix:colon
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|total_read
OL
id|sz
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|pack_window
op_star
id|window
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|mapped
suffix:semicolon
id|mapped
op_assign
id|use_pack
c_func
(paren
id|st-&gt;u.in_pack.pack
comma
op_amp
id|window
comma
id|st-&gt;u.in_pack.pos
comma
op_amp
id|st-&gt;z.avail_in
)paren
suffix:semicolon
id|st-&gt;z.next_out
op_assign
(paren
r_int
r_char
op_star
)paren
id|buf
op_plus
id|total_read
suffix:semicolon
id|st-&gt;z.avail_out
op_assign
id|sz
id|total_read
suffix:semicolon
id|st-&gt;z.next_in
op_assign
id|mapped
suffix:semicolon
id|status
op_assign
id|git_inflate
c_func
(paren
op_amp
id|st-&gt;z
comma
id|Z_FINISH
)paren
suffix:semicolon
id|st-&gt;u.in_pack.pos
op_add_assign
id|st-&gt;z.next_in
id|mapped
suffix:semicolon
id|total_read
op_assign
id|st-&gt;z.next_out
(paren
r_int
r_char
op_star
)paren
id|buf
suffix:semicolon
id|unuse_pack
c_func
(paren
op_amp
id|window
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|Z_STREAM_END
)paren
(brace
id|git_inflate_end
c_func
(paren
op_amp
id|st-&gt;z
)paren
suffix:semicolon
id|st-&gt;z_state
op_assign
id|z_done
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_ne
id|Z_OK
op_logical_and
id|status
op_ne
id|Z_BUF_ERROR
)paren
(brace
id|git_inflate_end
c_func
(paren
op_amp
id|st-&gt;z
)paren
suffix:semicolon
id|st-&gt;z_state
op_assign
id|z_error
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|total_read
suffix:semicolon
)brace
DECL|function|close_method_decl
r_static
id|close_method_decl
c_func
(paren
id|pack_non_delta
)paren
(brace
id|close_deflated_stream
c_func
(paren
id|st
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pack_non_delta_vtbl
r_static
r_struct
id|stream_vtbl
id|pack_non_delta_vtbl
op_assign
(brace
id|close_istream_pack_non_delta
comma
id|read_istream_pack_non_delta
comma
)brace
suffix:semicolon
DECL|function|open_method_decl
r_static
id|open_method_decl
c_func
(paren
id|pack_non_delta
)paren
(brace
r_struct
id|pack_window
op_star
id|window
suffix:semicolon
r_enum
id|object_type
id|in_pack_type
suffix:semicolon
id|st-&gt;u.in_pack.pack
op_assign
id|oi-&gt;u.packed.pack
suffix:semicolon
id|st-&gt;u.in_pack.pos
op_assign
id|oi-&gt;u.packed.offset
suffix:semicolon
id|window
op_assign
l_int|NULL
suffix:semicolon
id|in_pack_type
op_assign
id|unpack_object_header
c_func
(paren
id|st-&gt;u.in_pack.pack
comma
op_amp
id|window
comma
op_amp
id|st-&gt;u.in_pack.pos
comma
op_amp
id|st-&gt;size
)paren
suffix:semicolon
id|unuse_pack
c_func
(paren
op_amp
id|window
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|in_pack_type
)paren
(brace
r_default
suffix:colon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* we do not do deltas for now */
r_case
id|OBJ_COMMIT
suffix:colon
r_case
id|OBJ_TREE
suffix:colon
r_case
id|OBJ_BLOB
suffix:colon
r_case
id|OBJ_TAG
suffix:colon
r_break
suffix:semicolon
)brace
id|st-&gt;z_state
op_assign
id|z_unused
suffix:semicolon
id|st-&gt;vtbl
op_assign
op_amp
id|pack_non_delta_vtbl
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************&n; *&n; * In-core stream&n; *&n; *****************************************************************/
DECL|function|close_method_decl
r_static
id|close_method_decl
c_func
(paren
id|incore
)paren
(brace
id|free
c_func
(paren
id|st-&gt;u.incore.buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|read_method_decl
r_static
id|read_method_decl
c_func
(paren
id|incore
)paren
(brace
r_int
id|read_size
op_assign
id|sz
suffix:semicolon
r_int
id|remainder
op_assign
id|st-&gt;size
id|st-&gt;u.incore.read_ptr
suffix:semicolon
r_if
c_cond
(paren
id|remainder
op_le
id|read_size
)paren
id|read_size
op_assign
id|remainder
suffix:semicolon
r_if
c_cond
(paren
id|read_size
)paren
(brace
id|memcpy
c_func
(paren
id|buf
comma
id|st-&gt;u.incore.buf
op_plus
id|st-&gt;u.incore.read_ptr
comma
id|read_size
)paren
suffix:semicolon
id|st-&gt;u.incore.read_ptr
op_add_assign
id|read_size
suffix:semicolon
)brace
r_return
id|read_size
suffix:semicolon
)brace
DECL|variable|incore_vtbl
r_static
r_struct
id|stream_vtbl
id|incore_vtbl
op_assign
(brace
id|close_istream_incore
comma
id|read_istream_incore
comma
)brace
suffix:semicolon
DECL|function|open_method_decl
r_static
id|open_method_decl
c_func
(paren
id|incore
)paren
(brace
id|st-&gt;u.incore.buf
op_assign
id|read_sha1_file_extended
c_func
(paren
id|sha1
comma
id|type
comma
op_amp
id|st-&gt;size
comma
l_int|0
)paren
suffix:semicolon
id|st-&gt;u.incore.read_ptr
op_assign
l_int|0
suffix:semicolon
id|st-&gt;vtbl
op_assign
op_amp
id|incore_vtbl
suffix:semicolon
r_return
id|st-&gt;u.incore.buf
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
eof
