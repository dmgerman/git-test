macro_line|#include &quot;git-compat-util.h&quot;
macro_line|#include &quot;progress.h&quot;
DECL|struct|progress
r_struct
id|progress
(brace
DECL|member|title
r_const
r_char
op_star
id|title
suffix:semicolon
DECL|member|last_value
r_int
id|last_value
suffix:semicolon
DECL|member|total
r_int
id|total
suffix:semicolon
DECL|member|last_percent
r_int
id|last_percent
suffix:semicolon
DECL|member|delay
r_int
id|delay
suffix:semicolon
DECL|member|delayed_percent_treshold
r_int
id|delayed_percent_treshold
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|progress_update
r_static
r_volatile
id|sig_atomic_t
id|progress_update
suffix:semicolon
DECL|function|progress_interval
r_static
r_void
id|progress_interval
c_func
(paren
r_int
id|signum
)paren
(brace
id|progress_update
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|set_progress_signal
r_static
r_void
id|set_progress_signal
c_func
(paren
r_void
)paren
(brace
r_struct
id|sigaction
id|sa
suffix:semicolon
r_struct
id|itimerval
id|v
suffix:semicolon
id|progress_update
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sa
comma
l_int|0
comma
r_sizeof
(paren
id|sa
)paren
)paren
suffix:semicolon
id|sa.sa_handler
op_assign
id|progress_interval
suffix:semicolon
id|sigemptyset
c_func
(paren
op_amp
id|sa.sa_mask
)paren
suffix:semicolon
id|sa.sa_flags
op_assign
id|SA_RESTART
suffix:semicolon
id|sigaction
c_func
(paren
id|SIGALRM
comma
op_amp
id|sa
comma
l_int|NULL
)paren
suffix:semicolon
id|v.it_interval.tv_sec
op_assign
l_int|1
suffix:semicolon
id|v.it_interval.tv_usec
op_assign
l_int|0
suffix:semicolon
id|v.it_value
op_assign
id|v.it_interval
suffix:semicolon
id|setitimer
c_func
(paren
id|ITIMER_REAL
comma
op_amp
id|v
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|clear_progress_signal
r_static
r_void
id|clear_progress_signal
c_func
(paren
r_void
)paren
(brace
r_struct
id|itimerval
id|v
op_assign
(brace
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|setitimer
c_func
(paren
id|ITIMER_REAL
comma
op_amp
id|v
comma
l_int|NULL
)paren
suffix:semicolon
id|signal
c_func
(paren
id|SIGALRM
comma
id|SIG_IGN
)paren
suffix:semicolon
id|progress_update
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|display
r_static
r_int
id|display
c_func
(paren
r_struct
id|progress
op_star
id|progress
comma
r_int
id|n
comma
r_int
id|done
)paren
(brace
r_char
op_star
id|eol
suffix:semicolon
r_if
c_cond
(paren
id|progress-&gt;delay
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|progress_update
op_logical_or
op_decrement
id|progress-&gt;delay
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|progress-&gt;total
)paren
(brace
r_int
id|percent
op_assign
id|n
op_star
l_int|100
op_div
id|progress-&gt;total
suffix:semicolon
r_if
c_cond
(paren
id|percent
OG
id|progress-&gt;delayed_percent_treshold
)paren
(brace
multiline_comment|/* inhibit this progress report entirely */
id|clear_progress_signal
c_func
(paren
)paren
suffix:semicolon
id|progress-&gt;delay
op_assign
l_int|1
suffix:semicolon
id|progress-&gt;total
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
id|progress-&gt;last_value
op_assign
id|n
suffix:semicolon
id|eol
op_assign
id|done
ques
c_cond
l_string|&quot;, done.   &bslash;n&quot;
suffix:colon
l_string|&quot;   &bslash;r&quot;
suffix:semicolon
r_if
c_cond
(paren
id|progress-&gt;total
)paren
(brace
r_int
id|percent
op_assign
id|n
op_star
l_int|100
op_div
id|progress-&gt;total
suffix:semicolon
r_if
c_cond
(paren
id|percent
op_ne
id|progress-&gt;last_percent
op_logical_or
id|progress_update
)paren
(brace
id|progress-&gt;last_percent
op_assign
id|percent
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %3u%% (%u/%u)%s&quot;
comma
id|progress-&gt;title
comma
id|percent
comma
id|n
comma
id|progress-&gt;total
comma
id|eol
)paren
suffix:semicolon
id|progress_update
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|progress_update
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s: %u%s&quot;
comma
id|progress-&gt;title
comma
id|n
comma
id|eol
)paren
suffix:semicolon
id|progress_update
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|display_progress
r_int
id|display_progress
c_func
(paren
r_struct
id|progress
op_star
id|progress
comma
r_int
id|n
)paren
(brace
r_return
id|progress
ques
c_cond
id|display
c_func
(paren
id|progress
comma
id|n
comma
l_int|0
)paren
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|start_progress_delay
r_struct
id|progress
op_star
id|start_progress_delay
c_func
(paren
r_const
r_char
op_star
id|title
comma
r_int
id|total
comma
r_int
id|percent_treshold
comma
r_int
id|delay
)paren
(brace
r_struct
id|progress
op_star
id|progress
op_assign
id|malloc
c_func
(paren
r_sizeof
(paren
op_star
id|progress
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|progress
)paren
(brace
multiline_comment|/* unlikely, but here&squot;s a good fallback */
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s...&bslash;n&quot;
comma
id|title
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|progress-&gt;title
op_assign
id|title
suffix:semicolon
id|progress-&gt;total
op_assign
id|total
suffix:semicolon
id|progress-&gt;last_value
op_assign
l_int|1
suffix:semicolon
id|progress-&gt;last_percent
op_assign
l_int|1
suffix:semicolon
id|progress-&gt;delayed_percent_treshold
op_assign
id|percent_treshold
suffix:semicolon
id|progress-&gt;delay
op_assign
id|delay
suffix:semicolon
id|set_progress_signal
c_func
(paren
)paren
suffix:semicolon
r_return
id|progress
suffix:semicolon
)brace
DECL|function|start_progress
r_struct
id|progress
op_star
id|start_progress
c_func
(paren
r_const
r_char
op_star
id|title
comma
r_int
id|total
)paren
(brace
r_return
id|start_progress_delay
c_func
(paren
id|title
comma
id|total
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|stop_progress
r_void
id|stop_progress
c_func
(paren
r_struct
id|progress
op_star
op_star
id|p_progress
)paren
(brace
r_struct
id|progress
op_star
id|progress
op_assign
op_star
id|p_progress
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|progress
)paren
r_return
suffix:semicolon
op_star
id|p_progress
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|progress-&gt;last_value
op_ne
l_int|1
)paren
(brace
multiline_comment|/* Force the last update */
id|progress_update
op_assign
l_int|1
suffix:semicolon
id|display
c_func
(paren
id|progress
comma
id|progress-&gt;last_value
comma
l_int|1
)paren
suffix:semicolon
)brace
id|clear_progress_signal
c_func
(paren
)paren
suffix:semicolon
id|free
c_func
(paren
id|progress
)paren
suffix:semicolon
)brace
eof
