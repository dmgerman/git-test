macro_line|#include &quot;pkt-line.h&quot;
macro_line|#include &quot;sideband.h&quot;
multiline_comment|/*&n; * Receive multiplexed output stream over git native protocol.&n; * in_stream is the input stream from the remote, which carries data&n; * in pkt_line format with band designator.  Demultiplex it into out&n; * and err and return error appropriately.  Band #1 carries the&n; * primary payload.  Things coming over band #2 is not necessarily&n; * error; they are usually informative message on the standard error&n; * stream, aka &quot;verbose&quot;).  A message over band #3 is a signal that&n; * the remote died unexpectedly.  A flush() concludes the stream.&n; */
DECL|function|recv_sideband
r_int
id|recv_sideband
c_func
(paren
r_const
r_char
op_star
id|me
comma
r_int
id|in_stream
comma
r_int
id|out
comma
r_int
id|err
comma
r_char
op_star
id|buf
comma
r_int
id|bufsz
)paren
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|len
op_assign
id|packet_read_line
c_func
(paren
id|in_stream
comma
id|buf
comma
id|bufsz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|1
)paren
(brace
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s: protocol error: no band designator&bslash;n&quot;
comma
id|me
)paren
suffix:semicolon
id|safe_write
c_func
(paren
id|err
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
id|SIDEBAND_PROTOCOL_ERROR
suffix:semicolon
)brace
id|len
op_decrement
suffix:semicolon
r_switch
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0xFF
)paren
(brace
r_case
l_int|3
suffix:colon
id|safe_write
c_func
(paren
id|err
comma
l_string|&quot;remote: &quot;
comma
l_int|8
)paren
suffix:semicolon
id|safe_write
c_func
(paren
id|err
comma
id|buf
op_plus
l_int|1
comma
id|len
)paren
suffix:semicolon
id|safe_write
c_func
(paren
id|err
comma
l_string|&quot;&bslash;n&quot;
comma
l_int|1
)paren
suffix:semicolon
r_return
id|SIDEBAND_REMOTE_ERROR
suffix:semicolon
r_case
l_int|2
suffix:colon
id|safe_write
c_func
(paren
id|err
comma
l_string|&quot;remote: &quot;
comma
l_int|8
)paren
suffix:semicolon
id|safe_write
c_func
(paren
id|err
comma
id|buf
op_plus
l_int|1
comma
id|len
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
l_int|1
suffix:colon
id|safe_write
c_func
(paren
id|out
comma
id|buf
op_plus
l_int|1
comma
id|len
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_default
suffix:colon
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
op_plus
l_int|1
comma
l_string|&quot;%s: protocol error: bad band #%d&bslash;n&quot;
comma
id|me
comma
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|safe_write
c_func
(paren
id|err
comma
id|buf
op_plus
l_int|1
comma
id|len
)paren
suffix:semicolon
r_return
id|SIDEBAND_PROTOCOL_ERROR
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
