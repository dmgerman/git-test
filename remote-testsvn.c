macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;remote.h&quot;
macro_line|#include &quot;strbuf.h&quot;
macro_line|#include &quot;url.h&quot;
macro_line|#include &quot;exec_cmd.h&quot;
macro_line|#include &quot;run-command.h&quot;
macro_line|#include &quot;vcs-svn/svndump.h&quot;
macro_line|#include &quot;notes.h&quot;
macro_line|#include &quot;argv-array.h&quot;
DECL|variable|url
r_static
r_const
r_char
op_star
id|url
suffix:semicolon
DECL|variable|dump_from_file
r_static
r_int
id|dump_from_file
suffix:semicolon
DECL|variable|private_ref
r_static
r_const
r_char
op_star
id|private_ref
suffix:semicolon
DECL|variable|remote_ref
r_static
r_const
r_char
op_star
id|remote_ref
op_assign
l_string|&quot;refs/heads/master&quot;
suffix:semicolon
r_static
r_int
id|cmd_capabilities
c_func
(paren
r_const
r_char
op_star
id|line
)paren
suffix:semicolon
r_static
r_int
id|cmd_import
c_func
(paren
r_const
r_char
op_star
id|line
)paren
suffix:semicolon
r_static
r_int
id|cmd_list
c_func
(paren
r_const
r_char
op_star
id|line
)paren
suffix:semicolon
DECL|typedef|input_command_handler
r_typedef
r_int
(paren
op_star
id|input_command_handler
)paren
(paren
r_const
r_char
op_star
)paren
suffix:semicolon
DECL|struct|input_command_entry
r_struct
id|input_command_entry
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|fn
id|input_command_handler
id|fn
suffix:semicolon
DECL|member|batchable
r_int
r_char
id|batchable
suffix:semicolon
multiline_comment|/* whether the command starts or is part of a batch */
)brace
suffix:semicolon
DECL|variable|input_command_list
r_static
r_const
r_struct
id|input_command_entry
id|input_command_list
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;capabilities&quot;
comma
id|cmd_capabilities
comma
l_int|0
)brace
comma
(brace
l_string|&quot;import&quot;
comma
id|cmd_import
comma
l_int|1
)brace
comma
(brace
l_string|&quot;list&quot;
comma
id|cmd_list
comma
l_int|0
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|cmd_capabilities
r_static
r_int
id|cmd_capabilities
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;import&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;bidi-import&bslash;n&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;refspec %s:%s&bslash;n&bslash;n&quot;
comma
id|remote_ref
comma
id|private_ref
)paren
suffix:semicolon
id|fflush
c_func
(paren
id|stdout
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|terminate_batch
r_static
r_void
id|terminate_batch
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* terminate a current batch&squot;s fast-import stream */
id|printf
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
id|fflush
c_func
(paren
id|stdout
)paren
suffix:semicolon
)brace
DECL|function|cmd_import
r_static
r_int
id|cmd_import
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
r_int
id|code
suffix:semicolon
r_int
id|dumpin_fd
suffix:semicolon
r_int
r_int
id|startrev
op_assign
l_int|0
suffix:semicolon
r_struct
id|argv_array
id|svndump_argv
op_assign
id|ARGV_ARRAY_INIT
suffix:semicolon
r_struct
id|child_process
id|svndump_proc
suffix:semicolon
r_if
c_cond
(paren
id|dump_from_file
)paren
(brace
id|dumpin_fd
op_assign
id|open
c_func
(paren
id|url
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dumpin_fd
OL
l_int|0
)paren
(brace
id|die_errno
c_func
(paren
l_string|&quot;Couldn&squot;t open svn dump file %s.&quot;
comma
id|url
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|memset
c_func
(paren
op_amp
id|svndump_proc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|child_process
)paren
)paren
suffix:semicolon
id|svndump_proc.out
op_assign
l_int|1
suffix:semicolon
id|argv_array_push
c_func
(paren
op_amp
id|svndump_argv
comma
l_string|&quot;svnrdump&quot;
)paren
suffix:semicolon
id|argv_array_push
c_func
(paren
op_amp
id|svndump_argv
comma
l_string|&quot;dump&quot;
)paren
suffix:semicolon
id|argv_array_push
c_func
(paren
op_amp
id|svndump_argv
comma
id|url
)paren
suffix:semicolon
id|argv_array_pushf
c_func
(paren
op_amp
id|svndump_argv
comma
l_string|&quot;-r%u:HEAD&quot;
comma
id|startrev
)paren
suffix:semicolon
id|svndump_proc.argv
op_assign
id|svndump_argv.argv
suffix:semicolon
id|code
op_assign
id|start_command
c_func
(paren
op_amp
id|svndump_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
)paren
id|die
c_func
(paren
l_string|&quot;Unable to start %s, code %d&quot;
comma
id|svndump_proc.argv
(braket
l_int|0
)braket
comma
id|code
)paren
suffix:semicolon
id|dumpin_fd
op_assign
id|svndump_proc.out
suffix:semicolon
)brace
id|svndump_init_fd
c_func
(paren
id|dumpin_fd
comma
id|STDIN_FILENO
)paren
suffix:semicolon
id|svndump_read
c_func
(paren
id|url
comma
id|private_ref
)paren
suffix:semicolon
id|svndump_deinit
c_func
(paren
)paren
suffix:semicolon
id|svndump_reset
c_func
(paren
)paren
suffix:semicolon
id|close
c_func
(paren
id|dumpin_fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dump_from_file
)paren
(brace
id|code
op_assign
id|finish_command
c_func
(paren
op_amp
id|svndump_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
)paren
id|warning
c_func
(paren
l_string|&quot;%s, returned %d&quot;
comma
id|svndump_proc.argv
(braket
l_int|0
)braket
comma
id|code
)paren
suffix:semicolon
id|argv_array_clear
c_func
(paren
op_amp
id|svndump_argv
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cmd_list
r_static
r_int
id|cmd_list
c_func
(paren
r_const
r_char
op_star
id|line
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;? %s&bslash;n&bslash;n&quot;
comma
id|remote_ref
)paren
suffix:semicolon
id|fflush
c_func
(paren
id|stdout
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_command
r_static
r_int
id|do_command
c_func
(paren
r_struct
id|strbuf
op_star
id|line
)paren
(brace
r_const
r_struct
id|input_command_entry
op_star
id|p
op_assign
id|input_command_list
suffix:semicolon
r_static
r_struct
id|string_list
id|batchlines
op_assign
id|STRING_LIST_INIT_DUP
suffix:semicolon
r_static
r_const
r_struct
id|input_command_entry
op_star
id|batch_cmd
suffix:semicolon
multiline_comment|/*&n;&t; * commands can be grouped together in a batch.&n;&t; * Batches are ended by &bslash;n. If no batch is active the program ends.&n;&t; * During a batch all lines are buffered and passed to the handler function&n;&t; * when the batch is terminated.&n;&t; */
r_if
c_cond
(paren
id|line-&gt;len
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|batch_cmd
)paren
(brace
r_struct
id|string_list_item
op_star
id|item
suffix:semicolon
id|for_each_string_list_item
c_func
(paren
id|item
comma
op_amp
id|batchlines
)paren
id|batch_cmd
op_member_access_from_pointer
id|fn
c_func
(paren
id|item-&gt;string
)paren
suffix:semicolon
id|terminate_batch
c_func
(paren
)paren
suffix:semicolon
id|batch_cmd
op_assign
l_int|NULL
suffix:semicolon
id|string_list_clear
c_func
(paren
op_amp
id|batchlines
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* end of the batch, continue reading other commands. */
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* end of command stream, quit */
)brace
r_if
c_cond
(paren
id|batch_cmd
)paren
(brace
r_if
c_cond
(paren
id|prefixcmp
c_func
(paren
id|batch_cmd-&gt;name
comma
id|line-&gt;buf
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Active %s batch interrupted by %s&quot;
comma
id|batch_cmd-&gt;name
comma
id|line-&gt;buf
)paren
suffix:semicolon
multiline_comment|/* buffer batch lines */
id|string_list_append
c_func
(paren
op_amp
id|batchlines
comma
id|line-&gt;buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
id|input_command_list
suffix:semicolon
id|p-&gt;name
suffix:semicolon
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|line-&gt;buf
comma
id|p-&gt;name
)paren
op_logical_and
(paren
id|strlen
c_func
(paren
id|p-&gt;name
)paren
op_eq
id|line-&gt;len
op_logical_or
id|line-&gt;buf
(braket
id|strlen
c_func
(paren
id|p-&gt;name
)paren
)braket
op_eq
l_char|&squot; &squot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;batchable
)paren
(brace
id|batch_cmd
op_assign
id|p
suffix:semicolon
id|string_list_append
c_func
(paren
op_amp
id|batchlines
comma
id|line-&gt;buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|p
op_member_access_from_pointer
id|fn
c_func
(paren
id|line-&gt;buf
)paren
suffix:semicolon
)brace
)brace
id|die
c_func
(paren
l_string|&quot;Unknown command &squot;%s&squot;&bslash;n&quot;
comma
id|line-&gt;buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_const
r_char
op_star
op_star
id|argv
)paren
(brace
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
comma
id|url_sb
op_assign
id|STRBUF_INIT
comma
id|private_ref_sb
op_assign
id|STRBUF_INIT
suffix:semicolon
r_static
r_struct
id|remote
op_star
id|remote
suffix:semicolon
r_const
r_char
op_star
id|url_in
suffix:semicolon
id|git_extract_argv0_path
c_func
(paren
id|argv
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|setup_git_directory
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|argc
template_param
l_int|3
)paren
(brace
id|usage
c_func
(paren
l_string|&quot;git-remote-svn &lt;remote-name&gt; [&lt;url&gt;]&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|remote
op_assign
id|remote_get
c_func
(paren
id|argv
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|url_in
op_assign
(paren
id|argc
op_eq
l_int|3
)paren
ques
c_cond
id|argv
(braket
l_int|2
)braket
suffix:colon
id|remote-&gt;url
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|url_in
comma
l_string|&quot;file://&quot;
)paren
)paren
(brace
id|dump_from_file
op_assign
l_int|1
suffix:semicolon
id|url
op_assign
id|url_decode
c_func
(paren
id|url_in
op_plus
r_sizeof
(paren
l_string|&quot;file://&quot;
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|dump_from_file
op_assign
l_int|0
suffix:semicolon
id|end_url_with_slash
c_func
(paren
op_amp
id|url_sb
comma
id|url_in
)paren
suffix:semicolon
id|url
op_assign
id|url_sb.buf
suffix:semicolon
)brace
id|strbuf_addf
c_func
(paren
op_amp
id|private_ref_sb
comma
l_string|&quot;refs/svn/%s/master&quot;
comma
id|remote-&gt;name
)paren
suffix:semicolon
id|private_ref
op_assign
id|private_ref_sb.buf
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|strbuf_getline
c_func
(paren
op_amp
id|buf
comma
id|stdin
comma
l_char|&squot;&bslash;n&squot;
)paren
op_eq
id|EOF
)paren
(brace
r_if
c_cond
(paren
id|ferror
c_func
(paren
id|stdin
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Error reading command stream&quot;
)paren
suffix:semicolon
r_else
id|die
c_func
(paren
l_string|&quot;Unexpected end of command stream&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_command
c_func
(paren
op_amp
id|buf
)paren
)paren
r_break
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
)brace
id|strbuf_release
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|url_sb
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|private_ref_sb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
