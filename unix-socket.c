macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;unix-socket.h&quot;
DECL|function|unix_stream_socket
r_static
r_int
id|unix_stream_socket
c_func
(paren
r_void
)paren
(brace
r_int
id|fd
op_assign
id|socket
c_func
(paren
id|AF_UNIX
comma
id|SOCK_STREAM
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
id|die_errno
c_func
(paren
l_string|&quot;unable to create socket&quot;
)paren
suffix:semicolon
r_return
id|fd
suffix:semicolon
)brace
DECL|function|chdir_len
r_static
r_int
id|chdir_len
c_func
(paren
r_const
r_char
op_star
id|orig
comma
r_int
id|len
)paren
(brace
r_char
op_star
id|path
op_assign
id|xmemdupz
c_func
(paren
id|orig
comma
id|len
)paren
suffix:semicolon
r_int
id|r
op_assign
id|chdir
c_func
(paren
id|path
)paren
suffix:semicolon
id|free
c_func
(paren
id|path
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|struct|unix_sockaddr_context
r_struct
id|unix_sockaddr_context
(brace
DECL|member|orig_dir
r_char
id|orig_dir
(braket
id|PATH_MAX
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|unix_sockaddr_cleanup
r_static
r_void
id|unix_sockaddr_cleanup
c_func
(paren
r_struct
id|unix_sockaddr_context
op_star
id|ctx
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ctx-&gt;orig_dir
(braket
l_int|0
)braket
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * If we fail, we can&squot;t just return an error, since we have&n;&t; * moved the cwd of the whole process, which could confuse calling&n;&t; * code.  We are better off to just die.&n;&t; */
r_if
c_cond
(paren
id|chdir
c_func
(paren
id|ctx-&gt;orig_dir
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to restore original working directory&quot;
)paren
suffix:semicolon
)brace
DECL|function|unix_sockaddr_init
r_static
r_int
id|unix_sockaddr_init
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sa
comma
r_const
r_char
op_star
id|path
comma
r_struct
id|unix_sockaddr_context
op_star
id|ctx
)paren
(brace
r_int
id|size
op_assign
id|strlen
c_func
(paren
id|path
)paren
op_plus
l_int|1
suffix:semicolon
id|ctx-&gt;orig_dir
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|sa-&gt;sun_path
)paren
)paren
(brace
r_const
r_char
op_star
id|slash
op_assign
id|find_last_dir_sep
c_func
(paren
id|path
)paren
suffix:semicolon
r_const
r_char
op_star
id|dir
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slash
)paren
(brace
id|errno
op_assign
id|ENAMETOOLONG
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dir
op_assign
id|path
suffix:semicolon
id|path
op_assign
id|slash
op_plus
l_int|1
suffix:semicolon
id|size
op_assign
id|strlen
c_func
(paren
id|path
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|sa-&gt;sun_path
)paren
)paren
(brace
id|errno
op_assign
id|ENAMETOOLONG
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|getcwd
c_func
(paren
id|ctx-&gt;orig_dir
comma
r_sizeof
(paren
id|ctx-&gt;orig_dir
)paren
)paren
)paren
(brace
id|errno
op_assign
id|ENAMETOOLONG
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chdir_len
c_func
(paren
id|dir
comma
id|slash
id|dir
)paren
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sa
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sa
)paren
)paren
suffix:semicolon
id|sa-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
id|memcpy
c_func
(paren
id|sa-&gt;sun_path
comma
id|path
comma
id|size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_stream_connect
r_int
id|unix_stream_connect
c_func
(paren
r_const
r_char
op_star
id|path
)paren
(brace
r_int
id|fd
suffix:semicolon
r_struct
id|sockaddr_un
id|sa
suffix:semicolon
r_struct
id|unix_sockaddr_context
id|ctx
suffix:semicolon
r_if
c_cond
(paren
id|unix_sockaddr_init
c_func
(paren
op_amp
id|sa
comma
id|path
comma
op_amp
id|ctx
)paren
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|fd
op_assign
id|unix_stream_socket
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|connect
c_func
(paren
id|fd
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sa
comma
r_sizeof
(paren
id|sa
)paren
)paren
OL
l_int|0
)paren
(brace
id|unix_sockaddr_cleanup
c_func
(paren
op_amp
id|ctx
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|unix_sockaddr_cleanup
c_func
(paren
op_amp
id|ctx
)paren
suffix:semicolon
r_return
id|fd
suffix:semicolon
)brace
DECL|function|unix_stream_listen
r_int
id|unix_stream_listen
c_func
(paren
r_const
r_char
op_star
id|path
)paren
(brace
r_int
id|fd
suffix:semicolon
r_struct
id|sockaddr_un
id|sa
suffix:semicolon
r_struct
id|unix_sockaddr_context
id|ctx
suffix:semicolon
r_if
c_cond
(paren
id|unix_sockaddr_init
c_func
(paren
op_amp
id|sa
comma
id|path
comma
op_amp
id|ctx
)paren
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|fd
op_assign
id|unix_stream_socket
c_func
(paren
)paren
suffix:semicolon
id|unlink
c_func
(paren
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bind
c_func
(paren
id|fd
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sa
comma
r_sizeof
(paren
id|sa
)paren
)paren
OL
l_int|0
)paren
(brace
id|unix_sockaddr_cleanup
c_func
(paren
op_amp
id|ctx
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|listen
c_func
(paren
id|fd
comma
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|unix_sockaddr_cleanup
c_func
(paren
op_amp
id|ctx
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|unix_sockaddr_cleanup
c_func
(paren
op_amp
id|ctx
)paren
suffix:semicolon
r_return
id|fd
suffix:semicolon
)brace
eof
