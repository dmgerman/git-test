macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;split-index.h&quot;
DECL|function|init_split_index
r_struct
id|split_index
op_star
id|init_split_index
c_func
(paren
r_struct
id|index_state
op_star
id|istate
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|istate-&gt;split_index
)paren
(brace
id|istate-&gt;split_index
op_assign
id|xcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|istate-&gt;split_index
)paren
)paren
suffix:semicolon
id|istate-&gt;split_index-&gt;refcount
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|istate-&gt;split_index
suffix:semicolon
)brace
DECL|function|read_link_extension
r_int
id|read_link_extension
c_func
(paren
r_struct
id|index_state
op_star
id|istate
comma
r_const
r_void
op_star
id|data_
comma
r_int
r_int
id|sz
)paren
(brace
r_const
r_int
r_char
op_star
id|data
op_assign
id|data_
suffix:semicolon
r_struct
id|split_index
op_star
id|si
suffix:semicolon
r_if
c_cond
(paren
id|sz
OL
l_int|20
)paren
r_return
id|error
c_func
(paren
l_string|&quot;corrupt link extension (too short)&quot;
)paren
suffix:semicolon
id|si
op_assign
id|init_split_index
c_func
(paren
id|istate
)paren
suffix:semicolon
id|hashcpy
c_func
(paren
id|si-&gt;base_sha1
comma
id|data
)paren
suffix:semicolon
id|data
op_add_assign
l_int|20
suffix:semicolon
id|sz
op_sub_assign
l_int|20
suffix:semicolon
r_if
c_cond
(paren
id|sz
)paren
r_return
id|error
c_func
(paren
l_string|&quot;garbage at the end of link extension&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|write_link_extension
r_int
id|write_link_extension
c_func
(paren
r_struct
id|strbuf
op_star
id|sb
comma
r_struct
id|index_state
op_star
id|istate
)paren
(brace
r_struct
id|split_index
op_star
id|si
op_assign
id|istate-&gt;split_index
suffix:semicolon
id|strbuf_add
c_func
(paren
id|sb
comma
id|si-&gt;base_sha1
comma
l_int|20
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mark_base_index_entries
r_static
r_void
id|mark_base_index_entries
c_func
(paren
r_struct
id|index_state
op_star
id|base
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * To keep track of the shared entries between&n;&t; * istate-&gt;base-&gt;cache[] and istate-&gt;cache[], base entry&n;&t; * position is stored in each base entry. All positions start&n;&t; * from 1 instead of 0, which is resrved to say &quot;this is a new&n;&t; * entry&quot;.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|base-&gt;cache_nr
suffix:semicolon
id|i
op_increment
)paren
id|base-&gt;cache
(braket
id|i
)braket
op_member_access_from_pointer
id|index
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|merge_base_index
r_void
id|merge_base_index
c_func
(paren
r_struct
id|index_state
op_star
id|istate
)paren
(brace
r_struct
id|split_index
op_star
id|si
op_assign
id|istate-&gt;split_index
suffix:semicolon
id|mark_base_index_entries
c_func
(paren
id|si-&gt;base
)paren
suffix:semicolon
id|istate-&gt;cache_nr
op_assign
id|si-&gt;base-&gt;cache_nr
suffix:semicolon
id|ALLOC_GROW
c_func
(paren
id|istate-&gt;cache
comma
id|istate-&gt;cache_nr
comma
id|istate-&gt;cache_alloc
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|istate-&gt;cache
comma
id|si-&gt;base-&gt;cache
comma
r_sizeof
(paren
op_star
id|istate-&gt;cache
)paren
op_star
id|istate-&gt;cache_nr
)paren
suffix:semicolon
)brace
DECL|function|prepare_to_write_split_index
r_void
id|prepare_to_write_split_index
c_func
(paren
r_struct
id|index_state
op_star
id|istate
)paren
(brace
r_struct
id|split_index
op_star
id|si
op_assign
id|init_split_index
c_func
(paren
id|istate
)paren
suffix:semicolon
multiline_comment|/* take cache[] out temporarily */
id|si-&gt;saved_cache_nr
op_assign
id|istate-&gt;cache_nr
suffix:semicolon
id|istate-&gt;cache_nr
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|finish_writing_split_index
r_void
id|finish_writing_split_index
c_func
(paren
r_struct
id|index_state
op_star
id|istate
)paren
(brace
r_struct
id|split_index
op_star
id|si
op_assign
id|init_split_index
c_func
(paren
id|istate
)paren
suffix:semicolon
id|istate-&gt;cache_nr
op_assign
id|si-&gt;saved_cache_nr
suffix:semicolon
)brace
DECL|function|discard_split_index
r_void
id|discard_split_index
c_func
(paren
r_struct
id|index_state
op_star
id|istate
)paren
(brace
r_struct
id|split_index
op_star
id|si
op_assign
id|istate-&gt;split_index
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|si
)paren
r_return
suffix:semicolon
id|istate-&gt;split_index
op_assign
l_int|NULL
suffix:semicolon
id|si-&gt;refcount
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|si-&gt;refcount
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|si-&gt;base
)paren
(brace
id|discard_index
c_func
(paren
id|si-&gt;base
)paren
suffix:semicolon
id|free
c_func
(paren
id|si-&gt;base
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|si
)paren
suffix:semicolon
)brace
DECL|function|save_or_free_index_entry
r_void
id|save_or_free_index_entry
c_func
(paren
r_struct
id|index_state
op_star
id|istate
comma
r_struct
id|cache_entry
op_star
id|ce
)paren
(brace
r_if
c_cond
(paren
id|ce-&gt;index
op_logical_and
id|istate-&gt;split_index
op_logical_and
id|istate-&gt;split_index-&gt;base
op_logical_and
id|ce-&gt;index
op_le
id|istate-&gt;split_index-&gt;base-&gt;cache_nr
op_logical_and
id|ce
op_eq
id|istate-&gt;split_index-&gt;base-&gt;cache
(braket
id|ce-&gt;index
l_int|1
)braket
)paren
id|ce-&gt;ce_flags
op_or_assign
id|CE_REMOVE
suffix:semicolon
r_else
id|free
c_func
(paren
id|ce
)paren
suffix:semicolon
)brace
eof
