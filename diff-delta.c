multiline_comment|/*&n; * diff-delta.c: generate a delta between two buffers&n; *&n; *  Many parts of this file have been lifted from LibXDiff version 0.10.&n; *  http://www.xmailserver.org/xdiff-lib.html&n; *&n; *  LibXDiff was written by Davide Libenzi &lt;davidel@xmailserver.org&gt;&n; *  Copyright (C) 2003&t;Davide Libenzi&n; *&n; *  Many mods for GIT usage by Nicolas Pitre &lt;nico@cam.org&gt;, (C) 2005.&n; *&n; *  This file is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU Lesser General Public&n; *  License as published by the Free Software Foundation; either&n; *  version 2.1 of the License, or (at your option) any later version.&n; *&n; *  Use of this within git automatically means that the LGPL&n; *  licensing gets turned into GPLv2 within this project.&n; */
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &quot;delta.h&quot;
macro_line|#include &quot;zlib.h&quot;
multiline_comment|/* block size: min = 16, max = 64k, power of 2 */
DECL|macro|BLK_SIZE
mdefine_line|#define BLK_SIZE 16
DECL|macro|MIN
mdefine_line|#define MIN(a, b) ((a) &lt; (b) ? (a) : (b))
DECL|macro|GR_PRIME
mdefine_line|#define GR_PRIME 0x9e370001
DECL|macro|HASH
mdefine_line|#define HASH(v, b) (((unsigned int)(v) * GR_PRIME) &gt;&gt; (32 - (b)))
DECL|function|hashbits
r_static
r_int
r_int
id|hashbits
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|val
op_assign
l_int|1
comma
id|bits
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|val
OL
id|size
op_logical_and
id|bits
OL
l_int|32
)paren
(brace
id|val
op_lshift_assign
l_int|1
suffix:semicolon
id|bits
op_increment
suffix:semicolon
)brace
r_return
id|bits
ques
c_cond
id|bits
suffix:colon
l_int|1
suffix:semicolon
)brace
DECL|struct|s_chanode
r_typedef
r_struct
id|s_chanode
(brace
DECL|member|next
r_struct
id|s_chanode
op_star
id|next
suffix:semicolon
DECL|member|icurr
r_int
id|icurr
suffix:semicolon
DECL|typedef|chanode_t
)brace
id|chanode_t
suffix:semicolon
DECL|struct|s_chastore
r_typedef
r_struct
id|s_chastore
(brace
DECL|member|isize
DECL|member|nsize
r_int
id|isize
comma
id|nsize
suffix:semicolon
DECL|member|ancur
id|chanode_t
op_star
id|ancur
suffix:semicolon
DECL|typedef|chastore_t
)brace
id|chastore_t
suffix:semicolon
DECL|function|cha_init
r_static
r_void
id|cha_init
c_func
(paren
id|chastore_t
op_star
id|cha
comma
r_int
id|isize
comma
r_int
id|icount
)paren
(brace
id|cha-&gt;isize
op_assign
id|isize
suffix:semicolon
id|cha-&gt;nsize
op_assign
id|icount
op_star
id|isize
suffix:semicolon
id|cha-&gt;ancur
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|cha_alloc
r_static
r_void
op_star
id|cha_alloc
c_func
(paren
id|chastore_t
op_star
id|cha
)paren
(brace
id|chanode_t
op_star
id|ancur
suffix:semicolon
r_void
op_star
id|data
suffix:semicolon
id|ancur
op_assign
id|cha-&gt;ancur
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ancur
op_logical_or
id|ancur-&gt;icurr
op_eq
id|cha-&gt;nsize
)paren
(brace
id|ancur
op_assign
id|malloc
c_func
(paren
r_sizeof
(paren
id|chanode_t
)paren
op_plus
id|cha-&gt;nsize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ancur
)paren
r_return
l_int|NULL
suffix:semicolon
id|ancur-&gt;icurr
op_assign
l_int|0
suffix:semicolon
id|ancur-&gt;next
op_assign
id|cha-&gt;ancur
suffix:semicolon
id|cha-&gt;ancur
op_assign
id|ancur
suffix:semicolon
)brace
id|data
op_assign
(paren
r_void
op_star
)paren
id|ancur
op_plus
r_sizeof
(paren
id|chanode_t
)paren
op_plus
id|ancur-&gt;icurr
suffix:semicolon
id|ancur-&gt;icurr
op_add_assign
id|cha-&gt;isize
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|cha_free
r_static
r_void
id|cha_free
c_func
(paren
id|chastore_t
op_star
id|cha
)paren
(brace
id|chanode_t
op_star
id|cur
op_assign
id|cha-&gt;ancur
suffix:semicolon
r_while
c_loop
(paren
id|cur
)paren
(brace
id|chanode_t
op_star
id|tmp
op_assign
id|cur
suffix:semicolon
id|cur
op_assign
id|cur-&gt;next
suffix:semicolon
id|free
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
)brace
DECL|struct|s_bdrecord
r_typedef
r_struct
id|s_bdrecord
(brace
DECL|member|next
r_struct
id|s_bdrecord
op_star
id|next
suffix:semicolon
DECL|member|fp
r_int
r_int
id|fp
suffix:semicolon
DECL|member|ptr
r_const
r_int
r_char
op_star
id|ptr
suffix:semicolon
DECL|typedef|bdrecord_t
)brace
id|bdrecord_t
suffix:semicolon
DECL|struct|s_bdfile
r_typedef
r_struct
id|s_bdfile
(brace
DECL|member|cha
id|chastore_t
id|cha
suffix:semicolon
DECL|member|fphbits
r_int
r_int
id|fphbits
suffix:semicolon
DECL|member|fphash
id|bdrecord_t
op_star
op_star
id|fphash
suffix:semicolon
DECL|typedef|bdfile_t
)brace
id|bdfile_t
suffix:semicolon
DECL|function|delta_prepare
r_static
r_int
id|delta_prepare
c_func
(paren
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|bufsize
comma
id|bdfile_t
op_star
id|bdf
)paren
(brace
r_int
r_int
id|fphbits
suffix:semicolon
r_int
id|i
comma
id|hsize
suffix:semicolon
r_const
r_int
r_char
op_star
id|data
comma
op_star
id|top
suffix:semicolon
id|bdrecord_t
op_star
id|brec
suffix:semicolon
id|bdrecord_t
op_star
op_star
id|fphash
suffix:semicolon
id|fphbits
op_assign
id|hashbits
c_func
(paren
id|bufsize
op_div
id|BLK_SIZE
op_plus
l_int|1
)paren
suffix:semicolon
id|hsize
op_assign
l_int|1
op_lshift
id|fphbits
suffix:semicolon
id|fphash
op_assign
id|malloc
c_func
(paren
id|hsize
op_star
r_sizeof
(paren
id|bdrecord_t
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fphash
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hsize
suffix:semicolon
id|i
op_increment
)paren
id|fphash
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|cha_init
c_func
(paren
op_amp
id|bdf-&gt;cha
comma
r_sizeof
(paren
id|bdrecord_t
)paren
comma
id|hsize
op_div
l_int|4
op_plus
l_int|1
)paren
suffix:semicolon
id|top
op_assign
id|buf
op_plus
id|bufsize
suffix:semicolon
id|data
op_assign
id|buf
op_plus
(paren
id|bufsize
op_div
id|BLK_SIZE
)paren
op_star
id|BLK_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
id|top
)paren
id|data
op_sub_assign
id|BLK_SIZE
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|data
op_ge
id|buf
suffix:semicolon
id|data
op_sub_assign
id|BLK_SIZE
)paren
(brace
id|brec
op_assign
id|cha_alloc
c_func
(paren
op_amp
id|bdf-&gt;cha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|brec
)paren
(brace
id|cha_free
c_func
(paren
op_amp
id|bdf-&gt;cha
)paren
suffix:semicolon
id|free
c_func
(paren
id|fphash
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|brec-&gt;fp
op_assign
id|adler32
c_func
(paren
l_int|0
comma
id|data
comma
id|MIN
c_func
(paren
id|BLK_SIZE
comma
id|top
id|data
)paren
)paren
suffix:semicolon
id|brec-&gt;ptr
op_assign
id|data
suffix:semicolon
id|i
op_assign
id|HASH
c_func
(paren
id|brec-&gt;fp
comma
id|fphbits
)paren
suffix:semicolon
id|brec-&gt;next
op_assign
id|fphash
(braket
id|i
)braket
suffix:semicolon
id|fphash
(braket
id|i
)braket
op_assign
id|brec
suffix:semicolon
)brace
id|bdf-&gt;fphbits
op_assign
id|fphbits
suffix:semicolon
id|bdf-&gt;fphash
op_assign
id|fphash
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|delta_cleanup
r_static
r_void
id|delta_cleanup
c_func
(paren
id|bdfile_t
op_star
id|bdf
)paren
(brace
id|free
c_func
(paren
id|bdf-&gt;fphash
)paren
suffix:semicolon
id|cha_free
c_func
(paren
op_amp
id|bdf-&gt;cha
)paren
suffix:semicolon
)brace
multiline_comment|/* provide the size of the copy opcode given the block offset and size */
DECL|macro|COPYOP_SIZE
mdefine_line|#define COPYOP_SIZE(o, s) &bslash;&n;    (!!(o &amp; 0xff) + !!(o &amp; 0xff00) + !!(o &amp; 0xff0000) + !!(o &amp; 0xff000000) + &bslash;&n;     !!(s &amp; 0xff) + !!(s &amp; 0xff00) + 1)
multiline_comment|/* the maximum size for any opcode */
DECL|macro|MAX_OP_SIZE
mdefine_line|#define MAX_OP_SIZE COPYOP_SIZE(0xffffffff, 0xffffffff)
DECL|function|diff_delta
r_void
op_star
id|diff_delta
c_func
(paren
r_void
op_star
id|from_buf
comma
r_int
r_int
id|from_size
comma
r_void
op_star
id|to_buf
comma
r_int
r_int
id|to_size
comma
r_int
r_int
op_star
id|delta_size
comma
r_int
r_int
id|max_size
)paren
(brace
r_int
r_int
id|i
comma
id|outpos
comma
id|outsize
comma
id|inscnt
comma
id|csize
comma
id|msize
comma
id|moff
suffix:semicolon
r_int
r_int
id|fp
suffix:semicolon
r_const
r_int
r_char
op_star
id|ref_data
comma
op_star
id|ref_top
comma
op_star
id|data
comma
op_star
id|top
comma
op_star
id|ptr1
comma
op_star
id|ptr2
suffix:semicolon
r_int
r_char
op_star
id|out
comma
op_star
id|orig
suffix:semicolon
id|bdrecord_t
op_star
id|brec
suffix:semicolon
id|bdfile_t
id|bdf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|from_size
op_logical_or
op_logical_neg
id|to_size
op_logical_or
id|delta_prepare
c_func
(paren
id|from_buf
comma
id|from_size
comma
op_amp
id|bdf
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|outpos
op_assign
l_int|0
suffix:semicolon
id|outsize
op_assign
l_int|8192
suffix:semicolon
r_if
c_cond
(paren
id|max_size
op_logical_and
id|outsize
op_ge
id|max_size
)paren
id|outsize
op_assign
id|max_size
op_plus
id|MAX_OP_SIZE
op_plus
l_int|1
suffix:semicolon
id|out
op_assign
id|malloc
c_func
(paren
id|outsize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|out
)paren
(brace
id|delta_cleanup
c_func
(paren
op_amp
id|bdf
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ref_data
op_assign
id|from_buf
suffix:semicolon
id|ref_top
op_assign
id|from_buf
op_plus
id|from_size
suffix:semicolon
id|data
op_assign
id|to_buf
suffix:semicolon
id|top
op_assign
id|to_buf
op_plus
id|to_size
suffix:semicolon
multiline_comment|/* store reference buffer size */
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|from_size
suffix:semicolon
id|from_size
op_rshift_assign
l_int|7
suffix:semicolon
r_while
c_loop
(paren
id|from_size
)paren
(brace
id|out
(braket
id|outpos
l_int|1
)braket
op_or_assign
l_int|0x80
suffix:semicolon
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|from_size
suffix:semicolon
id|from_size
op_rshift_assign
l_int|7
suffix:semicolon
)brace
multiline_comment|/* store target buffer size */
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|to_size
suffix:semicolon
id|to_size
op_rshift_assign
l_int|7
suffix:semicolon
r_while
c_loop
(paren
id|to_size
)paren
(brace
id|out
(braket
id|outpos
l_int|1
)braket
op_or_assign
l_int|0x80
suffix:semicolon
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|to_size
suffix:semicolon
id|to_size
op_rshift_assign
l_int|7
suffix:semicolon
)brace
id|inscnt
op_assign
l_int|0
suffix:semicolon
id|moff
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|data
OL
id|top
)paren
(brace
id|msize
op_assign
l_int|0
suffix:semicolon
id|fp
op_assign
id|adler32
c_func
(paren
l_int|0
comma
id|data
comma
id|MIN
c_func
(paren
id|top
id|data
comma
id|BLK_SIZE
)paren
)paren
suffix:semicolon
id|i
op_assign
id|HASH
c_func
(paren
id|fp
comma
id|bdf.fphbits
)paren
suffix:semicolon
r_for
c_loop
(paren
id|brec
op_assign
id|bdf.fphash
(braket
id|i
)braket
suffix:semicolon
id|brec
suffix:semicolon
id|brec
op_assign
id|brec-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|brec-&gt;fp
op_eq
id|fp
)paren
(brace
id|csize
op_assign
id|ref_top
id|brec-&gt;ptr
suffix:semicolon
r_if
c_cond
(paren
id|csize
OG
id|top
id|data
)paren
id|csize
op_assign
id|top
id|data
suffix:semicolon
r_for
c_loop
(paren
id|ptr1
op_assign
id|brec-&gt;ptr
comma
id|ptr2
op_assign
id|data
suffix:semicolon
id|csize
op_logical_and
op_star
id|ptr1
op_eq
op_star
id|ptr2
suffix:semicolon
id|csize
op_decrement
comma
id|ptr1
op_increment
comma
id|ptr2
op_increment
)paren
suffix:semicolon
id|csize
op_assign
id|ptr1
id|brec-&gt;ptr
suffix:semicolon
r_if
c_cond
(paren
id|csize
OG
id|msize
)paren
(brace
id|moff
op_assign
id|brec-&gt;ptr
id|ref_data
suffix:semicolon
id|msize
op_assign
id|csize
suffix:semicolon
r_if
c_cond
(paren
id|msize
op_ge
l_int|0x10000
)paren
(brace
id|msize
op_assign
l_int|0x10000
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|msize
op_logical_or
id|msize
OL
id|COPYOP_SIZE
c_func
(paren
id|moff
comma
id|msize
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|inscnt
)paren
id|outpos
op_increment
suffix:semicolon
id|out
(braket
id|outpos
op_increment
)braket
op_assign
op_star
id|data
op_increment
suffix:semicolon
id|inscnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|inscnt
op_eq
l_int|0x7f
)paren
(brace
id|out
(braket
id|outpos
id|inscnt
l_int|1
)braket
op_assign
id|inscnt
suffix:semicolon
id|inscnt
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|inscnt
)paren
(brace
id|out
(braket
id|outpos
id|inscnt
l_int|1
)braket
op_assign
id|inscnt
suffix:semicolon
id|inscnt
op_assign
l_int|0
suffix:semicolon
)brace
id|data
op_add_assign
id|msize
suffix:semicolon
id|orig
op_assign
id|out
op_plus
id|outpos
op_increment
suffix:semicolon
id|i
op_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|moff
op_amp
l_int|0xff
)paren
(brace
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|moff
suffix:semicolon
id|i
op_or_assign
l_int|0x01
suffix:semicolon
)brace
id|moff
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|moff
op_amp
l_int|0xff
)paren
(brace
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|moff
suffix:semicolon
id|i
op_or_assign
l_int|0x02
suffix:semicolon
)brace
id|moff
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|moff
op_amp
l_int|0xff
)paren
(brace
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|moff
suffix:semicolon
id|i
op_or_assign
l_int|0x04
suffix:semicolon
)brace
id|moff
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|moff
op_amp
l_int|0xff
)paren
(brace
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|moff
suffix:semicolon
id|i
op_or_assign
l_int|0x08
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msize
op_amp
l_int|0xff
)paren
(brace
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|msize
suffix:semicolon
id|i
op_or_assign
l_int|0x10
suffix:semicolon
)brace
id|msize
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|msize
op_amp
l_int|0xff
)paren
(brace
id|out
(braket
id|outpos
op_increment
)braket
op_assign
id|msize
suffix:semicolon
id|i
op_or_assign
l_int|0x20
suffix:semicolon
)brace
op_star
id|orig
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|outpos
op_ge
id|outsize
id|MAX_OP_SIZE
)paren
(brace
r_void
op_star
id|tmp
op_assign
id|out
suffix:semicolon
id|outsize
op_assign
id|outsize
op_star
l_int|3
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|max_size
op_logical_and
id|outsize
op_ge
id|max_size
)paren
id|outsize
op_assign
id|max_size
op_plus
id|MAX_OP_SIZE
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|max_size
op_logical_and
id|outpos
OG
id|max_size
)paren
id|out
op_assign
l_int|NULL
suffix:semicolon
r_else
id|out
op_assign
id|realloc
c_func
(paren
id|out
comma
id|outsize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|out
)paren
(brace
id|free
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|delta_cleanup
c_func
(paren
op_amp
id|bdf
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|inscnt
)paren
id|out
(braket
id|outpos
id|inscnt
l_int|1
)braket
op_assign
id|inscnt
suffix:semicolon
id|delta_cleanup
c_func
(paren
op_amp
id|bdf
)paren
suffix:semicolon
op_star
id|delta_size
op_assign
id|outpos
suffix:semicolon
r_return
id|out
suffix:semicolon
)brace
eof
