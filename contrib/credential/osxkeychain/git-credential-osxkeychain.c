macro_line|#include &lt;stdio.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &lt;stdlib.h&gt;
macro_line|#include &lt;Security/Security.h&gt;
DECL|variable|protocol
r_static
id|SecProtocolType
id|protocol
suffix:semicolon
DECL|variable|host
r_static
r_char
op_star
id|host
suffix:semicolon
DECL|variable|path
r_static
r_char
op_star
id|path
suffix:semicolon
DECL|variable|username
r_static
r_char
op_star
id|username
suffix:semicolon
DECL|variable|password
r_static
r_char
op_star
id|password
suffix:semicolon
DECL|variable|port
r_static
id|UInt16
id|port
suffix:semicolon
DECL|function|die
r_static
r_void
id|die
c_func
(paren
r_const
r_char
op_star
id|err
comma
dot
dot
dot
)paren
(brace
r_char
id|msg
(braket
l_int|4096
)braket
suffix:semicolon
id|va_list
id|params
suffix:semicolon
id|va_start
c_func
(paren
id|params
comma
id|err
)paren
suffix:semicolon
id|vsnprintf
c_func
(paren
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
id|err
comma
id|params
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|msg
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|params
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|xstrdup
r_static
r_void
op_star
id|xstrdup
c_func
(paren
r_const
r_char
op_star
id|s1
)paren
(brace
r_void
op_star
id|ret
op_assign
id|strdup
c_func
(paren
id|s1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|die
c_func
(paren
l_string|&quot;Out of memory&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|macro|KEYCHAIN_ITEM
mdefine_line|#define KEYCHAIN_ITEM(x) (x ? strlen(x) : 0), x
DECL|macro|KEYCHAIN_ARGS
mdefine_line|#define KEYCHAIN_ARGS &bslash;&n;&t;NULL, /* default keychain */ &bslash;&n;&t;KEYCHAIN_ITEM(host), &bslash;&n;&t;0, NULL, /* account domain */ &bslash;&n;&t;KEYCHAIN_ITEM(username), &bslash;&n;&t;KEYCHAIN_ITEM(path), &bslash;&n;&t;port, &bslash;&n;&t;protocol, &bslash;&n;&t;kSecAuthenticationTypeDefault
DECL|function|write_item
r_static
r_void
id|write_item
c_func
(paren
r_const
r_char
op_star
id|what
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%s=&quot;
comma
id|what
)paren
suffix:semicolon
id|fwrite
c_func
(paren
id|buf
comma
l_int|1
comma
id|len
comma
id|stdout
)paren
suffix:semicolon
id|putchar
c_func
(paren
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
)brace
DECL|function|find_username_in_item
r_static
r_void
id|find_username_in_item
c_func
(paren
id|SecKeychainItemRef
id|item
)paren
(brace
id|SecKeychainAttributeList
id|list
suffix:semicolon
id|SecKeychainAttribute
id|attr
suffix:semicolon
id|list.count
op_assign
l_int|1
suffix:semicolon
id|list.attr
op_assign
op_amp
id|attr
suffix:semicolon
id|attr.tag
op_assign
id|kSecAccountItemAttr
suffix:semicolon
r_if
c_cond
(paren
id|SecKeychainItemCopyContent
c_func
(paren
id|item
comma
l_int|NULL
comma
op_amp
id|list
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
id|write_item
c_func
(paren
l_string|&quot;username&quot;
comma
id|attr.data
comma
id|attr.length
)paren
suffix:semicolon
id|SecKeychainItemFreeContent
c_func
(paren
op_amp
id|list
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|find_internet_password
r_static
r_void
id|find_internet_password
c_func
(paren
r_void
)paren
(brace
r_void
op_star
id|buf
suffix:semicolon
id|UInt32
id|len
suffix:semicolon
id|SecKeychainItemRef
id|item
suffix:semicolon
r_if
c_cond
(paren
id|SecKeychainFindInternetPassword
c_func
(paren
id|KEYCHAIN_ARGS
comma
op_amp
id|len
comma
op_amp
id|buf
comma
op_amp
id|item
)paren
)paren
r_return
suffix:semicolon
id|write_item
c_func
(paren
l_string|&quot;password&quot;
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|username
)paren
id|find_username_in_item
c_func
(paren
id|item
)paren
suffix:semicolon
id|SecKeychainItemFreeContent
c_func
(paren
l_int|NULL
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|delete_internet_password
r_static
r_void
id|delete_internet_password
c_func
(paren
r_void
)paren
(brace
id|SecKeychainItemRef
id|item
suffix:semicolon
multiline_comment|/*&n;&t; * Require at least a protocol and host for removal, which is what git&n;&t; * will give us; if you want to do something more fancy, use the&n;&t; * Keychain manager.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|protocol
op_logical_or
op_logical_neg
id|host
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|SecKeychainFindInternetPassword
c_func
(paren
id|KEYCHAIN_ARGS
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|item
)paren
)paren
r_return
suffix:semicolon
id|SecKeychainItemDelete
c_func
(paren
id|item
)paren
suffix:semicolon
)brace
DECL|function|add_internet_password
r_static
r_void
id|add_internet_password
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Only store complete credentials */
r_if
c_cond
(paren
op_logical_neg
id|protocol
op_logical_or
op_logical_neg
id|host
op_logical_or
op_logical_neg
id|username
op_logical_or
op_logical_neg
id|password
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|SecKeychainAddInternetPassword
c_func
(paren
id|KEYCHAIN_ARGS
comma
id|KEYCHAIN_ITEM
c_func
(paren
id|password
)paren
comma
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
)brace
DECL|function|read_credential
r_static
r_void
id|read_credential
c_func
(paren
r_void
)paren
(brace
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
r_while
c_loop
(paren
id|fgets
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|stdin
)paren
)paren
(brace
r_char
op_star
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
r_break
suffix:semicolon
id|buf
(braket
id|strlen
c_func
(paren
id|buf
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|v
op_assign
id|strchr
c_func
(paren
id|buf
comma
l_char|&squot;=&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|v
)paren
id|die
c_func
(paren
l_string|&quot;bad input: %s&quot;
comma
id|buf
)paren
suffix:semicolon
op_star
id|v
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
l_string|&quot;protocol&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|v
comma
l_string|&quot;https&quot;
)paren
)paren
id|protocol
op_assign
id|kSecProtocolTypeHTTPS
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|v
comma
l_string|&quot;http&quot;
)paren
)paren
id|protocol
op_assign
id|kSecProtocolTypeHTTP
suffix:semicolon
r_else
multiline_comment|/* we don&squot;t yet handle other protocols */
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
l_string|&quot;host&quot;
)paren
)paren
(brace
r_char
op_star
id|colon
op_assign
id|strchr
c_func
(paren
id|v
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|colon
)paren
(brace
op_star
id|colon
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|port
op_assign
id|atoi
c_func
(paren
id|colon
)paren
suffix:semicolon
)brace
id|host
op_assign
id|xstrdup
c_func
(paren
id|v
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
l_string|&quot;path&quot;
)paren
)paren
id|path
op_assign
id|xstrdup
c_func
(paren
id|v
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
l_string|&quot;username&quot;
)paren
)paren
id|username
op_assign
id|xstrdup
c_func
(paren
id|v
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
l_string|&quot;password&quot;
)paren
)paren
id|password
op_assign
id|xstrdup
c_func
(paren
id|v
)paren
suffix:semicolon
)brace
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_const
r_char
op_star
op_star
id|argv
)paren
(brace
r_const
r_char
op_star
id|usage
op_assign
l_string|&quot;Usage: git credential-osxkeychain &lt;get|store|erase&gt;&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|argv
(braket
l_int|1
)braket
)paren
id|die
c_func
(paren
id|usage
)paren
suffix:semicolon
id|read_credential
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
l_string|&quot;get&quot;
)paren
)paren
id|find_internet_password
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
l_string|&quot;store&quot;
)paren
)paren
id|add_internet_password
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
l_int|1
)braket
comma
l_string|&quot;erase&quot;
)paren
)paren
id|delete_internet_password
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* otherwise, ignore unknown action */
r_return
l_int|0
suffix:semicolon
)brace
eof
