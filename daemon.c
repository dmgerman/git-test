macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;pkt-line.h&quot;
macro_line|#include &quot;exec_cmd.h&quot;
macro_line|#include &quot;run-command.h&quot;
macro_line|#include &quot;strbuf.h&quot;
macro_line|#include &quot;string-list.h&quot;
macro_line|#ifndef HOST_NAME_MAX
DECL|macro|HOST_NAME_MAX
mdefine_line|#define HOST_NAME_MAX 256
macro_line|#endif
macro_line|#ifndef NI_MAXSERV
DECL|macro|NI_MAXSERV
mdefine_line|#define NI_MAXSERV 32
macro_line|#endif
macro_line|#ifdef NO_INITGROUPS
DECL|macro|initgroups
mdefine_line|#define initgroups(x, y) (0) /* nothing */
macro_line|#endif
DECL|variable|log_syslog
r_static
r_int
id|log_syslog
suffix:semicolon
DECL|variable|verbose
r_static
r_int
id|verbose
suffix:semicolon
DECL|variable|reuseaddr
r_static
r_int
id|reuseaddr
suffix:semicolon
DECL|variable|daemon_usage
r_static
r_const
r_char
id|daemon_usage
(braket
)braket
op_assign
l_string|&quot;git daemon [--verbose] [--syslog] [--export-all]&bslash;n&quot;
l_string|&quot;           [--timeout=&lt;n&gt;] [--init-timeout=&lt;n&gt;] [--max-connections=&lt;n&gt;]&bslash;n&quot;
l_string|&quot;           [--strict-paths] [--base-path=&lt;path&gt;] [--base-path-relaxed]&bslash;n&quot;
l_string|&quot;           [--user-path | --user-path=&lt;path&gt;]&bslash;n&quot;
l_string|&quot;           [--interpolated-path=&lt;path&gt;]&bslash;n&quot;
l_string|&quot;           [--reuseaddr] [--pid-file=&lt;file&gt;]&bslash;n&quot;
l_string|&quot;           [--(enable|disable|allow-override|forbid-override)=&lt;service&gt;]&bslash;n&quot;
l_string|&quot;           [--inetd | [--listen=&lt;host_or_ipaddr&gt;] [--port=&lt;n&gt;]&bslash;n&quot;
l_string|&quot;                      [--detach] [--user=&lt;user&gt; [--group=&lt;group&gt;]]&bslash;n&quot;
l_string|&quot;           [&lt;directory&gt;...]&quot;
suffix:semicolon
multiline_comment|/* List of acceptable pathname prefixes */
DECL|variable|ok_paths
r_static
r_char
op_star
op_star
id|ok_paths
suffix:semicolon
DECL|variable|strict_paths
r_static
r_int
id|strict_paths
suffix:semicolon
multiline_comment|/* If this is set, git-daemon-export-ok is not required */
DECL|variable|export_all_trees
r_static
r_int
id|export_all_trees
suffix:semicolon
multiline_comment|/* Take all paths relative to this one if non-NULL */
DECL|variable|base_path
r_static
r_char
op_star
id|base_path
suffix:semicolon
DECL|variable|interpolated_path
r_static
r_char
op_star
id|interpolated_path
suffix:semicolon
DECL|variable|base_path_relaxed
r_static
r_int
id|base_path_relaxed
suffix:semicolon
multiline_comment|/* Flag indicating client sent extra args. */
DECL|variable|saw_extended_args
r_static
r_int
id|saw_extended_args
suffix:semicolon
multiline_comment|/* If defined, ~user notation is allowed and the string is inserted&n; * after ~user/.  E.g. a request to git://host/~alice/frotz would&n; * go to /home/alice/pub_git/frotz with --user-path=pub_git.&n; */
DECL|variable|user_path
r_static
r_const
r_char
op_star
id|user_path
suffix:semicolon
multiline_comment|/* Timeout, and initial timeout */
DECL|variable|timeout
r_static
r_int
r_int
id|timeout
suffix:semicolon
DECL|variable|init_timeout
r_static
r_int
r_int
id|init_timeout
suffix:semicolon
DECL|variable|hostname
r_static
r_char
op_star
id|hostname
suffix:semicolon
DECL|variable|canon_hostname
r_static
r_char
op_star
id|canon_hostname
suffix:semicolon
DECL|variable|ip_address
r_static
r_char
op_star
id|ip_address
suffix:semicolon
DECL|variable|tcp_port
r_static
r_char
op_star
id|tcp_port
suffix:semicolon
DECL|function|logreport
r_static
r_void
id|logreport
c_func
(paren
r_int
id|priority
comma
r_const
r_char
op_star
id|err
comma
id|va_list
id|params
)paren
(brace
r_if
c_cond
(paren
id|log_syslog
)paren
(brace
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
id|vsnprintf
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|err
comma
id|params
)paren
suffix:semicolon
id|syslog
c_func
(paren
id|priority
comma
l_string|&quot;%s&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Since stderr is set to buffered mode, the&n;&t;&t; * logging of different processes will not overlap&n;&t;&t; * unless they overflow the (rather big) buffers.&n;&t;&t; */
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;[%&quot;
id|PRIuMAX
l_string|&quot;] &quot;
comma
(paren
r_uintmax
)paren
id|getpid
c_func
(paren
)paren
)paren
suffix:semicolon
id|vfprintf
c_func
(paren
id|stderr
comma
id|err
comma
id|params
)paren
suffix:semicolon
id|fputc
c_func
(paren
l_char|&squot;&bslash;n&squot;
comma
id|stderr
)paren
suffix:semicolon
id|fflush
c_func
(paren
id|stderr
)paren
suffix:semicolon
)brace
)brace
id|__attribute__
c_func
(paren
(paren
id|format
(paren
id|printf
comma
l_int|1
comma
l_int|2
)paren
)paren
)paren
DECL|function|logerror
r_static
r_void
id|logerror
c_func
(paren
r_const
r_char
op_star
id|err
comma
dot
dot
dot
)paren
(brace
id|va_list
id|params
suffix:semicolon
id|va_start
c_func
(paren
id|params
comma
id|err
)paren
suffix:semicolon
id|logreport
c_func
(paren
id|LOG_ERR
comma
id|err
comma
id|params
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|params
)paren
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|format
(paren
id|printf
comma
l_int|1
comma
l_int|2
)paren
)paren
)paren
DECL|function|loginfo
r_static
r_void
id|loginfo
c_func
(paren
r_const
r_char
op_star
id|err
comma
dot
dot
dot
)paren
(brace
id|va_list
id|params
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|verbose
)paren
r_return
suffix:semicolon
id|va_start
c_func
(paren
id|params
comma
id|err
)paren
suffix:semicolon
id|logreport
c_func
(paren
id|LOG_INFO
comma
id|err
comma
id|params
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|params
)paren
suffix:semicolon
)brace
DECL|function|daemon_die
r_static
r_void
id|NORETURN
id|daemon_die
c_func
(paren
r_const
r_char
op_star
id|err
comma
id|va_list
id|params
)paren
(brace
id|logreport
c_func
(paren
id|LOG_ERR
comma
id|err
comma
id|params
)paren
suffix:semicolon
m_exit
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|path_ok
r_static
r_char
op_star
id|path_ok
c_func
(paren
r_char
op_star
id|directory
)paren
(brace
r_static
r_char
id|rpath
(braket
id|PATH_MAX
)braket
suffix:semicolon
r_static
r_char
id|interp_path
(braket
id|PATH_MAX
)braket
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_char
op_star
id|dir
suffix:semicolon
id|dir
op_assign
id|directory
suffix:semicolon
r_if
c_cond
(paren
id|daemon_avoid_alias
c_func
(paren
id|dir
)paren
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: aliased&quot;
comma
id|dir
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|dir
op_eq
l_char|&squot;~&squot;
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|user_path
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: User-path not allowed&quot;
comma
id|dir
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|user_path
)paren
(brace
multiline_comment|/* Got either &quot;~alice&quot; or &quot;~alice/foo&quot;;&n;&t;&t;&t; * rewrite them to &quot;~alice/%s&quot; or&n;&t;&t;&t; * &quot;~alice/%s/foo&quot;.&n;&t;&t;&t; */
r_int
id|namlen
comma
id|restlen
op_assign
id|strlen
c_func
(paren
id|dir
)paren
suffix:semicolon
r_char
op_star
id|slash
op_assign
id|strchr
c_func
(paren
id|dir
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slash
)paren
id|slash
op_assign
id|dir
op_plus
id|restlen
suffix:semicolon
id|namlen
op_assign
id|slash
id|dir
suffix:semicolon
id|restlen
op_sub_assign
id|namlen
suffix:semicolon
id|loginfo
c_func
(paren
l_string|&quot;userpath &lt;%s&gt;, request &lt;%s&gt;, namlen %d, restlen %d, slash &lt;%s&gt;&quot;
comma
id|user_path
comma
id|dir
comma
id|namlen
comma
id|restlen
comma
id|slash
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|rpath
comma
id|PATH_MAX
comma
l_string|&quot;%.*s/%s%.*s&quot;
comma
id|namlen
comma
id|dir
comma
id|user_path
comma
id|restlen
comma
id|slash
)paren
suffix:semicolon
id|dir
op_assign
id|rpath
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|interpolated_path
op_logical_and
id|saw_extended_args
)paren
(brace
r_struct
id|strbuf
id|expanded_path
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|strbuf_expand_dict_entry
id|dict
(braket
l_int|6
)braket
suffix:semicolon
id|dict
(braket
l_int|0
)braket
dot
id|placeholder
op_assign
l_string|&quot;H&quot;
suffix:semicolon
id|dict
(braket
l_int|0
)braket
dot
id|value
op_assign
id|hostname
suffix:semicolon
id|dict
(braket
l_int|1
)braket
dot
id|placeholder
op_assign
l_string|&quot;CH&quot;
suffix:semicolon
id|dict
(braket
l_int|1
)braket
dot
id|value
op_assign
id|canon_hostname
suffix:semicolon
id|dict
(braket
l_int|2
)braket
dot
id|placeholder
op_assign
l_string|&quot;IP&quot;
suffix:semicolon
id|dict
(braket
l_int|2
)braket
dot
id|value
op_assign
id|ip_address
suffix:semicolon
id|dict
(braket
l_int|3
)braket
dot
id|placeholder
op_assign
l_string|&quot;P&quot;
suffix:semicolon
id|dict
(braket
l_int|3
)braket
dot
id|value
op_assign
id|tcp_port
suffix:semicolon
id|dict
(braket
l_int|4
)braket
dot
id|placeholder
op_assign
l_string|&quot;D&quot;
suffix:semicolon
id|dict
(braket
l_int|4
)braket
dot
id|value
op_assign
id|directory
suffix:semicolon
id|dict
(braket
l_int|5
)braket
dot
id|placeholder
op_assign
l_int|NULL
suffix:semicolon
id|dict
(braket
l_int|5
)braket
dot
id|value
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dir
op_ne
l_char|&squot;/&squot;
)paren
(brace
multiline_comment|/* Allow only absolute */
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: Non-absolute path denied (interpolated-path active)&quot;
comma
id|dir
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|strbuf_expand
c_func
(paren
op_amp
id|expanded_path
comma
id|interpolated_path
comma
id|strbuf_expand_dict_cb
comma
op_amp
id|dict
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|interp_path
comma
id|expanded_path.buf
comma
id|PATH_MAX
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|expanded_path
)paren
suffix:semicolon
id|loginfo
c_func
(paren
l_string|&quot;Interpolated dir &squot;%s&squot;&quot;
comma
id|interp_path
)paren
suffix:semicolon
id|dir
op_assign
id|interp_path
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base_path
)paren
(brace
r_if
c_cond
(paren
op_star
id|dir
op_ne
l_char|&squot;/&squot;
)paren
(brace
multiline_comment|/* Allow only absolute */
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: Non-absolute path denied (base-path active)&quot;
comma
id|dir
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|snprintf
c_func
(paren
id|rpath
comma
id|PATH_MAX
comma
l_string|&quot;%s%s&quot;
comma
id|base_path
comma
id|dir
)paren
suffix:semicolon
id|dir
op_assign
id|rpath
suffix:semicolon
)brace
id|path
op_assign
id|enter_repo
c_func
(paren
id|dir
comma
id|strict_paths
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
op_logical_and
id|base_path
op_logical_and
id|base_path_relaxed
)paren
(brace
multiline_comment|/*&n;&t;&t; * if we fail and base_path_relaxed is enabled, try without&n;&t;&t; * prefixing the base path&n;&t;&t; */
id|dir
op_assign
id|directory
suffix:semicolon
id|path
op_assign
id|enter_repo
c_func
(paren
id|dir
comma
id|strict_paths
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot; does not appear to be a git repository&quot;
comma
id|dir
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ok_paths
op_logical_and
op_star
id|ok_paths
)paren
(brace
r_char
op_star
op_star
id|pp
suffix:semicolon
r_int
id|pathlen
op_assign
id|strlen
c_func
(paren
id|path
)paren
suffix:semicolon
multiline_comment|/* The validation is done on the paths after enter_repo&n;&t;&t; * appends optional {.git,.git/.git} and friends, but&n;&t;&t; * it does not use getcwd().  So if your /pub is&n;&t;&t; * a symlink to /mnt/pub, you can whitelist /pub and&n;&t;&t; * do not have to say /mnt/pub.&n;&t;&t; * Do not say /pub/.&n;&t;&t; */
r_for
c_loop
(paren
id|pp
op_assign
id|ok_paths
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_increment
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
op_star
id|pp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|pathlen
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
op_star
id|pp
comma
id|path
comma
id|len
)paren
op_logical_and
(paren
id|path
(braket
id|len
)braket
op_eq
l_char|&squot;&bslash;0&squot;
op_logical_or
(paren
op_logical_neg
id|strict_paths
op_logical_and
id|path
(braket
id|len
)braket
op_eq
l_char|&squot;/&squot;
)paren
)paren
)paren
r_return
id|path
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* be backwards compatible */
r_if
c_cond
(paren
op_logical_neg
id|strict_paths
)paren
r_return
id|path
suffix:semicolon
)brace
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: not in whitelist&quot;
comma
id|path
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Fallthrough. Deny by default */
)brace
DECL|typedef|daemon_service_fn
r_typedef
r_int
(paren
op_star
id|daemon_service_fn
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|struct|daemon_service
r_struct
id|daemon_service
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|config_name
r_const
r_char
op_star
id|config_name
suffix:semicolon
DECL|member|fn
id|daemon_service_fn
id|fn
suffix:semicolon
DECL|member|enabled
r_int
id|enabled
suffix:semicolon
DECL|member|overridable
r_int
id|overridable
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|service_looking_at
r_static
r_struct
id|daemon_service
op_star
id|service_looking_at
suffix:semicolon
DECL|variable|service_enabled
r_static
r_int
id|service_enabled
suffix:semicolon
DECL|function|git_daemon_config
r_static
r_int
id|git_daemon_config
c_func
(paren
r_const
r_char
op_star
id|var
comma
r_const
r_char
op_star
id|value
comma
r_void
op_star
id|cb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|var
comma
l_string|&quot;daemon.&quot;
)paren
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|var
op_plus
l_int|7
comma
id|service_looking_at-&gt;config_name
)paren
)paren
(brace
id|service_enabled
op_assign
id|git_config_bool
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* we are not interested in parsing any other configuration here */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|run_service
r_static
r_int
id|run_service
c_func
(paren
r_char
op_star
id|dir
comma
r_struct
id|daemon_service
op_star
id|service
)paren
(brace
r_const
r_char
op_star
id|path
suffix:semicolon
r_int
id|enabled
op_assign
id|service-&gt;enabled
suffix:semicolon
id|loginfo
c_func
(paren
l_string|&quot;Request %s for &squot;%s&squot;&quot;
comma
id|service-&gt;name
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enabled
op_logical_and
op_logical_neg
id|service-&gt;overridable
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: service not enabled.&quot;
comma
id|service-&gt;name
)paren
suffix:semicolon
id|errno
op_assign
id|EACCES
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|path
op_assign
id|path_ok
c_func
(paren
id|dir
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Security on the cheap.&n;&t; *&n;&t; * We want a readable HEAD, usable &quot;objects&quot; directory, and&n;&t; * a &quot;git-daemon-export-ok&quot; flag that says that the other side&n;&t; * is ok with us doing this.&n;&t; *&n;&t; * path_ok() uses enter_repo() and does whitelist checking.&n;&t; * We only need to make sure the repository is exported.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|export_all_trees
op_logical_and
id|access
c_func
(paren
l_string|&quot;git-daemon-export-ok&quot;
comma
id|F_OK
)paren
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: repository not exported.&quot;
comma
id|path
)paren
suffix:semicolon
id|errno
op_assign
id|EACCES
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|service-&gt;overridable
)paren
(brace
id|service_looking_at
op_assign
id|service
suffix:semicolon
id|service_enabled
op_assign
l_int|1
suffix:semicolon
id|git_config
c_func
(paren
id|git_daemon_config
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_le
id|service_enabled
)paren
id|enabled
op_assign
id|service_enabled
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|enabled
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;&squot;%s&squot;: service not enabled for &squot;%s&squot;&quot;
comma
id|service-&gt;name
comma
id|path
)paren
suffix:semicolon
id|errno
op_assign
id|EACCES
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We&squot;ll ignore SIGTERM from now on, we have a&n;&t; * good client.&n;&t; */
id|signal
c_func
(paren
id|SIGTERM
comma
id|SIG_IGN
)paren
suffix:semicolon
r_return
id|service
op_member_access_from_pointer
id|fn
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|copy_to_log
r_static
r_void
id|copy_to_log
c_func
(paren
r_int
id|fd
)paren
(brace
r_struct
id|strbuf
id|line
op_assign
id|STRBUF_INIT
suffix:semicolon
id|FILE
op_star
id|fp
suffix:semicolon
id|fp
op_assign
id|fdopen
c_func
(paren
id|fd
comma
l_string|&quot;r&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp
op_eq
l_int|NULL
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;fdopen of error channel failed&quot;
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|strbuf_getline
c_func
(paren
op_amp
id|line
comma
id|fp
comma
l_char|&squot;&bslash;n&squot;
)paren
op_ne
id|EOF
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;%s&quot;
comma
id|line.buf
)paren
suffix:semicolon
id|strbuf_setlen
c_func
(paren
op_amp
id|line
comma
l_int|0
)paren
suffix:semicolon
)brace
id|strbuf_release
c_func
(paren
op_amp
id|line
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
DECL|function|run_service_command
r_static
r_int
id|run_service_command
c_func
(paren
r_const
r_char
op_star
op_star
id|argv
)paren
(brace
r_struct
id|child_process
id|cld
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cld
comma
l_int|0
comma
r_sizeof
(paren
id|cld
)paren
)paren
suffix:semicolon
id|cld.argv
op_assign
id|argv
suffix:semicolon
id|cld.git_cmd
op_assign
l_int|1
suffix:semicolon
id|cld.err
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|start_command
c_func
(paren
op_amp
id|cld
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|close
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|close
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|copy_to_log
c_func
(paren
id|cld.err
)paren
suffix:semicolon
r_return
id|finish_command
c_func
(paren
op_amp
id|cld
)paren
suffix:semicolon
)brace
DECL|function|upload_pack
r_static
r_int
id|upload_pack
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Timeout as string */
r_char
id|timeout_buf
(braket
l_int|64
)braket
suffix:semicolon
r_const
r_char
op_star
id|argv
(braket
)braket
op_assign
(brace
l_string|&quot;upload-pack&quot;
comma
l_string|&quot;--strict&quot;
comma
l_int|NULL
comma
l_string|&quot;.&quot;
comma
l_int|NULL
)brace
suffix:semicolon
id|argv
(braket
l_int|2
)braket
op_assign
id|timeout_buf
suffix:semicolon
id|snprintf
c_func
(paren
id|timeout_buf
comma
r_sizeof
id|timeout_buf
comma
l_string|&quot;--timeout=%u&quot;
comma
id|timeout
)paren
suffix:semicolon
r_return
id|run_service_command
c_func
(paren
id|argv
)paren
suffix:semicolon
)brace
DECL|function|upload_archive
r_static
r_int
id|upload_archive
c_func
(paren
r_void
)paren
(brace
r_static
r_const
r_char
op_star
id|argv
(braket
)braket
op_assign
(brace
l_string|&quot;upload-archive&quot;
comma
l_string|&quot;.&quot;
comma
l_int|NULL
)brace
suffix:semicolon
r_return
id|run_service_command
c_func
(paren
id|argv
)paren
suffix:semicolon
)brace
DECL|function|receive_pack
r_static
r_int
id|receive_pack
c_func
(paren
r_void
)paren
(brace
r_static
r_const
r_char
op_star
id|argv
(braket
)braket
op_assign
(brace
l_string|&quot;receive-pack&quot;
comma
l_string|&quot;.&quot;
comma
l_int|NULL
)brace
suffix:semicolon
r_return
id|run_service_command
c_func
(paren
id|argv
)paren
suffix:semicolon
)brace
DECL|variable|daemon_service
r_static
r_struct
id|daemon_service
id|daemon_service
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;upload-archive&quot;
comma
l_string|&quot;uploadarch&quot;
comma
id|upload_archive
comma
l_int|0
comma
l_int|1
)brace
comma
(brace
l_string|&quot;upload-pack&quot;
comma
l_string|&quot;uploadpack&quot;
comma
id|upload_pack
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_string|&quot;receive-pack&quot;
comma
l_string|&quot;receivepack&quot;
comma
id|receive_pack
comma
l_int|0
comma
l_int|1
)brace
comma
)brace
suffix:semicolon
DECL|function|enable_service
r_static
r_void
id|enable_service
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|ena
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|daemon_service
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|daemon_service
(braket
id|i
)braket
dot
id|name
comma
id|name
)paren
)paren
(brace
id|daemon_service
(braket
id|i
)braket
dot
id|enabled
op_assign
id|ena
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|die
c_func
(paren
l_string|&quot;No such service %s&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|make_service_overridable
r_static
r_void
id|make_service_overridable
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|ena
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|daemon_service
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|daemon_service
(braket
id|i
)braket
dot
id|name
comma
id|name
)paren
)paren
(brace
id|daemon_service
(braket
id|i
)braket
dot
id|overridable
op_assign
id|ena
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|die
c_func
(paren
l_string|&quot;No such service %s&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|xstrdup_tolower
r_static
r_char
op_star
id|xstrdup_tolower
c_func
(paren
r_const
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|dup
op_assign
id|xstrdup
c_func
(paren
id|str
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|dup
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_increment
)paren
op_star
id|p
op_assign
id|tolower
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
r_return
id|dup
suffix:semicolon
)brace
DECL|function|parse_host_and_port
r_static
r_void
id|parse_host_and_port
c_func
(paren
r_char
op_star
id|hostport
comma
r_char
op_star
op_star
id|host
comma
r_char
op_star
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
op_star
id|hostport
op_eq
l_char|&squot;[&squot;
)paren
(brace
r_char
op_star
id|end
suffix:semicolon
id|end
op_assign
id|strchr
c_func
(paren
id|hostport
comma
l_char|&squot;]&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|end
)paren
id|die
c_func
(paren
l_string|&quot;Invalid request (&squot;[&squot; without &squot;]&squot;)&quot;
)paren
suffix:semicolon
op_star
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|host
op_assign
id|hostport
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|end
(braket
l_int|1
)braket
)paren
op_star
id|port
op_assign
l_int|NULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|end
(braket
l_int|1
)braket
op_eq
l_char|&squot;:&squot;
)paren
op_star
id|port
op_assign
id|end
op_plus
l_int|2
suffix:semicolon
r_else
id|die
c_func
(paren
l_string|&quot;Garbage after end of host part&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|host
op_assign
id|hostport
suffix:semicolon
op_star
id|port
op_assign
id|strrchr
c_func
(paren
id|hostport
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|port
)paren
(brace
op_star
op_star
id|port
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_increment
op_star
id|port
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Read the host as supplied by the client connection.&n; */
DECL|function|parse_host_arg
r_static
r_void
id|parse_host_arg
c_func
(paren
r_char
op_star
id|extra_args
comma
r_int
id|buflen
)paren
(brace
r_char
op_star
id|val
suffix:semicolon
r_int
id|vallen
suffix:semicolon
r_char
op_star
id|end
op_assign
id|extra_args
op_plus
id|buflen
suffix:semicolon
r_if
c_cond
(paren
id|extra_args
OL
id|end
op_logical_and
op_star
id|extra_args
)paren
(brace
id|saw_extended_args
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|strncasecmp
c_func
(paren
l_string|&quot;host=&quot;
comma
id|extra_args
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|val
op_assign
id|extra_args
op_plus
l_int|5
suffix:semicolon
id|vallen
op_assign
id|strlen
c_func
(paren
id|val
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|val
)paren
(brace
multiline_comment|/* Split &lt;host&gt;:&lt;port&gt; at colon. */
r_char
op_star
id|host
suffix:semicolon
r_char
op_star
id|port
suffix:semicolon
id|parse_host_and_port
c_func
(paren
id|val
comma
op_amp
id|host
comma
op_amp
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
(brace
id|free
c_func
(paren
id|tcp_port
)paren
suffix:semicolon
id|tcp_port
op_assign
id|xstrdup
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|hostname
)paren
suffix:semicolon
id|hostname
op_assign
id|xstrdup_tolower
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
multiline_comment|/* On to the next one */
id|extra_args
op_assign
id|val
op_plus
id|vallen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|extra_args
OL
id|end
op_logical_and
op_star
id|extra_args
)paren
id|die
c_func
(paren
l_string|&quot;Invalid request&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Locate canonical hostname and its IP address.&n;&t; */
r_if
c_cond
(paren
id|hostname
)paren
(brace
macro_line|#ifndef NO_IPV6
r_struct
id|addrinfo
id|hints
suffix:semicolon
r_struct
id|addrinfo
op_star
id|ai
suffix:semicolon
r_int
id|gai
suffix:semicolon
r_static
r_char
id|addrbuf
(braket
id|HOST_NAME_MAX
op_plus
l_int|1
)braket
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hints
comma
l_int|0
comma
r_sizeof
(paren
id|hints
)paren
)paren
suffix:semicolon
id|hints.ai_flags
op_assign
id|AI_CANONNAME
suffix:semicolon
id|gai
op_assign
id|getaddrinfo
c_func
(paren
id|hostname
comma
l_int|NULL
comma
op_amp
id|hints
comma
op_amp
id|ai
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gai
)paren
(brace
r_struct
id|sockaddr_in
op_star
id|sin_addr
op_assign
(paren
r_void
op_star
)paren
id|ai-&gt;ai_addr
suffix:semicolon
id|inet_ntop
c_func
(paren
id|AF_INET
comma
op_amp
id|sin_addr-&gt;sin_addr
comma
id|addrbuf
comma
r_sizeof
(paren
id|addrbuf
)paren
)paren
suffix:semicolon
id|free
c_func
(paren
id|ip_address
)paren
suffix:semicolon
id|ip_address
op_assign
id|xstrdup
c_func
(paren
id|addrbuf
)paren
suffix:semicolon
id|free
c_func
(paren
id|canon_hostname
)paren
suffix:semicolon
id|canon_hostname
op_assign
id|xstrdup
c_func
(paren
id|ai-&gt;ai_canonname
ques
c_cond
id|ai-&gt;ai_canonname
suffix:colon
id|ip_address
)paren
suffix:semicolon
id|freeaddrinfo
c_func
(paren
id|ai
)paren
suffix:semicolon
)brace
macro_line|#else
r_struct
id|hostent
op_star
id|hent
suffix:semicolon
r_struct
id|sockaddr_in
id|sa
suffix:semicolon
r_char
op_star
op_star
id|ap
suffix:semicolon
r_static
r_char
id|addrbuf
(braket
id|HOST_NAME_MAX
op_plus
l_int|1
)braket
suffix:semicolon
id|hent
op_assign
id|gethostbyname
c_func
(paren
id|hostname
)paren
suffix:semicolon
id|ap
op_assign
id|hent-&gt;h_addr_list
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sa
comma
l_int|0
comma
r_sizeof
id|sa
)paren
suffix:semicolon
id|sa.sin_family
op_assign
id|hent-&gt;h_addrtype
suffix:semicolon
id|sa.sin_port
op_assign
id|htons
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sa.sin_addr
comma
op_star
id|ap
comma
id|hent-&gt;h_length
)paren
suffix:semicolon
id|inet_ntop
c_func
(paren
id|hent-&gt;h_addrtype
comma
op_amp
id|sa.sin_addr
comma
id|addrbuf
comma
r_sizeof
(paren
id|addrbuf
)paren
)paren
suffix:semicolon
id|free
c_func
(paren
id|canon_hostname
)paren
suffix:semicolon
id|canon_hostname
op_assign
id|xstrdup
c_func
(paren
id|hent-&gt;h_name
)paren
suffix:semicolon
id|free
c_func
(paren
id|ip_address
)paren
suffix:semicolon
id|ip_address
op_assign
id|xstrdup
c_func
(paren
id|addrbuf
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|execute
r_static
r_int
id|execute
c_func
(paren
r_void
)paren
(brace
r_static
r_char
id|line
(braket
l_int|1000
)braket
suffix:semicolon
r_int
id|pktlen
comma
id|len
comma
id|i
suffix:semicolon
r_char
op_star
id|addr
op_assign
id|getenv
c_func
(paren
l_string|&quot;REMOTE_ADDR&quot;
)paren
comma
op_star
id|port
op_assign
id|getenv
c_func
(paren
l_string|&quot;REMOTE_PORT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
)paren
id|loginfo
c_func
(paren
l_string|&quot;Connection from %s:%s&quot;
comma
id|addr
comma
id|port
)paren
suffix:semicolon
id|alarm
c_func
(paren
id|init_timeout
ques
c_cond
id|init_timeout
suffix:colon
id|timeout
)paren
suffix:semicolon
id|pktlen
op_assign
id|packet_read_line
c_func
(paren
l_int|0
comma
id|line
comma
r_sizeof
(paren
id|line
)paren
)paren
suffix:semicolon
id|alarm
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pktlen
op_ne
id|len
)paren
id|loginfo
c_func
(paren
l_string|&quot;Extended attributes (%d bytes) exist &lt;%.*s&gt;&quot;
comma
(paren
r_int
)paren
id|pktlen
id|len
comma
(paren
r_int
)paren
id|pktlen
id|len
comma
id|line
op_plus
id|len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|line
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|line
(braket
op_decrement
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|pktlen
op_decrement
suffix:semicolon
)brace
id|free
c_func
(paren
id|hostname
)paren
suffix:semicolon
id|free
c_func
(paren
id|canon_hostname
)paren
suffix:semicolon
id|free
c_func
(paren
id|ip_address
)paren
suffix:semicolon
id|free
c_func
(paren
id|tcp_port
)paren
suffix:semicolon
id|hostname
op_assign
id|canon_hostname
op_assign
id|ip_address
op_assign
id|tcp_port
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|pktlen
)paren
id|parse_host_arg
c_func
(paren
id|line
op_plus
id|len
op_plus
l_int|1
comma
id|pktlen
id|len
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|daemon_service
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|daemon_service
op_star
id|s
op_assign
op_amp
(paren
id|daemon_service
(braket
id|i
)braket
)paren
suffix:semicolon
r_int
id|namelen
op_assign
id|strlen
c_func
(paren
id|s-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|line
comma
l_string|&quot;git-&quot;
)paren
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|s-&gt;name
comma
id|line
op_plus
l_int|4
comma
id|namelen
)paren
op_logical_and
id|line
(braket
id|namelen
op_plus
l_int|4
)braket
op_eq
l_char|&squot; &squot;
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Note: The directory here is probably context sensitive,&n;&t;&t;&t; * and might depend on the actual service being performed.&n;&t;&t;&t; */
r_return
id|run_service
c_func
(paren
id|line
op_plus
id|namelen
op_plus
l_int|5
comma
id|s
)paren
suffix:semicolon
)brace
)brace
id|logerror
c_func
(paren
l_string|&quot;Protocol error: &squot;%s&squot;&quot;
comma
id|line
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|addrcmp
r_static
r_int
id|addrcmp
c_func
(paren
r_const
r_struct
id|sockaddr_storage
op_star
id|s1
comma
r_const
r_struct
id|sockaddr_storage
op_star
id|s2
)paren
(brace
r_const
r_struct
id|sockaddr
op_star
id|sa1
op_assign
(paren
r_const
r_struct
id|sockaddr
op_star
)paren
id|s1
suffix:semicolon
r_const
r_struct
id|sockaddr
op_star
id|sa2
op_assign
(paren
r_const
r_struct
id|sockaddr
op_star
)paren
id|s2
suffix:semicolon
r_if
c_cond
(paren
id|sa1-&gt;sa_family
op_ne
id|sa2-&gt;sa_family
)paren
r_return
id|sa1-&gt;sa_family
id|sa2-&gt;sa_family
suffix:semicolon
r_if
c_cond
(paren
id|sa1-&gt;sa_family
op_eq
id|AF_INET
)paren
r_return
id|memcmp
c_func
(paren
op_amp
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|s1
)paren
op_member_access_from_pointer
id|sin_addr
comma
op_amp
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|s2
)paren
op_member_access_from_pointer
id|sin_addr
comma
r_sizeof
(paren
r_struct
id|in_addr
)paren
)paren
suffix:semicolon
macro_line|#ifndef NO_IPV6
r_if
c_cond
(paren
id|sa1-&gt;sa_family
op_eq
id|AF_INET6
)paren
r_return
id|memcmp
c_func
(paren
op_amp
(paren
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|s1
)paren
op_member_access_from_pointer
id|sin6_addr
comma
op_amp
(paren
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|s2
)paren
op_member_access_from_pointer
id|sin6_addr
comma
r_sizeof
(paren
r_struct
id|in6_addr
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|max_connections
r_static
r_int
id|max_connections
op_assign
l_int|32
suffix:semicolon
DECL|variable|live_children
r_static
r_int
r_int
id|live_children
suffix:semicolon
DECL|struct|child
r_static
r_struct
id|child
(brace
DECL|member|next
r_struct
id|child
op_star
id|next
suffix:semicolon
DECL|member|cld
r_struct
id|child_process
id|cld
suffix:semicolon
DECL|member|address
r_struct
id|sockaddr_storage
id|address
suffix:semicolon
DECL|variable|firstborn
)brace
op_star
id|firstborn
suffix:semicolon
DECL|function|add_child
r_static
r_void
id|add_child
c_func
(paren
r_struct
id|child_process
op_star
id|cld
comma
r_struct
id|sockaddr
op_star
id|addr
comma
id|socklen_t
id|addrlen
)paren
(brace
r_struct
id|child
op_star
id|newborn
comma
op_star
op_star
id|cradle
suffix:semicolon
id|newborn
op_assign
id|xcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|newborn
)paren
)paren
suffix:semicolon
id|live_children
op_increment
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|newborn-&gt;cld
comma
id|cld
comma
r_sizeof
(paren
op_star
id|cld
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|newborn-&gt;address
comma
id|addr
comma
id|addrlen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cradle
op_assign
op_amp
id|firstborn
suffix:semicolon
op_star
id|cradle
suffix:semicolon
id|cradle
op_assign
op_amp
(paren
op_star
id|cradle
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_logical_neg
id|addrcmp
c_func
(paren
op_amp
(paren
op_star
id|cradle
)paren
op_member_access_from_pointer
id|address
comma
op_amp
id|newborn-&gt;address
)paren
)paren
r_break
suffix:semicolon
id|newborn-&gt;next
op_assign
op_star
id|cradle
suffix:semicolon
op_star
id|cradle
op_assign
id|newborn
suffix:semicolon
)brace
multiline_comment|/*&n; * This gets called if the number of connections grows&n; * past &quot;max_connections&quot;.&n; *&n; * We kill the newest connection from a duplicate IP.&n; */
DECL|function|kill_some_child
r_static
r_void
id|kill_some_child
c_func
(paren
r_void
)paren
(brace
r_const
r_struct
id|child
op_star
id|blanket
comma
op_star
id|next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|blanket
op_assign
id|firstborn
)paren
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|next
op_assign
id|blanket-&gt;next
)paren
suffix:semicolon
id|blanket
op_assign
id|next
)paren
r_if
c_cond
(paren
op_logical_neg
id|addrcmp
c_func
(paren
op_amp
id|blanket-&gt;address
comma
op_amp
id|next-&gt;address
)paren
)paren
(brace
id|kill
c_func
(paren
id|blanket-&gt;cld.pid
comma
id|SIGTERM
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|check_dead_children
r_static
r_void
id|check_dead_children
c_func
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
id|pid_t
id|pid
suffix:semicolon
r_struct
id|child
op_star
op_star
id|cradle
comma
op_star
id|blanket
suffix:semicolon
r_for
c_loop
(paren
id|cradle
op_assign
op_amp
id|firstborn
suffix:semicolon
(paren
id|blanket
op_assign
op_star
id|cradle
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
(paren
id|pid
op_assign
id|waitpid
c_func
(paren
id|blanket-&gt;cld.pid
comma
op_amp
id|status
comma
id|WNOHANG
)paren
)paren
OG
l_int|1
)paren
(brace
r_const
r_char
op_star
id|dead
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dead
op_assign
l_string|&quot; (with error)&quot;
suffix:semicolon
id|loginfo
c_func
(paren
l_string|&quot;[%&quot;
id|PRIuMAX
l_string|&quot;] Disconnected%s&quot;
comma
(paren
r_uintmax
)paren
id|pid
comma
id|dead
)paren
suffix:semicolon
multiline_comment|/* remove the child */
op_star
id|cradle
op_assign
id|blanket-&gt;next
suffix:semicolon
id|live_children
op_decrement
suffix:semicolon
id|free
c_func
(paren
id|blanket
)paren
suffix:semicolon
)brace
r_else
id|cradle
op_assign
op_amp
id|blanket-&gt;next
suffix:semicolon
)brace
DECL|variable|cld_argv
r_static
r_char
op_star
op_star
id|cld_argv
suffix:semicolon
DECL|function|handle
r_static
r_void
id|handle
c_func
(paren
r_int
id|incoming
comma
r_struct
id|sockaddr
op_star
id|addr
comma
id|socklen_t
id|addrlen
)paren
(brace
r_struct
id|child_process
id|cld
op_assign
(brace
l_int|NULL
)brace
suffix:semicolon
r_char
id|addrbuf
(braket
l_int|300
)braket
op_assign
l_string|&quot;REMOTE_ADDR=&quot;
comma
id|portbuf
(braket
l_int|300
)braket
suffix:semicolon
r_char
op_star
id|env
(braket
)braket
op_assign
(brace
id|addrbuf
comma
id|portbuf
comma
l_int|NULL
)brace
suffix:semicolon
r_if
c_cond
(paren
id|max_connections
op_logical_and
id|live_children
op_ge
id|max_connections
)paren
(brace
id|kill_some_child
c_func
(paren
)paren
suffix:semicolon
id|sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* give it some time to die */
id|check_dead_children
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|live_children
op_ge
id|max_connections
)paren
(brace
id|close
c_func
(paren
id|incoming
)paren
suffix:semicolon
id|logerror
c_func
(paren
l_string|&quot;Too many children, dropping connection&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|addr-&gt;sa_family
op_eq
id|AF_INET
)paren
(brace
r_struct
id|sockaddr_in
op_star
id|sin_addr
op_assign
(paren
r_void
op_star
)paren
id|addr
suffix:semicolon
id|inet_ntop
c_func
(paren
id|addr-&gt;sa_family
comma
op_amp
id|sin_addr-&gt;sin_addr
comma
id|addrbuf
op_plus
l_int|12
comma
r_sizeof
(paren
id|addrbuf
)paren
l_int|12
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|portbuf
comma
r_sizeof
(paren
id|portbuf
)paren
comma
l_string|&quot;REMOTE_PORT=%d&quot;
comma
id|ntohs
c_func
(paren
id|sin_addr-&gt;sin_port
)paren
)paren
suffix:semicolon
macro_line|#ifndef NO_IPV6
)brace
r_else
r_if
c_cond
(paren
id|addr
op_logical_and
id|addr-&gt;sa_family
op_eq
id|AF_INET6
)paren
(brace
r_struct
id|sockaddr_in6
op_star
id|sin6_addr
op_assign
(paren
r_void
op_star
)paren
id|addr
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|addrbuf
op_plus
l_int|12
suffix:semicolon
op_star
id|buf
op_increment
op_assign
l_char|&squot;[&squot;
suffix:semicolon
op_star
id|buf
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* stpcpy() is cool */
id|inet_ntop
c_func
(paren
id|AF_INET6
comma
op_amp
id|sin6_addr-&gt;sin6_addr
comma
id|buf
comma
r_sizeof
(paren
id|addrbuf
)paren
l_int|13
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|buf
comma
l_string|&quot;]&quot;
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|portbuf
comma
r_sizeof
(paren
id|portbuf
)paren
comma
l_string|&quot;REMOTE_PORT=%d&quot;
comma
id|ntohs
c_func
(paren
id|sin6_addr-&gt;sin6_port
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|cld.env
op_assign
(paren
r_const
r_char
op_star
op_star
)paren
id|env
suffix:semicolon
id|cld.argv
op_assign
(paren
r_const
r_char
op_star
op_star
)paren
id|cld_argv
suffix:semicolon
id|cld.in
op_assign
id|incoming
suffix:semicolon
id|cld.out
op_assign
id|dup
c_func
(paren
id|incoming
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start_command
c_func
(paren
op_amp
id|cld
)paren
)paren
id|logerror
c_func
(paren
l_string|&quot;unable to fork&quot;
)paren
suffix:semicolon
r_else
id|add_child
c_func
(paren
op_amp
id|cld
comma
id|addr
comma
id|addrlen
)paren
suffix:semicolon
id|close
c_func
(paren
id|incoming
)paren
suffix:semicolon
)brace
DECL|function|child_handler
r_static
r_void
id|child_handler
c_func
(paren
r_int
id|signo
)paren
(brace
multiline_comment|/*&n;&t; * Otherwise empty handler because systemcalls will get interrupted&n;&t; * upon signal receipt&n;&t; * SysV needs the handler to be rearmed&n;&t; */
id|signal
c_func
(paren
id|SIGCHLD
comma
id|child_handler
)paren
suffix:semicolon
)brace
DECL|function|set_reuse_addr
r_static
r_int
id|set_reuse_addr
c_func
(paren
r_int
id|sockfd
)paren
(brace
r_int
id|on
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reuseaddr
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|setsockopt
c_func
(paren
id|sockfd
comma
id|SOL_SOCKET
comma
id|SO_REUSEADDR
comma
op_amp
id|on
comma
r_sizeof
(paren
id|on
)paren
)paren
suffix:semicolon
)brace
DECL|struct|socketlist
r_struct
id|socketlist
(brace
DECL|member|list
r_int
op_star
id|list
suffix:semicolon
DECL|member|nr
r_int
id|nr
suffix:semicolon
DECL|member|alloc
r_int
id|alloc
suffix:semicolon
)brace
suffix:semicolon
DECL|function|ip2str
r_static
r_const
r_char
op_star
id|ip2str
c_func
(paren
r_int
id|family
comma
r_struct
id|sockaddr
op_star
id|sin
comma
id|socklen_t
id|len
)paren
(brace
macro_line|#ifdef NO_IPV6
r_static
r_char
id|ip
(braket
id|INET_ADDRSTRLEN
)braket
suffix:semicolon
macro_line|#else
r_static
r_char
id|ip
(braket
id|INET6_ADDRSTRLEN
)braket
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|family
)paren
(brace
macro_line|#ifndef NO_IPV6
r_case
id|AF_INET6
suffix:colon
id|inet_ntop
c_func
(paren
id|family
comma
op_amp
(paren
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|sin
)paren
op_member_access_from_pointer
id|sin6_addr
comma
id|ip
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|AF_INET
suffix:colon
id|inet_ntop
c_func
(paren
id|family
comma
op_amp
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
id|sin
)paren
op_member_access_from_pointer
id|sin_addr
comma
id|ip
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|strcpy
c_func
(paren
id|ip
comma
l_string|&quot;&lt;unknown&gt;&quot;
)paren
suffix:semicolon
)brace
r_return
id|ip
suffix:semicolon
)brace
macro_line|#ifndef NO_IPV6
DECL|function|setup_named_sock
r_static
r_int
id|setup_named_sock
c_func
(paren
r_char
op_star
id|listen_addr
comma
r_int
id|listen_port
comma
r_struct
id|socketlist
op_star
id|socklist
)paren
(brace
r_int
id|socknum
op_assign
l_int|0
suffix:semicolon
r_int
id|maxfd
op_assign
l_int|1
suffix:semicolon
r_char
id|pbuf
(braket
id|NI_MAXSERV
)braket
suffix:semicolon
r_struct
id|addrinfo
id|hints
comma
op_star
id|ai0
comma
op_star
id|ai
suffix:semicolon
r_int
id|gai
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|sprintf
c_func
(paren
id|pbuf
comma
l_string|&quot;%d&quot;
comma
id|listen_port
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hints
comma
l_int|0
comma
r_sizeof
(paren
id|hints
)paren
)paren
suffix:semicolon
id|hints.ai_family
op_assign
id|AF_UNSPEC
suffix:semicolon
id|hints.ai_socktype
op_assign
id|SOCK_STREAM
suffix:semicolon
id|hints.ai_protocol
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|hints.ai_flags
op_assign
id|AI_PASSIVE
suffix:semicolon
id|gai
op_assign
id|getaddrinfo
c_func
(paren
id|listen_addr
comma
id|pbuf
comma
op_amp
id|hints
comma
op_amp
id|ai0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gai
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;getaddrinfo() for %s failed: %s&quot;
comma
id|listen_addr
comma
id|gai_strerror
c_func
(paren
id|gai
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ai
op_assign
id|ai0
suffix:semicolon
id|ai
suffix:semicolon
id|ai
op_assign
id|ai-&gt;ai_next
)paren
(brace
r_int
id|sockfd
suffix:semicolon
id|sockfd
op_assign
id|socket
c_func
(paren
id|ai-&gt;ai_family
comma
id|ai-&gt;ai_socktype
comma
id|ai-&gt;ai_protocol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockfd
OL
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sockfd
op_ge
id|FD_SETSIZE
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Socket descriptor too large&quot;
)paren
suffix:semicolon
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#ifdef IPV6_V6ONLY
r_if
c_cond
(paren
id|ai-&gt;ai_family
op_eq
id|AF_INET6
)paren
(brace
r_int
id|on
op_assign
l_int|1
suffix:semicolon
id|setsockopt
c_func
(paren
id|sockfd
comma
id|IPPROTO_IPV6
comma
id|IPV6_V6ONLY
comma
op_amp
id|on
comma
r_sizeof
(paren
id|on
)paren
)paren
suffix:semicolon
multiline_comment|/* Note: error is not fatal */
)brace
macro_line|#endif
r_if
c_cond
(paren
id|set_reuse_addr
c_func
(paren
id|sockfd
)paren
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Could not set SO_REUSEADDR: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bind
c_func
(paren
id|sockfd
comma
id|ai-&gt;ai_addr
comma
id|ai-&gt;ai_addrlen
)paren
OL
l_int|0
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Could not bind to %s: %s&quot;
comma
id|ip2str
c_func
(paren
id|ai-&gt;ai_family
comma
id|ai-&gt;ai_addr
comma
id|ai-&gt;ai_addrlen
)paren
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* not fatal */
)brace
r_if
c_cond
(paren
id|listen
c_func
(paren
id|sockfd
comma
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Could not listen to %s: %s&quot;
comma
id|ip2str
c_func
(paren
id|ai-&gt;ai_family
comma
id|ai-&gt;ai_addr
comma
id|ai-&gt;ai_addrlen
)paren
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* not fatal */
)brace
id|flags
op_assign
id|fcntl
c_func
(paren
id|sockfd
comma
id|F_GETFD
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_ge
l_int|0
)paren
id|fcntl
c_func
(paren
id|sockfd
comma
id|F_SETFD
comma
id|flags
op_or
id|FD_CLOEXEC
)paren
suffix:semicolon
id|ALLOC_GROW
c_func
(paren
id|socklist-&gt;list
comma
id|socklist-&gt;nr
op_plus
l_int|1
comma
id|socklist-&gt;alloc
)paren
suffix:semicolon
id|socklist-&gt;list
(braket
id|socklist-&gt;nr
op_increment
)braket
op_assign
id|sockfd
suffix:semicolon
id|socknum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|maxfd
OL
id|sockfd
)paren
id|maxfd
op_assign
id|sockfd
suffix:semicolon
)brace
id|freeaddrinfo
c_func
(paren
id|ai0
)paren
suffix:semicolon
r_return
id|socknum
suffix:semicolon
)brace
macro_line|#else /* NO_IPV6 */
DECL|function|setup_named_sock
r_static
r_int
id|setup_named_sock
c_func
(paren
r_char
op_star
id|listen_addr
comma
r_int
id|listen_port
comma
r_struct
id|socketlist
op_star
id|socklist
)paren
(brace
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_int
id|sockfd
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sin
comma
l_int|0
comma
r_sizeof
id|sin
)paren
suffix:semicolon
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin.sin_port
op_assign
id|htons
c_func
(paren
id|listen_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|listen_addr
)paren
(brace
multiline_comment|/* Well, host better be an IP address here. */
r_if
c_cond
(paren
id|inet_pton
c_func
(paren
id|AF_INET
comma
id|listen_addr
comma
op_amp
id|sin.sin_addr.s_addr
)paren
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|sin.sin_addr.s_addr
op_assign
id|htonl
c_func
(paren
id|INADDR_ANY
)paren
suffix:semicolon
)brace
id|sockfd
op_assign
id|socket
c_func
(paren
id|AF_INET
comma
id|SOCK_STREAM
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockfd
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_reuse_addr
c_func
(paren
id|sockfd
)paren
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Could not set SO_REUSEADDR: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bind
c_func
(paren
id|sockfd
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin
comma
r_sizeof
id|sin
)paren
OL
l_int|0
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Could not listen to %s: %s&quot;
comma
id|ip2str
c_func
(paren
id|AF_INET
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin
comma
r_sizeof
(paren
id|sin
)paren
)paren
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|listen
c_func
(paren
id|sockfd
comma
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Could not listen to %s: %s&quot;
comma
id|ip2str
c_func
(paren
id|AF_INET
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin
comma
r_sizeof
(paren
id|sin
)paren
)paren
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|flags
op_assign
id|fcntl
c_func
(paren
id|sockfd
comma
id|F_GETFD
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_ge
l_int|0
)paren
id|fcntl
c_func
(paren
id|sockfd
comma
id|F_SETFD
comma
id|flags
op_or
id|FD_CLOEXEC
)paren
suffix:semicolon
id|ALLOC_GROW
c_func
(paren
id|socklist-&gt;list
comma
id|socklist-&gt;nr
op_plus
l_int|1
comma
id|socklist-&gt;alloc
)paren
suffix:semicolon
id|socklist-&gt;list
(braket
id|socklist-&gt;nr
op_increment
)braket
op_assign
id|sockfd
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|function|socksetup
r_static
r_void
id|socksetup
c_func
(paren
r_struct
id|string_list
op_star
id|listen_addr
comma
r_int
id|listen_port
comma
r_struct
id|socketlist
op_star
id|socklist
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|listen_addr-&gt;nr
)paren
id|setup_named_sock
c_func
(paren
l_int|NULL
comma
id|listen_port
comma
id|socklist
)paren
suffix:semicolon
r_else
(brace
r_int
id|i
comma
id|socknum
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|listen_addr-&gt;nr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|socknum
op_assign
id|setup_named_sock
c_func
(paren
id|listen_addr-&gt;items
(braket
id|i
)braket
dot
id|string
comma
id|listen_port
comma
id|socklist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socknum
op_eq
l_int|0
)paren
id|logerror
c_func
(paren
l_string|&quot;unable to allocate any listen sockets for host %s on port %u&quot;
comma
id|listen_addr-&gt;items
(braket
id|i
)braket
dot
id|string
comma
id|listen_port
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|service_loop
r_static
r_int
id|service_loop
c_func
(paren
r_struct
id|socketlist
op_star
id|socklist
)paren
(brace
r_struct
id|pollfd
op_star
id|pfd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pfd
op_assign
id|xcalloc
c_func
(paren
id|socklist-&gt;nr
comma
r_sizeof
(paren
r_struct
id|pollfd
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|socklist-&gt;nr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pfd
(braket
id|i
)braket
dot
id|fd
op_assign
id|socklist-&gt;list
(braket
id|i
)braket
suffix:semicolon
id|pfd
(braket
id|i
)braket
dot
id|events
op_assign
id|POLLIN
suffix:semicolon
)brace
id|signal
c_func
(paren
id|SIGCHLD
comma
id|child_handler
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
id|i
suffix:semicolon
id|check_dead_children
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|poll
c_func
(paren
id|pfd
comma
id|socklist-&gt;nr
comma
l_int|1
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|errno
op_ne
id|EINTR
)paren
(brace
id|logerror
c_func
(paren
l_string|&quot;Poll failed, resuming: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|socklist-&gt;nr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pfd
(braket
id|i
)braket
dot
id|revents
op_amp
id|POLLIN
)paren
(brace
r_union
(brace
r_struct
id|sockaddr
id|sa
suffix:semicolon
r_struct
id|sockaddr_in
id|sai
suffix:semicolon
macro_line|#ifndef NO_IPV6
r_struct
id|sockaddr_in6
id|sai6
suffix:semicolon
macro_line|#endif
)brace
id|ss
suffix:semicolon
id|socklen_t
id|sslen
op_assign
r_sizeof
(paren
id|ss
)paren
suffix:semicolon
r_int
id|incoming
op_assign
id|accept
c_func
(paren
id|pfd
(braket
id|i
)braket
dot
id|fd
comma
op_amp
id|ss.sa
comma
op_amp
id|sslen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|incoming
OL
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|errno
)paren
(brace
r_case
id|EAGAIN
suffix:colon
r_case
id|EINTR
suffix:colon
r_case
id|ECONNABORTED
suffix:colon
r_continue
suffix:semicolon
r_default
suffix:colon
id|die_errno
c_func
(paren
l_string|&quot;accept returned&quot;
)paren
suffix:semicolon
)brace
)brace
id|handle
c_func
(paren
id|incoming
comma
op_amp
id|ss.sa
comma
id|sslen
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* if any standard file descriptor is missing open it to /dev/null */
DECL|function|sanitize_stdfds
r_static
r_void
id|sanitize_stdfds
c_func
(paren
r_void
)paren
(brace
r_int
id|fd
op_assign
id|open
c_func
(paren
l_string|&quot;/dev/null&quot;
comma
id|O_RDWR
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|fd
op_ne
l_int|1
op_logical_and
id|fd
OL
l_int|2
)paren
id|fd
op_assign
id|dup
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
op_eq
l_int|1
)paren
id|die_errno
c_func
(paren
l_string|&quot;open /dev/null or dup failed&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OG
l_int|2
)paren
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
)brace
macro_line|#ifdef NO_POSIX_GOODIES
r_struct
id|credentials
suffix:semicolon
DECL|function|drop_privileges
r_static
r_void
id|drop_privileges
c_func
(paren
r_struct
id|credentials
op_star
id|cred
)paren
(brace
multiline_comment|/* nothing */
)brace
DECL|function|daemonize
r_static
r_void
id|daemonize
c_func
(paren
r_void
)paren
(brace
id|die
c_func
(paren
l_string|&quot;--detach not supported on this platform&quot;
)paren
suffix:semicolon
)brace
DECL|function|prepare_credentials
r_static
r_struct
id|credentials
op_star
id|prepare_credentials
c_func
(paren
r_const
r_char
op_star
id|user_name
comma
r_const
r_char
op_star
id|group_name
)paren
(brace
id|die
c_func
(paren
l_string|&quot;--user not supported on this platform&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|struct|credentials
r_struct
id|credentials
(brace
DECL|member|pass
r_struct
id|passwd
op_star
id|pass
suffix:semicolon
DECL|member|gid
id|gid_t
id|gid
suffix:semicolon
)brace
suffix:semicolon
DECL|function|drop_privileges
r_static
r_void
id|drop_privileges
c_func
(paren
r_struct
id|credentials
op_star
id|cred
)paren
(brace
r_if
c_cond
(paren
id|cred
op_logical_and
(paren
id|initgroups
c_func
(paren
id|cred-&gt;pass-&gt;pw_name
comma
id|cred-&gt;gid
)paren
op_logical_or
id|setgid
(paren
id|cred-&gt;gid
)paren
op_logical_or
id|setuid
c_func
(paren
id|cred-&gt;pass-&gt;pw_uid
)paren
)paren
)paren
id|die
c_func
(paren
l_string|&quot;cannot drop privileges&quot;
)paren
suffix:semicolon
)brace
DECL|function|prepare_credentials
r_static
r_struct
id|credentials
op_star
id|prepare_credentials
c_func
(paren
r_const
r_char
op_star
id|user_name
comma
r_const
r_char
op_star
id|group_name
)paren
(brace
r_static
r_struct
id|credentials
id|c
suffix:semicolon
id|c.pass
op_assign
id|getpwnam
c_func
(paren
id|user_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c.pass
)paren
id|die
c_func
(paren
l_string|&quot;user not found - %s&quot;
comma
id|user_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|group_name
)paren
id|c.gid
op_assign
id|c.pass-&gt;pw_gid
suffix:semicolon
r_else
(brace
r_struct
id|group
op_star
id|group
op_assign
id|getgrnam
c_func
(paren
id|group_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|group
)paren
id|die
c_func
(paren
l_string|&quot;group not found - %s&quot;
comma
id|group_name
)paren
suffix:semicolon
id|c.gid
op_assign
id|group-&gt;gr_gid
suffix:semicolon
)brace
r_return
op_amp
id|c
suffix:semicolon
)brace
DECL|function|daemonize
r_static
r_void
id|daemonize
c_func
(paren
r_void
)paren
(brace
r_switch
c_cond
(paren
id|fork
c_func
(paren
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|die_errno
c_func
(paren
l_string|&quot;fork failed&quot;
)paren
suffix:semicolon
r_default
suffix:colon
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setsid
c_func
(paren
)paren
op_eq
l_int|1
)paren
id|die_errno
c_func
(paren
l_string|&quot;setsid failed&quot;
)paren
suffix:semicolon
id|close
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|close
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|close
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|sanitize_stdfds
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|store_pid
r_static
r_void
id|store_pid
c_func
(paren
r_const
r_char
op_star
id|path
)paren
(brace
id|FILE
op_star
id|f
op_assign
id|fopen
c_func
(paren
id|path
comma
l_string|&quot;w&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
id|die_errno
c_func
(paren
l_string|&quot;cannot open pid file &squot;%s&squot;&quot;
comma
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fprintf
c_func
(paren
id|f
comma
l_string|&quot;%&quot;
id|PRIuMAX
l_string|&quot;&bslash;n&quot;
comma
(paren
r_uintmax
)paren
id|getpid
c_func
(paren
)paren
)paren
OL
l_int|0
op_logical_or
id|fclose
c_func
(paren
id|f
)paren
op_ne
l_int|0
)paren
id|die_errno
c_func
(paren
l_string|&quot;failed to write pid file &squot;%s&squot;&quot;
comma
id|path
)paren
suffix:semicolon
)brace
DECL|function|serve
r_static
r_int
id|serve
c_func
(paren
r_struct
id|string_list
op_star
id|listen_addr
comma
r_int
id|listen_port
comma
r_struct
id|credentials
op_star
id|cred
)paren
(brace
r_struct
id|socketlist
id|socklist
op_assign
(brace
l_int|NULL
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|socksetup
c_func
(paren
id|listen_addr
comma
id|listen_port
comma
op_amp
id|socklist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socklist.nr
op_eq
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to allocate any listen sockets on port %u&quot;
comma
id|listen_port
)paren
suffix:semicolon
id|drop_privileges
c_func
(paren
id|cred
)paren
suffix:semicolon
r_return
id|service_loop
c_func
(paren
op_amp
id|socklist
)paren
suffix:semicolon
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_int
id|listen_port
op_assign
l_int|0
suffix:semicolon
r_struct
id|string_list
id|listen_addr
op_assign
id|STRING_LIST_INIT_NODUP
suffix:semicolon
r_int
id|serve_mode
op_assign
l_int|0
comma
id|inetd_mode
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|pid_file
op_assign
l_int|NULL
comma
op_star
id|user_name
op_assign
l_int|NULL
comma
op_star
id|group_name
op_assign
l_int|NULL
suffix:semicolon
r_int
id|detach
op_assign
l_int|0
suffix:semicolon
r_struct
id|credentials
op_star
id|cred
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|git_extract_argv0_path
c_func
(paren
id|argv
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|argc
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|arg
op_assign
id|argv
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--listen=&quot;
)paren
)paren
(brace
id|string_list_append
c_func
(paren
op_amp
id|listen_addr
comma
id|xstrdup_tolower
c_func
(paren
id|arg
op_plus
l_int|9
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--port=&quot;
)paren
)paren
(brace
r_char
op_star
id|end
suffix:semicolon
r_int
r_int
id|n
suffix:semicolon
id|n
op_assign
id|strtoul
c_func
(paren
id|arg
op_plus
l_int|7
comma
op_amp
id|end
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
(braket
l_int|7
)braket
op_logical_and
op_logical_neg
op_star
id|end
)paren
(brace
id|listen_port
op_assign
id|n
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--serve&quot;
)paren
)paren
(brace
id|serve_mode
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--inetd&quot;
)paren
)paren
(brace
id|inetd_mode
op_assign
l_int|1
suffix:semicolon
id|log_syslog
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--verbose&quot;
)paren
)paren
(brace
id|verbose
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--syslog&quot;
)paren
)paren
(brace
id|log_syslog
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--export-all&quot;
)paren
)paren
(brace
id|export_all_trees
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--timeout=&quot;
)paren
)paren
(brace
id|timeout
op_assign
id|atoi
c_func
(paren
id|arg
op_plus
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--init-timeout=&quot;
)paren
)paren
(brace
id|init_timeout
op_assign
id|atoi
c_func
(paren
id|arg
op_plus
l_int|15
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--max-connections=&quot;
)paren
)paren
(brace
id|max_connections
op_assign
id|atoi
c_func
(paren
id|arg
op_plus
l_int|18
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_connections
OL
l_int|0
)paren
id|max_connections
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unlimited */
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--strict-paths&quot;
)paren
)paren
(brace
id|strict_paths
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--base-path=&quot;
)paren
)paren
(brace
id|base_path
op_assign
id|arg
op_plus
l_int|12
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--base-path-relaxed&quot;
)paren
)paren
(brace
id|base_path_relaxed
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--interpolated-path=&quot;
)paren
)paren
(brace
id|interpolated_path
op_assign
id|arg
op_plus
l_int|20
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--reuseaddr&quot;
)paren
)paren
(brace
id|reuseaddr
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--user-path&quot;
)paren
)paren
(brace
id|user_path
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--user-path=&quot;
)paren
)paren
(brace
id|user_path
op_assign
id|arg
op_plus
l_int|12
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--pid-file=&quot;
)paren
)paren
(brace
id|pid_file
op_assign
id|arg
op_plus
l_int|11
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--detach&quot;
)paren
)paren
(brace
id|detach
op_assign
l_int|1
suffix:semicolon
id|log_syslog
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--user=&quot;
)paren
)paren
(brace
id|user_name
op_assign
id|arg
op_plus
l_int|7
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--group=&quot;
)paren
)paren
(brace
id|group_name
op_assign
id|arg
op_plus
l_int|8
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--enable=&quot;
)paren
)paren
(brace
id|enable_service
c_func
(paren
id|arg
op_plus
l_int|9
comma
l_int|1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--disable=&quot;
)paren
)paren
(brace
id|enable_service
c_func
(paren
id|arg
op_plus
l_int|10
comma
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--allow-override=&quot;
)paren
)paren
(brace
id|make_service_overridable
c_func
(paren
id|arg
op_plus
l_int|17
comma
l_int|1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|arg
comma
l_string|&quot;--forbid-override=&quot;
)paren
)paren
(brace
id|make_service_overridable
c_func
(paren
id|arg
op_plus
l_int|18
comma
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|arg
comma
l_string|&quot;--&quot;
)paren
)paren
(brace
id|ok_paths
op_assign
op_amp
id|argv
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|arg
(braket
l_int|0
)braket
op_ne
l_char|&squot;-&squot;
)paren
(brace
id|ok_paths
op_assign
op_amp
id|argv
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|usage
c_func
(paren
id|daemon_usage
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|log_syslog
)paren
(brace
id|openlog
c_func
(paren
l_string|&quot;git-daemon&quot;
comma
id|LOG_PID
comma
id|LOG_DAEMON
)paren
suffix:semicolon
id|set_die_routine
c_func
(paren
id|daemon_die
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* avoid splitting a message in the middle */
id|setvbuf
c_func
(paren
id|stderr
comma
l_int|NULL
comma
id|_IOFBF
comma
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inetd_mode
op_logical_and
(paren
id|detach
op_logical_or
id|group_name
op_logical_or
id|user_name
)paren
)paren
id|die
c_func
(paren
l_string|&quot;--detach, --user and --group are incompatible with --inetd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inetd_mode
op_logical_and
(paren
id|listen_port
op_logical_or
(paren
id|listen_addr.nr
OG
l_int|0
)paren
)paren
)paren
id|die
c_func
(paren
l_string|&quot;--listen= and --port= are incompatible with --inetd&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|listen_port
op_eq
l_int|0
)paren
id|listen_port
op_assign
id|DEFAULT_GIT_PORT
suffix:semicolon
r_if
c_cond
(paren
id|group_name
op_logical_and
op_logical_neg
id|user_name
)paren
id|die
c_func
(paren
l_string|&quot;--group supplied without --user&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|user_name
)paren
id|cred
op_assign
id|prepare_credentials
c_func
(paren
id|user_name
comma
id|group_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strict_paths
op_logical_and
(paren
op_logical_neg
id|ok_paths
op_logical_or
op_logical_neg
op_star
id|ok_paths
)paren
)paren
id|die
c_func
(paren
l_string|&quot;option --strict-paths requires a whitelist&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base_path
op_logical_and
op_logical_neg
id|is_directory
c_func
(paren
id|base_path
)paren
)paren
id|die
c_func
(paren
l_string|&quot;base-path &squot;%s&squot; does not exist or is not a directory&quot;
comma
id|base_path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inetd_mode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|freopen
c_func
(paren
l_string|&quot;/dev/null&quot;
comma
l_string|&quot;w&quot;
comma
id|stderr
)paren
)paren
id|die_errno
c_func
(paren
l_string|&quot;failed to redirect stderr to /dev/null&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inetd_mode
op_logical_or
id|serve_mode
)paren
r_return
id|execute
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|detach
)paren
(brace
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|loginfo
c_func
(paren
l_string|&quot;Ready to rumble&quot;
)paren
suffix:semicolon
)brace
r_else
id|sanitize_stdfds
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pid_file
)paren
id|store_pid
c_func
(paren
id|pid_file
)paren
suffix:semicolon
multiline_comment|/* prepare argv for serving-processes */
id|cld_argv
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
r_char
op_star
)paren
op_star
(paren
id|argc
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|cld_argv
(braket
l_int|0
)braket
op_assign
id|argv
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* git-daemon */
id|cld_argv
(braket
l_int|1
)braket
op_assign
l_string|&quot;--serve&quot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|argc
suffix:semicolon
op_increment
id|i
)paren
id|cld_argv
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|argv
(braket
id|i
)braket
suffix:semicolon
id|cld_argv
(braket
id|argc
op_plus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|serve
c_func
(paren
op_amp
id|listen_addr
comma
id|listen_port
comma
id|cred
)paren
suffix:semicolon
)brace
eof
