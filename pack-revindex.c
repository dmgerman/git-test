macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;pack-revindex.h&quot;
multiline_comment|/*&n; * Pack index for existing packs give us easy access to the offsets into&n; * corresponding pack file where each object&squot;s data starts, but the entries&n; * do not store the size of the compressed representation (uncompressed&n; * size is easily available by examining the pack entry header).  It is&n; * also rather expensive to find the sha1 for an object given its offset.&n; *&n; * We build a hashtable of existing packs (pack_revindex), and keep reverse&n; * index here -- pack index file is sorted by object name mapping to offset;&n; * this pack_revindex[].revindex array is a list of offset/index_nr pairs&n; * ordered by offset, so if you know the offset of an object, next offset&n; * is where its packed representation ends and the index_nr can be used to&n; * get the object sha1 from the main index.&n; */
DECL|struct|pack_revindex
r_struct
id|pack_revindex
(brace
DECL|member|p
r_struct
id|packed_git
op_star
id|p
suffix:semicolon
DECL|member|revindex
r_struct
id|revindex_entry
op_star
id|revindex
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|pack_revindex
r_static
r_struct
id|pack_revindex
op_star
id|pack_revindex
suffix:semicolon
DECL|variable|pack_revindex_hashsz
r_static
r_int
id|pack_revindex_hashsz
suffix:semicolon
DECL|function|pack_revindex_ix
r_static
r_int
id|pack_revindex_ix
c_func
(paren
r_struct
id|packed_git
op_star
id|p
)paren
(brace
r_int
r_int
id|ui
op_assign
(paren
r_int
r_int
)paren
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ui
op_assign
id|ui
op_xor
(paren
id|ui
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* defeat structure alignment */
id|i
op_assign
(paren
r_int
)paren
(paren
id|ui
op_mod
id|pack_revindex_hashsz
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pack_revindex
(braket
id|i
)braket
dot
id|p
)paren
(brace
r_if
c_cond
(paren
id|pack_revindex
(braket
id|i
)braket
dot
id|p
op_eq
id|p
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_eq
id|pack_revindex_hashsz
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
id|i
suffix:semicolon
)brace
DECL|function|init_pack_revindex
r_static
r_void
id|init_pack_revindex
c_func
(paren
r_void
)paren
(brace
r_int
id|num
suffix:semicolon
r_struct
id|packed_git
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|num
op_assign
l_int|0
comma
id|p
op_assign
id|packed_git
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
id|num
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|num
)paren
r_return
suffix:semicolon
id|pack_revindex_hashsz
op_assign
id|num
op_star
l_int|11
suffix:semicolon
id|pack_revindex
op_assign
id|xcalloc
c_func
(paren
r_sizeof
(paren
op_star
id|pack_revindex
)paren
comma
id|pack_revindex_hashsz
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|packed_git
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
id|num
op_assign
id|pack_revindex_ix
c_func
(paren
id|p
)paren
suffix:semicolon
id|num
op_assign
l_int|1
id|num
suffix:semicolon
id|pack_revindex
(braket
id|num
)braket
dot
id|p
op_assign
id|p
suffix:semicolon
)brace
multiline_comment|/* revindex elements are lazily initialized */
)brace
DECL|function|cmp_offset
r_static
r_int
id|cmp_offset
c_func
(paren
r_const
r_void
op_star
id|a_
comma
r_const
r_void
op_star
id|b_
)paren
(brace
r_const
r_struct
id|revindex_entry
op_star
id|a
op_assign
id|a_
suffix:semicolon
r_const
r_struct
id|revindex_entry
op_star
id|b
op_assign
id|b_
suffix:semicolon
r_return
(paren
id|a-&gt;offset
OL
id|b-&gt;offset
)paren
ques
c_cond
l_int|1
suffix:colon
(paren
id|a-&gt;offset
OG
id|b-&gt;offset
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Ordered list of offsets of objects in the pack.&n; */
DECL|function|create_pack_revindex
r_static
r_void
id|create_pack_revindex
c_func
(paren
r_struct
id|pack_revindex
op_star
id|rix
)paren
(brace
r_struct
id|packed_git
op_star
id|p
op_assign
id|rix-&gt;p
suffix:semicolon
r_int
id|num_ent
op_assign
id|p-&gt;num_objects
suffix:semicolon
r_int
id|i
suffix:semicolon
r_const
r_char
op_star
id|index
op_assign
id|p-&gt;index_data
suffix:semicolon
id|rix-&gt;revindex
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|rix-&gt;revindex
)paren
op_star
(paren
id|num_ent
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|index
op_add_assign
l_int|4
op_star
l_int|256
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;index_version
OG
l_int|1
)paren
(brace
r_const
r_uint32
op_star
id|off_32
op_assign
(paren
r_uint32
op_star
)paren
(paren
id|index
op_plus
l_int|8
op_plus
id|p-&gt;num_objects
op_star
(paren
l_int|20
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_const
r_uint32
op_star
id|off_64
op_assign
id|off_32
op_plus
id|p-&gt;num_objects
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ent
suffix:semicolon
id|i
op_increment
)paren
(brace
r_uint32
id|off
op_assign
id|ntohl
c_func
(paren
op_star
id|off_32
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|off
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|rix-&gt;revindex
(braket
id|i
)braket
dot
id|offset
op_assign
id|off
suffix:semicolon
)brace
r_else
(brace
id|rix-&gt;revindex
(braket
id|i
)braket
dot
id|offset
op_assign
(paren
(paren
r_uint64
)paren
id|ntohl
c_func
(paren
op_star
id|off_64
op_increment
)paren
)paren
op_lshift
l_int|32
suffix:semicolon
id|rix-&gt;revindex
(braket
id|i
)braket
dot
id|offset
op_or_assign
id|ntohl
c_func
(paren
op_star
id|off_64
op_increment
)paren
suffix:semicolon
)brace
id|rix-&gt;revindex
(braket
id|i
)braket
dot
id|nr
op_assign
id|i
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ent
suffix:semicolon
id|i
op_increment
)paren
(brace
r_uint32
id|hl
op_assign
op_star
(paren
(paren
r_uint32
op_star
)paren
(paren
id|index
op_plus
l_int|24
op_star
id|i
)paren
)paren
suffix:semicolon
id|rix-&gt;revindex
(braket
id|i
)braket
dot
id|offset
op_assign
id|ntohl
c_func
(paren
id|hl
)paren
suffix:semicolon
id|rix-&gt;revindex
(braket
id|i
)braket
dot
id|nr
op_assign
id|i
suffix:semicolon
)brace
)brace
multiline_comment|/* This knows the pack format -- the 20-byte trailer&n;&t; * follows immediately after the last object data.&n;&t; */
id|rix-&gt;revindex
(braket
id|num_ent
)braket
dot
id|offset
op_assign
id|p-&gt;pack_size
l_int|20
suffix:semicolon
id|rix-&gt;revindex
(braket
id|num_ent
)braket
dot
id|nr
op_assign
l_int|1
suffix:semicolon
id|qsort
c_func
(paren
id|rix-&gt;revindex
comma
id|num_ent
comma
r_sizeof
(paren
op_star
id|rix-&gt;revindex
)paren
comma
id|cmp_offset
)paren
suffix:semicolon
)brace
DECL|function|find_pack_revindex
r_struct
id|revindex_entry
op_star
id|find_pack_revindex
c_func
(paren
r_struct
id|packed_git
op_star
id|p
comma
id|off_t
id|ofs
)paren
(brace
r_int
id|num
suffix:semicolon
r_int
id|lo
comma
id|hi
suffix:semicolon
r_struct
id|pack_revindex
op_star
id|rix
suffix:semicolon
r_struct
id|revindex_entry
op_star
id|revindex
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pack_revindex_hashsz
)paren
id|init_pack_revindex
c_func
(paren
)paren
suffix:semicolon
id|num
op_assign
id|pack_revindex_ix
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;internal error: pack revindex fubar&quot;
)paren
suffix:semicolon
id|rix
op_assign
op_amp
id|pack_revindex
(braket
id|num
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rix-&gt;revindex
)paren
id|create_pack_revindex
c_func
(paren
id|rix
)paren
suffix:semicolon
id|revindex
op_assign
id|rix-&gt;revindex
suffix:semicolon
id|lo
op_assign
l_int|0
suffix:semicolon
id|hi
op_assign
id|p-&gt;num_objects
op_plus
l_int|1
suffix:semicolon
r_do
(brace
r_int
id|mi
op_assign
(paren
id|lo
op_plus
id|hi
)paren
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|revindex
(braket
id|mi
)braket
dot
id|offset
op_eq
id|ofs
)paren
(brace
r_return
id|revindex
op_plus
id|mi
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ofs
OL
id|revindex
(braket
id|mi
)braket
dot
id|offset
)paren
id|hi
op_assign
id|mi
suffix:semicolon
r_else
id|lo
op_assign
id|mi
op_plus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|lo
OL
id|hi
)paren
suffix:semicolon
id|die
c_func
(paren
l_string|&quot;internal error: pack revindex corrupt&quot;
)paren
suffix:semicolon
)brace
eof
