macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;pkt-line.h&quot;
macro_line|#include &quot;quote.h&quot;
macro_line|#include &lt;sys/wait.h&gt;
macro_line|#include &lt;sys/socket.h&gt;
macro_line|#include &lt;netinet/in.h&gt;
macro_line|#include &lt;arpa/inet.h&gt;
macro_line|#include &lt;netdb.h&gt;
DECL|function|get_ack
r_int
id|get_ack
c_func
(paren
r_int
id|fd
comma
r_int
r_char
op_star
id|result_sha1
)paren
(brace
r_static
r_char
id|line
(braket
l_int|1000
)braket
suffix:semicolon
r_int
id|len
op_assign
id|packet_read_line
c_func
(paren
id|fd
comma
id|line
comma
r_sizeof
(paren
id|line
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|die
c_func
(paren
l_string|&quot;git-fetch-pack: expected ACK/NAK, got EOF&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|line
(braket
op_decrement
id|len
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|line
comma
l_string|&quot;NAK&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|line
comma
l_string|&quot;ACK &quot;
comma
l_int|3
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|get_sha1_hex
c_func
(paren
id|line
op_plus
l_int|4
comma
id|result_sha1
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
id|die
c_func
(paren
l_string|&quot;git-fetch_pack: expected ACK/NAK, got &squot;%s&squot;&quot;
comma
id|line
)paren
suffix:semicolon
)brace
DECL|function|path_match
r_int
id|path_match
c_func
(paren
r_const
r_char
op_star
id|path
comma
r_int
id|nr
comma
r_char
op_star
op_star
id|match
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|pathlen
op_assign
id|strlen
c_func
(paren
id|path
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|s
op_assign
id|match
(braket
id|i
)braket
suffix:semicolon
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
op_logical_or
id|len
OG
id|pathlen
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|path
op_plus
id|pathlen
id|len
comma
id|s
comma
id|len
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pathlen
OG
id|len
op_logical_and
id|path
(braket
id|pathlen
id|len
l_int|1
)braket
op_ne
l_char|&squot;/&squot;
)paren
r_continue
suffix:semicolon
op_star
id|s
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|enum|protocol
r_enum
id|protocol
(brace
DECL|enumerator|PROTO_LOCAL
id|PROTO_LOCAL
op_assign
l_int|1
comma
DECL|enumerator|PROTO_SSH
id|PROTO_SSH
comma
DECL|enumerator|PROTO_GIT
id|PROTO_GIT
comma
)brace
suffix:semicolon
DECL|function|get_protocol
r_static
r_enum
id|protocol
id|get_protocol
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;ssh&quot;
)paren
)paren
r_return
id|PROTO_SSH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;git&quot;
)paren
)paren
r_return
id|PROTO_GIT
suffix:semicolon
id|die
c_func
(paren
l_string|&quot;I don&squot;t handle protocol &squot;%s&squot;&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|lookup_host
r_static
r_void
id|lookup_host
c_func
(paren
r_const
r_char
op_star
id|host
comma
r_struct
id|sockaddr
op_star
id|in
)paren
(brace
r_struct
id|addrinfo
op_star
id|res
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|getaddrinfo
c_func
(paren
id|host
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|die
c_func
(paren
l_string|&quot;Unable to look up %s (%s)&quot;
comma
id|host
comma
id|gai_strerror
c_func
(paren
id|ret
)paren
)paren
suffix:semicolon
op_star
id|in
op_assign
op_star
id|res-&gt;ai_addr
suffix:semicolon
id|freeaddrinfo
c_func
(paren
id|res
)paren
suffix:semicolon
)brace
DECL|function|git_tcp_connect
r_static
r_int
id|git_tcp_connect
c_func
(paren
r_int
id|fd
(braket
l_int|2
)braket
comma
r_const
r_char
op_star
id|prog
comma
r_char
op_star
id|host
comma
r_char
op_star
id|path
)paren
(brace
r_struct
id|sockaddr
id|addr
suffix:semicolon
r_int
id|port
op_assign
id|DEFAULT_GIT_PORT
comma
id|sockfd
suffix:semicolon
r_char
op_star
id|colon
suffix:semicolon
id|colon
op_assign
id|strchr
c_func
(paren
id|host
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|colon
)paren
(brace
r_char
op_star
id|end
suffix:semicolon
r_int
r_int
id|n
op_assign
id|strtoul
c_func
(paren
id|colon
op_plus
l_int|1
comma
op_amp
id|end
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|colon
(braket
l_int|1
)braket
op_logical_and
op_logical_neg
op_star
id|end
)paren
(brace
op_star
id|colon
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
id|n
suffix:semicolon
)brace
)brace
id|lookup_host
c_func
(paren
id|host
comma
op_amp
id|addr
)paren
suffix:semicolon
(paren
(paren
r_struct
id|sockaddr_in
op_star
)paren
op_amp
id|addr
)paren
op_member_access_from_pointer
id|sin_port
op_assign
id|htons
c_func
(paren
id|port
)paren
suffix:semicolon
id|sockfd
op_assign
id|socket
c_func
(paren
id|PF_INET
comma
id|SOCK_STREAM
comma
id|IPPROTO_IP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockfd
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to create socket (%s)&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|connect
c_func
(paren
id|sockfd
comma
(paren
r_void
op_star
)paren
op_amp
id|addr
comma
r_sizeof
(paren
id|addr
)paren
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to connect (%s)&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|fd
(braket
l_int|0
)braket
op_assign
id|sockfd
suffix:semicolon
id|fd
(braket
l_int|1
)braket
op_assign
id|sockfd
suffix:semicolon
id|packet_write
c_func
(paren
id|sockfd
comma
l_string|&quot;%s %s&bslash;n&quot;
comma
id|prog
comma
id|path
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Yeah, yeah, fixme. Need to pass in the heads etc.&n; */
DECL|function|git_connect
r_int
id|git_connect
c_func
(paren
r_int
id|fd
(braket
l_int|2
)braket
comma
r_char
op_star
id|url
comma
r_const
r_char
op_star
id|prog
)paren
(brace
r_char
id|command
(braket
l_int|1024
)braket
suffix:semicolon
r_char
op_star
id|host
comma
op_star
id|path
suffix:semicolon
r_char
op_star
id|colon
suffix:semicolon
r_int
id|pipefd
(braket
l_int|2
)braket
(braket
l_int|2
)braket
suffix:semicolon
id|pid_t
id|pid
suffix:semicolon
r_enum
id|protocol
id|protocol
suffix:semicolon
id|host
op_assign
l_int|NULL
suffix:semicolon
id|path
op_assign
id|url
suffix:semicolon
id|colon
op_assign
id|strchr
c_func
(paren
id|url
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|protocol
op_assign
id|PROTO_LOCAL
suffix:semicolon
r_if
c_cond
(paren
id|colon
)paren
(brace
op_star
id|colon
op_assign
l_int|0
suffix:semicolon
id|host
op_assign
id|url
suffix:semicolon
id|path
op_assign
id|colon
op_plus
l_int|1
suffix:semicolon
id|protocol
op_assign
id|PROTO_SSH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|path
comma
l_string|&quot;//&quot;
comma
l_int|2
)paren
)paren
(brace
r_char
op_star
id|slash
op_assign
id|strchr
c_func
(paren
id|path
op_plus
l_int|2
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slash
)paren
(brace
r_int
id|nr
op_assign
id|slash
id|path
l_int|2
suffix:semicolon
id|memmove
c_func
(paren
id|path
comma
id|path
op_plus
l_int|2
comma
id|nr
)paren
suffix:semicolon
id|path
(braket
id|nr
)braket
op_assign
l_int|0
suffix:semicolon
id|protocol
op_assign
id|get_protocol
c_func
(paren
id|url
)paren
suffix:semicolon
id|host
op_assign
id|path
suffix:semicolon
id|path
op_assign
id|slash
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|protocol
op_eq
id|PROTO_GIT
)paren
r_return
id|git_tcp_connect
c_func
(paren
id|fd
comma
id|prog
comma
id|host
comma
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pipe
c_func
(paren
id|pipefd
(braket
l_int|0
)braket
)paren
OL
l_int|0
op_logical_or
id|pipe
c_func
(paren
id|pipefd
(braket
l_int|1
)braket
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to create pipe pair for communication&quot;
)paren
suffix:semicolon
id|pid
op_assign
id|fork
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pid
)paren
(brace
id|snprintf
c_func
(paren
id|command
comma
r_sizeof
(paren
id|command
)paren
comma
l_string|&quot;%s %s&quot;
comma
id|prog
comma
id|sq_quote
c_func
(paren
id|path
)paren
)paren
suffix:semicolon
id|dup2
c_func
(paren
id|pipefd
(braket
l_int|1
)braket
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|dup2
c_func
(paren
id|pipefd
(braket
l_int|0
)braket
(braket
l_int|1
)braket
comma
l_int|1
)paren
suffix:semicolon
id|close
c_func
(paren
id|pipefd
(braket
l_int|0
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|close
c_func
(paren
id|pipefd
(braket
l_int|0
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|close
c_func
(paren
id|pipefd
(braket
l_int|1
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|close
c_func
(paren
id|pipefd
(braket
l_int|1
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|protocol
op_eq
id|PROTO_SSH
)paren
id|execlp
c_func
(paren
l_string|&quot;ssh&quot;
comma
l_string|&quot;ssh&quot;
comma
id|host
comma
id|command
comma
l_int|NULL
)paren
suffix:semicolon
r_else
id|execlp
c_func
(paren
l_string|&quot;sh&quot;
comma
l_string|&quot;sh&quot;
comma
l_string|&quot;-c&quot;
comma
id|command
comma
l_int|NULL
)paren
suffix:semicolon
id|die
c_func
(paren
l_string|&quot;exec failed&quot;
)paren
suffix:semicolon
)brace
id|fd
(braket
l_int|0
)braket
op_assign
id|pipefd
(braket
l_int|0
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|fd
(braket
l_int|1
)braket
op_assign
id|pipefd
(braket
l_int|1
)braket
(braket
l_int|1
)braket
suffix:semicolon
id|close
c_func
(paren
id|pipefd
(braket
l_int|0
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|close
c_func
(paren
id|pipefd
(braket
l_int|1
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|pid
suffix:semicolon
)brace
DECL|function|finish_connect
r_int
id|finish_connect
c_func
(paren
id|pid_t
id|pid
)paren
(brace
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|ret
op_assign
id|waitpid
c_func
(paren
id|pid
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|errno
op_ne
id|EINTR
)paren
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
eof
