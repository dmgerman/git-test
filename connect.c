macro_line|#include &quot;git-compat-util.h&quot;
macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;pkt-line.h&quot;
macro_line|#include &quot;quote.h&quot;
macro_line|#include &quot;refs.h&quot;
macro_line|#include &quot;run-command.h&quot;
macro_line|#include &quot;remote.h&quot;
macro_line|#include &quot;connect.h&quot;
macro_line|#include &quot;url.h&quot;
macro_line|#include &quot;string-list.h&quot;
macro_line|#include &quot;sha1-array.h&quot;
DECL|variable|server_capabilities
r_static
r_char
op_star
id|server_capabilities
suffix:semicolon
r_static
r_const
r_char
op_star
id|parse_feature_value
c_func
(paren
r_const
r_char
op_star
comma
r_const
r_char
op_star
comma
r_int
op_star
)paren
suffix:semicolon
DECL|function|check_ref
r_static
r_int
id|check_ref
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|flags
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skip_prefix
c_func
(paren
id|name
comma
l_string|&quot;refs/&quot;
comma
op_amp
id|name
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* REF_NORMAL means that we don&squot;t want the magic fake tag refs */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|REF_NORMAL
)paren
op_logical_and
id|check_refname_format
c_func
(paren
id|name
comma
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* REF_HEADS means that we want regular branch heads */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|REF_HEADS
)paren
op_logical_and
id|starts_with
c_func
(paren
id|name
comma
l_string|&quot;heads/&quot;
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* REF_TAGS means that we want tags */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|REF_TAGS
)paren
op_logical_and
id|starts_with
c_func
(paren
id|name
comma
l_string|&quot;tags/&quot;
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* All type bits clear means that we are ok with anything */
r_return
op_logical_neg
(paren
id|flags
op_amp
op_complement
id|REF_NORMAL
)paren
suffix:semicolon
)brace
DECL|function|check_ref_type
r_int
id|check_ref_type
c_func
(paren
r_const
r_struct
id|ref
op_star
id|ref
comma
r_int
id|flags
)paren
(brace
r_return
id|check_ref
c_func
(paren
id|ref-&gt;name
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|die_initial_contact
r_static
r_void
id|die_initial_contact
c_func
(paren
r_int
id|got_at_least_one_head
)paren
(brace
r_if
c_cond
(paren
id|got_at_least_one_head
)paren
id|die
c_func
(paren
l_string|&quot;The remote end hung up upon initial contact&quot;
)paren
suffix:semicolon
r_else
id|die
c_func
(paren
l_string|&quot;Could not read from remote repository.&bslash;n&bslash;n&quot;
l_string|&quot;Please make sure you have the correct access rights&bslash;n&quot;
l_string|&quot;and the repository exists.&quot;
)paren
suffix:semicolon
)brace
DECL|function|parse_one_symref_info
r_static
r_void
id|parse_one_symref_info
c_func
(paren
r_struct
id|string_list
op_star
id|symref
comma
r_const
r_char
op_star
id|val
comma
r_int
id|len
)paren
(brace
r_char
op_star
id|sym
comma
op_star
id|target
suffix:semicolon
r_struct
id|string_list_item
op_star
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
suffix:semicolon
multiline_comment|/* just &quot;symref&quot; */
multiline_comment|/* e.g. &quot;symref=HEAD:refs/heads/master&quot; */
id|sym
op_assign
id|xmemdupz
c_func
(paren
id|val
comma
id|len
)paren
suffix:semicolon
id|target
op_assign
id|strchr
c_func
(paren
id|sym
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|target
)paren
multiline_comment|/* just &quot;symref=something&quot; */
r_goto
id|reject
suffix:semicolon
op_star
(paren
id|target
op_increment
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|check_refname_format
c_func
(paren
id|sym
comma
id|REFNAME_ALLOW_ONELEVEL
)paren
op_logical_or
id|check_refname_format
c_func
(paren
id|target
comma
id|REFNAME_ALLOW_ONELEVEL
)paren
)paren
multiline_comment|/* &quot;symref=bogus:pair */
r_goto
id|reject
suffix:semicolon
id|item
op_assign
id|string_list_append
c_func
(paren
id|symref
comma
id|sym
)paren
suffix:semicolon
id|item-&gt;util
op_assign
id|target
suffix:semicolon
r_return
suffix:semicolon
id|reject
suffix:colon
id|free
c_func
(paren
id|sym
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|annotate_refs_with_symref_info
r_static
r_void
id|annotate_refs_with_symref_info
c_func
(paren
r_struct
id|ref
op_star
id|ref
)paren
(brace
r_struct
id|string_list
id|symref
op_assign
id|STRING_LIST_INIT_DUP
suffix:semicolon
r_const
r_char
op_star
id|feature_list
op_assign
id|server_capabilities
suffix:semicolon
r_while
c_loop
(paren
id|feature_list
)paren
(brace
r_int
id|len
suffix:semicolon
r_const
r_char
op_star
id|val
suffix:semicolon
id|val
op_assign
id|parse_feature_value
c_func
(paren
id|feature_list
comma
l_string|&quot;symref&quot;
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
r_break
suffix:semicolon
id|parse_one_symref_info
c_func
(paren
op_amp
id|symref
comma
id|val
comma
id|len
)paren
suffix:semicolon
id|feature_list
op_assign
id|val
op_plus
l_int|1
suffix:semicolon
)brace
id|string_list_sort
c_func
(paren
op_amp
id|symref
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|ref
suffix:semicolon
id|ref
op_assign
id|ref-&gt;next
)paren
(brace
r_struct
id|string_list_item
op_star
id|item
suffix:semicolon
id|item
op_assign
id|string_list_lookup
c_func
(paren
op_amp
id|symref
comma
id|ref-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_continue
suffix:semicolon
id|ref-&gt;symref
op_assign
id|xstrdup
c_func
(paren
(paren
r_char
op_star
)paren
id|item-&gt;util
)paren
suffix:semicolon
)brace
id|string_list_clear
c_func
(paren
op_amp
id|symref
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read all the refs from the other end&n; */
DECL|function|get_remote_heads
r_struct
id|ref
op_star
op_star
id|get_remote_heads
c_func
(paren
r_int
id|in
comma
r_char
op_star
id|src_buf
comma
r_int
id|src_len
comma
r_struct
id|ref
op_star
op_star
id|list
comma
r_int
r_int
id|flags
comma
r_struct
id|sha1_array
op_star
id|extra_have
comma
r_struct
id|sha1_array
op_star
id|shallow_points
)paren
(brace
r_struct
id|ref
op_star
op_star
id|orig_list
op_assign
id|list
suffix:semicolon
r_int
id|got_at_least_one_head
op_assign
l_int|0
suffix:semicolon
op_star
id|list
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|ref
op_star
id|ref
suffix:semicolon
r_int
r_char
id|old_sha1
(braket
l_int|20
)braket
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|len
comma
id|name_len
suffix:semicolon
r_char
op_star
id|buffer
op_assign
id|packet_buffer
suffix:semicolon
r_const
r_char
op_star
id|arg
suffix:semicolon
id|len
op_assign
id|packet_read
c_func
(paren
id|in
comma
op_amp
id|src_buf
comma
op_amp
id|src_len
comma
id|packet_buffer
comma
r_sizeof
(paren
id|packet_buffer
)paren
comma
id|PACKET_READ_GENTLE_ON_EOF
op_or
id|PACKET_READ_CHOMP_NEWLINE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|die_initial_contact
c_func
(paren
id|got_at_least_one_head
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|4
op_logical_and
id|skip_prefix
c_func
(paren
id|buffer
comma
l_string|&quot;ERR &quot;
comma
op_amp
id|arg
)paren
)paren
id|die
c_func
(paren
l_string|&quot;remote error: %s&quot;
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|48
op_logical_and
id|skip_prefix
c_func
(paren
id|buffer
comma
l_string|&quot;shallow &quot;
comma
op_amp
id|arg
)paren
)paren
(brace
r_if
c_cond
(paren
id|get_sha1_hex
c_func
(paren
id|arg
comma
id|old_sha1
)paren
)paren
id|die
c_func
(paren
l_string|&quot;protocol error: expected shallow sha-1, got &squot;%s&squot;&quot;
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shallow_points
)paren
id|die
c_func
(paren
l_string|&quot;repository on the other end cannot be shallow&quot;
)paren
suffix:semicolon
id|sha1_array_append
c_func
(paren
id|shallow_points
comma
id|old_sha1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|42
op_logical_or
id|get_sha1_hex
c_func
(paren
id|buffer
comma
id|old_sha1
)paren
op_logical_or
id|buffer
(braket
l_int|40
)braket
op_ne
l_char|&squot; &squot;
)paren
id|die
c_func
(paren
l_string|&quot;protocol error: expected sha/ref, got &squot;%s&squot;&quot;
comma
id|buffer
)paren
suffix:semicolon
id|name
op_assign
id|buffer
op_plus
l_int|41
suffix:semicolon
id|name_len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|name_len
op_plus
l_int|41
)paren
(brace
id|free
c_func
(paren
id|server_capabilities
)paren
suffix:semicolon
id|server_capabilities
op_assign
id|xstrdup
c_func
(paren
id|name
op_plus
id|name_len
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|extra_have
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;.have&quot;
)paren
)paren
(brace
id|sha1_array_append
c_func
(paren
id|extra_have
comma
id|old_sha1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|check_ref
c_func
(paren
id|name
comma
id|flags
)paren
)paren
r_continue
suffix:semicolon
id|ref
op_assign
id|alloc_ref
c_func
(paren
id|buffer
op_plus
l_int|41
)paren
suffix:semicolon
id|hashcpy
c_func
(paren
id|ref-&gt;old_sha1
comma
id|old_sha1
)paren
suffix:semicolon
op_star
id|list
op_assign
id|ref
suffix:semicolon
id|list
op_assign
op_amp
id|ref-&gt;next
suffix:semicolon
id|got_at_least_one_head
op_assign
l_int|1
suffix:semicolon
)brace
id|annotate_refs_with_symref_info
c_func
(paren
op_star
id|orig_list
)paren
suffix:semicolon
r_return
id|list
suffix:semicolon
)brace
DECL|function|parse_feature_value
r_static
r_const
r_char
op_star
id|parse_feature_value
c_func
(paren
r_const
r_char
op_star
id|feature_list
comma
r_const
r_char
op_star
id|feature
comma
r_int
op_star
id|lenp
)paren
(brace
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|feature_list
)paren
r_return
l_int|NULL
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|feature
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|feature_list
)paren
(brace
r_const
r_char
op_star
id|found
op_assign
id|strstr
c_func
(paren
id|feature_list
comma
id|feature
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|feature_list
op_eq
id|found
op_logical_or
id|isspace
c_func
(paren
id|found
(braket
l_int|1
)braket
)paren
)paren
(brace
r_const
r_char
op_star
id|value
op_assign
id|found
op_plus
id|len
suffix:semicolon
multiline_comment|/* feature with no value (e.g., &quot;thin-pack&quot;) */
r_if
c_cond
(paren
op_logical_neg
op_star
id|value
op_logical_or
id|isspace
c_func
(paren
op_star
id|value
)paren
)paren
(brace
r_if
c_cond
(paren
id|lenp
)paren
op_star
id|lenp
op_assign
l_int|0
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/* feature with a value (e.g., &quot;agent=git/1.2.3&quot;) */
r_else
r_if
c_cond
(paren
op_star
id|value
op_eq
l_char|&squot;=&squot;
)paren
(brace
id|value
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lenp
)paren
op_star
id|lenp
op_assign
id|strcspn
c_func
(paren
id|value
comma
l_string|&quot; &bslash;t&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * otherwise we matched a substring of another feature;&n;&t;&t;&t; * keep looking&n;&t;&t;&t; */
)brace
id|feature_list
op_assign
id|found
op_plus
l_int|1
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|parse_feature_request
r_int
id|parse_feature_request
c_func
(paren
r_const
r_char
op_star
id|feature_list
comma
r_const
r_char
op_star
id|feature
)paren
(brace
r_return
op_logical_neg
op_logical_neg
id|parse_feature_value
c_func
(paren
id|feature_list
comma
id|feature
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|server_feature_value
r_const
r_char
op_star
id|server_feature_value
c_func
(paren
r_const
r_char
op_star
id|feature
comma
r_int
op_star
id|len
)paren
(brace
r_return
id|parse_feature_value
c_func
(paren
id|server_capabilities
comma
id|feature
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|server_supports
r_int
id|server_supports
c_func
(paren
r_const
r_char
op_star
id|feature
)paren
(brace
r_return
op_logical_neg
op_logical_neg
id|server_feature_value
c_func
(paren
id|feature
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|enum|protocol
r_enum
id|protocol
(brace
DECL|enumerator|PROTO_LOCAL
id|PROTO_LOCAL
op_assign
l_int|1
comma
DECL|enumerator|PROTO_FILE
id|PROTO_FILE
comma
DECL|enumerator|PROTO_SSH
id|PROTO_SSH
comma
DECL|enumerator|PROTO_GIT
id|PROTO_GIT
)brace
suffix:semicolon
DECL|function|url_is_local_not_ssh
r_int
id|url_is_local_not_ssh
c_func
(paren
r_const
r_char
op_star
id|url
)paren
(brace
r_const
r_char
op_star
id|colon
op_assign
id|strchr
c_func
(paren
id|url
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_const
r_char
op_star
id|slash
op_assign
id|strchr
c_func
(paren
id|url
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_return
op_logical_neg
id|colon
op_logical_or
(paren
id|slash
op_logical_and
id|slash
OL
id|colon
)paren
op_logical_or
id|has_dos_drive_prefix
c_func
(paren
id|url
)paren
suffix:semicolon
)brace
DECL|function|prot_name
r_static
r_const
r_char
op_star
id|prot_name
c_func
(paren
r_enum
id|protocol
id|protocol
)paren
(brace
r_switch
c_cond
(paren
id|protocol
)paren
(brace
r_case
id|PROTO_LOCAL
suffix:colon
r_case
id|PROTO_FILE
suffix:colon
r_return
l_string|&quot;file&quot;
suffix:semicolon
r_case
id|PROTO_SSH
suffix:colon
r_return
l_string|&quot;ssh&quot;
suffix:semicolon
r_case
id|PROTO_GIT
suffix:colon
r_return
l_string|&quot;git&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;unkown protocol&quot;
suffix:semicolon
)brace
)brace
DECL|function|get_protocol
r_static
r_enum
id|protocol
id|get_protocol
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;ssh&quot;
)paren
)paren
r_return
id|PROTO_SSH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;git&quot;
)paren
)paren
r_return
id|PROTO_GIT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;git+ssh&quot;
)paren
)paren
r_return
id|PROTO_SSH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;ssh+git&quot;
)paren
)paren
r_return
id|PROTO_SSH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;file&quot;
)paren
)paren
r_return
id|PROTO_FILE
suffix:semicolon
id|die
c_func
(paren
l_string|&quot;I don&squot;t handle protocol &squot;%s&squot;&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|host_end
r_static
r_char
op_star
id|host_end
c_func
(paren
r_char
op_star
op_star
id|hoststart
comma
r_int
id|removebrackets
)paren
(brace
r_char
op_star
id|host
op_assign
op_star
id|hoststart
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_char
op_star
id|start
op_assign
id|strstr
c_func
(paren
id|host
comma
l_string|&quot;@[&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start
)paren
id|start
op_increment
suffix:semicolon
multiline_comment|/* Jump over &squot;@&squot; */
r_else
id|start
op_assign
id|host
suffix:semicolon
r_if
c_cond
(paren
id|start
(braket
l_int|0
)braket
op_eq
l_char|&squot;[&squot;
)paren
(brace
id|end
op_assign
id|strchr
c_func
(paren
id|start
op_plus
l_int|1
comma
l_char|&squot;]&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
)paren
(brace
r_if
c_cond
(paren
id|removebrackets
)paren
(brace
op_star
id|end
op_assign
l_int|0
suffix:semicolon
id|memmove
c_func
(paren
id|start
comma
id|start
op_plus
l_int|1
comma
id|end
id|start
)paren
suffix:semicolon
id|end
op_increment
suffix:semicolon
)brace
)brace
r_else
id|end
op_assign
id|host
suffix:semicolon
)brace
r_else
id|end
op_assign
id|host
suffix:semicolon
r_return
id|end
suffix:semicolon
)brace
DECL|macro|STR_
mdefine_line|#define STR_(s)&t;# s
DECL|macro|STR
mdefine_line|#define STR(s)&t;STR_(s)
DECL|function|get_host_and_port
r_static
r_void
id|get_host_and_port
c_func
(paren
r_char
op_star
op_star
id|host
comma
r_const
r_char
op_star
op_star
id|port
)paren
(brace
r_char
op_star
id|colon
comma
op_star
id|end
suffix:semicolon
id|end
op_assign
id|host_end
c_func
(paren
id|host
comma
l_int|1
)paren
suffix:semicolon
id|colon
op_assign
id|strchr
c_func
(paren
id|end
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|colon
)paren
(brace
r_int
id|portnr
op_assign
id|strtol
c_func
(paren
id|colon
op_plus
l_int|1
comma
op_amp
id|end
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_ne
id|colon
op_plus
l_int|1
op_logical_and
op_star
id|end
op_eq
l_char|&squot;&bslash;0&squot;
op_logical_and
l_int|0
op_le
id|portnr
op_logical_and
id|portnr
OL
l_int|65536
)paren
(brace
op_star
id|colon
op_assign
l_int|0
suffix:semicolon
op_star
id|port
op_assign
id|colon
op_plus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|colon
(braket
l_int|1
)braket
)paren
(brace
op_star
id|colon
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|function|enable_keepalive
r_static
r_void
id|enable_keepalive
c_func
(paren
r_int
id|sockfd
)paren
(brace
r_int
id|ka
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|setsockopt
c_func
(paren
id|sockfd
comma
id|SOL_SOCKET
comma
id|SO_KEEPALIVE
comma
op_amp
id|ka
comma
r_sizeof
(paren
id|ka
)paren
)paren
OL
l_int|0
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;unable to set SO_KEEPALIVE on socket: %s&bslash;n&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_IPV6
DECL|function|ai_name
r_static
r_const
r_char
op_star
id|ai_name
c_func
(paren
r_const
r_struct
id|addrinfo
op_star
id|ai
)paren
(brace
r_static
r_char
id|addr
(braket
id|NI_MAXHOST
)braket
suffix:semicolon
r_if
c_cond
(paren
id|getnameinfo
c_func
(paren
id|ai-&gt;ai_addr
comma
id|ai-&gt;ai_addrlen
comma
id|addr
comma
r_sizeof
(paren
id|addr
)paren
comma
l_int|NULL
comma
l_int|0
comma
id|NI_NUMERICHOST
)paren
op_ne
l_int|0
)paren
id|strcpy
c_func
(paren
id|addr
comma
l_string|&quot;(unknown)&quot;
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns a connected socket() fd, or else die()s.&n; */
DECL|function|git_tcp_connect_sock
r_static
r_int
id|git_tcp_connect_sock
c_func
(paren
r_char
op_star
id|host
comma
r_int
id|flags
)paren
(brace
r_struct
id|strbuf
id|error_message
op_assign
id|STRBUF_INIT
suffix:semicolon
r_int
id|sockfd
op_assign
l_int|1
suffix:semicolon
r_const
r_char
op_star
id|port
op_assign
id|STR
c_func
(paren
id|DEFAULT_GIT_PORT
)paren
suffix:semicolon
r_struct
id|addrinfo
id|hints
comma
op_star
id|ai0
comma
op_star
id|ai
suffix:semicolon
r_int
id|gai
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|get_host_and_port
c_func
(paren
op_amp
id|host
comma
op_amp
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|port
)paren
id|port
op_assign
l_string|&quot;&lt;none&gt;&quot;
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hints
comma
l_int|0
comma
r_sizeof
(paren
id|hints
)paren
)paren
suffix:semicolon
id|hints.ai_socktype
op_assign
id|SOCK_STREAM
suffix:semicolon
id|hints.ai_protocol
op_assign
id|IPPROTO_TCP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Looking up %s ... &quot;
comma
id|host
)paren
suffix:semicolon
id|gai
op_assign
id|getaddrinfo
c_func
(paren
id|host
comma
id|port
comma
op_amp
id|hints
comma
op_amp
id|ai
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gai
)paren
id|die
c_func
(paren
l_string|&quot;Unable to look up %s (port %s) (%s)&quot;
comma
id|host
comma
id|port
comma
id|gai_strerror
c_func
(paren
id|gai
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;done.&bslash;nConnecting to %s (port %s) ... &quot;
comma
id|host
comma
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ai0
op_assign
id|ai
suffix:semicolon
id|ai
suffix:semicolon
id|ai
op_assign
id|ai-&gt;ai_next
comma
id|cnt
op_increment
)paren
(brace
id|sockfd
op_assign
id|socket
c_func
(paren
id|ai-&gt;ai_family
comma
id|ai-&gt;ai_socktype
comma
id|ai-&gt;ai_protocol
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sockfd
OL
l_int|0
)paren
op_logical_or
(paren
id|connect
c_func
(paren
id|sockfd
comma
id|ai-&gt;ai_addr
comma
id|ai-&gt;ai_addrlen
)paren
OL
l_int|0
)paren
)paren
(brace
id|strbuf_addf
c_func
(paren
op_amp
id|error_message
comma
l_string|&quot;%s[%d: %s]: errno=%s&bslash;n&quot;
comma
id|host
comma
id|cnt
comma
id|ai_name
c_func
(paren
id|ai
)paren
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_le
id|sockfd
)paren
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
id|sockfd
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s &quot;
comma
id|ai_name
c_func
(paren
id|ai
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|freeaddrinfo
c_func
(paren
id|ai0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockfd
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to connect to %s:&bslash;n%s&quot;
comma
id|host
comma
id|error_message.buf
)paren
suffix:semicolon
id|enable_keepalive
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|error_message
)paren
suffix:semicolon
r_return
id|sockfd
suffix:semicolon
)brace
macro_line|#else /* NO_IPV6 */
multiline_comment|/*&n; * Returns a connected socket() fd, or else die()s.&n; */
DECL|function|git_tcp_connect_sock
r_static
r_int
id|git_tcp_connect_sock
c_func
(paren
r_char
op_star
id|host
comma
r_int
id|flags
)paren
(brace
r_struct
id|strbuf
id|error_message
op_assign
id|STRBUF_INIT
suffix:semicolon
r_int
id|sockfd
op_assign
l_int|1
suffix:semicolon
r_const
r_char
op_star
id|port
op_assign
id|STR
c_func
(paren
id|DEFAULT_GIT_PORT
)paren
suffix:semicolon
r_char
op_star
id|ep
suffix:semicolon
r_struct
id|hostent
op_star
id|he
suffix:semicolon
r_struct
id|sockaddr_in
id|sa
suffix:semicolon
r_char
op_star
op_star
id|ap
suffix:semicolon
r_int
r_int
id|nport
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|get_host_and_port
c_func
(paren
op_amp
id|host
comma
op_amp
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Looking up %s ... &quot;
comma
id|host
)paren
suffix:semicolon
id|he
op_assign
id|gethostbyname
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|he
)paren
id|die
c_func
(paren
l_string|&quot;Unable to look up %s (%s)&quot;
comma
id|host
comma
id|hstrerror
c_func
(paren
id|h_errno
)paren
)paren
suffix:semicolon
id|nport
op_assign
id|strtoul
c_func
(paren
id|port
comma
op_amp
id|ep
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_eq
id|port
op_logical_or
op_star
id|ep
)paren
(brace
multiline_comment|/* Not numeric */
r_struct
id|servent
op_star
id|se
op_assign
id|getservbyname
c_func
(paren
id|port
comma
l_string|&quot;tcp&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|se
)paren
id|die
c_func
(paren
l_string|&quot;Unknown port %s&quot;
comma
id|port
)paren
suffix:semicolon
id|nport
op_assign
id|se-&gt;s_port
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;done.&bslash;nConnecting to %s (port %s) ... &quot;
comma
id|host
comma
id|port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
comma
id|ap
op_assign
id|he-&gt;h_addr_list
suffix:semicolon
op_star
id|ap
suffix:semicolon
id|ap
op_increment
comma
id|cnt
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|sa
comma
l_int|0
comma
r_sizeof
id|sa
)paren
suffix:semicolon
id|sa.sin_family
op_assign
id|he-&gt;h_addrtype
suffix:semicolon
id|sa.sin_port
op_assign
id|htons
c_func
(paren
id|nport
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sa.sin_addr
comma
op_star
id|ap
comma
id|he-&gt;h_length
)paren
suffix:semicolon
id|sockfd
op_assign
id|socket
c_func
(paren
id|he-&gt;h_addrtype
comma
id|SOCK_STREAM
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sockfd
OL
l_int|0
)paren
op_logical_or
id|connect
c_func
(paren
id|sockfd
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sa
comma
r_sizeof
id|sa
)paren
OL
l_int|0
)paren
(brace
id|strbuf_addf
c_func
(paren
op_amp
id|error_message
comma
l_string|&quot;%s[%d: %s]: errno=%s&bslash;n&quot;
comma
id|host
comma
id|cnt
comma
id|inet_ntoa
c_func
(paren
op_star
(paren
r_struct
id|in_addr
op_star
)paren
op_amp
id|sa.sin_addr
)paren
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_le
id|sockfd
)paren
id|close
c_func
(paren
id|sockfd
)paren
suffix:semicolon
id|sockfd
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;%s &quot;
comma
id|inet_ntoa
c_func
(paren
op_star
(paren
r_struct
id|in_addr
op_star
)paren
op_amp
id|sa.sin_addr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sockfd
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to connect to %s:&bslash;n%s&quot;
comma
id|host
comma
id|error_message.buf
)paren
suffix:semicolon
id|enable_keepalive
c_func
(paren
id|sockfd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_VERBOSE
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|sockfd
suffix:semicolon
)brace
macro_line|#endif /* NO_IPV6 */
DECL|function|git_tcp_connect
r_static
r_void
id|git_tcp_connect
c_func
(paren
r_int
id|fd
(braket
l_int|2
)braket
comma
r_char
op_star
id|host
comma
r_int
id|flags
)paren
(brace
r_int
id|sockfd
op_assign
id|git_tcp_connect_sock
c_func
(paren
id|host
comma
id|flags
)paren
suffix:semicolon
id|fd
(braket
l_int|0
)braket
op_assign
id|sockfd
suffix:semicolon
id|fd
(braket
l_int|1
)braket
op_assign
id|dup
c_func
(paren
id|sockfd
)paren
suffix:semicolon
)brace
DECL|variable|git_proxy_command
r_static
r_char
op_star
id|git_proxy_command
suffix:semicolon
DECL|function|git_proxy_command_options
r_static
r_int
id|git_proxy_command_options
c_func
(paren
r_const
r_char
op_star
id|var
comma
r_const
r_char
op_star
id|value
comma
r_void
op_star
id|cb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|var
comma
l_string|&quot;core.gitproxy&quot;
)paren
)paren
(brace
r_const
r_char
op_star
id|for_pos
suffix:semicolon
r_int
id|matchlen
op_assign
l_int|1
suffix:semicolon
r_int
id|hostlen
suffix:semicolon
r_const
r_char
op_star
id|rhost_name
op_assign
id|cb
suffix:semicolon
r_int
id|rhost_len
op_assign
id|strlen
c_func
(paren
id|rhost_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|git_proxy_command
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
r_return
id|config_error_nonbool
c_func
(paren
id|var
)paren
suffix:semicolon
multiline_comment|/* [core]&n;&t;&t; * ;# matches www.kernel.org as well&n;&t;&t; * gitproxy = netcatter-1 for kernel.org&n;&t;&t; * gitproxy = netcatter-2 for sample.xz&n;&t;&t; * gitproxy = netcatter-default&n;&t;&t; */
id|for_pos
op_assign
id|strstr
c_func
(paren
id|value
comma
l_string|&quot; for &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|for_pos
)paren
multiline_comment|/* matches everybody */
id|matchlen
op_assign
id|strlen
c_func
(paren
id|value
)paren
suffix:semicolon
r_else
(brace
id|hostlen
op_assign
id|strlen
c_func
(paren
id|for_pos
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rhost_len
OL
id|hostlen
)paren
id|matchlen
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|for_pos
op_plus
l_int|5
comma
id|rhost_name
op_plus
id|rhost_len
id|hostlen
comma
id|hostlen
)paren
op_logical_and
(paren
(paren
id|rhost_len
op_eq
id|hostlen
)paren
op_logical_or
id|rhost_name
(braket
id|rhost_len
id|hostlen
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
)paren
id|matchlen
op_assign
id|for_pos
id|value
suffix:semicolon
r_else
id|matchlen
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_le
id|matchlen
)paren
(brace
multiline_comment|/* core.gitproxy = none for kernel.org */
r_if
c_cond
(paren
id|matchlen
op_eq
l_int|4
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
id|value
comma
l_string|&quot;none&quot;
comma
l_int|4
)paren
)paren
id|matchlen
op_assign
l_int|0
suffix:semicolon
id|git_proxy_command
op_assign
id|xmemdupz
c_func
(paren
id|value
comma
id|matchlen
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|git_default_config
c_func
(paren
id|var
comma
id|value
comma
id|cb
)paren
suffix:semicolon
)brace
DECL|function|git_use_proxy
r_static
r_int
id|git_use_proxy
c_func
(paren
r_const
r_char
op_star
id|host
)paren
(brace
id|git_proxy_command
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_PROXY_COMMAND&quot;
)paren
suffix:semicolon
id|git_config
c_func
(paren
id|git_proxy_command_options
comma
(paren
r_void
op_star
)paren
id|host
)paren
suffix:semicolon
r_return
(paren
id|git_proxy_command
op_logical_and
op_star
id|git_proxy_command
)paren
suffix:semicolon
)brace
DECL|function|git_proxy_connect
r_static
r_struct
id|child_process
op_star
id|git_proxy_connect
c_func
(paren
r_int
id|fd
(braket
l_int|2
)braket
comma
r_char
op_star
id|host
)paren
(brace
r_const
r_char
op_star
id|port
op_assign
id|STR
c_func
(paren
id|DEFAULT_GIT_PORT
)paren
suffix:semicolon
r_struct
id|child_process
op_star
id|proxy
suffix:semicolon
id|get_host_and_port
c_func
(paren
op_amp
id|host
comma
op_amp
id|port
)paren
suffix:semicolon
id|proxy
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|proxy
)paren
)paren
suffix:semicolon
id|child_process_init
c_func
(paren
id|proxy
)paren
suffix:semicolon
id|argv_array_push
c_func
(paren
op_amp
id|proxy-&gt;args
comma
id|git_proxy_command
)paren
suffix:semicolon
id|argv_array_push
c_func
(paren
op_amp
id|proxy-&gt;args
comma
id|host
)paren
suffix:semicolon
id|argv_array_push
c_func
(paren
op_amp
id|proxy-&gt;args
comma
id|port
)paren
suffix:semicolon
id|proxy-&gt;in
op_assign
l_int|1
suffix:semicolon
id|proxy-&gt;out
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|start_command
c_func
(paren
id|proxy
)paren
)paren
id|die
c_func
(paren
l_string|&quot;cannot start proxy %s&quot;
comma
id|git_proxy_command
)paren
suffix:semicolon
id|fd
(braket
l_int|0
)braket
op_assign
id|proxy-&gt;out
suffix:semicolon
multiline_comment|/* read from proxy stdout */
id|fd
(braket
l_int|1
)braket
op_assign
id|proxy-&gt;in
suffix:semicolon
multiline_comment|/* write to proxy stdin */
r_return
id|proxy
suffix:semicolon
)brace
DECL|function|get_port
r_static
r_char
op_star
id|get_port
c_func
(paren
r_char
op_star
id|host
)paren
(brace
r_char
op_star
id|end
suffix:semicolon
r_char
op_star
id|p
op_assign
id|strchr
c_func
(paren
id|host
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_int
id|port
op_assign
id|strtol
c_func
(paren
id|p
op_plus
l_int|1
comma
op_amp
id|end
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_ne
id|p
op_plus
l_int|1
op_logical_and
op_star
id|end
op_eq
l_char|&squot;&bslash;0&squot;
op_logical_and
l_int|0
op_le
id|port
op_logical_and
id|port
OL
l_int|65536
)paren
(brace
op_star
id|p
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|p
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Extract protocol and relevant parts from the specified connection URL.&n; * The caller must free() the returned strings.&n; */
DECL|function|parse_connect_url
r_static
r_enum
id|protocol
id|parse_connect_url
c_func
(paren
r_const
r_char
op_star
id|url_orig
comma
r_char
op_star
op_star
id|ret_host
comma
r_char
op_star
op_star
id|ret_path
)paren
(brace
r_char
op_star
id|url
suffix:semicolon
r_char
op_star
id|host
comma
op_star
id|path
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_int
id|separator
op_assign
l_char|&squot;/&squot;
suffix:semicolon
r_enum
id|protocol
id|protocol
op_assign
id|PROTO_LOCAL
suffix:semicolon
r_if
c_cond
(paren
id|is_url
c_func
(paren
id|url_orig
)paren
)paren
id|url
op_assign
id|url_decode
c_func
(paren
id|url_orig
)paren
suffix:semicolon
r_else
id|url
op_assign
id|xstrdup
c_func
(paren
id|url_orig
)paren
suffix:semicolon
id|host
op_assign
id|strstr
c_func
(paren
id|url
comma
l_string|&quot;://&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
)paren
(brace
op_star
id|host
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|protocol
op_assign
id|get_protocol
c_func
(paren
id|url
)paren
suffix:semicolon
id|host
op_add_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|host
op_assign
id|url
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|url_is_local_not_ssh
c_func
(paren
id|url
)paren
)paren
(brace
id|protocol
op_assign
id|PROTO_SSH
suffix:semicolon
id|separator
op_assign
l_char|&squot;:&squot;
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Don&squot;t do destructive transforms as protocol code does&n;&t; * &squot;[]&squot; unwrapping in get_host_and_port()&n;&t; */
id|end
op_assign
id|host_end
c_func
(paren
op_amp
id|host
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|protocol
op_eq
id|PROTO_LOCAL
)paren
id|path
op_assign
id|end
suffix:semicolon
r_else
r_if
c_cond
(paren
id|protocol
op_eq
id|PROTO_FILE
op_logical_and
id|has_dos_drive_prefix
c_func
(paren
id|end
)paren
)paren
id|path
op_assign
id|end
suffix:semicolon
multiline_comment|/* &quot;file://$(pwd)&quot; may be &quot;file://C:/projects/repo&quot; */
r_else
id|path
op_assign
id|strchr
c_func
(paren
id|end
comma
id|separator
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
op_logical_or
op_logical_neg
op_star
id|path
)paren
id|die
c_func
(paren
l_string|&quot;No path specified. See &squot;man git-pull&squot; for valid url syntax&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * null-terminate hostname and point path to ~ for URL&squot;s like this:&n;&t; *    ssh://host.xz/~user/repo&n;&t; */
id|end
op_assign
id|path
suffix:semicolon
multiline_comment|/* Need to &bslash;0 terminate host here */
r_if
c_cond
(paren
id|separator
op_eq
l_char|&squot;:&squot;
)paren
id|path
op_increment
suffix:semicolon
multiline_comment|/* path starts after &squot;:&squot; */
r_if
c_cond
(paren
id|protocol
op_eq
id|PROTO_GIT
op_logical_or
id|protocol
op_eq
id|PROTO_SSH
)paren
(brace
r_if
c_cond
(paren
id|path
(braket
l_int|1
)braket
op_eq
l_char|&squot;~&squot;
)paren
id|path
op_increment
suffix:semicolon
)brace
id|path
op_assign
id|xstrdup
c_func
(paren
id|path
)paren
suffix:semicolon
op_star
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|ret_host
op_assign
id|xstrdup
c_func
(paren
id|host
)paren
suffix:semicolon
op_star
id|ret_path
op_assign
id|path
suffix:semicolon
id|free
c_func
(paren
id|url
)paren
suffix:semicolon
r_return
id|protocol
suffix:semicolon
)brace
DECL|variable|no_fork
r_static
r_struct
id|child_process
id|no_fork
op_assign
id|CHILD_PROCESS_INIT
suffix:semicolon
multiline_comment|/*&n; * This returns a dummy child_process if the transport protocol does not&n; * need fork(2), or a struct child_process object if it does.  Once done,&n; * finish the connection with finish_connect() with the value returned from&n; * this function (it is safe to call finish_connect() with NULL to support&n; * the former case).&n; *&n; * If it returns, the connect is successful; it just dies on errors (this&n; * will hopefully be changed in a libification effort, to return NULL when&n; * the connection failed).&n; */
DECL|function|git_connect
r_struct
id|child_process
op_star
id|git_connect
c_func
(paren
r_int
id|fd
(braket
l_int|2
)braket
comma
r_const
r_char
op_star
id|url
comma
r_const
r_char
op_star
id|prog
comma
r_int
id|flags
)paren
(brace
r_char
op_star
id|hostandport
comma
op_star
id|path
suffix:semicolon
r_struct
id|child_process
op_star
id|conn
op_assign
op_amp
id|no_fork
suffix:semicolon
r_enum
id|protocol
id|protocol
suffix:semicolon
r_struct
id|strbuf
id|cmd
op_assign
id|STRBUF_INIT
suffix:semicolon
multiline_comment|/* Without this we cannot rely on waitpid() to tell&n;&t; * what happened to our children.&n;&t; */
id|signal
c_func
(paren
id|SIGCHLD
comma
id|SIG_DFL
)paren
suffix:semicolon
id|protocol
op_assign
id|parse_connect_url
c_func
(paren
id|url
comma
op_amp
id|hostandport
comma
op_amp
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|CONNECT_DIAG_URL
)paren
op_logical_and
(paren
id|protocol
op_ne
id|PROTO_SSH
)paren
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Diag: url=%s&bslash;n&quot;
comma
id|url
ques
c_cond
id|url
suffix:colon
l_string|&quot;NULL&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Diag: protocol=%s&bslash;n&quot;
comma
id|prot_name
c_func
(paren
id|protocol
)paren
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Diag: hostandport=%s&bslash;n&quot;
comma
id|hostandport
ques
c_cond
id|hostandport
suffix:colon
l_string|&quot;NULL&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Diag: path=%s&bslash;n&quot;
comma
id|path
ques
c_cond
id|path
suffix:colon
l_string|&quot;NULL&quot;
)paren
suffix:semicolon
id|conn
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|protocol
op_eq
id|PROTO_GIT
)paren
(brace
multiline_comment|/*&n;&t;&t; * Set up virtual host information based on where we will&n;&t;&t; * connect, unless the user has overridden us in&n;&t;&t; * the environment.&n;&t;&t; */
r_char
op_star
id|target_host
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_OVERRIDE_VIRTUAL_HOST&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|target_host
)paren
id|target_host
op_assign
id|xstrdup
c_func
(paren
id|target_host
)paren
suffix:semicolon
r_else
id|target_host
op_assign
id|xstrdup
c_func
(paren
id|hostandport
)paren
suffix:semicolon
multiline_comment|/* These underlying connection commands die() if they&n;&t;&t; * cannot connect.&n;&t;&t; */
r_if
c_cond
(paren
id|git_use_proxy
c_func
(paren
id|hostandport
)paren
)paren
id|conn
op_assign
id|git_proxy_connect
c_func
(paren
id|fd
comma
id|hostandport
)paren
suffix:semicolon
r_else
id|git_tcp_connect
c_func
(paren
id|fd
comma
id|hostandport
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Separate original protocol components prog and path&n;&t;&t; * from extended host header with a NUL byte.&n;&t;&t; *&n;&t;&t; * Note: Do not add any other headers here!  Doing so&n;&t;&t; * will cause older git-daemon servers to crash.&n;&t;&t; */
id|packet_write
c_func
(paren
id|fd
(braket
l_int|1
)braket
comma
l_string|&quot;%s %s%chost=%s%c&quot;
comma
id|prog
comma
id|path
comma
l_int|0
comma
id|target_host
comma
l_int|0
)paren
suffix:semicolon
id|free
c_func
(paren
id|target_host
)paren
suffix:semicolon
)brace
r_else
(brace
id|conn
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|conn
)paren
)paren
suffix:semicolon
id|child_process_init
c_func
(paren
id|conn
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|cmd
comma
id|prog
)paren
suffix:semicolon
id|strbuf_addch
c_func
(paren
op_amp
id|cmd
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
id|sq_quote_buf
c_func
(paren
op_amp
id|cmd
comma
id|path
)paren
suffix:semicolon
id|conn-&gt;in
op_assign
id|conn-&gt;out
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|protocol
op_eq
id|PROTO_SSH
)paren
(brace
r_const
r_char
op_star
id|ssh
suffix:semicolon
r_int
id|putty
comma
id|tortoiseplink
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|ssh_host
op_assign
id|hostandport
suffix:semicolon
r_const
r_char
op_star
id|port
op_assign
l_int|NULL
suffix:semicolon
id|get_host_and_port
c_func
(paren
op_amp
id|ssh_host
comma
op_amp
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
id|port
op_assign
id|get_port
c_func
(paren
id|ssh_host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CONNECT_DIAG_URL
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Diag: url=%s&bslash;n&quot;
comma
id|url
ques
c_cond
id|url
suffix:colon
l_string|&quot;NULL&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Diag: protocol=%s&bslash;n&quot;
comma
id|prot_name
c_func
(paren
id|protocol
)paren
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Diag: userandhost=%s&bslash;n&quot;
comma
id|ssh_host
ques
c_cond
id|ssh_host
suffix:colon
l_string|&quot;NULL&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Diag: port=%s&bslash;n&quot;
comma
id|port
ques
c_cond
id|port
suffix:colon
l_string|&quot;NONE&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;Diag: path=%s&bslash;n&quot;
comma
id|path
ques
c_cond
id|path
suffix:colon
l_string|&quot;NULL&quot;
)paren
suffix:semicolon
id|free
c_func
(paren
id|hostandport
)paren
suffix:semicolon
id|free
c_func
(paren
id|path
)paren
suffix:semicolon
id|free
c_func
(paren
id|conn
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ssh
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_SSH_COMMAND&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssh
)paren
(brace
id|conn-&gt;use_shell
op_assign
l_int|1
suffix:semicolon
id|putty
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_const
r_char
op_star
id|base
suffix:semicolon
r_char
op_star
id|ssh_dup
suffix:semicolon
id|ssh
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_SSH&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ssh
)paren
id|ssh
op_assign
l_string|&quot;ssh&quot;
suffix:semicolon
id|ssh_dup
op_assign
id|xstrdup
c_func
(paren
id|ssh
)paren
suffix:semicolon
id|base
op_assign
id|basename
c_func
(paren
id|ssh_dup
)paren
suffix:semicolon
id|tortoiseplink
op_assign
op_logical_neg
id|strcasecmp
c_func
(paren
id|base
comma
l_string|&quot;tortoiseplink&quot;
)paren
op_logical_or
op_logical_neg
id|strcasecmp
c_func
(paren
id|base
comma
l_string|&quot;tortoiseplink.exe&quot;
)paren
suffix:semicolon
id|putty
op_assign
op_logical_neg
id|strcasecmp
c_func
(paren
id|base
comma
l_string|&quot;plink&quot;
)paren
op_logical_or
op_logical_neg
id|strcasecmp
c_func
(paren
id|base
comma
l_string|&quot;plink.exe&quot;
)paren
op_logical_or
id|tortoiseplink
suffix:semicolon
id|free
c_func
(paren
id|ssh_dup
)paren
suffix:semicolon
)brace
id|argv_array_push
c_func
(paren
op_amp
id|conn-&gt;args
comma
id|ssh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tortoiseplink
)paren
id|argv_array_push
c_func
(paren
op_amp
id|conn-&gt;args
comma
l_string|&quot;-batch&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
(brace
multiline_comment|/* P is for PuTTY, p is for OpenSSH */
id|argv_array_push
c_func
(paren
op_amp
id|conn-&gt;args
comma
id|putty
ques
c_cond
l_string|&quot;-P&quot;
suffix:colon
l_string|&quot;-p&quot;
)paren
suffix:semicolon
id|argv_array_push
c_func
(paren
op_amp
id|conn-&gt;args
comma
id|port
)paren
suffix:semicolon
)brace
id|argv_array_push
c_func
(paren
op_amp
id|conn-&gt;args
comma
id|ssh_host
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* remove repo-local variables from the environment */
id|conn-&gt;env
op_assign
id|local_repo_env
suffix:semicolon
id|conn-&gt;use_shell
op_assign
l_int|1
suffix:semicolon
)brace
id|argv_array_push
c_func
(paren
op_amp
id|conn-&gt;args
comma
id|cmd.buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start_command
c_func
(paren
id|conn
)paren
)paren
id|die
c_func
(paren
l_string|&quot;unable to fork&quot;
)paren
suffix:semicolon
id|fd
(braket
l_int|0
)braket
op_assign
id|conn-&gt;out
suffix:semicolon
multiline_comment|/* read from child&squot;s stdout */
id|fd
(braket
l_int|1
)braket
op_assign
id|conn-&gt;in
suffix:semicolon
multiline_comment|/* write to child&squot;s stdin */
id|strbuf_release
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|hostandport
)paren
suffix:semicolon
id|free
c_func
(paren
id|path
)paren
suffix:semicolon
r_return
id|conn
suffix:semicolon
)brace
DECL|function|git_connection_is_socket
r_int
id|git_connection_is_socket
c_func
(paren
r_struct
id|child_process
op_star
id|conn
)paren
(brace
r_return
id|conn
op_eq
op_amp
id|no_fork
suffix:semicolon
)brace
DECL|function|finish_connect
r_int
id|finish_connect
c_func
(paren
r_struct
id|child_process
op_star
id|conn
)paren
(brace
r_int
id|code
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conn
op_logical_or
id|git_connection_is_socket
c_func
(paren
id|conn
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|code
op_assign
id|finish_command
c_func
(paren
id|conn
)paren
suffix:semicolon
id|free
c_func
(paren
id|conn
)paren
suffix:semicolon
r_return
id|code
suffix:semicolon
)brace
eof
