multiline_comment|/*&n; * &quot;git reset&quot; builtin command&n; *&n; * Copyright (c) 2007 Carlos Rica&n; *&n; * Based on git-reset.sh, which is&n; *&n; * Copyright (c) 2005, 2006 Linus Torvalds and Junio C Hamano&n; */
macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;tag.h&quot;
macro_line|#include &quot;object.h&quot;
macro_line|#include &quot;commit.h&quot;
macro_line|#include &quot;run-command.h&quot;
macro_line|#include &quot;refs.h&quot;
macro_line|#include &quot;diff.h&quot;
macro_line|#include &quot;diffcore.h&quot;
macro_line|#include &quot;tree.h&quot;
DECL|variable|builtin_reset_usage
r_static
r_const
r_char
id|builtin_reset_usage
(braket
)braket
op_assign
l_string|&quot;git-reset [--mixed | --soft | --hard]  [&lt;commit-ish&gt;] [ [--] &lt;paths&gt;...]&quot;
suffix:semicolon
DECL|function|args_to_str
r_static
r_char
op_star
id|args_to_str
c_func
(paren
r_const
r_char
op_star
op_star
id|argv
)paren
(brace
r_char
op_star
id|buf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|len
comma
id|space
op_assign
l_int|0
comma
id|nr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
op_star
id|argv
suffix:semicolon
id|argv
op_increment
)paren
(brace
id|len
op_assign
id|strlen
c_func
(paren
op_star
id|argv
)paren
suffix:semicolon
id|ALLOC_GROW
c_func
(paren
id|buf
comma
id|nr
op_plus
l_int|1
op_plus
id|len
comma
id|space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr
)paren
id|buf
(braket
id|nr
op_increment
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
op_plus
id|nr
comma
op_star
id|argv
comma
id|len
)paren
suffix:semicolon
id|nr
op_add_assign
id|len
suffix:semicolon
)brace
id|ALLOC_GROW
c_func
(paren
id|buf
comma
id|nr
op_plus
l_int|1
comma
id|space
)paren
suffix:semicolon
id|buf
(braket
id|nr
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
DECL|function|is_merge
r_static
r_inline
r_int
id|is_merge
c_func
(paren
r_void
)paren
(brace
r_return
op_logical_neg
id|access
c_func
(paren
id|git_path
c_func
(paren
l_string|&quot;MERGE_HEAD&quot;
)paren
comma
id|F_OK
)paren
suffix:semicolon
)brace
DECL|function|unmerged_files
r_static
r_int
id|unmerged_files
c_func
(paren
r_void
)paren
(brace
r_char
id|b
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
r_struct
id|child_process
id|cmd
suffix:semicolon
r_const
r_char
op_star
id|argv_ls_files
(braket
)braket
op_assign
(brace
l_string|&quot;ls-files&quot;
comma
l_string|&quot;--unmerged&quot;
comma
l_int|NULL
)brace
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|cmd.argv
op_assign
id|argv_ls_files
suffix:semicolon
id|cmd.git_cmd
op_assign
l_int|1
suffix:semicolon
id|cmd.out
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|start_command
c_func
(paren
op_amp
id|cmd
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Could not run sub-command: git ls-files&quot;
)paren
suffix:semicolon
id|len
op_assign
id|xread
c_func
(paren
id|cmd.out
comma
op_amp
id|b
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Could not read output from git ls-files: %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|finish_command
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|reset_index_file
r_static
r_int
id|reset_index_file
c_func
(paren
r_const
r_int
r_char
op_star
id|sha1
comma
r_int
id|is_hard_reset
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|args
(braket
l_int|6
)braket
suffix:semicolon
id|args
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;read-tree&quot;
suffix:semicolon
id|args
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;-v&quot;
suffix:semicolon
id|args
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;--reset&quot;
suffix:semicolon
r_if
c_cond
(paren
id|is_hard_reset
)paren
id|args
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;-u&quot;
suffix:semicolon
id|args
(braket
id|i
op_increment
)braket
op_assign
id|sha1_to_hex
c_func
(paren
id|sha1
)paren
suffix:semicolon
id|args
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|run_command_v_opt
c_func
(paren
id|args
comma
id|RUN_GIT_CMD
)paren
suffix:semicolon
)brace
DECL|function|print_new_head_line
r_static
r_void
id|print_new_head_line
c_func
(paren
r_struct
id|commit
op_star
id|commit
)paren
(brace
r_const
r_char
op_star
id|hex
comma
op_star
id|dots
op_assign
l_string|&quot;...&quot;
comma
op_star
id|body
suffix:semicolon
id|hex
op_assign
id|find_unique_abbrev
c_func
(paren
id|commit-&gt;object.sha1
comma
id|DEFAULT_ABBREV
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hex
)paren
(brace
id|hex
op_assign
id|sha1_to_hex
c_func
(paren
id|commit-&gt;object.sha1
)paren
suffix:semicolon
id|dots
op_assign
l_string|&quot;&quot;
suffix:semicolon
)brace
id|printf
c_func
(paren
l_string|&quot;HEAD is now at %s%s&quot;
comma
id|hex
comma
id|dots
)paren
suffix:semicolon
id|body
op_assign
id|strstr
c_func
(paren
id|commit-&gt;buffer
comma
l_string|&quot;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|body
)paren
(brace
r_const
r_char
op_star
id|eol
suffix:semicolon
r_int
id|len
suffix:semicolon
id|body
op_add_assign
l_int|2
suffix:semicolon
id|eol
op_assign
id|strchr
c_func
(paren
id|body
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|len
op_assign
id|eol
ques
c_cond
id|eol
id|body
suffix:colon
id|strlen
c_func
(paren
id|body
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot; %.*s&bslash;n&quot;
comma
(paren
r_int
)paren
id|len
comma
id|body
)paren
suffix:semicolon
)brace
r_else
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|update_index_refresh
r_static
r_int
id|update_index_refresh
c_func
(paren
r_void
)paren
(brace
r_const
r_char
op_star
id|argv_update_index
(braket
)braket
op_assign
(brace
l_string|&quot;update-index&quot;
comma
l_string|&quot;--refresh&quot;
comma
l_int|NULL
)brace
suffix:semicolon
r_return
id|run_command_v_opt
c_func
(paren
id|argv_update_index
comma
id|RUN_GIT_CMD
)paren
suffix:semicolon
)brace
DECL|struct|update_cb_data
r_struct
id|update_cb_data
(brace
DECL|member|index_fd
r_int
id|index_fd
suffix:semicolon
DECL|member|lock
r_struct
id|lock_file
op_star
id|lock
suffix:semicolon
DECL|member|exit_code
r_int
id|exit_code
suffix:semicolon
)brace
suffix:semicolon
DECL|function|update_index_from_diff
r_static
r_void
id|update_index_from_diff
c_func
(paren
r_struct
id|diff_queue_struct
op_star
id|q
comma
r_struct
id|diff_options
op_star
id|opt
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|update_cb_data
op_star
id|cb
op_assign
id|data
suffix:semicolon
multiline_comment|/* do_diff_cache() mangled the index */
id|discard_cache
c_func
(paren
)paren
suffix:semicolon
id|read_cache
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|q-&gt;nr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|diff_filespec
op_star
id|one
op_assign
id|q-&gt;queue
(braket
id|i
)braket
op_member_access_from_pointer
id|one
suffix:semicolon
r_if
c_cond
(paren
id|one-&gt;mode
)paren
(brace
r_struct
id|cache_entry
op_star
id|ce
suffix:semicolon
id|ce
op_assign
id|make_cache_entry
c_func
(paren
id|one-&gt;mode
comma
id|one-&gt;sha1
comma
id|one-&gt;path
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|add_cache_entry
c_func
(paren
id|ce
comma
id|ADD_CACHE_OK_TO_ADD
op_or
id|ADD_CACHE_OK_TO_REPLACE
)paren
suffix:semicolon
)brace
r_else
id|remove_file_from_cache
c_func
(paren
id|one-&gt;path
)paren
suffix:semicolon
)brace
id|cb-&gt;exit_code
op_assign
id|write_cache
c_func
(paren
id|cb-&gt;index_fd
comma
id|active_cache
comma
id|active_nr
)paren
op_logical_or
id|close
c_func
(paren
id|cb-&gt;index_fd
)paren
op_logical_or
id|commit_locked_index
c_func
(paren
id|cb-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|read_from_tree
r_static
r_int
id|read_from_tree
c_func
(paren
r_const
r_char
op_star
id|prefix
comma
r_const
r_char
op_star
op_star
id|argv
comma
r_int
r_char
op_star
id|tree_sha1
)paren
(brace
r_struct
id|diff_options
id|opt
suffix:semicolon
r_struct
id|update_cb_data
id|cb
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|opt
comma
l_int|0
comma
r_sizeof
(paren
id|opt
)paren
)paren
suffix:semicolon
id|diff_tree_setup_paths
c_func
(paren
id|get_pathspec
c_func
(paren
id|prefix
comma
(paren
r_const
r_char
op_star
op_star
)paren
id|argv
)paren
comma
op_amp
id|opt
)paren
suffix:semicolon
id|opt.output_format
op_assign
id|DIFF_FORMAT_CALLBACK
suffix:semicolon
id|opt.format_callback
op_assign
id|update_index_from_diff
suffix:semicolon
id|opt.format_callback_data
op_assign
op_amp
id|cb
suffix:semicolon
id|cb.lock
op_assign
id|xcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
r_struct
id|lock_file
)paren
)paren
suffix:semicolon
id|cb.index_fd
op_assign
id|hold_locked_index
c_func
(paren
id|cb.lock
comma
l_int|1
)paren
suffix:semicolon
id|cb.exit_code
op_assign
l_int|0
suffix:semicolon
id|read_cache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_diff_cache
c_func
(paren
id|tree_sha1
comma
op_amp
id|opt
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|diffcore_std
c_func
(paren
op_amp
id|opt
)paren
suffix:semicolon
id|diff_flush
c_func
(paren
op_amp
id|opt
)paren
suffix:semicolon
r_return
id|cb.exit_code
suffix:semicolon
)brace
DECL|function|prepend_reflog_action
r_static
r_void
id|prepend_reflog_action
c_func
(paren
r_const
r_char
op_star
id|action
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_const
r_char
op_star
id|sep
op_assign
l_string|&quot;: &quot;
suffix:semicolon
r_const
r_char
op_star
id|rla
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_REFLOG_ACTION&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rla
)paren
id|rla
op_assign
id|sep
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_if
c_cond
(paren
id|snprintf
c_func
(paren
id|buf
comma
id|size
comma
l_string|&quot;%s%s%s&quot;
comma
id|rla
comma
id|sep
comma
id|action
)paren
op_ge
id|size
)paren
id|warning
c_func
(paren
l_string|&quot;Reflog action message too long: %.*s...&quot;
comma
l_int|50
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|enum|reset_type
DECL|enumerator|MIXED
DECL|enumerator|SOFT
DECL|enumerator|HARD
DECL|enumerator|NONE
r_enum
id|reset_type
(brace
id|MIXED
comma
id|SOFT
comma
id|HARD
comma
id|NONE
)brace
suffix:semicolon
DECL|variable|reset_type_names
r_static
r_const
r_char
op_star
id|reset_type_names
(braket
)braket
op_assign
(brace
l_string|&quot;mixed&quot;
comma
l_string|&quot;soft&quot;
comma
l_string|&quot;hard&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|cmd_reset
r_int
id|cmd_reset
c_func
(paren
r_int
id|argc
comma
r_const
r_char
op_star
op_star
id|argv
comma
r_const
r_char
op_star
id|prefix
)paren
(brace
r_int
id|i
op_assign
l_int|1
comma
id|reset_type
op_assign
id|NONE
comma
id|update_ref_status
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|rev
op_assign
l_string|&quot;HEAD&quot;
suffix:semicolon
r_int
r_char
id|sha1
(braket
l_int|20
)braket
comma
op_star
id|orig
op_assign
l_int|NULL
comma
id|sha1_orig
(braket
l_int|20
)braket
comma
op_star
id|old_orig
op_assign
l_int|NULL
comma
id|sha1_old_orig
(braket
l_int|20
)braket
suffix:semicolon
r_struct
id|commit
op_star
id|commit
suffix:semicolon
r_char
op_star
id|reflog_action
comma
id|msg
(braket
l_int|1024
)braket
suffix:semicolon
id|git_config
c_func
(paren
id|git_default_config
)paren
suffix:semicolon
id|reflog_action
op_assign
id|args_to_str
c_func
(paren
id|argv
)paren
suffix:semicolon
id|setenv
c_func
(paren
l_string|&quot;GIT_REFLOG_ACTION&quot;
comma
id|reflog_action
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|argc
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
id|i
)braket
comma
l_string|&quot;--mixed&quot;
)paren
)paren
(brace
id|reset_type
op_assign
id|MIXED
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
id|i
)braket
comma
l_string|&quot;--soft&quot;
)paren
)paren
(brace
id|reset_type
op_assign
id|SOFT
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
id|i
)braket
comma
l_string|&quot;--hard&quot;
)paren
)paren
(brace
id|reset_type
op_assign
id|HARD
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
OL
id|argc
op_logical_and
id|argv
(braket
id|i
)braket
(braket
l_int|0
)braket
op_ne
l_char|&squot;-&squot;
)paren
id|rev
op_assign
id|argv
(braket
id|i
op_increment
)braket
suffix:semicolon
r_if
c_cond
(paren
id|get_sha1
c_func
(paren
id|rev
comma
id|sha1
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Failed to resolve &squot;%s&squot; as a valid ref.&quot;
comma
id|rev
)paren
suffix:semicolon
id|commit
op_assign
id|lookup_commit_reference
c_func
(paren
id|sha1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|commit
)paren
id|die
c_func
(paren
l_string|&quot;Could not parse object &squot;%s&squot;.&quot;
comma
id|rev
)paren
suffix:semicolon
id|hashcpy
c_func
(paren
id|sha1
comma
id|commit-&gt;object.sha1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|argc
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|argv
(braket
id|i
)braket
comma
l_string|&quot;--&quot;
)paren
)paren
id|i
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
OL
id|argc
op_logical_and
id|argv
(braket
id|i
)braket
(braket
l_int|0
)braket
op_eq
l_char|&squot;-&squot;
)paren
id|usage
c_func
(paren
id|builtin_reset_usage
)paren
suffix:semicolon
multiline_comment|/* git reset tree [--] paths... can be used to&n;&t; * load chosen paths from the tree into the index without&n;&t; * affecting the working tree nor HEAD. */
r_if
c_cond
(paren
id|i
OL
id|argc
)paren
(brace
r_if
c_cond
(paren
id|reset_type
op_eq
id|MIXED
)paren
id|warning
c_func
(paren
l_string|&quot;--mixed option is deprecated with paths.&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|reset_type
op_ne
id|NONE
)paren
id|die
c_func
(paren
l_string|&quot;Cannot do %s reset with paths.&quot;
comma
id|reset_type_names
(braket
id|reset_type
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_from_tree
c_func
(paren
id|prefix
comma
id|argv
op_plus
id|i
comma
id|sha1
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|update_index_refresh
c_func
(paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reset_type
op_eq
id|NONE
)paren
id|reset_type
op_assign
id|MIXED
suffix:semicolon
multiline_comment|/* by default */
multiline_comment|/* Soft reset does not touch the index file nor the working tree&n;&t; * at all, but requires them in a good order.  Other resets reset&n;&t; * the index file to the tree object we are switching to. */
r_if
c_cond
(paren
id|reset_type
op_eq
id|SOFT
)paren
(brace
r_if
c_cond
(paren
id|is_merge
c_func
(paren
)paren
op_logical_or
id|unmerged_files
c_func
(paren
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Cannot do a soft reset in the middle of a merge.&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reset_index_file
c_func
(paren
id|sha1
comma
(paren
id|reset_type
op_eq
id|HARD
)paren
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Could not reset index file to revision &squot;%s&squot;.&quot;
comma
id|rev
)paren
suffix:semicolon
multiline_comment|/* Any resets update HEAD to the head being switched to,&n;&t; * saving the previous head in ORIG_HEAD before. */
r_if
c_cond
(paren
op_logical_neg
id|get_sha1
c_func
(paren
l_string|&quot;ORIG_HEAD&quot;
comma
id|sha1_old_orig
)paren
)paren
id|old_orig
op_assign
id|sha1_old_orig
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_sha1
c_func
(paren
l_string|&quot;HEAD&quot;
comma
id|sha1_orig
)paren
)paren
(brace
id|orig
op_assign
id|sha1_orig
suffix:semicolon
id|prepend_reflog_action
c_func
(paren
l_string|&quot;updating ORIG_HEAD&quot;
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|update_ref
c_func
(paren
id|msg
comma
l_string|&quot;ORIG_HEAD&quot;
comma
id|orig
comma
id|old_orig
comma
l_int|0
comma
id|MSG_ON_ERR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|old_orig
)paren
id|delete_ref
c_func
(paren
l_string|&quot;ORIG_HEAD&quot;
comma
id|old_orig
)paren
suffix:semicolon
id|prepend_reflog_action
c_func
(paren
l_string|&quot;updating HEAD&quot;
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|update_ref_status
op_assign
id|update_ref
c_func
(paren
id|msg
comma
l_string|&quot;HEAD&quot;
comma
id|sha1
comma
id|orig
comma
l_int|0
comma
id|MSG_ON_ERR
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reset_type
)paren
(brace
r_case
id|HARD
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|update_ref_status
)paren
id|print_new_head_line
c_func
(paren
id|commit
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOFT
suffix:colon
multiline_comment|/* Nothing else to do. */
r_break
suffix:semicolon
r_case
id|MIXED
suffix:colon
multiline_comment|/* Report what has not been updated. */
id|update_index_refresh
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|unlink
c_func
(paren
id|git_path
c_func
(paren
l_string|&quot;MERGE_HEAD&quot;
)paren
)paren
suffix:semicolon
id|unlink
c_func
(paren
id|git_path
c_func
(paren
l_string|&quot;rr-cache/MERGE_RR&quot;
)paren
)paren
suffix:semicolon
id|unlink
c_func
(paren
id|git_path
c_func
(paren
l_string|&quot;MERGE_MSG&quot;
)paren
)paren
suffix:semicolon
id|unlink
c_func
(paren
id|git_path
c_func
(paren
l_string|&quot;SQUASH_MSG&quot;
)paren
)paren
suffix:semicolon
id|free
c_func
(paren
id|reflog_action
)paren
suffix:semicolon
r_return
id|update_ref_status
suffix:semicolon
)brace
eof
