macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;commit.h&quot;
macro_line|#include &quot;refs.h&quot;
macro_line|#include &quot;notes-utils.h&quot;
macro_line|#include &quot;notes-merge.h&quot; /* for create_notes_commit() */
DECL|function|commit_notes
r_void
id|commit_notes
c_func
(paren
r_struct
id|notes_tree
op_star
id|t
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
r_int
r_char
id|commit_sha1
(braket
l_int|20
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t
)paren
id|t
op_assign
op_amp
id|default_notes_tree
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t-&gt;initialized
op_logical_or
op_logical_neg
id|t-&gt;ref
op_logical_or
op_logical_neg
op_star
id|t-&gt;ref
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Cannot commit uninitialized/unreferenced notes tree&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t-&gt;dirty
)paren
r_return
suffix:semicolon
multiline_comment|/* don&squot;t have to commit an unchanged tree */
multiline_comment|/* Prepare commit message and reflog message */
id|strbuf_addstr
c_func
(paren
op_amp
id|buf
comma
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf.buf
(braket
id|buf.len
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
id|strbuf_addch
c_func
(paren
op_amp
id|buf
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
multiline_comment|/* Make sure msg ends with newline */
id|create_notes_commit
c_func
(paren
id|t
comma
l_int|NULL
comma
op_amp
id|buf
comma
id|commit_sha1
)paren
suffix:semicolon
id|strbuf_insert
c_func
(paren
op_amp
id|buf
comma
l_int|0
comma
l_string|&quot;notes: &quot;
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* commit message starts at index 7 */
id|update_ref
c_func
(paren
id|buf.buf
comma
id|t-&gt;ref
comma
id|commit_sha1
comma
l_int|NULL
comma
l_int|0
comma
id|DIE_ON_ERR
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
)brace
DECL|function|parse_combine_notes_fn
r_static
id|combine_notes_fn
id|parse_combine_notes_fn
c_func
(paren
r_const
r_char
op_star
id|v
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcasecmp
c_func
(paren
id|v
comma
l_string|&quot;overwrite&quot;
)paren
)paren
r_return
id|combine_notes_overwrite
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcasecmp
c_func
(paren
id|v
comma
l_string|&quot;ignore&quot;
)paren
)paren
r_return
id|combine_notes_ignore
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcasecmp
c_func
(paren
id|v
comma
l_string|&quot;concatenate&quot;
)paren
)paren
r_return
id|combine_notes_concatenate
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcasecmp
c_func
(paren
id|v
comma
l_string|&quot;cat_sort_uniq&quot;
)paren
)paren
r_return
id|combine_notes_cat_sort_uniq
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|notes_rewrite_config
r_static
r_int
id|notes_rewrite_config
c_func
(paren
r_const
r_char
op_star
id|k
comma
r_const
r_char
op_star
id|v
comma
r_void
op_star
id|cb
)paren
(brace
r_struct
id|notes_rewrite_cfg
op_star
id|c
op_assign
id|cb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|k
comma
l_string|&quot;notes.rewrite.&quot;
)paren
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|k
op_plus
l_int|14
comma
id|c-&gt;cmd
)paren
)paren
(brace
id|c-&gt;enabled
op_assign
id|git_config_bool
c_func
(paren
id|k
comma
id|v
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;mode_from_env
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|k
comma
l_string|&quot;notes.rewritemode&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|v
)paren
id|config_error_nonbool
c_func
(paren
id|k
)paren
suffix:semicolon
id|c-&gt;combine
op_assign
id|parse_combine_notes_fn
c_func
(paren
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;combine
)paren
(brace
id|error
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Bad notes.rewriteMode value: &squot;%s&squot;&quot;
)paren
comma
id|v
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;refs_from_env
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|k
comma
l_string|&quot;notes.rewriteref&quot;
)paren
)paren
(brace
multiline_comment|/* note that a refs/ prefix is implied in the&n;&t;&t; * underlying for_each_glob_ref */
r_if
c_cond
(paren
op_logical_neg
id|prefixcmp
c_func
(paren
id|v
comma
l_string|&quot;refs/notes/&quot;
)paren
)paren
id|string_list_add_refs_by_glob
c_func
(paren
id|c-&gt;refs
comma
id|v
)paren
suffix:semicolon
r_else
id|warning
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Refusing to rewrite notes in %s&quot;
l_string|&quot; (outside of refs/notes/)&quot;
)paren
comma
id|v
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|init_copy_notes_for_rewrite
r_struct
id|notes_rewrite_cfg
op_star
id|init_copy_notes_for_rewrite
c_func
(paren
r_const
r_char
op_star
id|cmd
)paren
(brace
r_struct
id|notes_rewrite_cfg
op_star
id|c
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|notes_rewrite_cfg
)paren
)paren
suffix:semicolon
r_const
r_char
op_star
id|rewrite_mode_env
op_assign
id|getenv
c_func
(paren
id|GIT_NOTES_REWRITE_MODE_ENVIRONMENT
)paren
suffix:semicolon
r_const
r_char
op_star
id|rewrite_refs_env
op_assign
id|getenv
c_func
(paren
id|GIT_NOTES_REWRITE_REF_ENVIRONMENT
)paren
suffix:semicolon
id|c-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|c-&gt;enabled
op_assign
l_int|1
suffix:semicolon
id|c-&gt;combine
op_assign
id|combine_notes_concatenate
suffix:semicolon
id|c-&gt;refs
op_assign
id|xcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
r_struct
id|string_list
)paren
)paren
suffix:semicolon
id|c-&gt;refs-&gt;strdup_strings
op_assign
l_int|1
suffix:semicolon
id|c-&gt;refs_from_env
op_assign
l_int|0
suffix:semicolon
id|c-&gt;mode_from_env
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rewrite_mode_env
)paren
(brace
id|c-&gt;mode_from_env
op_assign
l_int|1
suffix:semicolon
id|c-&gt;combine
op_assign
id|parse_combine_notes_fn
c_func
(paren
id|rewrite_mode_env
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;combine
)paren
multiline_comment|/* TRANSLATORS: The first %s is the name of the&n;&t;&t;&t;   environment variable, the second %s is its value */
id|error
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Bad %s value: &squot;%s&squot;&quot;
)paren
comma
id|GIT_NOTES_REWRITE_MODE_ENVIRONMENT
comma
id|rewrite_mode_env
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rewrite_refs_env
)paren
(brace
id|c-&gt;refs_from_env
op_assign
l_int|1
suffix:semicolon
id|string_list_add_refs_from_colon_sep
c_func
(paren
id|c-&gt;refs
comma
id|rewrite_refs_env
)paren
suffix:semicolon
)brace
id|git_config
c_func
(paren
id|notes_rewrite_config
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;enabled
op_logical_or
op_logical_neg
id|c-&gt;refs-&gt;nr
)paren
(brace
id|string_list_clear
c_func
(paren
id|c-&gt;refs
comma
l_int|0
)paren
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;refs
)paren
suffix:semicolon
id|free
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|c-&gt;trees
op_assign
id|load_notes_trees
c_func
(paren
id|c-&gt;refs
)paren
suffix:semicolon
id|string_list_clear
c_func
(paren
id|c-&gt;refs
comma
l_int|0
)paren
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;refs
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
DECL|function|copy_note_for_rewrite
r_int
id|copy_note_for_rewrite
c_func
(paren
r_struct
id|notes_rewrite_cfg
op_star
id|c
comma
r_const
r_int
r_char
op_star
id|from_obj
comma
r_const
r_int
r_char
op_star
id|to_obj
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|c-&gt;trees
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
id|ret
op_assign
id|copy_note
c_func
(paren
id|c-&gt;trees
(braket
id|i
)braket
comma
id|from_obj
comma
id|to_obj
comma
l_int|1
comma
id|c-&gt;combine
)paren
op_logical_or
id|ret
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|finish_copy_notes_for_rewrite
r_void
id|finish_copy_notes_for_rewrite
c_func
(paren
r_struct
id|notes_rewrite_cfg
op_star
id|c
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|c-&gt;trees
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|commit_notes
c_func
(paren
id|c-&gt;trees
(braket
id|i
)braket
comma
id|msg
)paren
suffix:semicolon
id|free_notes
c_func
(paren
id|c-&gt;trees
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|c-&gt;trees
)paren
suffix:semicolon
id|free
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
eof
