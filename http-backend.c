macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;refs.h&quot;
macro_line|#include &quot;pkt-line.h&quot;
macro_line|#include &quot;object.h&quot;
macro_line|#include &quot;tag.h&quot;
macro_line|#include &quot;exec_cmd.h&quot;
DECL|variable|content_type
r_static
r_const
r_char
id|content_type
(braket
)braket
op_assign
l_string|&quot;Content-Type&quot;
suffix:semicolon
DECL|variable|content_length
r_static
r_const
r_char
id|content_length
(braket
)braket
op_assign
l_string|&quot;Content-Length&quot;
suffix:semicolon
DECL|variable|last_modified
r_static
r_const
r_char
id|last_modified
(braket
)braket
op_assign
l_string|&quot;Last-Modified&quot;
suffix:semicolon
DECL|function|format_write
r_static
r_void
id|format_write
c_func
(paren
r_int
id|fd
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|1024
)braket
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_int
id|n
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|n
op_assign
id|vsnprintf
c_func
(paren
id|buffer
comma
r_sizeof
(paren
id|buffer
)paren
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
r_sizeof
(paren
id|buffer
)paren
)paren
id|die
c_func
(paren
l_string|&quot;protocol error: impossibly long line&quot;
)paren
suffix:semicolon
id|safe_write
c_func
(paren
id|fd
comma
id|buffer
comma
id|n
)paren
suffix:semicolon
)brace
DECL|function|http_status
r_static
r_void
id|http_status
c_func
(paren
r_int
id|code
comma
r_const
r_char
op_star
id|msg
)paren
(brace
id|format_write
c_func
(paren
l_int|1
comma
l_string|&quot;Status: %u %s&bslash;r&bslash;n&quot;
comma
id|code
comma
id|msg
)paren
suffix:semicolon
)brace
DECL|function|hdr_str
r_static
r_void
id|hdr_str
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|value
)paren
(brace
id|format_write
c_func
(paren
l_int|1
comma
l_string|&quot;%s: %s&bslash;r&bslash;n&quot;
comma
id|name
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|hdr_int
r_static
r_void
id|hdr_int
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|value
)paren
(brace
id|format_write
c_func
(paren
l_int|1
comma
l_string|&quot;%s: %&quot;
id|PRIuMAX
l_string|&quot;&bslash;r&bslash;n&quot;
comma
id|name
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|hdr_date
r_static
r_void
id|hdr_date
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_int
id|when
)paren
(brace
r_const
r_char
op_star
id|value
op_assign
id|show_date
c_func
(paren
id|when
comma
l_int|0
comma
id|DATE_RFC2822
)paren
suffix:semicolon
id|hdr_str
c_func
(paren
id|name
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|hdr_nocache
r_static
r_void
id|hdr_nocache
c_func
(paren
r_void
)paren
(brace
id|hdr_str
c_func
(paren
l_string|&quot;Expires&quot;
comma
l_string|&quot;Fri, 01 Jan 1980 00:00:00 GMT&quot;
)paren
suffix:semicolon
id|hdr_str
c_func
(paren
l_string|&quot;Pragma&quot;
comma
l_string|&quot;no-cache&quot;
)paren
suffix:semicolon
id|hdr_str
c_func
(paren
l_string|&quot;Cache-Control&quot;
comma
l_string|&quot;no-cache, max-age=0, must-revalidate&quot;
)paren
suffix:semicolon
)brace
DECL|function|hdr_cache_forever
r_static
r_void
id|hdr_cache_forever
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|now
op_assign
id|time
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|hdr_date
c_func
(paren
l_string|&quot;Date&quot;
comma
id|now
)paren
suffix:semicolon
id|hdr_date
c_func
(paren
l_string|&quot;Expires&quot;
comma
id|now
op_plus
l_int|31536000
)paren
suffix:semicolon
id|hdr_str
c_func
(paren
l_string|&quot;Cache-Control&quot;
comma
l_string|&quot;public, max-age=31536000&quot;
)paren
suffix:semicolon
)brace
DECL|function|end_headers
r_static
r_void
id|end_headers
c_func
(paren
r_void
)paren
(brace
id|safe_write
c_func
(paren
l_int|1
comma
l_string|&quot;&bslash;r&bslash;n&quot;
comma
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|not_found
r_static
id|NORETURN
r_void
id|not_found
c_func
(paren
r_const
r_char
op_star
id|err
comma
dot
dot
dot
)paren
(brace
id|va_list
id|params
suffix:semicolon
id|http_status
c_func
(paren
l_int|404
comma
l_string|&quot;Not Found&quot;
)paren
suffix:semicolon
id|hdr_nocache
c_func
(paren
)paren
suffix:semicolon
id|end_headers
c_func
(paren
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|params
comma
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_and
op_star
id|err
)paren
id|vfprintf
c_func
(paren
id|stderr
comma
id|err
comma
id|params
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|params
)paren
suffix:semicolon
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|send_strbuf
r_static
r_void
id|send_strbuf
c_func
(paren
r_const
r_char
op_star
id|type
comma
r_struct
id|strbuf
op_star
id|buf
)paren
(brace
id|hdr_int
c_func
(paren
id|content_length
comma
id|buf-&gt;len
)paren
suffix:semicolon
id|hdr_str
c_func
(paren
id|content_type
comma
id|type
)paren
suffix:semicolon
id|end_headers
c_func
(paren
)paren
suffix:semicolon
id|safe_write
c_func
(paren
l_int|1
comma
id|buf-&gt;buf
comma
id|buf-&gt;len
)paren
suffix:semicolon
)brace
DECL|function|send_file
r_static
r_void
id|send_file
c_func
(paren
r_const
r_char
op_star
id|the_type
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_const
r_char
op_star
id|p
op_assign
id|git_path
c_func
(paren
l_string|&quot;%s&quot;
comma
id|name
)paren
suffix:semicolon
r_int
id|buf_alloc
op_assign
l_int|8192
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|xmalloc
c_func
(paren
id|buf_alloc
)paren
suffix:semicolon
r_int
id|fd
suffix:semicolon
r_struct
id|stat
id|sb
suffix:semicolon
r_int
id|size
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|p
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
id|not_found
c_func
(paren
l_string|&quot;Cannot open &squot;%s&squot;: %s&quot;
comma
id|p
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fstat
c_func
(paren
id|fd
comma
op_amp
id|sb
)paren
OL
l_int|0
)paren
id|die_errno
c_func
(paren
l_string|&quot;Cannot stat &squot;%s&squot;&quot;
comma
id|p
)paren
suffix:semicolon
id|size
op_assign
id|xsize_t
c_func
(paren
id|sb.st_size
)paren
suffix:semicolon
id|hdr_int
c_func
(paren
id|content_length
comma
id|size
)paren
suffix:semicolon
id|hdr_str
c_func
(paren
id|content_type
comma
id|the_type
)paren
suffix:semicolon
id|hdr_date
c_func
(paren
id|last_modified
comma
id|sb.st_mtime
)paren
suffix:semicolon
id|end_headers
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|size
)paren
(brace
id|ssize_t
id|n
op_assign
id|xread
c_func
(paren
id|fd
comma
id|buf
comma
id|buf_alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
id|die_errno
c_func
(paren
l_string|&quot;Cannot read &squot;%s&squot;&quot;
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
r_break
suffix:semicolon
id|safe_write
c_func
(paren
l_int|1
comma
id|buf
comma
id|n
)paren
suffix:semicolon
)brace
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
id|free
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|function|get_text_file
r_static
r_void
id|get_text_file
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|hdr_nocache
c_func
(paren
)paren
suffix:semicolon
id|send_file
c_func
(paren
l_string|&quot;text/plain&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|get_loose_object
r_static
r_void
id|get_loose_object
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|hdr_cache_forever
c_func
(paren
)paren
suffix:semicolon
id|send_file
c_func
(paren
l_string|&quot;application/x-git-loose-object&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|get_pack_file
r_static
r_void
id|get_pack_file
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|hdr_cache_forever
c_func
(paren
)paren
suffix:semicolon
id|send_file
c_func
(paren
l_string|&quot;application/x-git-packed-objects&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|get_idx_file
r_static
r_void
id|get_idx_file
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|hdr_cache_forever
c_func
(paren
)paren
suffix:semicolon
id|send_file
c_func
(paren
l_string|&quot;application/x-git-packed-objects-toc&quot;
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|show_text_ref
r_static
r_int
id|show_text_ref
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_int
r_char
op_star
id|sha1
comma
r_int
id|flag
comma
r_void
op_star
id|cb_data
)paren
(brace
r_struct
id|strbuf
op_star
id|buf
op_assign
id|cb_data
suffix:semicolon
r_struct
id|object
op_star
id|o
op_assign
id|parse_object
c_func
(paren
id|sha1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|o
)paren
r_return
l_int|0
suffix:semicolon
id|strbuf_addf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;t%s&bslash;n&quot;
comma
id|sha1_to_hex
c_func
(paren
id|sha1
)paren
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|o-&gt;type
op_eq
id|OBJ_TAG
)paren
(brace
id|o
op_assign
id|deref_tag
c_func
(paren
id|o
comma
id|name
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|o
)paren
r_return
l_int|0
suffix:semicolon
id|strbuf_addf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;t%s^{}&bslash;n&quot;
comma
id|sha1_to_hex
c_func
(paren
id|o-&gt;sha1
)paren
comma
id|name
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_info_refs
r_static
r_void
id|get_info_refs
c_func
(paren
r_char
op_star
id|arg
)paren
(brace
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
id|for_each_ref
c_func
(paren
id|show_text_ref
comma
op_amp
id|buf
)paren
suffix:semicolon
id|hdr_nocache
c_func
(paren
)paren
suffix:semicolon
id|send_strbuf
c_func
(paren
l_string|&quot;text/plain&quot;
comma
op_amp
id|buf
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
)brace
DECL|function|get_info_packs
r_static
r_void
id|get_info_packs
c_func
(paren
r_char
op_star
id|arg
)paren
(brace
r_int
id|objdirlen
op_assign
id|strlen
c_func
(paren
id|get_object_directory
c_func
(paren
)paren
)paren
suffix:semicolon
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|packed_git
op_star
id|p
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|prepare_packed_git
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|packed_git
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;pack_local
)paren
id|cnt
op_increment
suffix:semicolon
)brace
id|strbuf_grow
c_func
(paren
op_amp
id|buf
comma
id|cnt
op_star
l_int|53
op_plus
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|packed_git
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;pack_local
)paren
id|strbuf_addf
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;P %s&bslash;n&quot;
comma
id|p-&gt;pack_name
op_plus
id|objdirlen
op_plus
l_int|6
)paren
suffix:semicolon
)brace
id|strbuf_addch
c_func
(paren
op_amp
id|buf
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|hdr_nocache
c_func
(paren
)paren
suffix:semicolon
id|send_strbuf
c_func
(paren
l_string|&quot;text/plain; charset=utf-8&quot;
comma
op_amp
id|buf
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
)brace
DECL|function|die_webcgi
r_static
id|NORETURN
r_void
id|die_webcgi
c_func
(paren
r_const
r_char
op_star
id|err
comma
id|va_list
id|params
)paren
(brace
r_char
id|buffer
(braket
l_int|1000
)braket
suffix:semicolon
id|http_status
c_func
(paren
l_int|500
comma
l_string|&quot;Internal Server Error&quot;
)paren
suffix:semicolon
id|hdr_nocache
c_func
(paren
)paren
suffix:semicolon
id|end_headers
c_func
(paren
)paren
suffix:semicolon
id|vsnprintf
c_func
(paren
id|buffer
comma
r_sizeof
(paren
id|buffer
)paren
comma
id|err
comma
id|params
)paren
suffix:semicolon
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;fatal: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
m_exit
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|struct|service_cmd
r_static
r_struct
id|service_cmd
(brace
DECL|member|method
r_const
r_char
op_star
id|method
suffix:semicolon
DECL|member|pattern
r_const
r_char
op_star
id|pattern
suffix:semicolon
DECL|member|imp
r_void
(paren
op_star
id|imp
)paren
(paren
r_char
op_star
)paren
suffix:semicolon
DECL|variable|services
)brace
id|services
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/HEAD$&quot;
comma
id|get_text_file
)brace
comma
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/info/refs$&quot;
comma
id|get_info_refs
)brace
comma
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/objects/info/alternates$&quot;
comma
id|get_text_file
)brace
comma
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/objects/info/http-alternates$&quot;
comma
id|get_text_file
)brace
comma
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/objects/info/packs$&quot;
comma
id|get_info_packs
)brace
comma
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/objects/[0-9a-f]{2}/[0-9a-f]{38}$&quot;
comma
id|get_loose_object
)brace
comma
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/objects/pack/pack-[0-9a-f]{40}&bslash;&bslash;.pack$&quot;
comma
id|get_pack_file
)brace
comma
(brace
l_string|&quot;GET&quot;
comma
l_string|&quot;/objects/pack/pack-[0-9a-f]{40}&bslash;&bslash;.idx$&quot;
comma
id|get_idx_file
)brace
)brace
suffix:semicolon
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_char
op_star
id|method
op_assign
id|getenv
c_func
(paren
l_string|&quot;REQUEST_METHOD&quot;
)paren
suffix:semicolon
r_char
op_star
id|dir
op_assign
id|getenv
c_func
(paren
l_string|&quot;PATH_TRANSLATED&quot;
)paren
suffix:semicolon
r_struct
id|service_cmd
op_star
id|cmd
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|cmd_arg
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|git_extract_argv0_path
c_func
(paren
id|argv
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|set_die_routine
c_func
(paren
id|die_webcgi
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|method
)paren
id|die
c_func
(paren
l_string|&quot;No REQUEST_METHOD from server&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|method
comma
l_string|&quot;HEAD&quot;
)paren
)paren
id|method
op_assign
l_string|&quot;GET&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
id|die
c_func
(paren
l_string|&quot;No PATH_TRANSLATED from server&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|services
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|service_cmd
op_star
id|c
op_assign
op_amp
id|services
(braket
id|i
)braket
suffix:semicolon
id|regex_t
id|re
suffix:semicolon
id|regmatch_t
id|out
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|regcomp
c_func
(paren
op_amp
id|re
comma
id|c-&gt;pattern
comma
id|REG_EXTENDED
)paren
)paren
id|die
c_func
(paren
l_string|&quot;Bogus regex in service table: %s&quot;
comma
id|c-&gt;pattern
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|regexec
c_func
(paren
op_amp
id|re
comma
id|dir
comma
l_int|1
comma
id|out
comma
l_int|0
)paren
)paren
(brace
r_int
id|n
op_assign
id|out
(braket
l_int|0
)braket
dot
id|rm_eo
id|out
(braket
l_int|0
)braket
dot
id|rm_so
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|method
comma
id|c-&gt;method
)paren
)paren
(brace
r_const
r_char
op_star
id|proto
op_assign
id|getenv
c_func
(paren
l_string|&quot;SERVER_PROTOCOL&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proto
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|proto
comma
l_string|&quot;HTTP/1.1&quot;
)paren
)paren
id|http_status
c_func
(paren
l_int|405
comma
l_string|&quot;Method Not Allowed&quot;
)paren
suffix:semicolon
r_else
id|http_status
c_func
(paren
l_int|400
comma
l_string|&quot;Bad Request&quot;
)paren
suffix:semicolon
id|hdr_nocache
c_func
(paren
)paren
suffix:semicolon
id|end_headers
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cmd
op_assign
id|c
suffix:semicolon
id|cmd_arg
op_assign
id|xmalloc
c_func
(paren
id|n
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cmd_arg
comma
id|dir
op_plus
id|out
(braket
l_int|0
)braket
dot
id|rm_so
op_plus
l_int|1
comma
id|n
)paren
suffix:semicolon
id|cmd_arg
(braket
id|n
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|dir
(braket
id|out
(braket
l_int|0
)braket
dot
id|rm_so
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|regfree
c_func
(paren
op_amp
id|re
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
id|not_found
c_func
(paren
l_string|&quot;Request not supported: &squot;%s&squot;&quot;
comma
id|dir
)paren
suffix:semicolon
id|setup_path
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enter_repo
c_func
(paren
id|dir
comma
l_int|0
)paren
)paren
id|not_found
c_func
(paren
l_string|&quot;Not a git repository: &squot;%s&squot;&quot;
comma
id|dir
)paren
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|imp
c_func
(paren
id|cmd_arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
