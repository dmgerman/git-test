macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;credential.h&quot;
macro_line|#include &quot;string-list.h&quot;
macro_line|#include &quot;run-command.h&quot;
macro_line|#include &quot;url.h&quot;
DECL|function|credential_init
r_void
id|credential_init
c_func
(paren
r_struct
id|credential
op_star
id|c
)paren
(brace
id|memset
c_func
(paren
id|c
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|c
)paren
)paren
suffix:semicolon
id|c-&gt;helpers.strdup_strings
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|credential_clear
r_void
id|credential_clear
c_func
(paren
r_struct
id|credential
op_star
id|c
)paren
(brace
id|free
c_func
(paren
id|c-&gt;protocol
)paren
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;host
)paren
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;path
)paren
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;username
)paren
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;password
)paren
suffix:semicolon
id|string_list_clear
c_func
(paren
op_amp
id|c-&gt;helpers
comma
l_int|0
)paren
suffix:semicolon
id|credential_init
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
DECL|function|credential_describe
r_static
r_void
id|credential_describe
c_func
(paren
r_struct
id|credential
op_star
id|c
comma
r_struct
id|strbuf
op_star
id|out
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;protocol
)paren
r_return
suffix:semicolon
id|strbuf_addf
c_func
(paren
id|out
comma
l_string|&quot;%s://&quot;
comma
id|c-&gt;protocol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;username
op_logical_and
op_star
id|c-&gt;username
)paren
id|strbuf_addf
c_func
(paren
id|out
comma
l_string|&quot;%s@&quot;
comma
id|c-&gt;username
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;host
)paren
id|strbuf_addstr
c_func
(paren
id|out
comma
id|c-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;path
)paren
id|strbuf_addf
c_func
(paren
id|out
comma
l_string|&quot;/%s&quot;
comma
id|c-&gt;path
)paren
suffix:semicolon
)brace
DECL|function|credential_ask_one
r_static
r_char
op_star
id|credential_ask_one
c_func
(paren
r_const
r_char
op_star
id|what
comma
r_struct
id|credential
op_star
id|c
)paren
(brace
r_struct
id|strbuf
id|desc
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|strbuf
id|prompt
op_assign
id|STRBUF_INIT
suffix:semicolon
r_char
op_star
id|r
suffix:semicolon
id|credential_describe
c_func
(paren
id|c
comma
op_amp
id|desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|desc.len
)paren
id|strbuf_addf
c_func
(paren
op_amp
id|prompt
comma
l_string|&quot;%s for &squot;%s&squot;: &quot;
comma
id|what
comma
id|desc.buf
)paren
suffix:semicolon
r_else
id|strbuf_addf
c_func
(paren
op_amp
id|prompt
comma
l_string|&quot;%s: &quot;
comma
id|what
)paren
suffix:semicolon
multiline_comment|/* FIXME: for usernames, we should do something less magical that&n;&t; * actually echoes the characters. However, we need to read from&n;&t; * /dev/tty and not stdio, which is not portable (but getpass will do&n;&t; * it for us). http.c uses the same workaround. */
id|r
op_assign
id|git_getpass
c_func
(paren
id|prompt.buf
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|desc
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|prompt
)paren
suffix:semicolon
r_return
id|xstrdup
c_func
(paren
id|r
)paren
suffix:semicolon
)brace
DECL|function|credential_getpass
r_static
r_void
id|credential_getpass
c_func
(paren
r_struct
id|credential
op_star
id|c
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;username
)paren
id|c-&gt;username
op_assign
id|credential_ask_one
c_func
(paren
l_string|&quot;Username&quot;
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;password
)paren
id|c-&gt;password
op_assign
id|credential_ask_one
c_func
(paren
l_string|&quot;Password&quot;
comma
id|c
)paren
suffix:semicolon
)brace
DECL|function|credential_read
r_int
id|credential_read
c_func
(paren
r_struct
id|credential
op_star
id|c
comma
id|FILE
op_star
id|fp
)paren
(brace
r_struct
id|strbuf
id|line
op_assign
id|STRBUF_INIT
suffix:semicolon
r_while
c_loop
(paren
id|strbuf_getline
c_func
(paren
op_amp
id|line
comma
id|fp
comma
l_char|&squot;&bslash;n&squot;
)paren
op_ne
id|EOF
)paren
(brace
r_char
op_star
id|key
op_assign
id|line.buf
suffix:semicolon
r_char
op_star
id|value
op_assign
id|strchr
c_func
(paren
id|key
comma
l_char|&squot;=&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|line.len
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|warning
c_func
(paren
l_string|&quot;invalid credential line: %s&quot;
comma
id|key
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|line
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
op_star
id|value
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|key
comma
l_string|&quot;username&quot;
)paren
)paren
(brace
id|free
c_func
(paren
id|c-&gt;username
)paren
suffix:semicolon
id|c-&gt;username
op_assign
id|xstrdup
c_func
(paren
id|value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|key
comma
l_string|&quot;password&quot;
)paren
)paren
(brace
id|free
c_func
(paren
id|c-&gt;password
)paren
suffix:semicolon
id|c-&gt;password
op_assign
id|xstrdup
c_func
(paren
id|value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|key
comma
l_string|&quot;protocol&quot;
)paren
)paren
(brace
id|free
c_func
(paren
id|c-&gt;protocol
)paren
suffix:semicolon
id|c-&gt;protocol
op_assign
id|xstrdup
c_func
(paren
id|value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|key
comma
l_string|&quot;host&quot;
)paren
)paren
(brace
id|free
c_func
(paren
id|c-&gt;host
)paren
suffix:semicolon
id|c-&gt;host
op_assign
id|xstrdup
c_func
(paren
id|value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|key
comma
l_string|&quot;path&quot;
)paren
)paren
(brace
id|free
c_func
(paren
id|c-&gt;path
)paren
suffix:semicolon
id|c-&gt;path
op_assign
id|xstrdup
c_func
(paren
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Ignore other lines; we don&squot;t know what they mean, but&n;&t;&t; * this future-proofs us when later versions of git do&n;&t;&t; * learn new lines, and the helpers are updated to match.&n;&t;&t; */
)brace
id|strbuf_release
c_func
(paren
op_amp
id|line
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|credential_write_item
r_static
r_void
id|credential_write_item
c_func
(paren
id|FILE
op_star
id|fp
comma
r_const
r_char
op_star
id|key
comma
r_const
r_char
op_star
id|value
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
r_return
suffix:semicolon
id|fprintf
c_func
(paren
id|fp
comma
l_string|&quot;%s=%s&bslash;n&quot;
comma
id|key
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|credential_write
r_static
r_void
id|credential_write
c_func
(paren
r_const
r_struct
id|credential
op_star
id|c
comma
id|FILE
op_star
id|fp
)paren
(brace
id|credential_write_item
c_func
(paren
id|fp
comma
l_string|&quot;protocol&quot;
comma
id|c-&gt;protocol
)paren
suffix:semicolon
id|credential_write_item
c_func
(paren
id|fp
comma
l_string|&quot;host&quot;
comma
id|c-&gt;host
)paren
suffix:semicolon
id|credential_write_item
c_func
(paren
id|fp
comma
l_string|&quot;path&quot;
comma
id|c-&gt;path
)paren
suffix:semicolon
id|credential_write_item
c_func
(paren
id|fp
comma
l_string|&quot;username&quot;
comma
id|c-&gt;username
)paren
suffix:semicolon
id|credential_write_item
c_func
(paren
id|fp
comma
l_string|&quot;password&quot;
comma
id|c-&gt;password
)paren
suffix:semicolon
)brace
DECL|function|run_credential_helper
r_static
r_int
id|run_credential_helper
c_func
(paren
r_struct
id|credential
op_star
id|c
comma
r_const
r_char
op_star
id|cmd
comma
r_int
id|want_output
)paren
(brace
r_struct
id|child_process
id|helper
suffix:semicolon
r_const
r_char
op_star
id|argv
(braket
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
id|FILE
op_star
id|fp
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|helper
comma
l_int|0
comma
r_sizeof
(paren
id|helper
)paren
)paren
suffix:semicolon
id|argv
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|helper.argv
op_assign
id|argv
suffix:semicolon
id|helper.use_shell
op_assign
l_int|1
suffix:semicolon
id|helper.in
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|want_output
)paren
id|helper.out
op_assign
l_int|1
suffix:semicolon
r_else
id|helper.no_stdout
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|start_command
c_func
(paren
op_amp
id|helper
)paren
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|fp
op_assign
id|xfdopen
c_func
(paren
id|helper.in
comma
l_string|&quot;w&quot;
)paren
suffix:semicolon
id|credential_write
c_func
(paren
id|c
comma
id|fp
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|fp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|want_output
)paren
(brace
r_int
id|r
suffix:semicolon
id|fp
op_assign
id|xfdopen
c_func
(paren
id|helper.out
comma
l_string|&quot;r&quot;
)paren
suffix:semicolon
id|r
op_assign
id|credential_read
c_func
(paren
id|c
comma
id|fp
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|fp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
(brace
id|finish_command
c_func
(paren
op_amp
id|helper
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|finish_command
c_func
(paren
op_amp
id|helper
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|credential_do
r_static
r_int
id|credential_do
c_func
(paren
r_struct
id|credential
op_star
id|c
comma
r_const
r_char
op_star
id|helper
comma
r_const
r_char
op_star
id|operation
)paren
(brace
r_struct
id|strbuf
id|cmd
op_assign
id|STRBUF_INIT
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
id|helper
(braket
l_int|0
)braket
op_eq
l_char|&squot;!&squot;
)paren
id|strbuf_addstr
c_func
(paren
op_amp
id|cmd
comma
id|helper
op_plus
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|is_absolute_path
c_func
(paren
id|helper
)paren
)paren
id|strbuf_addstr
c_func
(paren
op_amp
id|cmd
comma
id|helper
)paren
suffix:semicolon
r_else
id|strbuf_addf
c_func
(paren
op_amp
id|cmd
comma
l_string|&quot;git credential-%s&quot;
comma
id|helper
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|cmd
comma
l_string|&quot; %s&quot;
comma
id|operation
)paren
suffix:semicolon
id|r
op_assign
id|run_credential_helper
c_func
(paren
id|c
comma
id|cmd.buf
comma
op_logical_neg
id|strcmp
c_func
(paren
id|operation
comma
l_string|&quot;get&quot;
)paren
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|cmd
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|credential_fill
r_void
id|credential_fill
c_func
(paren
r_struct
id|credential
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;username
op_logical_and
id|c-&gt;password
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|c-&gt;helpers.nr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|credential_do
c_func
(paren
id|c
comma
id|c-&gt;helpers.items
(braket
id|i
)braket
dot
id|string
comma
l_string|&quot;get&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;username
op_logical_and
id|c-&gt;password
)paren
r_return
suffix:semicolon
)brace
id|credential_getpass
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;username
op_logical_and
op_logical_neg
id|c-&gt;password
)paren
id|die
c_func
(paren
l_string|&quot;unable to get password from user&quot;
)paren
suffix:semicolon
)brace
DECL|function|credential_approve
r_void
id|credential_approve
c_func
(paren
r_struct
id|credential
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;approved
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c-&gt;username
op_logical_or
op_logical_neg
id|c-&gt;password
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|c-&gt;helpers.nr
suffix:semicolon
id|i
op_increment
)paren
id|credential_do
c_func
(paren
id|c
comma
id|c-&gt;helpers.items
(braket
id|i
)braket
dot
id|string
comma
l_string|&quot;store&quot;
)paren
suffix:semicolon
id|c-&gt;approved
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|credential_reject
r_void
id|credential_reject
c_func
(paren
r_struct
id|credential
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|c-&gt;helpers.nr
suffix:semicolon
id|i
op_increment
)paren
id|credential_do
c_func
(paren
id|c
comma
id|c-&gt;helpers.items
(braket
id|i
)braket
dot
id|string
comma
l_string|&quot;erase&quot;
)paren
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;username
)paren
suffix:semicolon
id|c-&gt;username
op_assign
l_int|NULL
suffix:semicolon
id|free
c_func
(paren
id|c-&gt;password
)paren
suffix:semicolon
id|c-&gt;password
op_assign
l_int|NULL
suffix:semicolon
id|c-&gt;approved
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|credential_from_url
r_void
id|credential_from_url
c_func
(paren
r_struct
id|credential
op_star
id|c
comma
r_const
r_char
op_star
id|url
)paren
(brace
r_const
r_char
op_star
id|at
comma
op_star
id|colon
comma
op_star
id|cp
comma
op_star
id|slash
comma
op_star
id|host
comma
op_star
id|proto_end
suffix:semicolon
id|credential_clear
c_func
(paren
id|c
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Match one of:&n;&t; *   (1) proto://&lt;host&gt;/...&n;&t; *   (2) proto://&lt;user&gt;@&lt;host&gt;/...&n;&t; *   (3) proto://&lt;user&gt;:&lt;pass&gt;@&lt;host&gt;/...&n;&t; */
id|proto_end
op_assign
id|strstr
c_func
(paren
id|url
comma
l_string|&quot;://&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proto_end
)paren
r_return
suffix:semicolon
id|cp
op_assign
id|proto_end
op_plus
l_int|3
suffix:semicolon
id|at
op_assign
id|strchr
c_func
(paren
id|cp
comma
l_char|&squot;@&squot;
)paren
suffix:semicolon
id|colon
op_assign
id|strchr
c_func
(paren
id|cp
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|slash
op_assign
id|strchrnul
c_func
(paren
id|cp
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|at
op_logical_or
id|slash
op_le
id|at
)paren
(brace
multiline_comment|/* Case (1) */
id|host
op_assign
id|cp
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|colon
op_logical_or
id|at
op_le
id|colon
)paren
(brace
multiline_comment|/* Case (2) */
id|c-&gt;username
op_assign
id|url_decode_mem
c_func
(paren
id|cp
comma
id|at
id|cp
)paren
suffix:semicolon
id|host
op_assign
id|at
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Case (3) */
id|c-&gt;username
op_assign
id|url_decode_mem
c_func
(paren
id|cp
comma
id|colon
id|cp
)paren
suffix:semicolon
id|c-&gt;password
op_assign
id|url_decode_mem
c_func
(paren
id|colon
op_plus
l_int|1
comma
id|at
(paren
id|colon
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|host
op_assign
id|at
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proto_end
id|url
OG
l_int|0
)paren
id|c-&gt;protocol
op_assign
id|xmemdupz
c_func
(paren
id|url
comma
id|proto_end
id|url
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slash
id|host
OG
l_int|0
)paren
id|c-&gt;host
op_assign
id|url_decode_mem
c_func
(paren
id|host
comma
id|slash
id|host
)paren
suffix:semicolon
multiline_comment|/* Trim leading and trailing slashes from path */
r_while
c_loop
(paren
op_star
id|slash
op_eq
l_char|&squot;/&squot;
)paren
id|slash
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|slash
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
id|c-&gt;path
op_assign
id|url_decode
c_func
(paren
id|slash
)paren
suffix:semicolon
id|p
op_assign
id|c-&gt;path
op_plus
id|strlen
c_func
(paren
id|c-&gt;path
)paren
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|p
OG
id|c-&gt;path
op_logical_and
op_star
id|p
op_eq
l_char|&squot;/&squot;
)paren
op_star
id|p
op_decrement
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
eof
