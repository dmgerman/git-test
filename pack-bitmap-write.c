macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;commit.h&quot;
macro_line|#include &quot;tag.h&quot;
macro_line|#include &quot;diff.h&quot;
macro_line|#include &quot;revision.h&quot;
macro_line|#include &quot;list-objects.h&quot;
macro_line|#include &quot;progress.h&quot;
macro_line|#include &quot;pack-revindex.h&quot;
macro_line|#include &quot;pack.h&quot;
macro_line|#include &quot;pack-bitmap.h&quot;
macro_line|#include &quot;sha1-lookup.h&quot;
macro_line|#include &quot;pack-objects.h&quot;
DECL|struct|bitmapped_commit
r_struct
id|bitmapped_commit
(brace
DECL|member|commit
r_struct
id|commit
op_star
id|commit
suffix:semicolon
DECL|member|bitmap
r_struct
id|ewah_bitmap
op_star
id|bitmap
suffix:semicolon
DECL|member|write_as
r_struct
id|ewah_bitmap
op_star
id|write_as
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|member|xor_offset
r_int
id|xor_offset
suffix:semicolon
DECL|member|commit_pos
r_uint32
id|commit_pos
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|bitmap_writer
r_struct
id|bitmap_writer
(brace
DECL|member|commits
r_struct
id|ewah_bitmap
op_star
id|commits
suffix:semicolon
DECL|member|trees
r_struct
id|ewah_bitmap
op_star
id|trees
suffix:semicolon
DECL|member|blobs
r_struct
id|ewah_bitmap
op_star
id|blobs
suffix:semicolon
DECL|member|tags
r_struct
id|ewah_bitmap
op_star
id|tags
suffix:semicolon
DECL|member|bitmaps
id|khash_sha1
op_star
id|bitmaps
suffix:semicolon
DECL|member|reused
id|khash_sha1
op_star
id|reused
suffix:semicolon
DECL|member|to_pack
r_struct
id|packing_data
op_star
id|to_pack
suffix:semicolon
DECL|member|selected
r_struct
id|bitmapped_commit
op_star
id|selected
suffix:semicolon
DECL|member|selected_nr
DECL|member|selected_alloc
r_int
r_int
id|selected_nr
comma
id|selected_alloc
suffix:semicolon
DECL|member|progress
r_struct
id|progress
op_star
id|progress
suffix:semicolon
DECL|member|show_progress
r_int
id|show_progress
suffix:semicolon
DECL|member|pack_checksum
r_int
r_char
id|pack_checksum
(braket
l_int|20
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|writer
r_static
r_struct
id|bitmap_writer
id|writer
suffix:semicolon
DECL|function|bitmap_writer_show_progress
r_void
id|bitmap_writer_show_progress
c_func
(paren
r_int
id|show
)paren
(brace
id|writer.show_progress
op_assign
id|show
suffix:semicolon
)brace
multiline_comment|/**&n; * Build the initial type index for the packfile&n; */
DECL|function|bitmap_writer_build_type_index
r_void
id|bitmap_writer_build_type_index
c_func
(paren
r_struct
id|pack_idx_entry
op_star
op_star
id|index
comma
r_uint32
id|index_nr
)paren
(brace
r_uint32
id|i
suffix:semicolon
id|writer.commits
op_assign
id|ewah_new
c_func
(paren
)paren
suffix:semicolon
id|writer.trees
op_assign
id|ewah_new
c_func
(paren
)paren
suffix:semicolon
id|writer.blobs
op_assign
id|ewah_new
c_func
(paren
)paren
suffix:semicolon
id|writer.tags
op_assign
id|ewah_new
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|index_nr
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|object_entry
op_star
id|entry
op_assign
(paren
r_struct
id|object_entry
op_star
)paren
id|index
(braket
id|i
)braket
suffix:semicolon
r_enum
id|object_type
id|real_type
suffix:semicolon
id|entry-&gt;in_pack_pos
op_assign
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|entry-&gt;type
)paren
(brace
r_case
id|OBJ_COMMIT
suffix:colon
r_case
id|OBJ_TREE
suffix:colon
r_case
id|OBJ_BLOB
suffix:colon
r_case
id|OBJ_TAG
suffix:colon
id|real_type
op_assign
id|entry-&gt;type
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|real_type
op_assign
id|sha1_object_info
c_func
(paren
id|entry-&gt;idx.sha1
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|real_type
)paren
(brace
r_case
id|OBJ_COMMIT
suffix:colon
id|ewah_set
c_func
(paren
id|writer.commits
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OBJ_TREE
suffix:colon
id|ewah_set
c_func
(paren
id|writer.trees
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OBJ_BLOB
suffix:colon
id|ewah_set
c_func
(paren
id|writer.blobs
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OBJ_TAG
suffix:colon
id|ewah_set
c_func
(paren
id|writer.tags
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|die
c_func
(paren
l_string|&quot;Missing type information for %s (%d/%d)&quot;
comma
id|sha1_to_hex
c_func
(paren
id|entry-&gt;idx.sha1
)paren
comma
id|real_type
comma
id|entry-&gt;type
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * Compute the actual bitmaps&n; */
DECL|variable|seen_objects
r_static
r_struct
id|object
op_star
op_star
id|seen_objects
suffix:semicolon
DECL|variable|seen_objects_nr
DECL|variable|seen_objects_alloc
r_static
r_int
r_int
id|seen_objects_nr
comma
id|seen_objects_alloc
suffix:semicolon
DECL|function|push_bitmapped_commit
r_static
r_inline
r_void
id|push_bitmapped_commit
c_func
(paren
r_struct
id|commit
op_star
id|commit
comma
r_struct
id|ewah_bitmap
op_star
id|reused
)paren
(brace
r_if
c_cond
(paren
id|writer.selected_nr
op_ge
id|writer.selected_alloc
)paren
(brace
id|writer.selected_alloc
op_assign
(paren
id|writer.selected_alloc
op_plus
l_int|32
)paren
op_star
l_int|2
suffix:semicolon
id|REALLOC_ARRAY
c_func
(paren
id|writer.selected
comma
id|writer.selected_alloc
)paren
suffix:semicolon
)brace
id|writer.selected
(braket
id|writer.selected_nr
)braket
dot
id|commit
op_assign
id|commit
suffix:semicolon
id|writer.selected
(braket
id|writer.selected_nr
)braket
dot
id|bitmap
op_assign
id|reused
suffix:semicolon
id|writer.selected
(braket
id|writer.selected_nr
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
id|writer.selected_nr
op_increment
suffix:semicolon
)brace
DECL|function|mark_as_seen
r_static
r_inline
r_void
id|mark_as_seen
c_func
(paren
r_struct
id|object
op_star
id|object
)paren
(brace
id|ALLOC_GROW
c_func
(paren
id|seen_objects
comma
id|seen_objects_nr
op_plus
l_int|1
comma
id|seen_objects_alloc
)paren
suffix:semicolon
id|seen_objects
(braket
id|seen_objects_nr
op_increment
)braket
op_assign
id|object
suffix:semicolon
)brace
DECL|function|reset_all_seen
r_static
r_inline
r_void
id|reset_all_seen
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|seen_objects_nr
suffix:semicolon
op_increment
id|i
)paren
(brace
id|seen_objects
(braket
id|i
)braket
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
(paren
id|SEEN
op_or
id|ADDED
op_or
id|SHOWN
)paren
suffix:semicolon
)brace
id|seen_objects_nr
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|find_object_pos
r_static
r_uint32
id|find_object_pos
c_func
(paren
r_const
r_int
r_char
op_star
id|sha1
)paren
(brace
r_struct
id|object_entry
op_star
id|entry
op_assign
id|packlist_find
c_func
(paren
id|writer.to_pack
comma
id|sha1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
(brace
id|die
c_func
(paren
l_string|&quot;Failed to write bitmap index. Packfile doesn&squot;t have full closure &quot;
l_string|&quot;(object %s is missing)&quot;
comma
id|sha1_to_hex
c_func
(paren
id|sha1
)paren
)paren
suffix:semicolon
)brace
r_return
id|entry-&gt;in_pack_pos
suffix:semicolon
)brace
DECL|function|show_object
r_static
r_void
id|show_object
c_func
(paren
r_struct
id|object
op_star
id|object
comma
r_const
r_struct
id|name_path
op_star
id|path
comma
r_const
r_char
op_star
id|last
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|bitmap
op_star
id|base
op_assign
id|data
suffix:semicolon
id|bitmap_set
c_func
(paren
id|base
comma
id|find_object_pos
c_func
(paren
id|get_object_hash
c_func
(paren
op_star
id|object
)paren
)paren
)paren
suffix:semicolon
id|mark_as_seen
c_func
(paren
id|object
)paren
suffix:semicolon
)brace
DECL|function|show_commit
r_static
r_void
id|show_commit
c_func
(paren
r_struct
id|commit
op_star
id|commit
comma
r_void
op_star
id|data
)paren
(brace
id|mark_as_seen
c_func
(paren
(paren
r_struct
id|object
op_star
)paren
id|commit
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|add_to_include_set
id|add_to_include_set
c_func
(paren
r_struct
id|bitmap
op_star
id|base
comma
r_struct
id|commit
op_star
id|commit
)paren
(brace
id|khiter_t
id|hash_pos
suffix:semicolon
r_uint32
id|bitmap_pos
op_assign
id|find_object_pos
c_func
(paren
id|get_object_hash
c_func
(paren
id|commit-&gt;object
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bitmap_get
c_func
(paren
id|base
comma
id|bitmap_pos
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|hash_pos
op_assign
id|kh_get_sha1
c_func
(paren
id|writer.bitmaps
comma
id|get_object_hash
c_func
(paren
id|commit-&gt;object
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hash_pos
OL
id|kh_end
c_func
(paren
id|writer.bitmaps
)paren
)paren
(brace
r_struct
id|bitmapped_commit
op_star
id|bc
op_assign
id|kh_value
c_func
(paren
id|writer.bitmaps
comma
id|hash_pos
)paren
suffix:semicolon
id|bitmap_or_ewah
c_func
(paren
id|base
comma
id|bc-&gt;bitmap
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bitmap_set
c_func
(paren
id|base
comma
id|bitmap_pos
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|should_include
id|should_include
c_func
(paren
r_struct
id|commit
op_star
id|commit
comma
r_void
op_star
id|_data
)paren
(brace
r_struct
id|bitmap
op_star
id|base
op_assign
id|_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|add_to_include_set
c_func
(paren
id|base
comma
id|commit
)paren
)paren
(brace
r_struct
id|commit_list
op_star
id|parent
op_assign
id|commit-&gt;parents
suffix:semicolon
id|mark_as_seen
c_func
(paren
(paren
r_struct
id|object
op_star
)paren
id|commit
)paren
suffix:semicolon
r_while
c_loop
(paren
id|parent
)paren
(brace
id|parent-&gt;item-&gt;object.flags
op_or_assign
id|SEEN
suffix:semicolon
id|mark_as_seen
c_func
(paren
(paren
r_struct
id|object
op_star
)paren
id|parent-&gt;item
)paren
suffix:semicolon
id|parent
op_assign
id|parent-&gt;next
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|compute_xor_offsets
r_static
r_void
id|compute_xor_offsets
c_func
(paren
r_void
)paren
(brace
r_static
r_const
r_int
id|MAX_XOR_OFFSET_SEARCH
op_assign
l_int|10
suffix:semicolon
r_int
id|i
comma
id|next
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|next
OL
id|writer.selected_nr
)paren
(brace
r_struct
id|bitmapped_commit
op_star
id|stored
op_assign
op_amp
id|writer.selected
(braket
id|next
)braket
suffix:semicolon
r_int
id|best_offset
op_assign
l_int|0
suffix:semicolon
r_struct
id|ewah_bitmap
op_star
id|best_bitmap
op_assign
id|stored-&gt;bitmap
suffix:semicolon
r_struct
id|ewah_bitmap
op_star
id|test_xor
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|MAX_XOR_OFFSET_SEARCH
suffix:semicolon
op_increment
id|i
)paren
(brace
r_int
id|curr
op_assign
id|next
id|i
suffix:semicolon
r_if
c_cond
(paren
id|curr
OL
l_int|0
)paren
r_break
suffix:semicolon
id|test_xor
op_assign
id|ewah_pool_new
c_func
(paren
)paren
suffix:semicolon
id|ewah_xor
c_func
(paren
id|writer.selected
(braket
id|curr
)braket
dot
id|bitmap
comma
id|stored-&gt;bitmap
comma
id|test_xor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_xor-&gt;buffer_size
OL
id|best_bitmap-&gt;buffer_size
)paren
(brace
r_if
c_cond
(paren
id|best_bitmap
op_ne
id|stored-&gt;bitmap
)paren
id|ewah_pool_free
c_func
(paren
id|best_bitmap
)paren
suffix:semicolon
id|best_bitmap
op_assign
id|test_xor
suffix:semicolon
id|best_offset
op_assign
id|i
suffix:semicolon
)brace
r_else
(brace
id|ewah_pool_free
c_func
(paren
id|test_xor
)paren
suffix:semicolon
)brace
)brace
id|stored-&gt;xor_offset
op_assign
id|best_offset
suffix:semicolon
id|stored-&gt;write_as
op_assign
id|best_bitmap
suffix:semicolon
id|next
op_increment
suffix:semicolon
)brace
)brace
DECL|function|bitmap_writer_build
r_void
id|bitmap_writer_build
c_func
(paren
r_struct
id|packing_data
op_star
id|to_pack
)paren
(brace
r_static
r_const
r_float
id|REUSE_BITMAP_THRESHOLD
op_assign
l_float|0.2
suffix:semicolon
r_int
id|i
comma
id|reuse_after
comma
id|need_reset
suffix:semicolon
r_struct
id|bitmap
op_star
id|base
op_assign
id|bitmap_new
c_func
(paren
)paren
suffix:semicolon
r_struct
id|rev_info
id|revs
suffix:semicolon
id|writer.bitmaps
op_assign
id|kh_init_sha1
c_func
(paren
)paren
suffix:semicolon
id|writer.to_pack
op_assign
id|to_pack
suffix:semicolon
r_if
c_cond
(paren
id|writer.show_progress
)paren
id|writer.progress
op_assign
id|start_progress
c_func
(paren
l_string|&quot;Building bitmaps&quot;
comma
id|writer.selected_nr
)paren
suffix:semicolon
id|init_revisions
c_func
(paren
op_amp
id|revs
comma
l_int|NULL
)paren
suffix:semicolon
id|revs.tag_objects
op_assign
l_int|1
suffix:semicolon
id|revs.tree_objects
op_assign
l_int|1
suffix:semicolon
id|revs.blob_objects
op_assign
l_int|1
suffix:semicolon
id|revs.no_walk
op_assign
l_int|0
suffix:semicolon
id|revs.include_check
op_assign
id|should_include
suffix:semicolon
id|reset_revision_walk
c_func
(paren
)paren
suffix:semicolon
id|reuse_after
op_assign
id|writer.selected_nr
op_star
id|REUSE_BITMAP_THRESHOLD
suffix:semicolon
id|need_reset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|writer.selected_nr
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
r_struct
id|bitmapped_commit
op_star
id|stored
suffix:semicolon
r_struct
id|object
op_star
id|object
suffix:semicolon
id|khiter_t
id|hash_pos
suffix:semicolon
r_int
id|hash_ret
suffix:semicolon
id|stored
op_assign
op_amp
id|writer.selected
(braket
id|i
)braket
suffix:semicolon
id|object
op_assign
(paren
r_struct
id|object
op_star
)paren
id|stored-&gt;commit
suffix:semicolon
r_if
c_cond
(paren
id|stored-&gt;bitmap
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|writer.selected_nr
l_int|1
op_logical_and
(paren
id|need_reset
op_logical_or
op_logical_neg
id|in_merge_bases
c_func
(paren
id|writer.selected
(braket
id|i
op_plus
l_int|1
)braket
dot
id|commit
comma
id|stored-&gt;commit
)paren
)paren
)paren
(brace
id|bitmap_reset
c_func
(paren
id|base
)paren
suffix:semicolon
id|reset_all_seen
c_func
(paren
)paren
suffix:semicolon
)brace
id|add_pending_object
c_func
(paren
op_amp
id|revs
comma
id|object
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
id|revs.include_check_data
op_assign
id|base
suffix:semicolon
r_if
c_cond
(paren
id|prepare_revision_walk
c_func
(paren
op_amp
id|revs
)paren
)paren
id|die
c_func
(paren
l_string|&quot;revision walk setup failed&quot;
)paren
suffix:semicolon
id|traverse_commit_list
c_func
(paren
op_amp
id|revs
comma
id|show_commit
comma
id|show_object
comma
id|base
)paren
suffix:semicolon
id|revs.pending.nr
op_assign
l_int|0
suffix:semicolon
id|revs.pending.alloc
op_assign
l_int|0
suffix:semicolon
id|revs.pending.objects
op_assign
l_int|NULL
suffix:semicolon
id|stored-&gt;bitmap
op_assign
id|bitmap_to_ewah
c_func
(paren
id|base
)paren
suffix:semicolon
id|need_reset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|need_reset
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|reuse_after
)paren
id|stored-&gt;flags
op_or_assign
id|BITMAP_FLAG_REUSE
suffix:semicolon
id|hash_pos
op_assign
id|kh_put_sha1
c_func
(paren
id|writer.bitmaps
comma
id|get_object_hash
c_func
(paren
op_star
id|object
)paren
comma
op_amp
id|hash_ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hash_ret
op_eq
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Duplicate entry when writing index: %s&quot;
comma
id|oid_to_hex
c_func
(paren
op_amp
id|object-&gt;oid
)paren
)paren
suffix:semicolon
id|kh_value
c_func
(paren
id|writer.bitmaps
comma
id|hash_pos
)paren
op_assign
id|stored
suffix:semicolon
id|display_progress
c_func
(paren
id|writer.progress
comma
id|writer.selected_nr
id|i
)paren
suffix:semicolon
)brace
id|bitmap_free
c_func
(paren
id|base
)paren
suffix:semicolon
id|stop_progress
c_func
(paren
op_amp
id|writer.progress
)paren
suffix:semicolon
id|compute_xor_offsets
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Select the commits that will be bitmapped&n; */
DECL|function|next_commit_index
r_static
r_inline
r_int
r_int
id|next_commit_index
c_func
(paren
r_int
r_int
id|idx
)paren
(brace
r_static
r_const
r_int
r_int
id|MIN_COMMITS
op_assign
l_int|100
suffix:semicolon
r_static
r_const
r_int
r_int
id|MAX_COMMITS
op_assign
l_int|5000
suffix:semicolon
r_static
r_const
r_int
r_int
id|MUST_REGION
op_assign
l_int|100
suffix:semicolon
r_static
r_const
r_int
r_int
id|MIN_REGION
op_assign
l_int|20000
suffix:semicolon
r_int
r_int
id|offset
comma
id|next
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_le
id|MUST_REGION
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_le
id|MIN_REGION
)paren
(brace
id|offset
op_assign
id|idx
id|MUST_REGION
suffix:semicolon
r_return
(paren
id|offset
OL
id|MIN_COMMITS
)paren
ques
c_cond
id|offset
suffix:colon
id|MIN_COMMITS
suffix:semicolon
)brace
id|offset
op_assign
id|idx
id|MIN_REGION
suffix:semicolon
id|next
op_assign
(paren
id|offset
OL
id|MAX_COMMITS
)paren
ques
c_cond
id|offset
suffix:colon
id|MAX_COMMITS
suffix:semicolon
r_return
(paren
id|next
OG
id|MIN_COMMITS
)paren
ques
c_cond
id|next
suffix:colon
id|MIN_COMMITS
suffix:semicolon
)brace
DECL|function|date_compare
r_static
r_int
id|date_compare
c_func
(paren
r_const
r_void
op_star
id|_a
comma
r_const
r_void
op_star
id|_b
)paren
(brace
r_struct
id|commit
op_star
id|a
op_assign
op_star
(paren
r_struct
id|commit
op_star
op_star
)paren
id|_a
suffix:semicolon
r_struct
id|commit
op_star
id|b
op_assign
op_star
(paren
r_struct
id|commit
op_star
op_star
)paren
id|_b
suffix:semicolon
r_return
(paren
r_int
)paren
id|b-&gt;date
(paren
r_int
)paren
id|a-&gt;date
suffix:semicolon
)brace
DECL|function|bitmap_writer_reuse_bitmaps
r_void
id|bitmap_writer_reuse_bitmaps
c_func
(paren
r_struct
id|packing_data
op_star
id|to_pack
)paren
(brace
r_if
c_cond
(paren
id|prepare_bitmap_git
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|writer.reused
op_assign
id|kh_init_sha1
c_func
(paren
)paren
suffix:semicolon
id|rebuild_existing_bitmaps
c_func
(paren
id|to_pack
comma
id|writer.reused
comma
id|writer.show_progress
)paren
suffix:semicolon
)brace
DECL|function|find_reused_bitmap
r_static
r_struct
id|ewah_bitmap
op_star
id|find_reused_bitmap
c_func
(paren
r_const
r_int
r_char
op_star
id|sha1
)paren
(brace
id|khiter_t
id|hash_pos
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|writer.reused
)paren
r_return
l_int|NULL
suffix:semicolon
id|hash_pos
op_assign
id|kh_get_sha1
c_func
(paren
id|writer.reused
comma
id|sha1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hash_pos
op_ge
id|kh_end
c_func
(paren
id|writer.reused
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|kh_value
c_func
(paren
id|writer.reused
comma
id|hash_pos
)paren
suffix:semicolon
)brace
DECL|function|bitmap_writer_select_commits
r_void
id|bitmap_writer_select_commits
c_func
(paren
r_struct
id|commit
op_star
op_star
id|indexed_commits
comma
r_int
r_int
id|indexed_commits_nr
comma
r_int
id|max_bitmaps
)paren
(brace
r_int
r_int
id|i
op_assign
l_int|0
comma
id|j
comma
id|next
suffix:semicolon
id|qsort
c_func
(paren
id|indexed_commits
comma
id|indexed_commits_nr
comma
r_sizeof
(paren
id|indexed_commits
(braket
l_int|0
)braket
)paren
comma
id|date_compare
)paren
suffix:semicolon
r_if
c_cond
(paren
id|writer.show_progress
)paren
id|writer.progress
op_assign
id|start_progress
c_func
(paren
l_string|&quot;Selecting bitmap commits&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|indexed_commits_nr
OL
l_int|100
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|indexed_commits_nr
suffix:semicolon
op_increment
id|i
)paren
id|push_bitmapped_commit
c_func
(paren
id|indexed_commits
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|ewah_bitmap
op_star
id|reused_bitmap
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|commit
op_star
id|chosen
op_assign
l_int|NULL
suffix:semicolon
id|next
op_assign
id|next_commit_index
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_plus
id|next
op_ge
id|indexed_commits_nr
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|max_bitmaps
OG
l_int|0
op_logical_and
id|writer.selected_nr
op_ge
id|max_bitmaps
)paren
(brace
id|writer.selected_nr
op_assign
id|max_bitmaps
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|next
op_eq
l_int|0
)paren
(brace
id|chosen
op_assign
id|indexed_commits
(braket
id|i
)braket
suffix:semicolon
id|reused_bitmap
op_assign
id|find_reused_bitmap
c_func
(paren
id|get_object_hash
c_func
(paren
id|chosen-&gt;object
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|chosen
op_assign
id|indexed_commits
(braket
id|i
op_plus
id|next
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|next
suffix:semicolon
op_increment
id|j
)paren
(brace
r_struct
id|commit
op_star
id|cm
op_assign
id|indexed_commits
(braket
id|i
op_plus
id|j
)braket
suffix:semicolon
id|reused_bitmap
op_assign
id|find_reused_bitmap
c_func
(paren
id|get_object_hash
c_func
(paren
id|cm-&gt;object
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reused_bitmap
op_logical_or
(paren
id|cm-&gt;object.flags
op_amp
id|NEEDS_BITMAP
)paren
op_ne
l_int|0
)paren
(brace
id|chosen
op_assign
id|cm
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cm-&gt;parents
op_logical_and
id|cm-&gt;parents-&gt;next
)paren
id|chosen
op_assign
id|cm
suffix:semicolon
)brace
)brace
id|push_bitmapped_commit
c_func
(paren
id|chosen
comma
id|reused_bitmap
)paren
suffix:semicolon
id|i
op_add_assign
id|next
op_plus
l_int|1
suffix:semicolon
id|display_progress
c_func
(paren
id|writer.progress
comma
id|i
)paren
suffix:semicolon
)brace
id|stop_progress
c_func
(paren
op_amp
id|writer.progress
)paren
suffix:semicolon
)brace
DECL|function|sha1write_ewah_helper
r_static
r_int
id|sha1write_ewah_helper
c_func
(paren
r_void
op_star
id|f
comma
r_const
r_void
op_star
id|buf
comma
r_int
id|len
)paren
(brace
multiline_comment|/* sha1write will die on error */
id|sha1write
c_func
(paren
id|f
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/**&n; * Write the bitmap index to disk&n; */
DECL|function|dump_bitmap
r_static
r_inline
r_void
id|dump_bitmap
c_func
(paren
r_struct
id|sha1file
op_star
id|f
comma
r_struct
id|ewah_bitmap
op_star
id|bitmap
)paren
(brace
r_if
c_cond
(paren
id|ewah_serialize_to
c_func
(paren
id|bitmap
comma
id|sha1write_ewah_helper
comma
id|f
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;Failed to write bitmap index&quot;
)paren
suffix:semicolon
)brace
DECL|function|sha1_access
r_static
r_const
r_int
r_char
op_star
id|sha1_access
c_func
(paren
r_int
id|pos
comma
r_void
op_star
id|table
)paren
(brace
r_struct
id|pack_idx_entry
op_star
op_star
id|index
op_assign
id|table
suffix:semicolon
r_return
id|index
(braket
id|pos
)braket
op_member_access_from_pointer
id|sha1
suffix:semicolon
)brace
DECL|function|write_selected_commits_v1
r_static
r_void
id|write_selected_commits_v1
c_func
(paren
r_struct
id|sha1file
op_star
id|f
comma
r_struct
id|pack_idx_entry
op_star
op_star
id|index
comma
r_uint32
id|index_nr
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|writer.selected_nr
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|bitmapped_commit
op_star
id|stored
op_assign
op_amp
id|writer.selected
(braket
id|i
)braket
suffix:semicolon
r_int
id|commit_pos
op_assign
id|sha1_pos
c_func
(paren
id|get_object_hash
c_func
(paren
id|stored-&gt;commit-&gt;object
)paren
comma
id|index
comma
id|index_nr
comma
id|sha1_access
)paren
suffix:semicolon
r_if
c_cond
(paren
id|commit_pos
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;BUG: trying to write commit not in index&quot;
)paren
suffix:semicolon
id|sha1write_be32
c_func
(paren
id|f
comma
id|commit_pos
)paren
suffix:semicolon
id|sha1write_u8
c_func
(paren
id|f
comma
id|stored-&gt;xor_offset
)paren
suffix:semicolon
id|sha1write_u8
c_func
(paren
id|f
comma
id|stored-&gt;flags
)paren
suffix:semicolon
id|dump_bitmap
c_func
(paren
id|f
comma
id|stored-&gt;write_as
)paren
suffix:semicolon
)brace
)brace
DECL|function|write_hash_cache
r_static
r_void
id|write_hash_cache
c_func
(paren
r_struct
id|sha1file
op_star
id|f
comma
r_struct
id|pack_idx_entry
op_star
op_star
id|index
comma
r_uint32
id|index_nr
)paren
(brace
r_uint32
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|index_nr
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|object_entry
op_star
id|entry
op_assign
(paren
r_struct
id|object_entry
op_star
)paren
id|index
(braket
id|i
)braket
suffix:semicolon
r_uint32
id|hash_value
op_assign
id|htonl
c_func
(paren
id|entry-&gt;hash
)paren
suffix:semicolon
id|sha1write
c_func
(paren
id|f
comma
op_amp
id|hash_value
comma
r_sizeof
(paren
id|hash_value
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|bitmap_writer_set_checksum
r_void
id|bitmap_writer_set_checksum
c_func
(paren
r_int
r_char
op_star
id|sha1
)paren
(brace
id|hashcpy
c_func
(paren
id|writer.pack_checksum
comma
id|sha1
)paren
suffix:semicolon
)brace
DECL|function|bitmap_writer_finish
r_void
id|bitmap_writer_finish
c_func
(paren
r_struct
id|pack_idx_entry
op_star
op_star
id|index
comma
r_uint32
id|index_nr
comma
r_const
r_char
op_star
id|filename
comma
r_uint16
id|options
)paren
(brace
r_static
r_char
id|tmp_file
(braket
id|PATH_MAX
)braket
suffix:semicolon
r_static
r_uint16
id|default_version
op_assign
l_int|1
suffix:semicolon
r_static
r_uint16
id|flags
op_assign
id|BITMAP_OPT_FULL_DAG
suffix:semicolon
r_struct
id|sha1file
op_star
id|f
suffix:semicolon
r_struct
id|bitmap_disk_header
id|header
suffix:semicolon
r_int
id|fd
op_assign
id|odb_mkstemp
c_func
(paren
id|tmp_file
comma
r_sizeof
(paren
id|tmp_file
)paren
comma
l_string|&quot;pack/tmp_bitmap_XXXXXX&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
id|die_errno
c_func
(paren
l_string|&quot;unable to create &squot;%s&squot;&quot;
comma
id|tmp_file
)paren
suffix:semicolon
id|f
op_assign
id|sha1fd
c_func
(paren
id|fd
comma
id|tmp_file
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|header.magic
comma
id|BITMAP_IDX_SIGNATURE
comma
r_sizeof
(paren
id|BITMAP_IDX_SIGNATURE
)paren
)paren
suffix:semicolon
id|header.version
op_assign
id|htons
c_func
(paren
id|default_version
)paren
suffix:semicolon
id|header.options
op_assign
id|htons
c_func
(paren
id|flags
op_or
id|options
)paren
suffix:semicolon
id|header.entry_count
op_assign
id|htonl
c_func
(paren
id|writer.selected_nr
)paren
suffix:semicolon
id|hashcpy
c_func
(paren
id|header.checksum
comma
id|writer.pack_checksum
)paren
suffix:semicolon
id|sha1write
c_func
(paren
id|f
comma
op_amp
id|header
comma
r_sizeof
(paren
id|header
)paren
)paren
suffix:semicolon
id|dump_bitmap
c_func
(paren
id|f
comma
id|writer.commits
)paren
suffix:semicolon
id|dump_bitmap
c_func
(paren
id|f
comma
id|writer.trees
)paren
suffix:semicolon
id|dump_bitmap
c_func
(paren
id|f
comma
id|writer.blobs
)paren
suffix:semicolon
id|dump_bitmap
c_func
(paren
id|f
comma
id|writer.tags
)paren
suffix:semicolon
id|write_selected_commits_v1
c_func
(paren
id|f
comma
id|index
comma
id|index_nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|options
op_amp
id|BITMAP_OPT_HASH_CACHE
)paren
id|write_hash_cache
c_func
(paren
id|f
comma
id|index
comma
id|index_nr
)paren
suffix:semicolon
id|sha1close
c_func
(paren
id|f
comma
l_int|NULL
comma
id|CSUM_FSYNC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adjust_shared_perm
c_func
(paren
id|tmp_file
)paren
)paren
id|die_errno
c_func
(paren
l_string|&quot;unable to make temporary bitmap file readable&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rename
c_func
(paren
id|tmp_file
comma
id|filename
)paren
)paren
id|die_errno
c_func
(paren
l_string|&quot;unable to rename temporary bitmap file to &squot;%s&squot;&quot;
comma
id|filename
)paren
suffix:semicolon
)brace
eof
