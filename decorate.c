multiline_comment|/*&n; * decorate.c - decorate a git object with some arbitrary&n; * data.&n; */
macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;object.h&quot;
macro_line|#include &quot;decorate.h&quot;
DECL|function|hash_obj
r_static
r_int
r_int
id|hash_obj
c_func
(paren
r_const
r_struct
id|object
op_star
id|obj
comma
r_int
r_int
id|n
)paren
(brace
r_int
r_int
id|hash
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|obj-&gt;sha1
suffix:semicolon
r_return
id|hash
op_mod
id|n
suffix:semicolon
)brace
DECL|function|insert_decoration
r_static
r_void
op_star
id|insert_decoration
c_func
(paren
r_struct
id|decoration
op_star
id|n
comma
r_const
r_struct
id|object
op_star
id|base
comma
r_void
op_star
id|decoration
)paren
(brace
r_int
id|size
op_assign
id|n-&gt;size
suffix:semicolon
r_struct
id|object_decoration
op_star
id|hash
op_assign
id|n-&gt;hash
suffix:semicolon
r_int
id|j
op_assign
id|hash_obj
c_func
(paren
id|base
comma
id|size
)paren
suffix:semicolon
r_while
c_loop
(paren
id|hash
(braket
id|j
)braket
dot
id|base
)paren
(brace
r_if
c_cond
(paren
id|hash
(braket
id|j
)braket
dot
id|base
op_eq
id|base
)paren
(brace
r_void
op_star
id|old
op_assign
id|hash
(braket
id|j
)braket
dot
id|decoration
suffix:semicolon
id|hash
(braket
id|j
)braket
dot
id|decoration
op_assign
id|decoration
suffix:semicolon
r_return
id|old
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|j
op_ge
id|size
)paren
id|j
op_assign
l_int|0
suffix:semicolon
)brace
id|hash
(braket
id|j
)braket
dot
id|base
op_assign
id|base
suffix:semicolon
id|hash
(braket
id|j
)braket
dot
id|decoration
op_assign
id|decoration
suffix:semicolon
id|n-&gt;nr
op_increment
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|grow_decoration
r_static
r_void
id|grow_decoration
c_func
(paren
r_struct
id|decoration
op_star
id|n
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|old_size
op_assign
id|n-&gt;size
suffix:semicolon
r_struct
id|object_decoration
op_star
id|old_hash
op_assign
id|n-&gt;hash
suffix:semicolon
id|n-&gt;size
op_assign
(paren
id|old_size
op_plus
l_int|1000
)paren
op_star
l_int|3
op_div
l_int|2
suffix:semicolon
id|n-&gt;hash
op_assign
id|xcalloc
c_func
(paren
id|n-&gt;size
comma
r_sizeof
(paren
r_struct
id|object_decoration
)paren
)paren
suffix:semicolon
id|n-&gt;nr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|old_size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_const
r_struct
id|object
op_star
id|base
op_assign
id|old_hash
(braket
id|i
)braket
dot
id|base
suffix:semicolon
r_void
op_star
id|decoration
op_assign
id|old_hash
(braket
id|i
)braket
dot
id|decoration
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
r_continue
suffix:semicolon
id|insert_decoration
c_func
(paren
id|n
comma
id|base
comma
id|decoration
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|old_hash
)paren
suffix:semicolon
)brace
multiline_comment|/* Add a decoration pointer, return any old one */
DECL|function|add_decoration
r_void
op_star
id|add_decoration
c_func
(paren
r_struct
id|decoration
op_star
id|n
comma
r_const
r_struct
id|object
op_star
id|obj
comma
r_void
op_star
id|decoration
)paren
(brace
r_int
id|nr
op_assign
id|n-&gt;nr
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|nr
OG
id|n-&gt;size
op_star
l_int|2
op_div
l_int|3
)paren
id|grow_decoration
c_func
(paren
id|n
)paren
suffix:semicolon
r_return
id|insert_decoration
c_func
(paren
id|n
comma
id|obj
comma
id|decoration
)paren
suffix:semicolon
)brace
multiline_comment|/* Lookup a decoration pointer */
DECL|function|lookup_decoration
r_void
op_star
id|lookup_decoration
c_func
(paren
r_struct
id|decoration
op_star
id|n
comma
r_const
r_struct
id|object
op_star
id|obj
)paren
(brace
r_int
id|j
suffix:semicolon
multiline_comment|/* nothing to lookup */
r_if
c_cond
(paren
op_logical_neg
id|n-&gt;size
)paren
r_return
l_int|NULL
suffix:semicolon
id|j
op_assign
id|hash_obj
c_func
(paren
id|obj
comma
id|n-&gt;size
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|object_decoration
op_star
id|ref
op_assign
id|n-&gt;hash
op_plus
id|j
suffix:semicolon
r_if
c_cond
(paren
id|ref-&gt;base
op_eq
id|obj
)paren
r_return
id|ref-&gt;decoration
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ref-&gt;base
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|j
op_eq
id|n-&gt;size
)paren
id|j
op_assign
l_int|0
suffix:semicolon
)brace
)brace
eof
