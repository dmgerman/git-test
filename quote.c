macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;quote.h&quot;
multiline_comment|/* Help to copy the thing properly quoted for the shell safety.&n; * any single quote is replaced with &squot;&bslash;&squot;&squot;, any exclamation point&n; * is replaced with &squot;&bslash;!&squot;, and the whole thing is enclosed in a&n; *&n; * E.g.&n; *  original     sq_quote     result&n; *  name     ==&gt; name      ==&gt; &squot;name&squot;&n; *  a b      ==&gt; a b       ==&gt; &squot;a b&squot;&n; *  a&squot;b      ==&gt; a&squot;&bslash;&squot;&squot;b    ==&gt; &squot;a&squot;&bslash;&squot;&squot;b&squot;&n; *  a!b      ==&gt; a&squot;&bslash;!&squot;b    ==&gt; &squot;a&squot;&bslash;!&squot;b&squot;&n; */
DECL|macro|EMIT
mdefine_line|#define EMIT(x) ( (++len &lt; n) &amp;&amp; (*bp++ = (x)) )
DECL|function|sq_quote_buf
r_int
id|sq_quote_buf
c_func
(paren
r_char
op_star
id|dst
comma
r_int
id|n
comma
r_const
r_char
op_star
id|src
)paren
(brace
r_char
id|c
suffix:semicolon
r_char
op_star
id|bp
op_assign
id|dst
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|EMIT
c_func
(paren
l_char|&squot;&bslash;&squot;&squot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
op_star
id|src
op_increment
)paren
)paren
(brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;&bslash;&squot;&squot;
op_logical_or
id|c
op_eq
l_char|&squot;!&squot;
)paren
(brace
id|EMIT
c_func
(paren
l_char|&squot;&bslash;&squot;&squot;
)paren
suffix:semicolon
id|EMIT
c_func
(paren
l_char|&squot;&bslash;&bslash;&squot;
)paren
suffix:semicolon
id|EMIT
c_func
(paren
id|c
)paren
suffix:semicolon
id|EMIT
c_func
(paren
l_char|&squot;&bslash;&squot;&squot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|EMIT
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
)brace
id|EMIT
c_func
(paren
l_char|&squot;&bslash;&squot;&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
)paren
op_star
id|bp
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|sq_quote
r_char
op_star
id|sq_quote
c_func
(paren
r_const
r_char
op_star
id|src
)paren
(brace
r_char
op_star
id|buf
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|cnt
op_assign
id|sq_quote_buf
c_func
(paren
l_int|NULL
comma
l_int|0
comma
id|src
)paren
op_plus
l_int|1
suffix:semicolon
id|buf
op_assign
id|xmalloc
c_func
(paren
id|cnt
)paren
suffix:semicolon
id|sq_quote_buf
c_func
(paren
id|buf
comma
id|cnt
comma
id|src
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
eof
