multiline_comment|/*&n; * csum-file.c&n; *&n; * Copyright (C) 2005 Linus Torvalds&n; *&n; * Simple file write infrastructure for writing SHA1-summed&n; * files. Useful when you write a file that you want to be&n; * able to verify hasn&squot;t been messed with afterwards.&n; */
macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;csum-file.h&quot;
DECL|function|sha1flush
r_static
r_int
id|sha1flush
c_func
(paren
r_struct
id|sha1file
op_star
id|f
comma
r_int
r_int
id|count
)paren
(brace
r_void
op_star
id|buf
op_assign
id|f-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
id|ret
op_assign
id|write
c_func
(paren
id|f-&gt;fd
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|buf
op_add_assign
id|ret
suffix:semicolon
id|count
op_sub_assign
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
r_continue
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|die
c_func
(paren
l_string|&quot;sha1 file &squot;%s&squot; write error. Out of diskspace&quot;
comma
id|f-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errno
op_eq
id|EAGAIN
op_logical_or
id|errno
op_eq
id|EINTR
)paren
r_continue
suffix:semicolon
id|die
c_func
(paren
l_string|&quot;sha1 file &squot;%s&squot; write error (%s)&quot;
comma
id|f-&gt;name
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|sha1close
r_int
id|sha1close
c_func
(paren
r_struct
id|sha1file
op_star
id|f
comma
r_int
r_char
op_star
id|result
comma
r_int
id|update
)paren
(brace
r_int
id|offset
op_assign
id|f-&gt;offset
suffix:semicolon
r_if
c_cond
(paren
id|offset
)paren
(brace
id|SHA1_Update
c_func
(paren
op_amp
id|f-&gt;ctx
comma
id|f-&gt;buffer
comma
id|offset
)paren
suffix:semicolon
id|sha1flush
c_func
(paren
id|f
comma
id|offset
)paren
suffix:semicolon
)brace
id|SHA1_Final
c_func
(paren
id|f-&gt;buffer
comma
op_amp
id|f-&gt;ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|memcpy
c_func
(paren
id|result
comma
id|f-&gt;buffer
comma
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update
)paren
id|sha1flush
c_func
(paren
id|f
comma
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|close
c_func
(paren
id|f-&gt;fd
)paren
)paren
id|die
c_func
(paren
l_string|&quot;%s: sha1 file error on close (%s)&quot;
comma
id|f-&gt;name
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sha1write
r_int
id|sha1write
c_func
(paren
r_struct
id|sha1file
op_star
id|f
comma
r_void
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_while
c_loop
(paren
id|count
)paren
(brace
r_int
id|offset
op_assign
id|f-&gt;offset
suffix:semicolon
r_int
id|left
op_assign
r_sizeof
(paren
id|f-&gt;buffer
)paren
id|offset
suffix:semicolon
r_int
id|nr
op_assign
id|count
OG
id|left
ques
c_cond
id|left
suffix:colon
id|count
suffix:semicolon
id|memcpy
c_func
(paren
id|f-&gt;buffer
op_plus
id|offset
comma
id|buf
comma
id|nr
)paren
suffix:semicolon
id|count
op_sub_assign
id|nr
suffix:semicolon
id|offset
op_add_assign
id|nr
suffix:semicolon
id|buf
op_add_assign
id|nr
suffix:semicolon
id|left
op_sub_assign
id|nr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|left
)paren
(brace
id|SHA1_Update
c_func
(paren
op_amp
id|f-&gt;ctx
comma
id|f-&gt;buffer
comma
id|offset
)paren
suffix:semicolon
id|sha1flush
c_func
(paren
id|f
comma
id|offset
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
id|f-&gt;offset
op_assign
id|offset
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sha1create
r_struct
id|sha1file
op_star
id|sha1create
c_func
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_struct
id|sha1file
op_star
id|f
suffix:semicolon
r_int
id|len
suffix:semicolon
id|va_list
id|arg
suffix:semicolon
r_int
id|fd
suffix:semicolon
id|f
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|f
)paren
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|arg
comma
id|fmt
)paren
suffix:semicolon
id|len
op_assign
id|vsnprintf
c_func
(paren
id|f-&gt;name
comma
r_sizeof
(paren
id|f-&gt;name
)paren
comma
id|fmt
comma
id|arg
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|PATH_MAX
)paren
id|die
c_func
(paren
l_string|&quot;you wascally wabbit, you&quot;
)paren
suffix:semicolon
id|f-&gt;namelen
op_assign
id|len
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|f-&gt;name
comma
id|O_CREAT
op_or
id|O_EXCL
op_or
id|O_WRONLY
comma
l_int|0644
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to open %s (%s)&quot;
comma
id|f-&gt;name
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
id|f-&gt;fd
op_assign
id|fd
suffix:semicolon
id|f-&gt;error
op_assign
l_int|0
suffix:semicolon
id|f-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|SHA1_Init
c_func
(paren
op_amp
id|f-&gt;ctx
)paren
suffix:semicolon
r_return
id|f
suffix:semicolon
)brace
DECL|function|sha1fd
r_struct
id|sha1file
op_star
id|sha1fd
c_func
(paren
r_int
id|fd
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|sha1file
op_star
id|f
suffix:semicolon
r_int
id|len
suffix:semicolon
id|f
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|f
)paren
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|PATH_MAX
)paren
id|die
c_func
(paren
l_string|&quot;you wascally wabbit, you&quot;
)paren
suffix:semicolon
id|f-&gt;namelen
op_assign
id|len
suffix:semicolon
id|memcpy
c_func
(paren
id|f-&gt;name
comma
id|name
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|f-&gt;fd
op_assign
id|fd
suffix:semicolon
id|f-&gt;error
op_assign
l_int|0
suffix:semicolon
id|f-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|SHA1_Init
c_func
(paren
op_amp
id|f-&gt;ctx
)paren
suffix:semicolon
r_return
id|f
suffix:semicolon
)brace
DECL|function|sha1write_compressed
r_int
id|sha1write_compressed
c_func
(paren
r_struct
id|sha1file
op_star
id|f
comma
r_void
op_star
id|in
comma
r_int
r_int
id|size
)paren
(brace
id|z_stream
id|stream
suffix:semicolon
r_int
r_int
id|maxsize
suffix:semicolon
r_void
op_star
id|out
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|stream
comma
l_int|0
comma
r_sizeof
(paren
id|stream
)paren
)paren
suffix:semicolon
id|deflateInit
c_func
(paren
op_amp
id|stream
comma
id|Z_DEFAULT_COMPRESSION
)paren
suffix:semicolon
id|maxsize
op_assign
id|deflateBound
c_func
(paren
op_amp
id|stream
comma
id|size
)paren
suffix:semicolon
id|out
op_assign
id|xmalloc
c_func
(paren
id|maxsize
)paren
suffix:semicolon
multiline_comment|/* Compress it */
id|stream.next_in
op_assign
id|in
suffix:semicolon
id|stream.avail_in
op_assign
id|size
suffix:semicolon
id|stream.next_out
op_assign
id|out
suffix:semicolon
id|stream.avail_out
op_assign
id|maxsize
suffix:semicolon
r_while
c_loop
(paren
id|deflate
c_func
(paren
op_amp
id|stream
comma
id|Z_FINISH
)paren
op_eq
id|Z_OK
)paren
multiline_comment|/* nothing */
suffix:semicolon
id|deflateEnd
c_func
(paren
op_amp
id|stream
)paren
suffix:semicolon
id|size
op_assign
id|stream.total_out
suffix:semicolon
id|sha1write
c_func
(paren
id|f
comma
id|out
comma
id|size
)paren
suffix:semicolon
id|free
c_func
(paren
id|out
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
eof
