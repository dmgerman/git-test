macro_line|#include &quot;git-compat-util.h&quot;
macro_line|#include &quot;http.h&quot;
macro_line|#include &quot;pack.h&quot;
macro_line|#include &quot;sideband.h&quot;
macro_line|#include &quot;run-command.h&quot;
macro_line|#include &quot;url.h&quot;
macro_line|#include &quot;urlmatch.h&quot;
macro_line|#include &quot;credential.h&quot;
macro_line|#include &quot;version.h&quot;
macro_line|#include &quot;pkt-line.h&quot;
macro_line|#include &quot;gettext.h&quot;
DECL|variable|active_requests
r_int
id|active_requests
suffix:semicolon
DECL|variable|http_is_verbose
r_int
id|http_is_verbose
suffix:semicolon
DECL|variable|http_post_buffer
r_int
id|http_post_buffer
op_assign
l_int|16
op_star
id|LARGE_PACKET_MAX
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070a06
DECL|macro|LIBCURL_CAN_HANDLE_AUTH_ANY
mdefine_line|#define LIBCURL_CAN_HANDLE_AUTH_ANY
macro_line|#endif
DECL|variable|min_curl_sessions
r_static
r_int
id|min_curl_sessions
op_assign
l_int|1
suffix:semicolon
DECL|variable|curl_session_count
r_static
r_int
id|curl_session_count
suffix:semicolon
macro_line|#ifdef USE_CURL_MULTI
DECL|variable|max_requests
r_static
r_int
id|max_requests
op_assign
l_int|1
suffix:semicolon
DECL|variable|curlm
r_static
id|CURLM
op_star
id|curlm
suffix:semicolon
macro_line|#endif
macro_line|#ifndef NO_CURL_EASY_DUPHANDLE
DECL|variable|curl_default
r_static
id|CURL
op_star
id|curl_default
suffix:semicolon
macro_line|#endif
DECL|macro|PREV_BUF_SIZE
mdefine_line|#define PREV_BUF_SIZE 4096
DECL|macro|RANGE_HEADER_SIZE
mdefine_line|#define RANGE_HEADER_SIZE 30
DECL|variable|curl_errorstr
r_char
id|curl_errorstr
(braket
id|CURL_ERROR_SIZE
)braket
suffix:semicolon
DECL|variable|curl_ssl_verify
r_static
r_int
id|curl_ssl_verify
op_assign
l_int|1
suffix:semicolon
DECL|variable|curl_ssl_try
r_static
r_int
id|curl_ssl_try
suffix:semicolon
DECL|variable|ssl_cert
r_static
r_const
r_char
op_star
id|ssl_cert
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070903
DECL|variable|ssl_key
r_static
r_const
r_char
op_star
id|ssl_key
suffix:semicolon
macro_line|#endif
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070908
DECL|variable|ssl_capath
r_static
r_const
r_char
op_star
id|ssl_capath
suffix:semicolon
macro_line|#endif
DECL|variable|ssl_cainfo
r_static
r_const
r_char
op_star
id|ssl_cainfo
suffix:semicolon
DECL|variable|curl_low_speed_limit
r_static
r_int
id|curl_low_speed_limit
op_assign
l_int|1
suffix:semicolon
DECL|variable|curl_low_speed_time
r_static
r_int
id|curl_low_speed_time
op_assign
l_int|1
suffix:semicolon
DECL|variable|curl_ftp_no_epsv
r_static
r_int
id|curl_ftp_no_epsv
suffix:semicolon
DECL|variable|curl_http_proxy
r_static
r_const
r_char
op_star
id|curl_http_proxy
suffix:semicolon
DECL|variable|curl_cookie_file
r_static
r_const
r_char
op_star
id|curl_cookie_file
suffix:semicolon
DECL|variable|curl_save_cookies
r_static
r_int
id|curl_save_cookies
suffix:semicolon
DECL|variable|http_auth
r_struct
id|credential
id|http_auth
op_assign
id|CREDENTIAL_INIT
suffix:semicolon
DECL|variable|http_proactive_auth
r_static
r_int
id|http_proactive_auth
suffix:semicolon
DECL|variable|user_agent
r_static
r_const
r_char
op_star
id|user_agent
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x071700
multiline_comment|/* Use CURLOPT_KEYPASSWD as is */
macro_line|#elif LIBCURL_VERSION_NUM &gt;= 0x070903
DECL|macro|CURLOPT_KEYPASSWD
mdefine_line|#define CURLOPT_KEYPASSWD CURLOPT_SSLKEYPASSWD
macro_line|#else
DECL|macro|CURLOPT_KEYPASSWD
mdefine_line|#define CURLOPT_KEYPASSWD CURLOPT_SSLCERTPASSWD
macro_line|#endif
DECL|variable|cert_auth
r_static
r_struct
id|credential
id|cert_auth
op_assign
id|CREDENTIAL_INIT
suffix:semicolon
DECL|variable|ssl_cert_password_required
r_static
r_int
id|ssl_cert_password_required
suffix:semicolon
macro_line|#ifdef LIBCURL_CAN_HANDLE_AUTH_ANY
DECL|variable|http_auth_methods
r_static
r_int
r_int
id|http_auth_methods
op_assign
id|CURLAUTH_ANY
suffix:semicolon
macro_line|#endif
DECL|variable|pragma_header
r_static
r_struct
id|curl_slist
op_star
id|pragma_header
suffix:semicolon
DECL|variable|no_pragma_header
r_static
r_struct
id|curl_slist
op_star
id|no_pragma_header
suffix:semicolon
DECL|variable|active_queue_head
r_static
r_struct
id|active_request_slot
op_star
id|active_queue_head
suffix:semicolon
DECL|variable|cached_accept_language
r_static
r_char
op_star
id|cached_accept_language
suffix:semicolon
DECL|function|fread_buffer
r_int
id|fread_buffer
c_func
(paren
r_char
op_star
id|ptr
comma
r_int
id|eltsize
comma
r_int
id|nmemb
comma
r_void
op_star
id|buffer_
)paren
(brace
r_int
id|size
op_assign
id|eltsize
op_star
id|nmemb
suffix:semicolon
r_struct
id|buffer
op_star
id|buffer
op_assign
id|buffer_
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|buffer-&gt;buf.len
id|buffer-&gt;posn
)paren
id|size
op_assign
id|buffer-&gt;buf.len
id|buffer-&gt;posn
suffix:semicolon
id|memcpy
c_func
(paren
id|ptr
comma
id|buffer-&gt;buf.buf
op_plus
id|buffer-&gt;posn
comma
id|size
)paren
suffix:semicolon
id|buffer-&gt;posn
op_add_assign
id|size
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
macro_line|#ifndef NO_CURL_IOCTL
DECL|function|ioctl_buffer
id|curlioerr
id|ioctl_buffer
c_func
(paren
id|CURL
op_star
id|handle
comma
r_int
id|cmd
comma
r_void
op_star
id|clientp
)paren
(brace
r_struct
id|buffer
op_star
id|buffer
op_assign
id|clientp
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CURLIOCMD_NOP
suffix:colon
r_return
id|CURLIOE_OK
suffix:semicolon
r_case
id|CURLIOCMD_RESTARTREAD
suffix:colon
id|buffer-&gt;posn
op_assign
l_int|0
suffix:semicolon
r_return
id|CURLIOE_OK
suffix:semicolon
r_default
suffix:colon
r_return
id|CURLIOE_UNKNOWNCMD
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|fwrite_buffer
r_int
id|fwrite_buffer
c_func
(paren
r_char
op_star
id|ptr
comma
r_int
id|eltsize
comma
r_int
id|nmemb
comma
r_void
op_star
id|buffer_
)paren
(brace
r_int
id|size
op_assign
id|eltsize
op_star
id|nmemb
suffix:semicolon
r_struct
id|strbuf
op_star
id|buffer
op_assign
id|buffer_
suffix:semicolon
id|strbuf_add
c_func
(paren
id|buffer
comma
id|ptr
comma
id|size
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
DECL|function|fwrite_null
r_int
id|fwrite_null
c_func
(paren
r_char
op_star
id|ptr
comma
r_int
id|eltsize
comma
r_int
id|nmemb
comma
r_void
op_star
id|strbuf
)paren
(brace
r_return
id|eltsize
op_star
id|nmemb
suffix:semicolon
)brace
DECL|function|closedown_active_slot
r_static
r_void
id|closedown_active_slot
c_func
(paren
r_struct
id|active_request_slot
op_star
id|slot
)paren
(brace
id|active_requests
op_decrement
suffix:semicolon
id|slot-&gt;in_use
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|finish_active_slot
r_static
r_void
id|finish_active_slot
c_func
(paren
r_struct
id|active_request_slot
op_star
id|slot
)paren
(brace
id|closedown_active_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
id|curl_easy_getinfo
c_func
(paren
id|slot-&gt;curl
comma
id|CURLINFO_HTTP_CODE
comma
op_amp
id|slot-&gt;http_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;finished
op_ne
l_int|NULL
)paren
(paren
op_star
id|slot-&gt;finished
)paren
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Store slot results so they can be read after the slot is reused */
r_if
c_cond
(paren
id|slot-&gt;results
op_ne
l_int|NULL
)paren
(brace
id|slot-&gt;results-&gt;curl_result
op_assign
id|slot-&gt;curl_result
suffix:semicolon
id|slot-&gt;results-&gt;http_code
op_assign
id|slot-&gt;http_code
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070a08
id|curl_easy_getinfo
c_func
(paren
id|slot-&gt;curl
comma
id|CURLINFO_HTTPAUTH_AVAIL
comma
op_amp
id|slot-&gt;results-&gt;auth_avail
)paren
suffix:semicolon
macro_line|#else
id|slot-&gt;results-&gt;auth_avail
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Run callback if appropriate */
r_if
c_cond
(paren
id|slot-&gt;callback_func
op_ne
l_int|NULL
)paren
id|slot
op_member_access_from_pointer
id|callback_func
c_func
(paren
id|slot-&gt;callback_data
)paren
suffix:semicolon
)brace
macro_line|#ifdef USE_CURL_MULTI
DECL|function|process_curl_messages
r_static
r_void
id|process_curl_messages
c_func
(paren
r_void
)paren
(brace
r_int
id|num_messages
suffix:semicolon
r_struct
id|active_request_slot
op_star
id|slot
suffix:semicolon
id|CURLMsg
op_star
id|curl_message
op_assign
id|curl_multi_info_read
c_func
(paren
id|curlm
comma
op_amp
id|num_messages
)paren
suffix:semicolon
r_while
c_loop
(paren
id|curl_message
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|curl_message-&gt;msg
op_eq
id|CURLMSG_DONE
)paren
(brace
r_int
id|curl_result
op_assign
id|curl_message-&gt;data.result
suffix:semicolon
id|slot
op_assign
id|active_queue_head
suffix:semicolon
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
op_logical_and
id|slot-&gt;curl
op_ne
id|curl_message-&gt;easy_handle
)paren
id|slot
op_assign
id|slot-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_ne
l_int|NULL
)paren
(brace
id|curl_multi_remove_handle
c_func
(paren
id|curlm
comma
id|slot-&gt;curl
)paren
suffix:semicolon
id|slot-&gt;curl_result
op_assign
id|curl_result
suffix:semicolon
id|finish_active_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
r_else
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Received DONE message for unknown request!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Unknown CURL message received: %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|curl_message-&gt;msg
)paren
suffix:semicolon
)brace
id|curl_message
op_assign
id|curl_multi_info_read
c_func
(paren
id|curlm
comma
op_amp
id|num_messages
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|http_options
r_static
r_int
id|http_options
c_func
(paren
r_const
r_char
op_star
id|var
comma
r_const
r_char
op_star
id|value
comma
r_void
op_star
id|cb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.sslverify&quot;
comma
id|var
)paren
)paren
(brace
id|curl_ssl_verify
op_assign
id|git_config_bool
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.sslcert&quot;
comma
id|var
)paren
)paren
r_return
id|git_config_string
c_func
(paren
op_amp
id|ssl_cert
comma
id|var
comma
id|value
)paren
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070903
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.sslkey&quot;
comma
id|var
)paren
)paren
r_return
id|git_config_string
c_func
(paren
op_amp
id|ssl_key
comma
id|var
comma
id|value
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070908
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.sslcapath&quot;
comma
id|var
)paren
)paren
r_return
id|git_config_string
c_func
(paren
op_amp
id|ssl_capath
comma
id|var
comma
id|value
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.sslcainfo&quot;
comma
id|var
)paren
)paren
r_return
id|git_config_string
c_func
(paren
op_amp
id|ssl_cainfo
comma
id|var
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.sslcertpasswordprotected&quot;
comma
id|var
)paren
)paren
(brace
id|ssl_cert_password_required
op_assign
id|git_config_bool
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.ssltry&quot;
comma
id|var
)paren
)paren
(brace
id|curl_ssl_try
op_assign
id|git_config_bool
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.minsessions&quot;
comma
id|var
)paren
)paren
(brace
id|min_curl_sessions
op_assign
id|git_config_int
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
macro_line|#ifndef USE_CURL_MULTI
r_if
c_cond
(paren
id|min_curl_sessions
OG
l_int|1
)paren
id|min_curl_sessions
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef USE_CURL_MULTI
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.maxrequests&quot;
comma
id|var
)paren
)paren
(brace
id|max_requests
op_assign
id|git_config_int
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.lowspeedlimit&quot;
comma
id|var
)paren
)paren
(brace
id|curl_low_speed_limit
op_assign
(paren
r_int
)paren
id|git_config_int
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.lowspeedtime&quot;
comma
id|var
)paren
)paren
(brace
id|curl_low_speed_time
op_assign
(paren
r_int
)paren
id|git_config_int
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.noepsv&quot;
comma
id|var
)paren
)paren
(brace
id|curl_ftp_no_epsv
op_assign
id|git_config_bool
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.proxy&quot;
comma
id|var
)paren
)paren
r_return
id|git_config_string
c_func
(paren
op_amp
id|curl_http_proxy
comma
id|var
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.cookiefile&quot;
comma
id|var
)paren
)paren
r_return
id|git_config_string
c_func
(paren
op_amp
id|curl_cookie_file
comma
id|var
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.savecookies&quot;
comma
id|var
)paren
)paren
(brace
id|curl_save_cookies
op_assign
id|git_config_bool
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.postbuffer&quot;
comma
id|var
)paren
)paren
(brace
id|http_post_buffer
op_assign
id|git_config_int
c_func
(paren
id|var
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|http_post_buffer
OL
id|LARGE_PACKET_MAX
)paren
id|http_post_buffer
op_assign
id|LARGE_PACKET_MAX
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;http.useragent&quot;
comma
id|var
)paren
)paren
r_return
id|git_config_string
c_func
(paren
op_amp
id|user_agent
comma
id|var
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Fall back on the default ones */
r_return
id|git_default_config
c_func
(paren
id|var
comma
id|value
comma
id|cb
)paren
suffix:semicolon
)brace
DECL|function|init_curl_http_auth
r_static
r_void
id|init_curl_http_auth
c_func
(paren
id|CURL
op_star
id|result
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|http_auth.username
)paren
r_return
suffix:semicolon
id|credential_fill
c_func
(paren
op_amp
id|http_auth
)paren
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x071301
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_USERNAME
comma
id|http_auth.username
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_PASSWORD
comma
id|http_auth.password
)paren
suffix:semicolon
macro_line|#else
(brace
r_static
r_struct
id|strbuf
id|up
op_assign
id|STRBUF_INIT
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Note that we assume we only ever have a single set of&n;&t;&t; * credentials in a given program run, so we do not have&n;&t;&t; * to worry about updating this buffer, only setting its&n;&t;&t; * initial value.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|up.len
)paren
id|strbuf_addf
c_func
(paren
op_amp
id|up
comma
l_string|&quot;%s:%s&quot;
comma
id|http_auth.username
comma
id|http_auth.password
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_USERPWD
comma
id|up.buf
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|has_cert_password
r_static
r_int
id|has_cert_password
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ssl_cert
op_eq
l_int|NULL
op_logical_or
id|ssl_cert_password_required
op_ne
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cert_auth.password
)paren
(brace
id|cert_auth.protocol
op_assign
id|xstrdup
c_func
(paren
l_string|&quot;cert&quot;
)paren
suffix:semicolon
id|cert_auth.username
op_assign
id|xstrdup
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
id|cert_auth.path
op_assign
id|xstrdup
c_func
(paren
id|ssl_cert
)paren
suffix:semicolon
id|credential_fill
c_func
(paren
op_amp
id|cert_auth
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x071900
DECL|function|set_curl_keepalive
r_static
r_void
id|set_curl_keepalive
c_func
(paren
id|CURL
op_star
id|c
)paren
(brace
id|curl_easy_setopt
c_func
(paren
id|c
comma
id|CURLOPT_TCP_KEEPALIVE
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#elif LIBCURL_VERSION_NUM &gt;= 0x071000
DECL|function|sockopt_callback
r_static
r_int
id|sockopt_callback
c_func
(paren
r_void
op_star
id|client
comma
id|curl_socket_t
id|fd
comma
id|curlsocktype
id|type
)paren
(brace
r_int
id|ka
op_assign
l_int|1
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|socklen_t
id|len
op_assign
(paren
id|socklen_t
)paren
r_sizeof
(paren
id|ka
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
id|CURLSOCKTYPE_IPCXN
)paren
r_return
l_int|0
suffix:semicolon
id|rc
op_assign
id|setsockopt
c_func
(paren
id|fd
comma
id|SOL_SOCKET
comma
id|SO_KEEPALIVE
comma
(paren
r_void
op_star
)paren
op_amp
id|ka
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|warning
c_func
(paren
l_string|&quot;unable to set SO_KEEPALIVE on socket %s&quot;
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* CURL_SOCKOPT_OK only exists since curl 7.21.5 */
)brace
DECL|function|set_curl_keepalive
r_static
r_void
id|set_curl_keepalive
c_func
(paren
id|CURL
op_star
id|c
)paren
(brace
id|curl_easy_setopt
c_func
(paren
id|c
comma
id|CURLOPT_SOCKOPTFUNCTION
comma
id|sockopt_callback
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|set_curl_keepalive
r_static
r_void
id|set_curl_keepalive
c_func
(paren
id|CURL
op_star
id|c
)paren
(brace
multiline_comment|/* not supported on older curl versions */
)brace
macro_line|#endif
DECL|function|get_curl_handle
r_static
id|CURL
op_star
id|get_curl_handle
c_func
(paren
r_void
)paren
(brace
id|CURL
op_star
id|result
op_assign
id|curl_easy_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|die
c_func
(paren
l_string|&quot;curl_easy_init failed&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|curl_ssl_verify
)paren
(brace
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_SSL_VERIFYPEER
comma
l_int|0
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_SSL_VERIFYHOST
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Verify authenticity of the peer&squot;s certificate */
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_SSL_VERIFYPEER
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* The name in the cert must match whom we tried to connect */
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_SSL_VERIFYHOST
comma
l_int|2
)paren
suffix:semicolon
)brace
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070907
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_NETRC
comma
id|CURL_NETRC_OPTIONAL
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef LIBCURL_CAN_HANDLE_AUTH_ANY
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_HTTPAUTH
comma
id|CURLAUTH_ANY
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|http_proactive_auth
)paren
id|init_curl_http_auth
c_func
(paren
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ssl_cert
op_ne
l_int|NULL
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_SSLCERT
comma
id|ssl_cert
)paren
suffix:semicolon
r_if
c_cond
(paren
id|has_cert_password
c_func
(paren
)paren
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_KEYPASSWD
comma
id|cert_auth.password
)paren
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070903
r_if
c_cond
(paren
id|ssl_key
op_ne
l_int|NULL
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_SSLKEY
comma
id|ssl_key
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070908
r_if
c_cond
(paren
id|ssl_capath
op_ne
l_int|NULL
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_CAPATH
comma
id|ssl_capath
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ssl_cainfo
op_ne
l_int|NULL
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_CAINFO
comma
id|ssl_cainfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curl_low_speed_limit
OG
l_int|0
op_logical_and
id|curl_low_speed_time
OG
l_int|0
)paren
(brace
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_LOW_SPEED_LIMIT
comma
id|curl_low_speed_limit
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_LOW_SPEED_TIME
comma
id|curl_low_speed_time
)paren
suffix:semicolon
)brace
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_FOLLOWLOCATION
comma
l_int|1
)paren
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x071301
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_POSTREDIR
comma
id|CURL_REDIR_POST_ALL
)paren
suffix:semicolon
macro_line|#elif LIBCURL_VERSION_NUM &gt;= 0x071101
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_POST301
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|getenv
c_func
(paren
l_string|&quot;GIT_CURL_VERBOSE&quot;
)paren
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_VERBOSE
comma
l_int|1
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_USERAGENT
comma
id|user_agent
ques
c_cond
id|user_agent
suffix:colon
id|git_user_agent
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curl_ftp_no_epsv
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_FTP_USE_EPSV
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CURLOPT_USE_SSL
r_if
c_cond
(paren
id|curl_ssl_try
)paren
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_USE_SSL
comma
id|CURLUSESSL_TRY
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|curl_http_proxy
)paren
(brace
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_PROXY
comma
id|curl_http_proxy
)paren
suffix:semicolon
)brace
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070a07
id|curl_easy_setopt
c_func
(paren
id|result
comma
id|CURLOPT_PROXYAUTH
comma
id|CURLAUTH_ANY
)paren
suffix:semicolon
macro_line|#endif
id|set_curl_keepalive
c_func
(paren
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|set_from_env
r_static
r_void
id|set_from_env
c_func
(paren
r_const
r_char
op_star
op_star
id|var
comma
r_const
r_char
op_star
id|envname
)paren
(brace
r_const
r_char
op_star
id|val
op_assign
id|getenv
c_func
(paren
id|envname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
op_star
id|var
op_assign
id|val
suffix:semicolon
)brace
DECL|function|http_init
r_void
id|http_init
c_func
(paren
r_struct
id|remote
op_star
id|remote
comma
r_const
r_char
op_star
id|url
comma
r_int
id|proactive_auth
)paren
(brace
r_char
op_star
id|low_speed_limit
suffix:semicolon
r_char
op_star
id|low_speed_time
suffix:semicolon
r_char
op_star
id|normalized_url
suffix:semicolon
r_struct
id|urlmatch_config
id|config
op_assign
(brace
id|STRING_LIST_INIT_DUP
)brace
suffix:semicolon
id|config.section
op_assign
l_string|&quot;http&quot;
suffix:semicolon
id|config.key
op_assign
l_int|NULL
suffix:semicolon
id|config.collect_fn
op_assign
id|http_options
suffix:semicolon
id|config.cascade_fn
op_assign
id|git_default_config
suffix:semicolon
id|config.cb
op_assign
l_int|NULL
suffix:semicolon
id|http_is_verbose
op_assign
l_int|0
suffix:semicolon
id|normalized_url
op_assign
id|url_normalize
c_func
(paren
id|url
comma
op_amp
id|config.url
)paren
suffix:semicolon
id|git_config
c_func
(paren
id|urlmatch_config_entry
comma
op_amp
id|config
)paren
suffix:semicolon
id|free
c_func
(paren
id|normalized_url
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curl_global_init
c_func
(paren
id|CURL_GLOBAL_ALL
)paren
op_ne
id|CURLE_OK
)paren
id|die
c_func
(paren
l_string|&quot;curl_global_init failed&quot;
)paren
suffix:semicolon
id|http_proactive_auth
op_assign
id|proactive_auth
suffix:semicolon
r_if
c_cond
(paren
id|remote
op_logical_and
id|remote-&gt;http_proxy
)paren
id|curl_http_proxy
op_assign
id|xstrdup
c_func
(paren
id|remote-&gt;http_proxy
)paren
suffix:semicolon
id|pragma_header
op_assign
id|curl_slist_append
c_func
(paren
id|pragma_header
comma
l_string|&quot;Pragma: no-cache&quot;
)paren
suffix:semicolon
id|no_pragma_header
op_assign
id|curl_slist_append
c_func
(paren
id|no_pragma_header
comma
l_string|&quot;Pragma:&quot;
)paren
suffix:semicolon
macro_line|#ifdef USE_CURL_MULTI
(brace
r_char
op_star
id|http_max_requests
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_HTTP_MAX_REQUESTS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|http_max_requests
op_ne
l_int|NULL
)paren
id|max_requests
op_assign
id|atoi
c_func
(paren
id|http_max_requests
)paren
suffix:semicolon
)brace
id|curlm
op_assign
id|curl_multi_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|curlm
)paren
id|die
c_func
(paren
l_string|&quot;curl_multi_init failed&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|getenv
c_func
(paren
l_string|&quot;GIT_SSL_NO_VERIFY&quot;
)paren
)paren
id|curl_ssl_verify
op_assign
l_int|0
suffix:semicolon
id|set_from_env
c_func
(paren
op_amp
id|ssl_cert
comma
l_string|&quot;GIT_SSL_CERT&quot;
)paren
suffix:semicolon
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070903
id|set_from_env
c_func
(paren
op_amp
id|ssl_key
comma
l_string|&quot;GIT_SSL_KEY&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070908
id|set_from_env
c_func
(paren
op_amp
id|ssl_capath
comma
l_string|&quot;GIT_SSL_CAPATH&quot;
)paren
suffix:semicolon
macro_line|#endif
id|set_from_env
c_func
(paren
op_amp
id|ssl_cainfo
comma
l_string|&quot;GIT_SSL_CAINFO&quot;
)paren
suffix:semicolon
id|set_from_env
c_func
(paren
op_amp
id|user_agent
comma
l_string|&quot;GIT_HTTP_USER_AGENT&quot;
)paren
suffix:semicolon
id|low_speed_limit
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_HTTP_LOW_SPEED_LIMIT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|low_speed_limit
op_ne
l_int|NULL
)paren
id|curl_low_speed_limit
op_assign
id|strtol
c_func
(paren
id|low_speed_limit
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|low_speed_time
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_HTTP_LOW_SPEED_TIME&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|low_speed_time
op_ne
l_int|NULL
)paren
id|curl_low_speed_time
op_assign
id|strtol
c_func
(paren
id|low_speed_time
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curl_ssl_verify
op_eq
l_int|1
)paren
id|curl_ssl_verify
op_assign
l_int|1
suffix:semicolon
id|curl_session_count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef USE_CURL_MULTI
r_if
c_cond
(paren
id|max_requests
OL
l_int|1
)paren
id|max_requests
op_assign
id|DEFAULT_MAX_REQUESTS
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|getenv
c_func
(paren
l_string|&quot;GIT_CURL_FTP_NO_EPSV&quot;
)paren
)paren
id|curl_ftp_no_epsv
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|url
)paren
(brace
id|credential_from_url
c_func
(paren
op_amp
id|http_auth
comma
id|url
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ssl_cert_password_required
op_logical_and
id|getenv
c_func
(paren
l_string|&quot;GIT_SSL_CERT_PASSWORD_PROTECTED&quot;
)paren
op_logical_and
id|starts_with
c_func
(paren
id|url
comma
l_string|&quot;https://&quot;
)paren
)paren
id|ssl_cert_password_required
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifndef NO_CURL_EASY_DUPHANDLE
id|curl_default
op_assign
id|get_curl_handle
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|http_cleanup
r_void
id|http_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|active_request_slot
op_star
id|slot
op_assign
id|active_queue_head
suffix:semicolon
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
)paren
(brace
r_struct
id|active_request_slot
op_star
id|next
op_assign
id|slot-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;curl
op_ne
l_int|NULL
)paren
(brace
macro_line|#ifdef USE_CURL_MULTI
id|curl_multi_remove_handle
c_func
(paren
id|curlm
comma
id|slot-&gt;curl
)paren
suffix:semicolon
macro_line|#endif
id|curl_easy_cleanup
c_func
(paren
id|slot-&gt;curl
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|slot
)paren
suffix:semicolon
id|slot
op_assign
id|next
suffix:semicolon
)brace
id|active_queue_head
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifndef NO_CURL_EASY_DUPHANDLE
id|curl_easy_cleanup
c_func
(paren
id|curl_default
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef USE_CURL_MULTI
id|curl_multi_cleanup
c_func
(paren
id|curlm
)paren
suffix:semicolon
macro_line|#endif
id|curl_global_cleanup
c_func
(paren
)paren
suffix:semicolon
id|curl_slist_free_all
c_func
(paren
id|pragma_header
)paren
suffix:semicolon
id|pragma_header
op_assign
l_int|NULL
suffix:semicolon
id|curl_slist_free_all
c_func
(paren
id|no_pragma_header
)paren
suffix:semicolon
id|no_pragma_header
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|curl_http_proxy
)paren
(brace
id|free
c_func
(paren
(paren
r_void
op_star
)paren
id|curl_http_proxy
)paren
suffix:semicolon
id|curl_http_proxy
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cert_auth.password
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|cert_auth.password
comma
l_int|0
comma
id|strlen
c_func
(paren
id|cert_auth.password
)paren
)paren
suffix:semicolon
id|free
c_func
(paren
id|cert_auth.password
)paren
suffix:semicolon
id|cert_auth.password
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ssl_cert_password_required
op_assign
l_int|0
suffix:semicolon
id|free
c_func
(paren
id|cached_accept_language
)paren
suffix:semicolon
id|cached_accept_language
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|get_active_slot
r_struct
id|active_request_slot
op_star
id|get_active_slot
c_func
(paren
r_void
)paren
(brace
r_struct
id|active_request_slot
op_star
id|slot
op_assign
id|active_queue_head
suffix:semicolon
r_struct
id|active_request_slot
op_star
id|newslot
suffix:semicolon
macro_line|#ifdef USE_CURL_MULTI
r_int
id|num_transfers
suffix:semicolon
multiline_comment|/* Wait for a slot to open up if the queue is full */
r_while
c_loop
(paren
id|active_requests
op_ge
id|max_requests
)paren
(brace
id|curl_multi_perform
c_func
(paren
id|curlm
comma
op_amp
id|num_transfers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_transfers
OL
id|active_requests
)paren
id|process_curl_messages
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
op_logical_and
id|slot-&gt;in_use
)paren
id|slot
op_assign
id|slot-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
id|newslot
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|newslot
)paren
)paren
suffix:semicolon
id|newslot-&gt;curl
op_assign
l_int|NULL
suffix:semicolon
id|newslot-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|newslot-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|slot
op_assign
id|active_queue_head
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
id|active_queue_head
op_assign
id|newslot
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|slot-&gt;next
op_ne
l_int|NULL
)paren
id|slot
op_assign
id|slot-&gt;next
suffix:semicolon
id|slot-&gt;next
op_assign
id|newslot
suffix:semicolon
)brace
id|slot
op_assign
id|newslot
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;curl
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef NO_CURL_EASY_DUPHANDLE
id|slot-&gt;curl
op_assign
id|get_curl_handle
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|slot-&gt;curl
op_assign
id|curl_easy_duphandle
c_func
(paren
id|curl_default
)paren
suffix:semicolon
macro_line|#endif
id|curl_session_count
op_increment
suffix:semicolon
)brace
id|active_requests
op_increment
suffix:semicolon
id|slot-&gt;in_use
op_assign
l_int|1
suffix:semicolon
id|slot-&gt;results
op_assign
l_int|NULL
suffix:semicolon
id|slot-&gt;finished
op_assign
l_int|NULL
suffix:semicolon
id|slot-&gt;callback_data
op_assign
l_int|NULL
suffix:semicolon
id|slot-&gt;callback_func
op_assign
l_int|NULL
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_COOKIEFILE
comma
id|curl_cookie_file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curl_save_cookies
)paren
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_COOKIEJAR
comma
id|curl_cookie_file
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_HTTPHEADER
comma
id|pragma_header
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_ERRORBUFFER
comma
id|curl_errorstr
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_CUSTOMREQUEST
comma
l_int|NULL
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_READFUNCTION
comma
l_int|NULL
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_WRITEFUNCTION
comma
l_int|NULL
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_POSTFIELDS
comma
l_int|NULL
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_UPLOAD
comma
l_int|0
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_HTTPGET
comma
l_int|1
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_FAILONERROR
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef LIBCURL_CAN_HANDLE_AUTH_ANY
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_HTTPAUTH
comma
id|http_auth_methods
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|http_auth.password
)paren
id|init_curl_http_auth
c_func
(paren
id|slot-&gt;curl
)paren
suffix:semicolon
r_return
id|slot
suffix:semicolon
)brace
DECL|function|start_active_slot
r_int
id|start_active_slot
c_func
(paren
r_struct
id|active_request_slot
op_star
id|slot
)paren
(brace
macro_line|#ifdef USE_CURL_MULTI
id|CURLMcode
id|curlm_result
op_assign
id|curl_multi_add_handle
c_func
(paren
id|curlm
comma
id|slot-&gt;curl
)paren
suffix:semicolon
r_int
id|num_transfers
suffix:semicolon
r_if
c_cond
(paren
id|curlm_result
op_ne
id|CURLM_OK
op_logical_and
id|curlm_result
op_ne
id|CURLM_CALL_MULTI_PERFORM
)paren
(brace
id|active_requests
op_decrement
suffix:semicolon
id|slot-&gt;in_use
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We know there must be something to do, since we just added&n;&t; * something.&n;&t; */
id|curl_multi_perform
c_func
(paren
id|curlm
comma
op_amp
id|num_transfers
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef USE_CURL_MULTI
DECL|struct|fill_chain
r_struct
id|fill_chain
(brace
DECL|member|data
r_void
op_star
id|data
suffix:semicolon
DECL|member|fill
r_int
(paren
op_star
id|fill
)paren
(paren
r_void
op_star
)paren
suffix:semicolon
DECL|member|next
r_struct
id|fill_chain
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|fill_cfg
r_static
r_struct
id|fill_chain
op_star
id|fill_cfg
suffix:semicolon
DECL|function|add_fill_function
r_void
id|add_fill_function
c_func
(paren
r_void
op_star
id|data
comma
r_int
(paren
op_star
id|fill
)paren
(paren
r_void
op_star
)paren
)paren
(brace
r_struct
id|fill_chain
op_star
r_new
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
op_star
r_new
)paren
)paren
suffix:semicolon
r_struct
id|fill_chain
op_star
op_star
id|linkp
op_assign
op_amp
id|fill_cfg
suffix:semicolon
r_new
op_member_access_from_pointer
id|data
op_assign
id|data
suffix:semicolon
r_new
op_member_access_from_pointer
id|fill
op_assign
id|fill
suffix:semicolon
r_new
op_member_access_from_pointer
id|next
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
op_star
id|linkp
)paren
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
op_star
id|linkp
op_assign
r_new
suffix:semicolon
)brace
DECL|function|fill_active_slots
r_void
id|fill_active_slots
c_func
(paren
r_void
)paren
(brace
r_struct
id|active_request_slot
op_star
id|slot
op_assign
id|active_queue_head
suffix:semicolon
r_while
c_loop
(paren
id|active_requests
OL
id|max_requests
)paren
(brace
r_struct
id|fill_chain
op_star
id|fill
suffix:semicolon
r_for
c_loop
(paren
id|fill
op_assign
id|fill_cfg
suffix:semicolon
id|fill
suffix:semicolon
id|fill
op_assign
id|fill-&gt;next
)paren
r_if
c_cond
(paren
id|fill
op_member_access_from_pointer
id|fill
c_func
(paren
id|fill-&gt;data
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fill
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|slot-&gt;in_use
op_logical_and
id|slot-&gt;curl
op_ne
l_int|NULL
op_logical_and
id|curl_session_count
OG
id|min_curl_sessions
)paren
(brace
id|curl_easy_cleanup
c_func
(paren
id|slot-&gt;curl
)paren
suffix:semicolon
id|slot-&gt;curl
op_assign
l_int|NULL
suffix:semicolon
id|curl_session_count
op_decrement
suffix:semicolon
)brace
id|slot
op_assign
id|slot-&gt;next
suffix:semicolon
)brace
)brace
DECL|function|step_active_slots
r_void
id|step_active_slots
c_func
(paren
r_void
)paren
(brace
r_int
id|num_transfers
suffix:semicolon
id|CURLMcode
id|curlm_result
suffix:semicolon
r_do
(brace
id|curlm_result
op_assign
id|curl_multi_perform
c_func
(paren
id|curlm
comma
op_amp
id|num_transfers
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|curlm_result
op_eq
id|CURLM_CALL_MULTI_PERFORM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_transfers
OL
id|active_requests
)paren
(brace
id|process_curl_messages
c_func
(paren
)paren
suffix:semicolon
id|fill_active_slots
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|run_active_slot
r_void
id|run_active_slot
c_func
(paren
r_struct
id|active_request_slot
op_star
id|slot
)paren
(brace
macro_line|#ifdef USE_CURL_MULTI
id|fd_set
id|readfds
suffix:semicolon
id|fd_set
id|writefds
suffix:semicolon
id|fd_set
id|excfds
suffix:semicolon
r_int
id|max_fd
suffix:semicolon
r_struct
id|timeval
id|select_timeout
suffix:semicolon
r_int
id|finished
op_assign
l_int|0
suffix:semicolon
id|slot-&gt;finished
op_assign
op_amp
id|finished
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|finished
)paren
(brace
id|step_active_slots
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;in_use
)paren
(brace
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070f04
r_int
id|curl_timeout
suffix:semicolon
id|curl_multi_timeout
c_func
(paren
id|curlm
comma
op_amp
id|curl_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curl_timeout
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|curl_timeout
op_eq
l_int|1
)paren
(brace
id|select_timeout.tv_sec
op_assign
l_int|0
suffix:semicolon
id|select_timeout.tv_usec
op_assign
l_int|50000
suffix:semicolon
)brace
r_else
(brace
id|select_timeout.tv_sec
op_assign
id|curl_timeout
op_div
l_int|1000
suffix:semicolon
id|select_timeout.tv_usec
op_assign
(paren
id|curl_timeout
op_mod
l_int|1000
)paren
op_star
l_int|1000
suffix:semicolon
)brace
macro_line|#else
id|select_timeout.tv_sec
op_assign
l_int|0
suffix:semicolon
id|select_timeout.tv_usec
op_assign
l_int|50000
suffix:semicolon
macro_line|#endif
id|max_fd
op_assign
l_int|1
suffix:semicolon
id|FD_ZERO
c_func
(paren
op_amp
id|readfds
)paren
suffix:semicolon
id|FD_ZERO
c_func
(paren
op_amp
id|writefds
)paren
suffix:semicolon
id|FD_ZERO
c_func
(paren
op_amp
id|excfds
)paren
suffix:semicolon
id|curl_multi_fdset
c_func
(paren
id|curlm
comma
op_amp
id|readfds
comma
op_amp
id|writefds
comma
op_amp
id|excfds
comma
op_amp
id|max_fd
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * It can happen that curl_multi_timeout returns a pathologically&n;&t;&t;&t; * long timeout when curl_multi_fdset returns no file descriptors&n;&t;&t;&t; * to read.  See commit message for more details.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|max_fd
OL
l_int|0
op_logical_and
(paren
id|select_timeout.tv_sec
OG
l_int|0
op_logical_or
id|select_timeout.tv_usec
OG
l_int|50000
)paren
)paren
(brace
id|select_timeout.tv_sec
op_assign
l_int|0
suffix:semicolon
id|select_timeout.tv_usec
op_assign
l_int|50000
suffix:semicolon
)brace
id|select
c_func
(paren
id|max_fd
op_plus
l_int|1
comma
op_amp
id|readfds
comma
op_amp
id|writefds
comma
op_amp
id|excfds
comma
op_amp
id|select_timeout
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
r_while
c_loop
(paren
id|slot-&gt;in_use
)paren
(brace
id|slot-&gt;curl_result
op_assign
id|curl_easy_perform
c_func
(paren
id|slot-&gt;curl
)paren
suffix:semicolon
id|finish_active_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|release_active_slot
r_static
r_void
id|release_active_slot
c_func
(paren
r_struct
id|active_request_slot
op_star
id|slot
)paren
(brace
id|closedown_active_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;curl
op_logical_and
id|curl_session_count
OG
id|min_curl_sessions
)paren
(brace
macro_line|#ifdef USE_CURL_MULTI
id|curl_multi_remove_handle
c_func
(paren
id|curlm
comma
id|slot-&gt;curl
)paren
suffix:semicolon
macro_line|#endif
id|curl_easy_cleanup
c_func
(paren
id|slot-&gt;curl
)paren
suffix:semicolon
id|slot-&gt;curl
op_assign
l_int|NULL
suffix:semicolon
id|curl_session_count
op_decrement
suffix:semicolon
)brace
macro_line|#ifdef USE_CURL_MULTI
id|fill_active_slots
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|finish_all_active_slots
r_void
id|finish_all_active_slots
c_func
(paren
r_void
)paren
(brace
r_struct
id|active_request_slot
op_star
id|slot
op_assign
id|active_queue_head
suffix:semicolon
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
)paren
r_if
c_cond
(paren
id|slot-&gt;in_use
)paren
(brace
id|run_active_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
id|slot
op_assign
id|active_queue_head
suffix:semicolon
)brace
r_else
(brace
id|slot
op_assign
id|slot-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/* Helpers for modifying and creating URLs */
DECL|function|needs_quote
r_static
r_inline
r_int
id|needs_quote
c_func
(paren
r_int
id|ch
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|ch
op_ge
l_char|&squot;A&squot;
)paren
op_logical_and
(paren
id|ch
op_le
l_char|&squot;Z&squot;
)paren
)paren
op_logical_or
(paren
(paren
id|ch
op_ge
l_char|&squot;a&squot;
)paren
op_logical_and
(paren
id|ch
op_le
l_char|&squot;z&squot;
)paren
)paren
op_logical_or
(paren
(paren
id|ch
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|ch
op_le
l_char|&squot;9&squot;
)paren
)paren
op_logical_or
(paren
id|ch
op_eq
l_char|&squot;/&squot;
)paren
op_logical_or
(paren
id|ch
op_eq
l_char|&squot;-&squot;
)paren
op_logical_or
(paren
id|ch
op_eq
l_char|&squot;.&squot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|quote_ref_url
r_static
r_char
op_star
id|quote_ref_url
c_func
(paren
r_const
r_char
op_star
id|base
comma
r_const
r_char
op_star
id|ref
)paren
(brace
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
r_const
r_char
op_star
id|cp
suffix:semicolon
r_int
id|ch
suffix:semicolon
id|end_url_with_slash
c_func
(paren
op_amp
id|buf
comma
id|base
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cp
op_assign
id|ref
suffix:semicolon
(paren
id|ch
op_assign
op_star
id|cp
)paren
op_ne
l_int|0
suffix:semicolon
id|cp
op_increment
)paren
r_if
c_cond
(paren
id|needs_quote
c_func
(paren
id|ch
)paren
)paren
id|strbuf_addf
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;%%%02x&quot;
comma
id|ch
)paren
suffix:semicolon
r_else
id|strbuf_addch
c_func
(paren
op_amp
id|buf
comma
op_star
id|cp
)paren
suffix:semicolon
r_return
id|strbuf_detach
c_func
(paren
op_amp
id|buf
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|append_remote_object_url
r_void
id|append_remote_object_url
c_func
(paren
r_struct
id|strbuf
op_star
id|buf
comma
r_const
r_char
op_star
id|url
comma
r_const
r_char
op_star
id|hex
comma
r_int
id|only_two_digit_prefix
)paren
(brace
id|end_url_with_slash
c_func
(paren
id|buf
comma
id|url
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
id|buf
comma
l_string|&quot;objects/%.*s/&quot;
comma
l_int|2
comma
id|hex
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|only_two_digit_prefix
)paren
id|strbuf_addf
c_func
(paren
id|buf
comma
l_string|&quot;%s&quot;
comma
id|hex
op_plus
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|get_remote_object_url
r_char
op_star
id|get_remote_object_url
c_func
(paren
r_const
r_char
op_star
id|url
comma
r_const
r_char
op_star
id|hex
comma
r_int
id|only_two_digit_prefix
)paren
(brace
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
id|append_remote_object_url
c_func
(paren
op_amp
id|buf
comma
id|url
comma
id|hex
comma
id|only_two_digit_prefix
)paren
suffix:semicolon
r_return
id|strbuf_detach
c_func
(paren
op_amp
id|buf
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|handle_curl_result
r_static
r_int
id|handle_curl_result
c_func
(paren
r_struct
id|slot_results
op_star
id|results
)paren
(brace
multiline_comment|/*&n;&t; * If we see a failing http code with CURLE_OK, we have turned off&n;&t; * FAILONERROR (to keep the server&squot;s custom error response), and should&n;&t; * translate the code into failure here.&n;&t; */
r_if
c_cond
(paren
id|results-&gt;curl_result
op_eq
id|CURLE_OK
op_logical_and
id|results-&gt;http_code
op_ge
l_int|400
)paren
(brace
id|results-&gt;curl_result
op_assign
id|CURLE_HTTP_RETURNED_ERROR
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Normally curl will already have put the &quot;reason phrase&quot;&n;&t;&t; * from the server into curl_errorstr; unfortunately without&n;&t;&t; * FAILONERROR it is lost, so we can give only the numeric&n;&t;&t; * status code.&n;&t;&t; */
id|snprintf
c_func
(paren
id|curl_errorstr
comma
r_sizeof
(paren
id|curl_errorstr
)paren
comma
l_string|&quot;The requested URL returned error: %ld&quot;
comma
id|results-&gt;http_code
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|results-&gt;curl_result
op_eq
id|CURLE_OK
)paren
(brace
id|credential_approve
c_func
(paren
op_amp
id|http_auth
)paren
suffix:semicolon
r_return
id|HTTP_OK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|missing_target
c_func
(paren
id|results
)paren
)paren
r_return
id|HTTP_MISSING_TARGET
suffix:semicolon
r_else
r_if
c_cond
(paren
id|results-&gt;http_code
op_eq
l_int|401
)paren
(brace
r_if
c_cond
(paren
id|http_auth.username
op_logical_and
id|http_auth.password
)paren
(brace
id|credential_reject
c_func
(paren
op_amp
id|http_auth
)paren
suffix:semicolon
r_return
id|HTTP_NOAUTH
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef LIBCURL_CAN_HANDLE_AUTH_ANY
id|http_auth_methods
op_and_assign
op_complement
id|CURLAUTH_GSSNEGOTIATE
suffix:semicolon
macro_line|#endif
r_return
id|HTTP_REAUTH
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#if LIBCURL_VERSION_NUM &gt;= 0x070c00
r_if
c_cond
(paren
op_logical_neg
id|curl_errorstr
(braket
l_int|0
)braket
)paren
id|strlcpy
c_func
(paren
id|curl_errorstr
comma
id|curl_easy_strerror
c_func
(paren
id|results-&gt;curl_result
)paren
comma
r_sizeof
(paren
id|curl_errorstr
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|HTTP_ERROR
suffix:semicolon
)brace
)brace
DECL|function|run_one_slot
r_int
id|run_one_slot
c_func
(paren
r_struct
id|active_request_slot
op_star
id|slot
comma
r_struct
id|slot_results
op_star
id|results
)paren
(brace
id|slot-&gt;results
op_assign
id|results
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start_active_slot
c_func
(paren
id|slot
)paren
)paren
(brace
id|snprintf
c_func
(paren
id|curl_errorstr
comma
r_sizeof
(paren
id|curl_errorstr
)paren
comma
l_string|&quot;failed to start HTTP request&quot;
)paren
suffix:semicolon
r_return
id|HTTP_START_FAILED
suffix:semicolon
)brace
id|run_active_slot
c_func
(paren
id|slot
)paren
suffix:semicolon
r_return
id|handle_curl_result
c_func
(paren
id|results
)paren
suffix:semicolon
)brace
DECL|function|curlinfo_strbuf
r_static
id|CURLcode
id|curlinfo_strbuf
c_func
(paren
id|CURL
op_star
id|curl
comma
id|CURLINFO
id|info
comma
r_struct
id|strbuf
op_star
id|buf
)paren
(brace
r_char
op_star
id|ptr
suffix:semicolon
id|CURLcode
id|ret
suffix:semicolon
id|strbuf_reset
c_func
(paren
id|buf
)paren
suffix:semicolon
id|ret
op_assign
id|curl_easy_getinfo
c_func
(paren
id|curl
comma
id|info
comma
op_amp
id|ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|ptr
)paren
id|strbuf_addstr
c_func
(paren
id|buf
comma
id|ptr
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Check for and extract a content-type parameter. &quot;raw&quot;&n; * should be positioned at the start of the potential&n; * parameter, with any whitespace already removed.&n; *&n; * &quot;name&quot; is the name of the parameter. The value is appended&n; * to &quot;out&quot;.&n; */
DECL|function|extract_param
r_static
r_int
id|extract_param
c_func
(paren
r_const
r_char
op_star
id|raw
comma
r_const
r_char
op_star
id|name
comma
r_struct
id|strbuf
op_star
id|out
)paren
(brace
r_int
id|len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncasecmp
c_func
(paren
id|raw
comma
id|name
comma
id|len
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|raw
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
op_star
id|raw
op_ne
l_char|&squot;=&squot;
)paren
r_return
l_int|1
suffix:semicolon
id|raw
op_increment
suffix:semicolon
r_while
c_loop
(paren
op_star
id|raw
op_logical_and
op_logical_neg
id|isspace
c_func
(paren
op_star
id|raw
)paren
op_logical_and
op_star
id|raw
op_ne
l_char|&squot;;&squot;
)paren
id|strbuf_addch
c_func
(paren
id|out
comma
op_star
id|raw
op_increment
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Extract a normalized version of the content type, with any&n; * spaces suppressed, all letters lowercased, and no trailing &quot;;&quot;&n; * or parameters.&n; *&n; * Note that we will silently remove even invalid whitespace. For&n; * example, &quot;text / plain&quot; is specifically forbidden by RFC 2616,&n; * but &quot;text/plain&quot; is the only reasonable output, and this keeps&n; * our code simple.&n; *&n; * If the &quot;charset&quot; argument is not NULL, store the value of any&n; * charset parameter there.&n; *&n; * Example:&n; *   &quot;TEXT/PLAIN; charset=utf-8&quot; -&gt; &quot;text/plain&quot;, &quot;utf-8&quot;&n; *   &quot;text / plain&quot; -&gt; &quot;text/plain&quot;&n; */
DECL|function|extract_content_type
r_static
r_void
id|extract_content_type
c_func
(paren
r_struct
id|strbuf
op_star
id|raw
comma
r_struct
id|strbuf
op_star
id|type
comma
r_struct
id|strbuf
op_star
id|charset
)paren
(brace
r_const
r_char
op_star
id|p
suffix:semicolon
id|strbuf_reset
c_func
(paren
id|type
)paren
suffix:semicolon
id|strbuf_grow
c_func
(paren
id|type
comma
id|raw-&gt;len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|raw-&gt;buf
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|isspace
c_func
(paren
op_star
id|p
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;;&squot;
)paren
(brace
id|p
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|strbuf_addch
c_func
(paren
id|type
comma
id|tolower
c_func
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|charset
)paren
r_return
suffix:semicolon
id|strbuf_reset
c_func
(paren
id|charset
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
r_while
c_loop
(paren
id|isspace
c_func
(paren
op_star
id|p
)paren
op_logical_or
op_star
id|p
op_eq
l_char|&squot;;&squot;
)paren
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|extract_param
c_func
(paren
id|p
comma
l_string|&quot;charset&quot;
comma
id|charset
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_logical_and
op_logical_neg
id|isspace
c_func
(paren
op_star
id|p
)paren
)paren
id|p
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|charset-&gt;len
op_logical_and
id|starts_with
c_func
(paren
id|type-&gt;buf
comma
l_string|&quot;text/&quot;
)paren
)paren
id|strbuf_addstr
c_func
(paren
id|charset
comma
l_string|&quot;ISO-8859-1&quot;
)paren
suffix:semicolon
)brace
DECL|function|write_accept_language
r_static
r_void
id|write_accept_language
c_func
(paren
r_struct
id|strbuf
op_star
id|buf
)paren
(brace
multiline_comment|/*&n;&t; * MAX_DECIMAL_PLACES must not be larger than 3. If it is larger than&n;&t; * that, q-value will be smaller than 0.001, the minimum q-value the&n;&t; * HTTP specification allows. See&n;&t; * http://tools.ietf.org/html/rfc7231#section-5.3.1 for q-value.&n;&t; */
r_const
r_int
id|MAX_DECIMAL_PLACES
op_assign
l_int|3
suffix:semicolon
r_const
r_int
id|MAX_LANGUAGE_TAGS
op_assign
l_int|1000
suffix:semicolon
r_const
r_int
id|MAX_ACCEPT_LANGUAGE_HEADER_SIZE
op_assign
l_int|4000
suffix:semicolon
r_char
op_star
op_star
id|language_tags
op_assign
l_int|NULL
suffix:semicolon
r_int
id|num_langs
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|s
op_assign
id|get_preferred_languages
c_func
(paren
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|strbuf
id|tag
op_assign
id|STRBUF_INIT
suffix:semicolon
multiline_comment|/* Don&squot;t add Accept-Language header if no language is preferred. */
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Split the colon-separated string of preferred languages into&n;&t; * language_tags array.&n;&t; */
r_do
(brace
multiline_comment|/* collect language tag */
r_for
c_loop
(paren
suffix:semicolon
op_star
id|s
op_logical_and
(paren
id|isalnum
c_func
(paren
op_star
id|s
)paren
op_logical_or
op_star
id|s
op_eq
l_char|&squot;_&squot;
)paren
suffix:semicolon
id|s
op_increment
)paren
id|strbuf_addch
c_func
(paren
op_amp
id|tag
comma
op_star
id|s
op_eq
l_char|&squot;_&squot;
ques
c_cond
l_char|&squot;-&squot;
suffix:colon
op_star
id|s
)paren
suffix:semicolon
multiline_comment|/* skip .codeset, @modifier and any other unnecessary parts */
r_while
c_loop
(paren
op_star
id|s
op_logical_and
op_star
id|s
op_ne
l_char|&squot;:&squot;
)paren
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tag.len
)paren
(brace
id|num_langs
op_increment
suffix:semicolon
id|REALLOC_ARRAY
c_func
(paren
id|language_tags
comma
id|num_langs
)paren
suffix:semicolon
id|language_tags
(braket
id|num_langs
l_int|1
)braket
op_assign
id|strbuf_detach
c_func
(paren
op_amp
id|tag
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_langs
op_ge
id|MAX_LANGUAGE_TAGS
l_int|1
)paren
multiline_comment|/* -1 for &squot;*&squot; */
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_star
id|s
op_increment
)paren
suffix:semicolon
multiline_comment|/* write Accept-Language header into buf */
r_if
c_cond
(paren
id|num_langs
)paren
(brace
r_int
id|last_buf_len
op_assign
l_int|0
suffix:semicolon
r_int
id|max_q
suffix:semicolon
r_int
id|decimal_places
suffix:semicolon
r_char
id|q_format
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* add &squot;*&squot; */
id|REALLOC_ARRAY
c_func
(paren
id|language_tags
comma
id|num_langs
op_plus
l_int|1
)paren
suffix:semicolon
id|language_tags
(braket
id|num_langs
op_increment
)braket
op_assign
l_string|&quot;*&quot;
suffix:semicolon
multiline_comment|/* it&squot;s OK; this won&squot;t be freed */
multiline_comment|/* compute decimal_places */
r_for
c_loop
(paren
id|max_q
op_assign
l_int|1
comma
id|decimal_places
op_assign
l_int|0
suffix:semicolon
id|max_q
OL
id|num_langs
op_logical_and
id|decimal_places
op_le
id|MAX_DECIMAL_PLACES
suffix:semicolon
id|decimal_places
op_increment
comma
id|max_q
op_mul_assign
l_int|10
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|q_format
comma
l_string|&quot;;q=0.%%0%dd&quot;
comma
id|decimal_places
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
id|buf
comma
l_string|&quot;Accept-Language: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_langs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
id|strbuf_addstr
c_func
(paren
id|buf
comma
l_string|&quot;, &quot;
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
id|buf
comma
id|language_tags
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
id|strbuf_addf
c_func
(paren
id|buf
comma
id|q_format
comma
id|max_q
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;len
OG
id|MAX_ACCEPT_LANGUAGE_HEADER_SIZE
)paren
(brace
id|strbuf_remove
c_func
(paren
id|buf
comma
id|last_buf_len
comma
id|buf-&gt;len
id|last_buf_len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|last_buf_len
op_assign
id|buf-&gt;len
suffix:semicolon
)brace
)brace
multiline_comment|/* free language tags -- last one is a static &squot;*&squot; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_langs
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|free
c_func
(paren
id|language_tags
(braket
id|i
)braket
)paren
suffix:semicolon
id|free
c_func
(paren
id|language_tags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get an Accept-Language header which indicates user&squot;s preferred languages.&n; *&n; * Examples:&n; *   LANGUAGE= -&gt; &quot;&quot;&n; *   LANGUAGE=ko:en -&gt; &quot;Accept-Language: ko, en; q=0.9, *; q=0.1&quot;&n; *   LANGUAGE=ko_KR.UTF-8:sr@latin -&gt; &quot;Accept-Language: ko-KR, sr; q=0.9, *; q=0.1&quot;&n; *   LANGUAGE=ko LANG=en_US.UTF-8 -&gt; &quot;Accept-Language: ko, *; q=0.1&quot;&n; *   LANGUAGE= LANG=en_US.UTF-8 -&gt; &quot;Accept-Language: en-US, *; q=0.1&quot;&n; *   LANGUAGE= LANG=C -&gt; &quot;&quot;&n; */
DECL|function|get_accept_language
r_static
r_const
r_char
op_star
id|get_accept_language
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cached_accept_language
)paren
(brace
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
id|write_accept_language
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf.len
OG
l_int|0
)paren
id|cached_accept_language
op_assign
id|strbuf_detach
c_func
(paren
op_amp
id|buf
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
id|cached_accept_language
suffix:semicolon
)brace
multiline_comment|/* http_request() targets */
DECL|macro|HTTP_REQUEST_STRBUF
mdefine_line|#define HTTP_REQUEST_STRBUF&t;0
DECL|macro|HTTP_REQUEST_FILE
mdefine_line|#define HTTP_REQUEST_FILE&t;1
DECL|function|http_request
r_static
r_int
id|http_request
c_func
(paren
r_const
r_char
op_star
id|url
comma
r_void
op_star
id|result
comma
r_int
id|target
comma
r_const
r_struct
id|http_get_options
op_star
id|options
)paren
(brace
r_struct
id|active_request_slot
op_star
id|slot
suffix:semicolon
r_struct
id|slot_results
id|results
suffix:semicolon
r_struct
id|curl_slist
op_star
id|headers
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
r_const
r_char
op_star
id|accept_language
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|slot
op_assign
id|get_active_slot
c_func
(paren
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_HTTPGET
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|NULL
)paren
(brace
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_NOBODY
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_NOBODY
comma
l_int|0
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_FILE
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|target
op_eq
id|HTTP_REQUEST_FILE
)paren
(brace
r_int
id|posn
op_assign
id|ftell
c_func
(paren
id|result
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_WRITEFUNCTION
comma
id|fwrite
)paren
suffix:semicolon
r_if
c_cond
(paren
id|posn
OG
l_int|0
)paren
(brace
id|strbuf_addf
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;Range: bytes=%ld-&quot;
comma
id|posn
)paren
suffix:semicolon
id|headers
op_assign
id|curl_slist_append
c_func
(paren
id|headers
comma
id|buf.buf
)paren
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
)brace
)brace
r_else
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_WRITEFUNCTION
comma
id|fwrite_buffer
)paren
suffix:semicolon
)brace
id|accept_language
op_assign
id|get_accept_language
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|accept_language
)paren
id|headers
op_assign
id|curl_slist_append
c_func
(paren
id|headers
comma
id|accept_language
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;Pragma:&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|options
op_logical_and
id|options-&gt;no_cache
)paren
id|strbuf_addstr
c_func
(paren
op_amp
id|buf
comma
l_string|&quot; no-cache&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|options
op_logical_and
id|options-&gt;keep_error
)paren
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_FAILONERROR
comma
l_int|0
)paren
suffix:semicolon
id|headers
op_assign
id|curl_slist_append
c_func
(paren
id|headers
comma
id|buf.buf
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_URL
comma
id|url
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_HTTPHEADER
comma
id|headers
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|slot-&gt;curl
comma
id|CURLOPT_ENCODING
comma
l_string|&quot;gzip&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|run_one_slot
c_func
(paren
id|slot
comma
op_amp
id|results
)paren
suffix:semicolon
r_if
c_cond
(paren
id|options
op_logical_and
id|options-&gt;content_type
)paren
(brace
r_struct
id|strbuf
id|raw
op_assign
id|STRBUF_INIT
suffix:semicolon
id|curlinfo_strbuf
c_func
(paren
id|slot-&gt;curl
comma
id|CURLINFO_CONTENT_TYPE
comma
op_amp
id|raw
)paren
suffix:semicolon
id|extract_content_type
c_func
(paren
op_amp
id|raw
comma
id|options-&gt;content_type
comma
id|options-&gt;charset
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|raw
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|options
op_logical_and
id|options-&gt;effective_url
)paren
id|curlinfo_strbuf
c_func
(paren
id|slot-&gt;curl
comma
id|CURLINFO_EFFECTIVE_URL
comma
id|options-&gt;effective_url
)paren
suffix:semicolon
id|curl_slist_free_all
c_func
(paren
id|headers
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Update the &quot;base&quot; url to a more appropriate value, as deduced by&n; * redirects seen when requesting a URL starting with &quot;url&quot;.&n; *&n; * The &quot;asked&quot; parameter is a URL that we asked curl to access, and must begin&n; * with &quot;base&quot;.&n; *&n; * The &quot;got&quot; parameter is the URL that curl reported to us as where we ended&n; * up.&n; *&n; * Returns 1 if we updated the base url, 0 otherwise.&n; *&n; * Our basic strategy is to compare &quot;base&quot; and &quot;asked&quot; to find the bits&n; * specific to our request. We then strip those bits off of &quot;got&quot; to yield the&n; * new base. So for example, if our base is &quot;http://example.com/foo.git&quot;,&n; * and we ask for &quot;http://example.com/foo.git/info/refs&quot;, we might end up&n; * with &quot;https://other.example.com/foo.git/info/refs&quot;. We would want the&n; * new URL to become &quot;https://other.example.com/foo.git&quot;.&n; *&n; * Note that this assumes a sane redirect scheme. It&squot;s entirely possible&n; * in the example above to end up at a URL that does not even end in&n; * &quot;info/refs&quot;.  In such a case we simply punt, as there is not much we can&n; * do (and such a scheme is unlikely to represent a real git repository,&n; * which means we are likely about to abort anyway).&n; */
DECL|function|update_url_from_redirect
r_static
r_int
id|update_url_from_redirect
c_func
(paren
r_struct
id|strbuf
op_star
id|base
comma
r_const
r_char
op_star
id|asked
comma
r_const
r_struct
id|strbuf
op_star
id|got
)paren
(brace
r_const
r_char
op_star
id|tail
suffix:semicolon
r_int
id|tail_len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|asked
comma
id|got-&gt;buf
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skip_prefix
c_func
(paren
id|asked
comma
id|base-&gt;buf
comma
op_amp
id|tail
)paren
)paren
id|die
c_func
(paren
l_string|&quot;BUG: update_url_from_redirect: %s is not a superset of %s&quot;
comma
id|asked
comma
id|base-&gt;buf
)paren
suffix:semicolon
id|tail_len
op_assign
id|strlen
c_func
(paren
id|tail
)paren
suffix:semicolon
r_if
c_cond
(paren
id|got-&gt;len
OL
id|tail_len
op_logical_or
id|strcmp
c_func
(paren
id|tail
comma
id|got-&gt;buf
op_plus
id|got-&gt;len
id|tail_len
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* insane redirect scheme */
id|strbuf_reset
c_func
(paren
id|base
)paren
suffix:semicolon
id|strbuf_add
c_func
(paren
id|base
comma
id|got-&gt;buf
comma
id|got-&gt;len
id|tail_len
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|http_request_reauth
r_static
r_int
id|http_request_reauth
c_func
(paren
r_const
r_char
op_star
id|url
comma
r_void
op_star
id|result
comma
r_int
id|target
comma
r_struct
id|http_get_options
op_star
id|options
)paren
(brace
r_int
id|ret
op_assign
id|http_request
c_func
(paren
id|url
comma
id|result
comma
id|target
comma
id|options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|options
op_logical_and
id|options-&gt;effective_url
op_logical_and
id|options-&gt;base_url
)paren
(brace
r_if
c_cond
(paren
id|update_url_from_redirect
c_func
(paren
id|options-&gt;base_url
comma
id|url
comma
id|options-&gt;effective_url
)paren
)paren
(brace
id|credential_from_url
c_func
(paren
op_amp
id|http_auth
comma
id|options-&gt;base_url-&gt;buf
)paren
suffix:semicolon
id|url
op_assign
id|options-&gt;effective_url-&gt;buf
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ret
op_ne
id|HTTP_REAUTH
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * If we are using KEEP_ERROR, the previous request may have&n;&t; * put cruft into our output stream; we should clear it out before&n;&t; * making our next request. We only know how to do this for&n;&t; * the strbuf case, but that is enough to satisfy current callers.&n;&t; */
r_if
c_cond
(paren
id|options
op_logical_and
id|options-&gt;keep_error
)paren
(brace
r_switch
c_cond
(paren
id|target
)paren
(brace
r_case
id|HTTP_REQUEST_STRBUF
suffix:colon
id|strbuf_reset
c_func
(paren
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|die
c_func
(paren
l_string|&quot;BUG: HTTP_KEEP_ERROR is only supported with strbufs&quot;
)paren
suffix:semicolon
)brace
)brace
id|credential_fill
c_func
(paren
op_amp
id|http_auth
)paren
suffix:semicolon
r_return
id|http_request
c_func
(paren
id|url
comma
id|result
comma
id|target
comma
id|options
)paren
suffix:semicolon
)brace
DECL|function|http_get_strbuf
r_int
id|http_get_strbuf
c_func
(paren
r_const
r_char
op_star
id|url
comma
r_struct
id|strbuf
op_star
id|result
comma
r_struct
id|http_get_options
op_star
id|options
)paren
(brace
r_return
id|http_request_reauth
c_func
(paren
id|url
comma
id|result
comma
id|HTTP_REQUEST_STRBUF
comma
id|options
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Downloads a URL and stores the result in the given file.&n; *&n; * If a previous interrupted download is detected (i.e. a previous temporary&n; * file is still around) the download is resumed.&n; */
DECL|function|http_get_file
r_static
r_int
id|http_get_file
c_func
(paren
r_const
r_char
op_star
id|url
comma
r_const
r_char
op_star
id|filename
comma
r_struct
id|http_get_options
op_star
id|options
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|strbuf
id|tmpfile
op_assign
id|STRBUF_INIT
suffix:semicolon
id|FILE
op_star
id|result
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|tmpfile
comma
l_string|&quot;%s.temp&quot;
comma
id|filename
)paren
suffix:semicolon
id|result
op_assign
id|fopen
c_func
(paren
id|tmpfile.buf
comma
l_string|&quot;a&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
id|error
c_func
(paren
l_string|&quot;Unable to open local file %s&quot;
comma
id|tmpfile.buf
)paren
suffix:semicolon
id|ret
op_assign
id|HTTP_ERROR
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|ret
op_assign
id|http_request_reauth
c_func
(paren
id|url
comma
id|result
comma
id|HTTP_REQUEST_FILE
comma
id|options
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|HTTP_OK
op_logical_and
id|move_temp_to_file
c_func
(paren
id|tmpfile.buf
comma
id|filename
)paren
)paren
id|ret
op_assign
id|HTTP_ERROR
suffix:semicolon
id|cleanup
suffix:colon
id|strbuf_release
c_func
(paren
op_amp
id|tmpfile
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|http_fetch_ref
r_int
id|http_fetch_ref
c_func
(paren
r_const
r_char
op_star
id|base
comma
r_struct
id|ref
op_star
id|ref
)paren
(brace
r_struct
id|http_get_options
id|options
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_char
op_star
id|url
suffix:semicolon
r_struct
id|strbuf
id|buffer
op_assign
id|STRBUF_INIT
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
id|options.no_cache
op_assign
l_int|1
suffix:semicolon
id|url
op_assign
id|quote_ref_url
c_func
(paren
id|base
comma
id|ref-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|http_get_strbuf
c_func
(paren
id|url
comma
op_amp
id|buffer
comma
op_amp
id|options
)paren
op_eq
id|HTTP_OK
)paren
(brace
id|strbuf_rtrim
c_func
(paren
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer.len
op_eq
l_int|40
)paren
id|ret
op_assign
id|get_sha1_hex
c_func
(paren
id|buffer.buf
comma
id|ref-&gt;old_sha1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|starts_with
c_func
(paren
id|buffer.buf
comma
l_string|&quot;ref: &quot;
)paren
)paren
(brace
id|ref-&gt;symref
op_assign
id|xstrdup
c_func
(paren
id|buffer.buf
op_plus
l_int|5
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|strbuf_release
c_func
(paren
op_amp
id|buffer
)paren
suffix:semicolon
id|free
c_func
(paren
id|url
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Helpers for fetching packs */
DECL|function|fetch_pack_index
r_static
r_char
op_star
id|fetch_pack_index
c_func
(paren
r_int
r_char
op_star
id|sha1
comma
r_const
r_char
op_star
id|base_url
)paren
(brace
r_char
op_star
id|url
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
r_if
c_cond
(paren
id|http_is_verbose
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Getting index for pack %s&bslash;n&quot;
comma
id|sha1_to_hex
c_func
(paren
id|sha1
)paren
)paren
suffix:semicolon
id|end_url_with_slash
c_func
(paren
op_amp
id|buf
comma
id|base_url
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;objects/pack/pack-%s.idx&quot;
comma
id|sha1_to_hex
c_func
(paren
id|sha1
)paren
)paren
suffix:semicolon
id|url
op_assign
id|strbuf_detach
c_func
(paren
op_amp
id|buf
comma
l_int|NULL
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;%s.temp&quot;
comma
id|sha1_pack_index_name
c_func
(paren
id|sha1
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|strbuf_detach
c_func
(paren
op_amp
id|buf
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|http_get_file
c_func
(paren
id|url
comma
id|tmp
comma
l_int|NULL
)paren
op_ne
id|HTTP_OK
)paren
(brace
id|error
c_func
(paren
l_string|&quot;Unable to get pack index %s&quot;
comma
id|url
)paren
suffix:semicolon
id|free
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
l_int|NULL
suffix:semicolon
)brace
id|free
c_func
(paren
id|url
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|fetch_and_setup_pack_index
r_static
r_int
id|fetch_and_setup_pack_index
c_func
(paren
r_struct
id|packed_git
op_star
op_star
id|packs_head
comma
r_int
r_char
op_star
id|sha1
comma
r_const
r_char
op_star
id|base_url
)paren
(brace
r_struct
id|packed_git
op_star
id|new_pack
suffix:semicolon
r_char
op_star
id|tmp_idx
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|has_pack_index
c_func
(paren
id|sha1
)paren
)paren
(brace
id|new_pack
op_assign
id|parse_pack_index
c_func
(paren
id|sha1
comma
id|sha1_pack_index_name
c_func
(paren
id|sha1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_pack
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* parse_pack_index() already issued error message */
r_goto
id|add_pack
suffix:semicolon
)brace
id|tmp_idx
op_assign
id|fetch_pack_index
c_func
(paren
id|sha1
comma
id|base_url
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_idx
)paren
r_return
l_int|1
suffix:semicolon
id|new_pack
op_assign
id|parse_pack_index
c_func
(paren
id|sha1
comma
id|tmp_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_pack
)paren
(brace
id|unlink
c_func
(paren
id|tmp_idx
)paren
suffix:semicolon
id|free
c_func
(paren
id|tmp_idx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* parse_pack_index() already issued error message */
)brace
id|ret
op_assign
id|verify_pack_index
c_func
(paren
id|new_pack
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|close_pack_index
c_func
(paren
id|new_pack
)paren
suffix:semicolon
id|ret
op_assign
id|move_temp_to_file
c_func
(paren
id|tmp_idx
comma
id|sha1_pack_index_name
c_func
(paren
id|sha1
)paren
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|tmp_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
l_int|1
suffix:semicolon
id|add_pack
suffix:colon
id|new_pack-&gt;next
op_assign
op_star
id|packs_head
suffix:semicolon
op_star
id|packs_head
op_assign
id|new_pack
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|http_get_info_packs
r_int
id|http_get_info_packs
c_func
(paren
r_const
r_char
op_star
id|base_url
comma
r_struct
id|packed_git
op_star
op_star
id|packs_head
)paren
(brace
r_struct
id|http_get_options
id|options
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|url
comma
op_star
id|data
suffix:semicolon
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
r_int
r_char
id|sha1
(braket
l_int|20
)braket
suffix:semicolon
id|end_url_with_slash
c_func
(paren
op_amp
id|buf
comma
id|base_url
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;objects/info/packs&quot;
)paren
suffix:semicolon
id|url
op_assign
id|strbuf_detach
c_func
(paren
op_amp
id|buf
comma
l_int|NULL
)paren
suffix:semicolon
id|options.no_cache
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
id|http_get_strbuf
c_func
(paren
id|url
comma
op_amp
id|buf
comma
op_amp
id|options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|HTTP_OK
)paren
r_goto
id|cleanup
suffix:semicolon
id|data
op_assign
id|buf.buf
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|buf.len
)paren
(brace
r_switch
c_cond
(paren
id|data
(braket
id|i
)braket
)paren
(brace
r_case
l_char|&squot;P&squot;
suffix:colon
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_plus
l_int|52
op_le
id|buf.len
op_logical_and
id|starts_with
c_func
(paren
id|data
op_plus
id|i
comma
l_string|&quot; pack-&quot;
)paren
op_logical_and
id|starts_with
c_func
(paren
id|data
op_plus
id|i
op_plus
l_int|46
comma
l_string|&quot;.pack&bslash;n&quot;
)paren
)paren
(brace
id|get_sha1_hex
c_func
(paren
id|data
op_plus
id|i
op_plus
l_int|6
comma
id|sha1
)paren
suffix:semicolon
id|fetch_and_setup_pack_index
c_func
(paren
id|packs_head
comma
id|sha1
comma
id|base_url
)paren
suffix:semicolon
id|i
op_add_assign
l_int|51
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
r_while
c_loop
(paren
id|i
OL
id|buf.len
op_logical_and
id|data
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
id|i
op_increment
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
id|cleanup
suffix:colon
id|free
c_func
(paren
id|url
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|release_http_pack_request
r_void
id|release_http_pack_request
c_func
(paren
r_struct
id|http_pack_request
op_star
id|preq
)paren
(brace
r_if
c_cond
(paren
id|preq-&gt;packfile
op_ne
l_int|NULL
)paren
(brace
id|fclose
c_func
(paren
id|preq-&gt;packfile
)paren
suffix:semicolon
id|preq-&gt;packfile
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|preq-&gt;range_header
op_ne
l_int|NULL
)paren
(brace
id|curl_slist_free_all
c_func
(paren
id|preq-&gt;range_header
)paren
suffix:semicolon
id|preq-&gt;range_header
op_assign
l_int|NULL
suffix:semicolon
)brace
id|preq-&gt;slot
op_assign
l_int|NULL
suffix:semicolon
id|free
c_func
(paren
id|preq-&gt;url
)paren
suffix:semicolon
id|free
c_func
(paren
id|preq
)paren
suffix:semicolon
)brace
DECL|function|finish_http_pack_request
r_int
id|finish_http_pack_request
c_func
(paren
r_struct
id|http_pack_request
op_star
id|preq
)paren
(brace
r_struct
id|packed_git
op_star
op_star
id|lst
suffix:semicolon
r_struct
id|packed_git
op_star
id|p
op_assign
id|preq-&gt;target
suffix:semicolon
r_char
op_star
id|tmp_idx
suffix:semicolon
r_struct
id|child_process
id|ip
op_assign
id|CHILD_PROCESS_INIT
suffix:semicolon
r_const
r_char
op_star
id|ip_argv
(braket
l_int|8
)braket
suffix:semicolon
id|close_pack_index
c_func
(paren
id|p
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|preq-&gt;packfile
)paren
suffix:semicolon
id|preq-&gt;packfile
op_assign
l_int|NULL
suffix:semicolon
id|lst
op_assign
id|preq-&gt;lst
suffix:semicolon
r_while
c_loop
(paren
op_star
id|lst
op_ne
id|p
)paren
id|lst
op_assign
op_amp
(paren
(paren
op_star
id|lst
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|lst
op_assign
(paren
op_star
id|lst
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|tmp_idx
op_assign
id|xstrdup
c_func
(paren
id|preq-&gt;tmpfile
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|tmp_idx
op_plus
id|strlen
c_func
(paren
id|tmp_idx
)paren
id|strlen
c_func
(paren
l_string|&quot;.pack.temp&quot;
)paren
comma
l_string|&quot;.idx.temp&quot;
)paren
suffix:semicolon
id|ip_argv
(braket
l_int|0
)braket
op_assign
l_string|&quot;index-pack&quot;
suffix:semicolon
id|ip_argv
(braket
l_int|1
)braket
op_assign
l_string|&quot;-o&quot;
suffix:semicolon
id|ip_argv
(braket
l_int|2
)braket
op_assign
id|tmp_idx
suffix:semicolon
id|ip_argv
(braket
l_int|3
)braket
op_assign
id|preq-&gt;tmpfile
suffix:semicolon
id|ip_argv
(braket
l_int|4
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ip.argv
op_assign
id|ip_argv
suffix:semicolon
id|ip.git_cmd
op_assign
l_int|1
suffix:semicolon
id|ip.no_stdin
op_assign
l_int|1
suffix:semicolon
id|ip.no_stdout
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|run_command
c_func
(paren
op_amp
id|ip
)paren
)paren
(brace
id|unlink
c_func
(paren
id|preq-&gt;tmpfile
)paren
suffix:semicolon
id|unlink
c_func
(paren
id|tmp_idx
)paren
suffix:semicolon
id|free
c_func
(paren
id|tmp_idx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|unlink
c_func
(paren
id|sha1_pack_index_name
c_func
(paren
id|p-&gt;sha1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|move_temp_to_file
c_func
(paren
id|preq-&gt;tmpfile
comma
id|sha1_pack_name
c_func
(paren
id|p-&gt;sha1
)paren
)paren
op_logical_or
id|move_temp_to_file
c_func
(paren
id|tmp_idx
comma
id|sha1_pack_index_name
c_func
(paren
id|p-&gt;sha1
)paren
)paren
)paren
(brace
id|free
c_func
(paren
id|tmp_idx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|install_packed_git
c_func
(paren
id|p
)paren
suffix:semicolon
id|free
c_func
(paren
id|tmp_idx
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|new_http_pack_request
r_struct
id|http_pack_request
op_star
id|new_http_pack_request
c_func
(paren
r_struct
id|packed_git
op_star
id|target
comma
r_const
r_char
op_star
id|base_url
)paren
(brace
r_int
id|prev_posn
op_assign
l_int|0
suffix:semicolon
r_char
id|range
(braket
id|RANGE_HEADER_SIZE
)braket
suffix:semicolon
r_struct
id|strbuf
id|buf
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|http_pack_request
op_star
id|preq
suffix:semicolon
id|preq
op_assign
id|xcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|preq
)paren
)paren
suffix:semicolon
id|preq-&gt;target
op_assign
id|target
suffix:semicolon
id|end_url_with_slash
c_func
(paren
op_amp
id|buf
comma
id|base_url
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|buf
comma
l_string|&quot;objects/pack/pack-%s.pack&quot;
comma
id|sha1_to_hex
c_func
(paren
id|target-&gt;sha1
)paren
)paren
suffix:semicolon
id|preq-&gt;url
op_assign
id|strbuf_detach
c_func
(paren
op_amp
id|buf
comma
l_int|NULL
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|preq-&gt;tmpfile
comma
r_sizeof
(paren
id|preq-&gt;tmpfile
)paren
comma
l_string|&quot;%s.temp&quot;
comma
id|sha1_pack_name
c_func
(paren
id|target-&gt;sha1
)paren
)paren
suffix:semicolon
id|preq-&gt;packfile
op_assign
id|fopen
c_func
(paren
id|preq-&gt;tmpfile
comma
l_string|&quot;a&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|preq-&gt;packfile
)paren
(brace
id|error
c_func
(paren
l_string|&quot;Unable to open local file %s for pack&quot;
comma
id|preq-&gt;tmpfile
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|preq-&gt;slot
op_assign
id|get_active_slot
c_func
(paren
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|preq-&gt;slot-&gt;curl
comma
id|CURLOPT_FILE
comma
id|preq-&gt;packfile
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|preq-&gt;slot-&gt;curl
comma
id|CURLOPT_WRITEFUNCTION
comma
id|fwrite
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|preq-&gt;slot-&gt;curl
comma
id|CURLOPT_URL
comma
id|preq-&gt;url
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|preq-&gt;slot-&gt;curl
comma
id|CURLOPT_HTTPHEADER
comma
id|no_pragma_header
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If there is data present from a previous transfer attempt,&n;&t; * resume where it left off&n;&t; */
id|prev_posn
op_assign
id|ftell
c_func
(paren
id|preq-&gt;packfile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev_posn
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|http_is_verbose
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Resuming fetch of pack %s at byte %ld&bslash;n&quot;
comma
id|sha1_to_hex
c_func
(paren
id|target-&gt;sha1
)paren
comma
id|prev_posn
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|range
comma
l_string|&quot;Range: bytes=%ld-&quot;
comma
id|prev_posn
)paren
suffix:semicolon
id|preq-&gt;range_header
op_assign
id|curl_slist_append
c_func
(paren
l_int|NULL
comma
id|range
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|preq-&gt;slot-&gt;curl
comma
id|CURLOPT_HTTPHEADER
comma
id|preq-&gt;range_header
)paren
suffix:semicolon
)brace
r_return
id|preq
suffix:semicolon
m_abort
suffix:colon
id|free
c_func
(paren
id|preq-&gt;url
)paren
suffix:semicolon
id|free
c_func
(paren
id|preq
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Helpers for fetching objects (loose) */
DECL|function|fwrite_sha1_file
r_static
r_int
id|fwrite_sha1_file
c_func
(paren
r_char
op_star
id|ptr
comma
r_int
id|eltsize
comma
r_int
id|nmemb
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_char
id|expn
(braket
l_int|4096
)braket
suffix:semicolon
r_int
id|size
op_assign
id|eltsize
op_star
id|nmemb
suffix:semicolon
r_int
id|posn
op_assign
l_int|0
suffix:semicolon
r_struct
id|http_object_request
op_star
id|freq
op_assign
(paren
r_struct
id|http_object_request
op_star
)paren
id|data
suffix:semicolon
r_do
(brace
id|ssize_t
id|retval
op_assign
id|xwrite
c_func
(paren
id|freq-&gt;localfile
comma
(paren
r_char
op_star
)paren
id|ptr
op_plus
id|posn
comma
id|size
id|posn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|posn
suffix:semicolon
id|posn
op_add_assign
id|retval
suffix:semicolon
)brace
r_while
c_loop
(paren
id|posn
OL
id|size
)paren
suffix:semicolon
id|freq-&gt;stream.avail_in
op_assign
id|size
suffix:semicolon
id|freq-&gt;stream.next_in
op_assign
(paren
r_void
op_star
)paren
id|ptr
suffix:semicolon
r_do
(brace
id|freq-&gt;stream.next_out
op_assign
id|expn
suffix:semicolon
id|freq-&gt;stream.avail_out
op_assign
r_sizeof
(paren
id|expn
)paren
suffix:semicolon
id|freq-&gt;zret
op_assign
id|git_inflate
c_func
(paren
op_amp
id|freq-&gt;stream
comma
id|Z_SYNC_FLUSH
)paren
suffix:semicolon
id|git_SHA1_Update
c_func
(paren
op_amp
id|freq-&gt;c
comma
id|expn
comma
r_sizeof
(paren
id|expn
)paren
id|freq-&gt;stream.avail_out
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|freq-&gt;stream.avail_in
op_logical_and
id|freq-&gt;zret
op_eq
id|Z_OK
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
DECL|function|new_http_object_request
r_struct
id|http_object_request
op_star
id|new_http_object_request
c_func
(paren
r_const
r_char
op_star
id|base_url
comma
r_int
r_char
op_star
id|sha1
)paren
(brace
r_char
op_star
id|hex
op_assign
id|sha1_to_hex
c_func
(paren
id|sha1
)paren
suffix:semicolon
r_const
r_char
op_star
id|filename
suffix:semicolon
r_char
id|prevfile
(braket
id|PATH_MAX
)braket
suffix:semicolon
r_int
id|prevlocal
suffix:semicolon
r_char
id|prev_buf
(braket
id|PREV_BUF_SIZE
)braket
suffix:semicolon
id|ssize_t
id|prev_read
op_assign
l_int|0
suffix:semicolon
r_int
id|prev_posn
op_assign
l_int|0
suffix:semicolon
r_char
id|range
(braket
id|RANGE_HEADER_SIZE
)braket
suffix:semicolon
r_struct
id|curl_slist
op_star
id|range_header
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|http_object_request
op_star
id|freq
suffix:semicolon
id|freq
op_assign
id|xcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|freq
)paren
)paren
suffix:semicolon
id|hashcpy
c_func
(paren
id|freq-&gt;sha1
comma
id|sha1
)paren
suffix:semicolon
id|freq-&gt;localfile
op_assign
l_int|1
suffix:semicolon
id|filename
op_assign
id|sha1_file_name
c_func
(paren
id|sha1
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|freq-&gt;tmpfile
comma
r_sizeof
(paren
id|freq-&gt;tmpfile
)paren
comma
l_string|&quot;%s.temp&quot;
comma
id|filename
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|prevfile
comma
r_sizeof
(paren
id|prevfile
)paren
comma
l_string|&quot;%s.prev&quot;
comma
id|filename
)paren
suffix:semicolon
id|unlink_or_warn
c_func
(paren
id|prevfile
)paren
suffix:semicolon
id|rename
c_func
(paren
id|freq-&gt;tmpfile
comma
id|prevfile
)paren
suffix:semicolon
id|unlink_or_warn
c_func
(paren
id|freq-&gt;tmpfile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq-&gt;localfile
op_ne
l_int|1
)paren
id|error
c_func
(paren
l_string|&quot;fd leakage in start: %d&quot;
comma
id|freq-&gt;localfile
)paren
suffix:semicolon
id|freq-&gt;localfile
op_assign
id|open
c_func
(paren
id|freq-&gt;tmpfile
comma
id|O_WRONLY
op_or
id|O_CREAT
op_or
id|O_EXCL
comma
l_int|0666
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This could have failed due to the &quot;lazy directory creation&quot;;&n;&t; * try to mkdir the last path component.&n;&t; */
r_if
c_cond
(paren
id|freq-&gt;localfile
OL
l_int|0
op_logical_and
id|errno
op_eq
id|ENOENT
)paren
(brace
r_char
op_star
id|dir
op_assign
id|strrchr
c_func
(paren
id|freq-&gt;tmpfile
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
)paren
(brace
op_star
id|dir
op_assign
l_int|0
suffix:semicolon
id|mkdir
c_func
(paren
id|freq-&gt;tmpfile
comma
l_int|0777
)paren
suffix:semicolon
op_star
id|dir
op_assign
l_char|&squot;/&squot;
suffix:semicolon
)brace
id|freq-&gt;localfile
op_assign
id|open
c_func
(paren
id|freq-&gt;tmpfile
comma
id|O_WRONLY
op_or
id|O_CREAT
op_or
id|O_EXCL
comma
l_int|0666
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freq-&gt;localfile
OL
l_int|0
)paren
(brace
id|error
c_func
(paren
l_string|&quot;Couldn&squot;t create temporary file %s: %s&quot;
comma
id|freq-&gt;tmpfile
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|git_inflate_init
c_func
(paren
op_amp
id|freq-&gt;stream
)paren
suffix:semicolon
id|git_SHA1_Init
c_func
(paren
op_amp
id|freq-&gt;c
)paren
suffix:semicolon
id|freq-&gt;url
op_assign
id|get_remote_object_url
c_func
(paren
id|base_url
comma
id|hex
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If a previous temp file is present, process what was already&n;&t; * fetched.&n;&t; */
id|prevlocal
op_assign
id|open
c_func
(paren
id|prevfile
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prevlocal
op_ne
l_int|1
)paren
(brace
r_do
(brace
id|prev_read
op_assign
id|xread
c_func
(paren
id|prevlocal
comma
id|prev_buf
comma
id|PREV_BUF_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev_read
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|fwrite_sha1_file
c_func
(paren
id|prev_buf
comma
l_int|1
comma
id|prev_read
comma
id|freq
)paren
op_eq
id|prev_read
)paren
(brace
id|prev_posn
op_add_assign
id|prev_read
suffix:semicolon
)brace
r_else
(brace
id|prev_read
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|prev_read
OG
l_int|0
)paren
suffix:semicolon
id|close
c_func
(paren
id|prevlocal
)paren
suffix:semicolon
)brace
id|unlink_or_warn
c_func
(paren
id|prevfile
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset inflate/SHA1 if there was an error reading the previous temp&n;&t; * file; also rewind to the beginning of the local file.&n;&t; */
r_if
c_cond
(paren
id|prev_read
op_eq
l_int|1
)paren
(brace
id|memset
c_func
(paren
op_amp
id|freq-&gt;stream
comma
l_int|0
comma
r_sizeof
(paren
id|freq-&gt;stream
)paren
)paren
suffix:semicolon
id|git_inflate_init
c_func
(paren
op_amp
id|freq-&gt;stream
)paren
suffix:semicolon
id|git_SHA1_Init
c_func
(paren
op_amp
id|freq-&gt;c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev_posn
OG
l_int|0
)paren
(brace
id|prev_posn
op_assign
l_int|0
suffix:semicolon
id|lseek
c_func
(paren
id|freq-&gt;localfile
comma
l_int|0
comma
id|SEEK_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ftruncate
c_func
(paren
id|freq-&gt;localfile
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|error
c_func
(paren
l_string|&quot;Couldn&squot;t truncate temporary file %s: %s&quot;
comma
id|freq-&gt;tmpfile
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
)brace
)brace
id|freq-&gt;slot
op_assign
id|get_active_slot
c_func
(paren
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|freq-&gt;slot-&gt;curl
comma
id|CURLOPT_FILE
comma
id|freq
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|freq-&gt;slot-&gt;curl
comma
id|CURLOPT_WRITEFUNCTION
comma
id|fwrite_sha1_file
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|freq-&gt;slot-&gt;curl
comma
id|CURLOPT_ERRORBUFFER
comma
id|freq-&gt;errorstr
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|freq-&gt;slot-&gt;curl
comma
id|CURLOPT_URL
comma
id|freq-&gt;url
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|freq-&gt;slot-&gt;curl
comma
id|CURLOPT_HTTPHEADER
comma
id|no_pragma_header
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we have successfully processed data from a previous fetch&n;&t; * attempt, only fetch the data we don&squot;t already have.&n;&t; */
r_if
c_cond
(paren
id|prev_posn
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|http_is_verbose
)paren
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Resuming fetch of object %s at byte %ld&bslash;n&quot;
comma
id|hex
comma
id|prev_posn
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|range
comma
l_string|&quot;Range: bytes=%ld-&quot;
comma
id|prev_posn
)paren
suffix:semicolon
id|range_header
op_assign
id|curl_slist_append
c_func
(paren
id|range_header
comma
id|range
)paren
suffix:semicolon
id|curl_easy_setopt
c_func
(paren
id|freq-&gt;slot-&gt;curl
comma
id|CURLOPT_HTTPHEADER
comma
id|range_header
)paren
suffix:semicolon
)brace
r_return
id|freq
suffix:semicolon
m_abort
suffix:colon
id|free
c_func
(paren
id|freq-&gt;url
)paren
suffix:semicolon
id|free
c_func
(paren
id|freq
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|process_http_object_request
r_void
id|process_http_object_request
c_func
(paren
r_struct
id|http_object_request
op_star
id|freq
)paren
(brace
r_if
c_cond
(paren
id|freq-&gt;slot
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|freq-&gt;curl_result
op_assign
id|freq-&gt;slot-&gt;curl_result
suffix:semicolon
id|freq-&gt;http_code
op_assign
id|freq-&gt;slot-&gt;http_code
suffix:semicolon
id|freq-&gt;slot
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|finish_http_object_request
r_int
id|finish_http_object_request
c_func
(paren
r_struct
id|http_object_request
op_star
id|freq
)paren
(brace
r_struct
id|stat
id|st
suffix:semicolon
id|close
c_func
(paren
id|freq-&gt;localfile
)paren
suffix:semicolon
id|freq-&gt;localfile
op_assign
l_int|1
suffix:semicolon
id|process_http_object_request
c_func
(paren
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq-&gt;http_code
op_eq
l_int|416
)paren
(brace
id|warning
c_func
(paren
l_string|&quot;requested range invalid; we may already have all the data.&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|freq-&gt;curl_result
op_ne
id|CURLE_OK
)paren
(brace
r_if
c_cond
(paren
id|stat
c_func
(paren
id|freq-&gt;tmpfile
comma
op_amp
id|st
)paren
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|st.st_size
op_eq
l_int|0
)paren
id|unlink_or_warn
c_func
(paren
id|freq-&gt;tmpfile
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|git_inflate_end
c_func
(paren
op_amp
id|freq-&gt;stream
)paren
suffix:semicolon
id|git_SHA1_Final
c_func
(paren
id|freq-&gt;real_sha1
comma
op_amp
id|freq-&gt;c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq-&gt;zret
op_ne
id|Z_STREAM_END
)paren
(brace
id|unlink_or_warn
c_func
(paren
id|freq-&gt;tmpfile
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hashcmp
c_func
(paren
id|freq-&gt;sha1
comma
id|freq-&gt;real_sha1
)paren
)paren
(brace
id|unlink_or_warn
c_func
(paren
id|freq-&gt;tmpfile
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|freq-&gt;rename
op_assign
id|move_temp_to_file
c_func
(paren
id|freq-&gt;tmpfile
comma
id|sha1_file_name
c_func
(paren
id|freq-&gt;sha1
)paren
)paren
suffix:semicolon
r_return
id|freq-&gt;rename
suffix:semicolon
)brace
DECL|function|abort_http_object_request
r_void
id|abort_http_object_request
c_func
(paren
r_struct
id|http_object_request
op_star
id|freq
)paren
(brace
id|unlink_or_warn
c_func
(paren
id|freq-&gt;tmpfile
)paren
suffix:semicolon
id|release_http_object_request
c_func
(paren
id|freq
)paren
suffix:semicolon
)brace
DECL|function|release_http_object_request
r_void
id|release_http_object_request
c_func
(paren
r_struct
id|http_object_request
op_star
id|freq
)paren
(brace
r_if
c_cond
(paren
id|freq-&gt;localfile
op_ne
l_int|1
)paren
(brace
id|close
c_func
(paren
id|freq-&gt;localfile
)paren
suffix:semicolon
id|freq-&gt;localfile
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freq-&gt;url
op_ne
l_int|NULL
)paren
(brace
id|free
c_func
(paren
id|freq-&gt;url
)paren
suffix:semicolon
id|freq-&gt;url
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|freq-&gt;slot
op_ne
l_int|NULL
)paren
(brace
id|freq-&gt;slot-&gt;callback_func
op_assign
l_int|NULL
suffix:semicolon
id|freq-&gt;slot-&gt;callback_data
op_assign
l_int|NULL
suffix:semicolon
id|release_active_slot
c_func
(paren
id|freq-&gt;slot
)paren
suffix:semicolon
id|freq-&gt;slot
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
eof
