multiline_comment|/*&n; * Copyright (c) 2005, Junio C Hamano&n; */
macro_line|#include &lt;signal.h&gt;
macro_line|#include &quot;cache.h&quot;
DECL|variable|cache_file_list
r_static
r_struct
id|cache_file
op_star
id|cache_file_list
suffix:semicolon
DECL|function|remove_lock_file
r_static
r_void
id|remove_lock_file
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
id|cache_file_list
)paren
(brace
r_if
c_cond
(paren
id|cache_file_list-&gt;lockfile
(braket
l_int|0
)braket
)paren
id|unlink
c_func
(paren
id|cache_file_list-&gt;lockfile
)paren
suffix:semicolon
id|cache_file_list
op_assign
id|cache_file_list-&gt;next
suffix:semicolon
)brace
)brace
DECL|function|remove_lock_file_on_signal
r_static
r_void
id|remove_lock_file_on_signal
c_func
(paren
r_int
id|signo
)paren
(brace
id|remove_lock_file
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|hold_index_file_for_update
r_int
id|hold_index_file_for_update
c_func
(paren
r_struct
id|cache_file
op_star
id|cf
comma
r_const
r_char
op_star
id|path
)paren
(brace
id|sprintf
c_func
(paren
id|cf-&gt;lockfile
comma
l_string|&quot;%s.lock&quot;
comma
id|path
)paren
suffix:semicolon
id|cf-&gt;next
op_assign
id|cache_file_list
suffix:semicolon
id|cache_file_list
op_assign
id|cf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cf-&gt;next
)paren
(brace
id|signal
c_func
(paren
id|SIGINT
comma
id|remove_lock_file_on_signal
)paren
suffix:semicolon
id|atexit
c_func
(paren
id|remove_lock_file
)paren
suffix:semicolon
)brace
r_return
id|open
c_func
(paren
id|cf-&gt;lockfile
comma
id|O_RDWR
op_or
id|O_CREAT
op_or
id|O_EXCL
comma
l_int|0666
)paren
suffix:semicolon
)brace
DECL|function|commit_index_file
r_int
id|commit_index_file
c_func
(paren
r_struct
id|cache_file
op_star
id|cf
)paren
(brace
r_char
id|indexfile
(braket
id|PATH_MAX
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|strcpy
c_func
(paren
id|indexfile
comma
id|cf-&gt;lockfile
)paren
suffix:semicolon
id|i
op_assign
id|strlen
c_func
(paren
id|indexfile
)paren
l_int|5
suffix:semicolon
multiline_comment|/* .lock */
id|indexfile
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|rename
c_func
(paren
id|cf-&gt;lockfile
comma
id|indexfile
)paren
suffix:semicolon
id|cf-&gt;lockfile
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|rollback_index_file
r_void
id|rollback_index_file
c_func
(paren
r_struct
id|cache_file
op_star
id|cf
)paren
(brace
r_if
c_cond
(paren
id|cf-&gt;lockfile
(braket
l_int|0
)braket
)paren
id|unlink
c_func
(paren
id|cf-&gt;lockfile
)paren
suffix:semicolon
id|cf-&gt;lockfile
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
eof
