multiline_comment|/*&n; * Builtin &quot;git clone&quot;&n; *&n; * Copyright (c) 2007 Kristian H&oslash;gsberg &lt;krh@redhat.com&gt;,&n; *&t;&t; 2008 Daniel Barkalow &lt;barkalow@iabervon.org&gt;&n; * Based on git-commit.sh by Junio C Hamano and Linus Torvalds&n; *&n; * Clone a repository into a different directory that does not yet exist.&n; */
macro_line|#include &quot;builtin.h&quot;
macro_line|#include &quot;parse-options.h&quot;
macro_line|#include &quot;fetch-pack.h&quot;
macro_line|#include &quot;refs.h&quot;
macro_line|#include &quot;tree.h&quot;
macro_line|#include &quot;tree-walk.h&quot;
macro_line|#include &quot;unpack-trees.h&quot;
macro_line|#include &quot;transport.h&quot;
macro_line|#include &quot;strbuf.h&quot;
macro_line|#include &quot;dir.h&quot;
macro_line|#include &quot;pack-refs.h&quot;
macro_line|#include &quot;sigchain.h&quot;
macro_line|#include &quot;branch.h&quot;
macro_line|#include &quot;remote.h&quot;
macro_line|#include &quot;run-command.h&quot;
multiline_comment|/*&n; * Overall FIXMEs:&n; *  - respect DB_ENVIRONMENT for .git/objects.&n; *&n; * Implementation notes:&n; *  - dropping use-separate-remote and no-separate-remote compatibility&n; *&n; */
DECL|variable|builtin_clone_usage
r_static
r_const
r_char
op_star
r_const
id|builtin_clone_usage
(braket
)braket
op_assign
(brace
l_string|&quot;git clone [options] [--] &lt;repo&gt; [&lt;dir&gt;]&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|option_no_checkout
DECL|variable|option_bare
DECL|variable|option_mirror
DECL|variable|option_single_branch
r_static
r_int
id|option_no_checkout
comma
id|option_bare
comma
id|option_mirror
comma
id|option_single_branch
op_assign
l_int|1
suffix:semicolon
DECL|variable|option_local
DECL|variable|option_no_hardlinks
DECL|variable|option_shared
DECL|variable|option_recursive
r_static
r_int
id|option_local
comma
id|option_no_hardlinks
comma
id|option_shared
comma
id|option_recursive
suffix:semicolon
DECL|variable|option_template
DECL|variable|option_depth
r_static
r_char
op_star
id|option_template
comma
op_star
id|option_depth
suffix:semicolon
DECL|variable|option_origin
r_static
r_char
op_star
id|option_origin
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|option_branch
r_static
r_char
op_star
id|option_branch
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|real_git_dir
r_static
r_const
r_char
op_star
id|real_git_dir
suffix:semicolon
DECL|variable|option_upload_pack
r_static
r_char
op_star
id|option_upload_pack
op_assign
l_string|&quot;git-upload-pack&quot;
suffix:semicolon
DECL|variable|option_verbosity
r_static
r_int
id|option_verbosity
suffix:semicolon
DECL|variable|option_progress
r_static
r_int
id|option_progress
suffix:semicolon
DECL|variable|option_config
r_static
r_struct
id|string_list
id|option_config
suffix:semicolon
DECL|variable|option_reference
r_static
r_struct
id|string_list
id|option_reference
suffix:semicolon
DECL|function|opt_parse_reference
r_static
r_int
id|opt_parse_reference
c_func
(paren
r_const
r_struct
id|option
op_star
id|opt
comma
r_const
r_char
op_star
id|arg
comma
r_int
id|unset
)paren
(brace
r_struct
id|string_list
op_star
id|option_reference
op_assign
id|opt-&gt;value
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
l_int|1
suffix:semicolon
id|string_list_append
c_func
(paren
id|option_reference
comma
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|builtin_clone_options
r_static
r_struct
id|option
id|builtin_clone_options
(braket
)braket
op_assign
(brace
id|OPT__VERBOSITY
c_func
(paren
op_amp
id|option_verbosity
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_int|0
comma
l_string|&quot;progress&quot;
comma
op_amp
id|option_progress
comma
l_string|&quot;force progress reporting&quot;
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_char|&squot;n&squot;
comma
l_string|&quot;no-checkout&quot;
comma
op_amp
id|option_no_checkout
comma
l_string|&quot;don&squot;t create a checkout&quot;
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_int|0
comma
l_string|&quot;bare&quot;
comma
op_amp
id|option_bare
comma
l_string|&quot;create a bare repository&quot;
)paren
comma
(brace
id|OPTION_BOOLEAN
comma
l_int|0
comma
l_string|&quot;naked&quot;
comma
op_amp
id|option_bare
comma
l_int|NULL
comma
l_string|&quot;create a bare repository&quot;
comma
id|PARSE_OPT_NOARG
op_or
id|PARSE_OPT_HIDDEN
)brace
comma
id|OPT_BOOLEAN
c_func
(paren
l_int|0
comma
l_string|&quot;mirror&quot;
comma
op_amp
id|option_mirror
comma
l_string|&quot;create a mirror repository (implies bare)&quot;
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_char|&squot;l&squot;
comma
l_string|&quot;local&quot;
comma
op_amp
id|option_local
comma
l_string|&quot;to clone from a local repository&quot;
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_int|0
comma
l_string|&quot;no-hardlinks&quot;
comma
op_amp
id|option_no_hardlinks
comma
l_string|&quot;don&squot;t use local hardlinks, always copy&quot;
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_char|&squot;s&squot;
comma
l_string|&quot;shared&quot;
comma
op_amp
id|option_shared
comma
l_string|&quot;setup as shared repository&quot;
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_int|0
comma
l_string|&quot;recursive&quot;
comma
op_amp
id|option_recursive
comma
l_string|&quot;initialize submodules in the clone&quot;
)paren
comma
id|OPT_BOOLEAN
c_func
(paren
l_int|0
comma
l_string|&quot;recurse-submodules&quot;
comma
op_amp
id|option_recursive
comma
l_string|&quot;initialize submodules in the clone&quot;
)paren
comma
id|OPT_STRING
c_func
(paren
l_int|0
comma
l_string|&quot;template&quot;
comma
op_amp
id|option_template
comma
l_string|&quot;template-directory&quot;
comma
l_string|&quot;directory from which templates will be used&quot;
)paren
comma
id|OPT_CALLBACK
c_func
(paren
l_int|0
comma
l_string|&quot;reference&quot;
comma
op_amp
id|option_reference
comma
l_string|&quot;repo&quot;
comma
l_string|&quot;reference repository&quot;
comma
op_amp
id|opt_parse_reference
)paren
comma
id|OPT_STRING
c_func
(paren
l_char|&squot;o&squot;
comma
l_string|&quot;origin&quot;
comma
op_amp
id|option_origin
comma
l_string|&quot;name&quot;
comma
l_string|&quot;use &lt;name&gt; instead of &squot;origin&squot; to track upstream&quot;
)paren
comma
id|OPT_STRING
c_func
(paren
l_char|&squot;b&squot;
comma
l_string|&quot;branch&quot;
comma
op_amp
id|option_branch
comma
l_string|&quot;branch&quot;
comma
l_string|&quot;checkout &lt;branch&gt; instead of the remote&squot;s HEAD&quot;
)paren
comma
id|OPT_STRING
c_func
(paren
l_char|&squot;u&squot;
comma
l_string|&quot;upload-pack&quot;
comma
op_amp
id|option_upload_pack
comma
l_string|&quot;path&quot;
comma
l_string|&quot;path to git-upload-pack on the remote&quot;
)paren
comma
id|OPT_STRING
c_func
(paren
l_int|0
comma
l_string|&quot;depth&quot;
comma
op_amp
id|option_depth
comma
l_string|&quot;depth&quot;
comma
l_string|&quot;create a shallow clone of that depth&quot;
)paren
comma
id|OPT_BOOL
c_func
(paren
l_int|0
comma
l_string|&quot;single-branch&quot;
comma
op_amp
id|option_single_branch
comma
l_string|&quot;clone only one branch, HEAD or --branch&quot;
)paren
comma
id|OPT_STRING
c_func
(paren
l_int|0
comma
l_string|&quot;separate-git-dir&quot;
comma
op_amp
id|real_git_dir
comma
l_string|&quot;gitdir&quot;
comma
l_string|&quot;separate git dir from working tree&quot;
)paren
comma
id|OPT_STRING_LIST
c_func
(paren
l_char|&squot;c&squot;
comma
l_string|&quot;config&quot;
comma
op_amp
id|option_config
comma
l_string|&quot;key=value&quot;
comma
l_string|&quot;set config inside the new repository&quot;
)paren
comma
id|OPT_END
c_func
(paren
)paren
)brace
suffix:semicolon
DECL|variable|argv_submodule
r_static
r_const
r_char
op_star
id|argv_submodule
(braket
)braket
op_assign
(brace
l_string|&quot;submodule&quot;
comma
l_string|&quot;update&quot;
comma
l_string|&quot;--init&quot;
comma
l_string|&quot;--recursive&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|get_repo_path
r_static
r_char
op_star
id|get_repo_path
c_func
(paren
r_const
r_char
op_star
id|repo
comma
r_int
op_star
id|is_bundle
)paren
(brace
r_static
r_char
op_star
id|suffix
(braket
)braket
op_assign
(brace
l_string|&quot;/.git&quot;
comma
l_string|&quot;.git&quot;
comma
l_string|&quot;&quot;
)brace
suffix:semicolon
r_static
r_char
op_star
id|bundle_suffix
(braket
)braket
op_assign
(brace
l_string|&quot;.bundle&quot;
comma
l_string|&quot;&quot;
)brace
suffix:semicolon
r_struct
id|stat
id|st
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|suffix
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_const
r_char
op_star
id|path
suffix:semicolon
id|path
op_assign
id|mkpath
c_func
(paren
l_string|&quot;%s%s&quot;
comma
id|repo
comma
id|suffix
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
c_func
(paren
id|path
comma
op_amp
id|st
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|st.st_mode
)paren
)paren
(brace
op_star
id|is_bundle
op_assign
l_int|0
suffix:semicolon
r_return
id|xstrdup
c_func
(paren
id|absolute_path
c_func
(paren
id|path
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|st.st_mode
)paren
op_logical_and
id|st.st_size
OG
l_int|8
)paren
(brace
multiline_comment|/* Is it a &quot;gitfile&quot;? */
r_char
id|signature
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|len
comma
id|fd
op_assign
id|open
c_func
(paren
id|path
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|len
op_assign
id|read_in_full
c_func
(paren
id|fd
comma
id|signature
comma
l_int|8
)paren
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|8
op_logical_or
id|strncmp
c_func
(paren
id|signature
comma
l_string|&quot;gitdir: &quot;
comma
l_int|8
)paren
)paren
r_continue
suffix:semicolon
id|path
op_assign
id|read_gitfile
c_func
(paren
id|path
)paren
suffix:semicolon
r_if
c_cond
(paren
id|path
)paren
(brace
op_star
id|is_bundle
op_assign
l_int|0
suffix:semicolon
r_return
id|xstrdup
c_func
(paren
id|absolute_path
c_func
(paren
id|path
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|bundle_suffix
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_const
r_char
op_star
id|path
suffix:semicolon
id|path
op_assign
id|mkpath
c_func
(paren
l_string|&quot;%s%s&quot;
comma
id|repo
comma
id|bundle_suffix
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stat
c_func
(paren
id|path
comma
op_amp
id|st
)paren
op_logical_and
id|S_ISREG
c_func
(paren
id|st.st_mode
)paren
)paren
(brace
op_star
id|is_bundle
op_assign
l_int|1
suffix:semicolon
r_return
id|xstrdup
c_func
(paren
id|absolute_path
c_func
(paren
id|path
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|guess_dir_name
r_static
r_char
op_star
id|guess_dir_name
c_func
(paren
r_const
r_char
op_star
id|repo
comma
r_int
id|is_bundle
comma
r_int
id|is_bare
)paren
(brace
r_const
r_char
op_star
id|end
op_assign
id|repo
op_plus
id|strlen
c_func
(paren
id|repo
)paren
comma
op_star
id|start
suffix:semicolon
r_char
op_star
id|dir
suffix:semicolon
multiline_comment|/*&n;&t; * Strip trailing spaces, slashes and /.git&n;&t; */
r_while
c_loop
(paren
id|repo
OL
id|end
op_logical_and
(paren
id|is_dir_sep
c_func
(paren
id|end
(braket
l_int|1
)braket
)paren
op_logical_or
id|isspace
c_func
(paren
id|end
(braket
l_int|1
)braket
)paren
)paren
)paren
id|end
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|end
id|repo
OG
l_int|5
op_logical_and
id|is_dir_sep
c_func
(paren
id|end
(braket
l_int|5
)braket
)paren
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|end
l_int|4
comma
l_string|&quot;.git&quot;
comma
l_int|4
)paren
)paren
(brace
id|end
op_sub_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|repo
OL
id|end
op_logical_and
id|is_dir_sep
c_func
(paren
id|end
(braket
l_int|1
)braket
)paren
)paren
id|end
op_decrement
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Find last component, but be prepared that repo could have&n;&t; * the form  &quot;remote.example.com:foo.git&quot;, i.e. no slash&n;&t; * in the directory part.&n;&t; */
id|start
op_assign
id|end
suffix:semicolon
r_while
c_loop
(paren
id|repo
OL
id|start
op_logical_and
op_logical_neg
id|is_dir_sep
c_func
(paren
id|start
(braket
l_int|1
)braket
)paren
op_logical_and
id|start
(braket
l_int|1
)braket
op_ne
l_char|&squot;:&squot;
)paren
id|start
op_decrement
suffix:semicolon
multiline_comment|/*&n;&t; * Strip .{bundle,git}.&n;&t; */
r_if
c_cond
(paren
id|is_bundle
)paren
(brace
r_if
c_cond
(paren
id|end
id|start
OG
l_int|7
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|end
l_int|7
comma
l_string|&quot;.bundle&quot;
comma
l_int|7
)paren
)paren
id|end
op_sub_assign
l_int|7
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|end
id|start
OG
l_int|4
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|end
l_int|4
comma
l_string|&quot;.git&quot;
comma
l_int|4
)paren
)paren
id|end
op_sub_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_bare
)paren
(brace
r_struct
id|strbuf
id|result
op_assign
id|STRBUF_INIT
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|result
comma
l_string|&quot;%.*s.git&quot;
comma
(paren
r_int
)paren
(paren
id|end
id|start
)paren
comma
id|start
)paren
suffix:semicolon
id|dir
op_assign
id|strbuf_detach
c_func
(paren
op_amp
id|result
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|dir
op_assign
id|xstrndup
c_func
(paren
id|start
comma
id|end
id|start
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Replace sequences of &squot;control&squot; characters and whitespace&n;&t; * with one ascii space, remove leading and trailing spaces.&n;&t; */
r_if
c_cond
(paren
op_star
id|dir
)paren
(brace
r_char
op_star
id|out
op_assign
id|dir
suffix:semicolon
r_int
id|prev_space
op_assign
l_int|1
multiline_comment|/* strip leading whitespace */
suffix:semicolon
r_for
c_loop
(paren
id|end
op_assign
id|dir
suffix:semicolon
op_star
id|end
suffix:semicolon
op_increment
id|end
)paren
(brace
r_char
id|ch
op_assign
op_star
id|end
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_char
)paren
id|ch
OL
l_char|&squot;&bslash;x20&squot;
)paren
id|ch
op_assign
l_char|&squot;&bslash;x20&squot;
suffix:semicolon
r_if
c_cond
(paren
id|isspace
c_func
(paren
id|ch
)paren
)paren
(brace
r_if
c_cond
(paren
id|prev_space
)paren
r_continue
suffix:semicolon
id|prev_space
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|prev_space
op_assign
l_int|0
suffix:semicolon
op_star
id|out
op_increment
op_assign
id|ch
suffix:semicolon
)brace
op_star
id|out
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|out
OG
id|dir
op_logical_and
id|prev_space
)paren
id|out
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|dir
suffix:semicolon
)brace
DECL|function|strip_trailing_slashes
r_static
r_void
id|strip_trailing_slashes
c_func
(paren
r_char
op_star
id|dir
)paren
(brace
r_char
op_star
id|end
op_assign
id|dir
op_plus
id|strlen
c_func
(paren
id|dir
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dir
OL
id|end
l_int|1
op_logical_and
id|is_dir_sep
c_func
(paren
id|end
(braket
l_int|1
)braket
)paren
)paren
id|end
op_decrement
suffix:semicolon
op_star
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
DECL|function|add_one_reference
r_static
r_int
id|add_one_reference
c_func
(paren
r_struct
id|string_list_item
op_star
id|item
comma
r_void
op_star
id|cb_data
)paren
(brace
r_char
op_star
id|ref_git
suffix:semicolon
r_struct
id|strbuf
id|alternate
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|remote
op_star
id|remote
suffix:semicolon
r_struct
id|transport
op_star
id|transport
suffix:semicolon
r_const
r_struct
id|ref
op_star
id|extra
suffix:semicolon
multiline_comment|/* Beware: real_path() and mkpath() return static buffer */
id|ref_git
op_assign
id|xstrdup
c_func
(paren
id|real_path
c_func
(paren
id|item-&gt;string
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_directory
c_func
(paren
id|mkpath
c_func
(paren
l_string|&quot;%s/.git/objects&quot;
comma
id|ref_git
)paren
)paren
)paren
(brace
r_char
op_star
id|ref_git_git
op_assign
id|xstrdup
c_func
(paren
id|mkpath
c_func
(paren
l_string|&quot;%s/.git&quot;
comma
id|ref_git
)paren
)paren
suffix:semicolon
id|free
c_func
(paren
id|ref_git
)paren
suffix:semicolon
id|ref_git
op_assign
id|ref_git_git
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|is_directory
c_func
(paren
id|mkpath
c_func
(paren
l_string|&quot;%s/objects&quot;
comma
id|ref_git
)paren
)paren
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;reference repository &squot;%s&squot; is not a local directory.&quot;
)paren
comma
id|item-&gt;string
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|alternate
comma
l_string|&quot;%s/objects&quot;
comma
id|ref_git
)paren
suffix:semicolon
id|add_to_alternates_file
c_func
(paren
id|alternate.buf
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|alternate
)paren
suffix:semicolon
id|remote
op_assign
id|remote_get
c_func
(paren
id|ref_git
)paren
suffix:semicolon
id|transport
op_assign
id|transport_get
c_func
(paren
id|remote
comma
id|ref_git
)paren
suffix:semicolon
r_for
c_loop
(paren
id|extra
op_assign
id|transport_get_remote_refs
c_func
(paren
id|transport
)paren
suffix:semicolon
id|extra
suffix:semicolon
id|extra
op_assign
id|extra-&gt;next
)paren
id|add_extra_ref
c_func
(paren
id|extra-&gt;name
comma
id|extra-&gt;old_sha1
comma
l_int|0
)paren
suffix:semicolon
id|transport_disconnect
c_func
(paren
id|transport
)paren
suffix:semicolon
id|free
c_func
(paren
id|ref_git
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|setup_reference
r_static
r_void
id|setup_reference
c_func
(paren
r_void
)paren
(brace
id|for_each_string_list
c_func
(paren
op_amp
id|option_reference
comma
id|add_one_reference
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|copy_alternates
r_static
r_void
id|copy_alternates
c_func
(paren
r_struct
id|strbuf
op_star
id|src
comma
r_struct
id|strbuf
op_star
id|dst
comma
r_const
r_char
op_star
id|src_repo
)paren
(brace
multiline_comment|/*&n;&t; * Read from the source objects/info/alternates file&n;&t; * and copy the entries to corresponding file in the&n;&t; * destination repository with add_to_alternates_file().&n;&t; * Both src and dst have &quot;$path/objects/info/alternates&quot;.&n;&t; *&n;&t; * Instead of copying bit-for-bit from the original,&n;&t; * we need to append to existing one so that the already&n;&t; * created entry via &quot;clone -s&quot; is not lost, and also&n;&t; * to turn entries with paths relative to the original&n;&t; * absolute, so that they can be used in the new repository.&n;&t; */
id|FILE
op_star
id|in
op_assign
id|fopen
c_func
(paren
id|src-&gt;buf
comma
l_string|&quot;r&quot;
)paren
suffix:semicolon
r_struct
id|strbuf
id|line
op_assign
id|STRBUF_INIT
suffix:semicolon
r_while
c_loop
(paren
id|strbuf_getline
c_func
(paren
op_amp
id|line
comma
id|in
comma
l_char|&squot;&bslash;n&squot;
)paren
op_ne
id|EOF
)paren
(brace
r_char
op_star
id|abs_path
comma
id|abs_buf
(braket
id|PATH_MAX
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|line.len
op_logical_or
id|line.buf
(braket
l_int|0
)braket
op_eq
l_char|&squot;#&squot;
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|is_absolute_path
c_func
(paren
id|line.buf
)paren
)paren
(brace
id|add_to_alternates_file
c_func
(paren
id|line.buf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|abs_path
op_assign
id|mkpath
c_func
(paren
l_string|&quot;%s/objects/%s&quot;
comma
id|src_repo
comma
id|line.buf
)paren
suffix:semicolon
id|normalize_path_copy
c_func
(paren
id|abs_buf
comma
id|abs_path
)paren
suffix:semicolon
id|add_to_alternates_file
c_func
(paren
id|abs_buf
)paren
suffix:semicolon
)brace
id|strbuf_release
c_func
(paren
op_amp
id|line
)paren
suffix:semicolon
id|fclose
c_func
(paren
id|in
)paren
suffix:semicolon
)brace
DECL|function|copy_or_link_directory
r_static
r_void
id|copy_or_link_directory
c_func
(paren
r_struct
id|strbuf
op_star
id|src
comma
r_struct
id|strbuf
op_star
id|dest
comma
r_const
r_char
op_star
id|src_repo
comma
r_int
id|src_baselen
)paren
(brace
r_struct
id|dirent
op_star
id|de
suffix:semicolon
r_struct
id|stat
id|buf
suffix:semicolon
r_int
id|src_len
comma
id|dest_len
suffix:semicolon
id|DIR
op_star
id|dir
suffix:semicolon
id|dir
op_assign
id|opendir
c_func
(paren
id|src-&gt;buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dir
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;failed to open &squot;%s&squot;&quot;
)paren
comma
id|src-&gt;buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mkdir
c_func
(paren
id|dest-&gt;buf
comma
l_int|0777
)paren
)paren
(brace
r_if
c_cond
(paren
id|errno
op_ne
id|EEXIST
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;failed to create directory &squot;%s&squot;&quot;
)paren
comma
id|dest-&gt;buf
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|stat
c_func
(paren
id|dest-&gt;buf
comma
op_amp
id|buf
)paren
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;failed to stat &squot;%s&squot;&quot;
)paren
comma
id|dest-&gt;buf
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|buf.st_mode
)paren
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;%s exists and is not a directory&quot;
)paren
comma
id|dest-&gt;buf
)paren
suffix:semicolon
)brace
id|strbuf_addch
c_func
(paren
id|src
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
id|src_len
op_assign
id|src-&gt;len
suffix:semicolon
id|strbuf_addch
c_func
(paren
id|dest
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
id|dest_len
op_assign
id|dest-&gt;len
suffix:semicolon
r_while
c_loop
(paren
(paren
id|de
op_assign
id|readdir
c_func
(paren
id|dir
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|strbuf_setlen
c_func
(paren
id|src
comma
id|src_len
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
id|src
comma
id|de-&gt;d_name
)paren
suffix:semicolon
id|strbuf_setlen
c_func
(paren
id|dest
comma
id|dest_len
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
id|dest
comma
id|de-&gt;d_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
c_func
(paren
id|src-&gt;buf
comma
op_amp
id|buf
)paren
)paren
(brace
id|warning
(paren
id|_
c_func
(paren
l_string|&quot;failed to stat %s&bslash;n&quot;
)paren
comma
id|src-&gt;buf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|buf.st_mode
)paren
)paren
(brace
r_if
c_cond
(paren
id|de-&gt;d_name
(braket
l_int|0
)braket
op_ne
l_char|&squot;.&squot;
)paren
id|copy_or_link_directory
c_func
(paren
id|src
comma
id|dest
comma
id|src_repo
comma
id|src_baselen
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Files that cannot be copied bit-for-bit... */
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|src-&gt;buf
op_plus
id|src_baselen
comma
l_string|&quot;/info/alternates&quot;
)paren
)paren
(brace
id|copy_alternates
c_func
(paren
id|src
comma
id|dest
comma
id|src_repo
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlink
c_func
(paren
id|dest-&gt;buf
)paren
op_logical_and
id|errno
op_ne
id|ENOENT
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;failed to unlink &squot;%s&squot;&quot;
)paren
comma
id|dest-&gt;buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|option_no_hardlinks
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|link
c_func
(paren
id|src-&gt;buf
comma
id|dest-&gt;buf
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|option_local
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;failed to create link &squot;%s&squot;&quot;
)paren
comma
id|dest-&gt;buf
)paren
suffix:semicolon
id|option_no_hardlinks
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_file_with_time
c_func
(paren
id|dest-&gt;buf
comma
id|src-&gt;buf
comma
l_int|0666
)paren
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;failed to copy file to &squot;%s&squot;&quot;
)paren
comma
id|dest-&gt;buf
)paren
suffix:semicolon
)brace
id|closedir
c_func
(paren
id|dir
)paren
suffix:semicolon
)brace
DECL|function|clone_local
r_static
r_void
id|clone_local
c_func
(paren
r_const
r_char
op_star
id|src_repo
comma
r_const
r_char
op_star
id|dest_repo
)paren
(brace
r_if
c_cond
(paren
id|option_shared
)paren
(brace
r_struct
id|strbuf
id|alt
op_assign
id|STRBUF_INIT
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|alt
comma
l_string|&quot;%s/objects&quot;
comma
id|src_repo
)paren
suffix:semicolon
id|add_to_alternates_file
c_func
(paren
id|alt.buf
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|alt
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|strbuf
id|src
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|strbuf
id|dest
op_assign
id|STRBUF_INIT
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|src
comma
l_string|&quot;%s/objects&quot;
comma
id|src_repo
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|dest
comma
l_string|&quot;%s/objects&quot;
comma
id|dest_repo
)paren
suffix:semicolon
id|copy_or_link_directory
c_func
(paren
op_amp
id|src
comma
op_amp
id|dest
comma
id|src_repo
comma
id|src.len
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|src
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|dest
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_le
id|option_verbosity
)paren
id|printf
c_func
(paren
id|_
c_func
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|variable|junk_work_tree
r_static
r_const
r_char
op_star
id|junk_work_tree
suffix:semicolon
DECL|variable|junk_git_dir
r_static
r_const
r_char
op_star
id|junk_git_dir
suffix:semicolon
DECL|variable|junk_pid
r_static
id|pid_t
id|junk_pid
suffix:semicolon
DECL|function|remove_junk
r_static
r_void
id|remove_junk
c_func
(paren
r_void
)paren
(brace
r_struct
id|strbuf
id|sb
op_assign
id|STRBUF_INIT
suffix:semicolon
r_if
c_cond
(paren
id|getpid
c_func
(paren
)paren
op_ne
id|junk_pid
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|junk_git_dir
)paren
(brace
id|strbuf_addstr
c_func
(paren
op_amp
id|sb
comma
id|junk_git_dir
)paren
suffix:semicolon
id|remove_dir_recursively
c_func
(paren
op_amp
id|sb
comma
l_int|0
)paren
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|sb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|junk_work_tree
)paren
(brace
id|strbuf_addstr
c_func
(paren
op_amp
id|sb
comma
id|junk_work_tree
)paren
suffix:semicolon
id|remove_dir_recursively
c_func
(paren
op_amp
id|sb
comma
l_int|0
)paren
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|sb
)paren
suffix:semicolon
)brace
)brace
DECL|function|remove_junk_on_signal
r_static
r_void
id|remove_junk_on_signal
c_func
(paren
r_int
id|signo
)paren
(brace
id|remove_junk
c_func
(paren
)paren
suffix:semicolon
id|sigchain_pop
c_func
(paren
id|signo
)paren
suffix:semicolon
id|raise
c_func
(paren
id|signo
)paren
suffix:semicolon
)brace
DECL|function|find_remote_branch
r_static
r_struct
id|ref
op_star
id|find_remote_branch
c_func
(paren
r_const
r_struct
id|ref
op_star
id|refs
comma
r_const
r_char
op_star
id|branch
)paren
(brace
r_struct
id|ref
op_star
id|ref
suffix:semicolon
r_struct
id|strbuf
id|head
op_assign
id|STRBUF_INIT
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|head
comma
l_string|&quot;refs/heads/&quot;
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|head
comma
id|branch
)paren
suffix:semicolon
id|ref
op_assign
id|find_ref_by_name
c_func
(paren
id|refs
comma
id|head.buf
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|head
)paren
suffix:semicolon
r_return
id|ref
suffix:semicolon
)brace
DECL|function|wanted_peer_refs
r_static
r_struct
id|ref
op_star
id|wanted_peer_refs
c_func
(paren
r_const
r_struct
id|ref
op_star
id|refs
comma
r_struct
id|refspec
op_star
id|refspec
)paren
(brace
r_struct
id|ref
op_star
id|head
op_assign
id|copy_ref
c_func
(paren
id|find_ref_by_name
c_func
(paren
id|refs
comma
l_string|&quot;HEAD&quot;
)paren
)paren
suffix:semicolon
r_struct
id|ref
op_star
id|local_refs
op_assign
id|head
suffix:semicolon
r_struct
id|ref
op_star
op_star
id|tail
op_assign
id|head
ques
c_cond
op_amp
id|head-&gt;next
suffix:colon
op_amp
id|local_refs
suffix:semicolon
r_if
c_cond
(paren
id|option_single_branch
)paren
(brace
r_struct
id|ref
op_star
id|remote_head
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|option_branch
)paren
id|remote_head
op_assign
id|guess_remote_head
c_func
(paren
id|head
comma
id|refs
comma
l_int|0
)paren
suffix:semicolon
r_else
id|remote_head
op_assign
id|find_remote_branch
c_func
(paren
id|refs
comma
id|option_branch
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|remote_head
op_logical_and
id|option_branch
)paren
id|warning
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Could not find remote branch %s to clone.&quot;
)paren
comma
id|option_branch
)paren
suffix:semicolon
r_else
id|get_fetch_map
c_func
(paren
id|remote_head
comma
id|refspec
comma
op_amp
id|tail
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|get_fetch_map
c_func
(paren
id|refs
comma
id|refspec
comma
op_amp
id|tail
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|option_mirror
op_logical_and
op_logical_neg
id|option_single_branch
)paren
id|get_fetch_map
c_func
(paren
id|refs
comma
id|tag_refspec
comma
op_amp
id|tail
comma
l_int|0
)paren
suffix:semicolon
r_return
id|local_refs
suffix:semicolon
)brace
DECL|function|write_remote_refs
r_static
r_void
id|write_remote_refs
c_func
(paren
r_const
r_struct
id|ref
op_star
id|local_refs
)paren
(brace
r_const
r_struct
id|ref
op_star
id|r
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
id|local_refs
suffix:semicolon
id|r
suffix:semicolon
id|r
op_assign
id|r-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;peer_ref
)paren
r_continue
suffix:semicolon
id|add_extra_ref
c_func
(paren
id|r-&gt;peer_ref-&gt;name
comma
id|r-&gt;old_sha1
comma
l_int|0
)paren
suffix:semicolon
)brace
id|pack_refs
c_func
(paren
id|PACK_REFS_ALL
)paren
suffix:semicolon
id|clear_extra_refs
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|write_followtags
r_static
r_void
id|write_followtags
c_func
(paren
r_const
r_struct
id|ref
op_star
id|refs
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_const
r_struct
id|ref
op_star
id|ref
suffix:semicolon
r_for
c_loop
(paren
id|ref
op_assign
id|refs
suffix:semicolon
id|ref
suffix:semicolon
id|ref
op_assign
id|ref-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|prefixcmp
c_func
(paren
id|ref-&gt;name
comma
l_string|&quot;refs/tags/&quot;
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suffixcmp
c_func
(paren
id|ref-&gt;name
comma
l_string|&quot;^{}&quot;
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|has_sha1_file
c_func
(paren
id|ref-&gt;old_sha1
)paren
)paren
r_continue
suffix:semicolon
id|update_ref
c_func
(paren
id|msg
comma
id|ref-&gt;name
comma
id|ref-&gt;old_sha1
comma
l_int|NULL
comma
l_int|0
comma
id|DIE_ON_ERR
)paren
suffix:semicolon
)brace
)brace
DECL|function|update_remote_refs
r_static
r_void
id|update_remote_refs
c_func
(paren
r_const
r_struct
id|ref
op_star
id|refs
comma
r_const
r_struct
id|ref
op_star
id|mapped_refs
comma
r_const
r_struct
id|ref
op_star
id|remote_head_points_at
comma
r_const
r_char
op_star
id|branch_top
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_if
c_cond
(paren
id|refs
)paren
(brace
id|clear_extra_refs
c_func
(paren
)paren
suffix:semicolon
id|write_remote_refs
c_func
(paren
id|mapped_refs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_single_branch
)paren
id|write_followtags
c_func
(paren
id|refs
comma
id|msg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|remote_head_points_at
op_logical_and
op_logical_neg
id|option_bare
)paren
(brace
r_struct
id|strbuf
id|head_ref
op_assign
id|STRBUF_INIT
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|head_ref
comma
id|branch_top
)paren
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|head_ref
comma
l_string|&quot;HEAD&quot;
)paren
suffix:semicolon
id|create_symref
c_func
(paren
id|head_ref.buf
comma
id|remote_head_points_at-&gt;peer_ref-&gt;name
comma
id|msg
)paren
suffix:semicolon
)brace
)brace
DECL|function|update_head
r_static
r_void
id|update_head
c_func
(paren
r_const
r_struct
id|ref
op_star
id|our
comma
r_const
r_struct
id|ref
op_star
id|remote
comma
r_const
r_char
op_star
id|msg
)paren
(brace
r_if
c_cond
(paren
id|our
op_logical_and
op_logical_neg
id|prefixcmp
c_func
(paren
id|our-&gt;name
comma
l_string|&quot;refs/heads/&quot;
)paren
)paren
(brace
multiline_comment|/* Local default branch link */
id|create_symref
c_func
(paren
l_string|&quot;HEAD&quot;
comma
id|our-&gt;name
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|option_bare
)paren
(brace
r_const
r_char
op_star
id|head
op_assign
id|skip_prefix
c_func
(paren
id|our-&gt;name
comma
l_string|&quot;refs/heads/&quot;
)paren
suffix:semicolon
id|update_ref
c_func
(paren
id|msg
comma
l_string|&quot;HEAD&quot;
comma
id|our-&gt;old_sha1
comma
l_int|NULL
comma
l_int|0
comma
id|DIE_ON_ERR
)paren
suffix:semicolon
id|install_branch_config
c_func
(paren
l_int|0
comma
id|head
comma
id|option_origin
comma
id|our-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|remote
)paren
(brace
multiline_comment|/*&n;&t;&t; * We know remote HEAD points to a non-branch, or&n;&t;&t; * HEAD points to a branch but we don&squot;t know which one.&n;&t;&t; * Detach HEAD in all these cases.&n;&t;&t; */
id|update_ref
c_func
(paren
id|msg
comma
l_string|&quot;HEAD&quot;
comma
id|remote-&gt;old_sha1
comma
l_int|NULL
comma
id|REF_NODEREF
comma
id|DIE_ON_ERR
)paren
suffix:semicolon
)brace
)brace
DECL|function|checkout
r_static
r_int
id|checkout
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|sha1
(braket
l_int|20
)braket
suffix:semicolon
r_char
op_star
id|head
suffix:semicolon
r_struct
id|lock_file
op_star
id|lock_file
suffix:semicolon
r_struct
id|unpack_trees_options
id|opts
suffix:semicolon
r_struct
id|tree
op_star
id|tree
suffix:semicolon
r_struct
id|tree_desc
id|t
suffix:semicolon
r_int
id|err
op_assign
l_int|0
comma
id|fd
suffix:semicolon
r_if
c_cond
(paren
id|option_no_checkout
)paren
r_return
l_int|0
suffix:semicolon
id|head
op_assign
id|resolve_refdup
c_func
(paren
l_string|&quot;HEAD&quot;
comma
id|sha1
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|head
)paren
(brace
id|warning
c_func
(paren
id|_
c_func
(paren
l_string|&quot;remote HEAD refers to nonexistent ref, &quot;
l_string|&quot;unable to checkout.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|head
comma
l_string|&quot;HEAD&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|prefixcmp
c_func
(paren
id|head
comma
l_string|&quot;refs/heads/&quot;
)paren
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;HEAD not found below refs/heads!&quot;
)paren
)paren
suffix:semicolon
)brace
id|free
c_func
(paren
id|head
)paren
suffix:semicolon
multiline_comment|/* We need to be in the new work tree for the checkout */
id|setup_work_tree
c_func
(paren
)paren
suffix:semicolon
id|lock_file
op_assign
id|xcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
r_struct
id|lock_file
)paren
)paren
suffix:semicolon
id|fd
op_assign
id|hold_locked_index
c_func
(paren
id|lock_file
comma
l_int|1
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|opts
comma
l_int|0
comma
r_sizeof
id|opts
)paren
suffix:semicolon
id|opts.update
op_assign
l_int|1
suffix:semicolon
id|opts.merge
op_assign
l_int|1
suffix:semicolon
id|opts.fn
op_assign
id|oneway_merge
suffix:semicolon
id|opts.verbose_update
op_assign
(paren
id|option_verbosity
OG
l_int|0
)paren
suffix:semicolon
id|opts.src_index
op_assign
op_amp
id|the_index
suffix:semicolon
id|opts.dst_index
op_assign
op_amp
id|the_index
suffix:semicolon
id|tree
op_assign
id|parse_tree_indirect
c_func
(paren
id|sha1
)paren
suffix:semicolon
id|parse_tree
c_func
(paren
id|tree
)paren
suffix:semicolon
id|init_tree_desc
c_func
(paren
op_amp
id|t
comma
id|tree-&gt;buffer
comma
id|tree-&gt;size
)paren
suffix:semicolon
id|unpack_trees
c_func
(paren
l_int|1
comma
op_amp
id|t
comma
op_amp
id|opts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_cache
c_func
(paren
id|fd
comma
id|active_cache
comma
id|active_nr
)paren
op_logical_or
id|commit_locked_index
c_func
(paren
id|lock_file
)paren
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;unable to write new index file&quot;
)paren
)paren
suffix:semicolon
id|err
op_or_assign
id|run_hook
c_func
(paren
l_int|NULL
comma
l_string|&quot;post-checkout&quot;
comma
id|sha1_to_hex
c_func
(paren
id|null_sha1
)paren
comma
id|sha1_to_hex
c_func
(paren
id|sha1
)paren
comma
l_string|&quot;1&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|option_recursive
)paren
id|err
op_assign
id|run_command_v_opt
c_func
(paren
id|argv_submodule
comma
id|RUN_GIT_CMD
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|write_one_config
r_static
r_int
id|write_one_config
c_func
(paren
r_const
r_char
op_star
id|key
comma
r_const
r_char
op_star
id|value
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|git_config_set_multivar
c_func
(paren
id|key
comma
id|value
ques
c_cond
id|value
suffix:colon
l_string|&quot;true&quot;
comma
l_string|&quot;^$&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|write_config
r_static
r_void
id|write_config
c_func
(paren
r_struct
id|string_list
op_star
id|config
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;nr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|git_config_parse_parameter
c_func
(paren
id|config-&gt;items
(braket
id|i
)braket
dot
id|string
comma
id|write_one_config
comma
l_int|NULL
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
l_string|&quot;unable to write parameters to config file&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|cmd_clone
r_int
id|cmd_clone
c_func
(paren
r_int
id|argc
comma
r_const
r_char
op_star
op_star
id|argv
comma
r_const
r_char
op_star
id|prefix
)paren
(brace
r_int
id|is_bundle
op_assign
l_int|0
comma
id|is_local
suffix:semicolon
r_struct
id|stat
id|buf
suffix:semicolon
r_const
r_char
op_star
id|repo_name
comma
op_star
id|repo
comma
op_star
id|work_tree
comma
op_star
id|git_dir
suffix:semicolon
r_char
op_star
id|path
comma
op_star
id|dir
suffix:semicolon
r_int
id|dest_exists
suffix:semicolon
r_const
r_struct
id|ref
op_star
id|refs
comma
op_star
id|remote_head
suffix:semicolon
r_const
r_struct
id|ref
op_star
id|remote_head_points_at
suffix:semicolon
r_const
r_struct
id|ref
op_star
id|our_head_points_at
suffix:semicolon
r_struct
id|ref
op_star
id|mapped_refs
suffix:semicolon
r_struct
id|strbuf
id|key
op_assign
id|STRBUF_INIT
comma
id|value
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|strbuf
id|branch_top
op_assign
id|STRBUF_INIT
comma
id|reflog_msg
op_assign
id|STRBUF_INIT
suffix:semicolon
r_struct
id|transport
op_star
id|transport
op_assign
l_int|NULL
suffix:semicolon
r_const
r_char
op_star
id|src_ref_prefix
op_assign
l_string|&quot;refs/heads/&quot;
suffix:semicolon
r_struct
id|remote
op_star
id|remote
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|refspec
op_star
id|refspec
suffix:semicolon
r_const
r_char
op_star
id|fetch_pattern
suffix:semicolon
id|junk_pid
op_assign
id|getpid
c_func
(paren
)paren
suffix:semicolon
id|packet_trace_identity
c_func
(paren
l_string|&quot;clone&quot;
)paren
suffix:semicolon
id|argc
op_assign
id|parse_options
c_func
(paren
id|argc
comma
id|argv
comma
id|prefix
comma
id|builtin_clone_options
comma
id|builtin_clone_usage
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|argc
OG
l_int|2
)paren
id|usage_msg_opt
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Too many arguments.&quot;
)paren
comma
id|builtin_clone_usage
comma
id|builtin_clone_options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|argc
op_eq
l_int|0
)paren
id|usage_msg_opt
c_func
(paren
id|_
c_func
(paren
l_string|&quot;You must specify a repository to clone.&quot;
)paren
comma
id|builtin_clone_usage
comma
id|builtin_clone_options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_single_branch
op_eq
l_int|1
)paren
id|option_single_branch
op_assign
id|option_depth
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|option_mirror
)paren
id|option_bare
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|option_bare
)paren
(brace
r_if
c_cond
(paren
id|option_origin
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;--bare and --origin %s options are incompatible.&quot;
)paren
comma
id|option_origin
)paren
suffix:semicolon
id|option_no_checkout
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|option_origin
)paren
id|option_origin
op_assign
l_string|&quot;origin&quot;
suffix:semicolon
id|repo_name
op_assign
id|argv
(braket
l_int|0
)braket
suffix:semicolon
id|path
op_assign
id|get_repo_path
c_func
(paren
id|repo_name
comma
op_amp
id|is_bundle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|path
)paren
id|repo
op_assign
id|xstrdup
c_func
(paren
id|absolute_path
c_func
(paren
id|repo_name
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strchr
c_func
(paren
id|repo_name
comma
l_char|&squot;:&squot;
)paren
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;repository &squot;%s&squot; does not exist&quot;
)paren
comma
id|repo_name
)paren
suffix:semicolon
r_else
id|repo
op_assign
id|repo_name
suffix:semicolon
id|is_local
op_assign
id|path
op_logical_and
op_logical_neg
id|is_bundle
suffix:semicolon
r_if
c_cond
(paren
id|is_local
op_logical_and
id|option_depth
)paren
id|warning
c_func
(paren
id|_
c_func
(paren
l_string|&quot;--depth is ignored in local clones; use file:// instead.&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|argc
op_eq
l_int|2
)paren
id|dir
op_assign
id|xstrdup
c_func
(paren
id|argv
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_else
id|dir
op_assign
id|guess_dir_name
c_func
(paren
id|repo_name
comma
id|is_bundle
comma
id|option_bare
)paren
suffix:semicolon
id|strip_trailing_slashes
c_func
(paren
id|dir
)paren
suffix:semicolon
id|dest_exists
op_assign
op_logical_neg
id|stat
c_func
(paren
id|dir
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest_exists
op_logical_and
op_logical_neg
id|is_empty_dir
c_func
(paren
id|dir
)paren
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;destination path &squot;%s&squot; already exists and is not &quot;
l_string|&quot;an empty directory.&quot;
)paren
comma
id|dir
)paren
suffix:semicolon
id|strbuf_addf
c_func
(paren
op_amp
id|reflog_msg
comma
l_string|&quot;clone: from %s&quot;
comma
id|repo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_bare
)paren
id|work_tree
op_assign
l_int|NULL
suffix:semicolon
r_else
(brace
id|work_tree
op_assign
id|getenv
c_func
(paren
l_string|&quot;GIT_WORK_TREE&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|work_tree
op_logical_and
op_logical_neg
id|stat
c_func
(paren
id|work_tree
comma
op_amp
id|buf
)paren
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;working tree &squot;%s&squot; already exists.&quot;
)paren
comma
id|work_tree
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|option_bare
op_logical_or
id|work_tree
)paren
id|git_dir
op_assign
id|xstrdup
c_func
(paren
id|dir
)paren
suffix:semicolon
r_else
(brace
id|work_tree
op_assign
id|dir
suffix:semicolon
id|git_dir
op_assign
id|xstrdup
c_func
(paren
id|mkpath
c_func
(paren
l_string|&quot;%s/.git&quot;
comma
id|dir
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|option_bare
)paren
(brace
id|junk_work_tree
op_assign
id|work_tree
suffix:semicolon
r_if
c_cond
(paren
id|safe_create_leading_directories_const
c_func
(paren
id|work_tree
)paren
OL
l_int|0
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;could not create leading directories of &squot;%s&squot;&quot;
)paren
comma
id|work_tree
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dest_exists
op_logical_and
id|mkdir
c_func
(paren
id|work_tree
comma
l_int|0755
)paren
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;could not create work tree dir &squot;%s&squot;.&quot;
)paren
comma
id|work_tree
)paren
suffix:semicolon
id|set_git_work_tree
c_func
(paren
id|work_tree
)paren
suffix:semicolon
)brace
id|junk_git_dir
op_assign
id|git_dir
suffix:semicolon
id|atexit
c_func
(paren
id|remove_junk
)paren
suffix:semicolon
id|sigchain_push_common
c_func
(paren
id|remove_junk_on_signal
)paren
suffix:semicolon
id|setenv
c_func
(paren
id|CONFIG_ENVIRONMENT
comma
id|mkpath
c_func
(paren
l_string|&quot;%s/config&quot;
comma
id|git_dir
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|safe_create_leading_directories_const
c_func
(paren
id|git_dir
)paren
OL
l_int|0
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;could not create leading directories of &squot;%s&squot;&quot;
)paren
comma
id|git_dir
)paren
suffix:semicolon
id|set_git_dir_init
c_func
(paren
id|git_dir
comma
id|real_git_dir
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|real_git_dir
)paren
id|git_dir
op_assign
id|real_git_dir
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_le
id|option_verbosity
)paren
(brace
r_if
c_cond
(paren
id|option_bare
)paren
id|printf
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Cloning into bare repository &squot;%s&squot;...&bslash;n&quot;
)paren
comma
id|dir
)paren
suffix:semicolon
r_else
id|printf
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Cloning into &squot;%s&squot;...&bslash;n&quot;
)paren
comma
id|dir
)paren
suffix:semicolon
)brace
id|init_db
c_func
(paren
id|option_template
comma
id|INIT_DB_QUIET
)paren
suffix:semicolon
id|write_config
c_func
(paren
op_amp
id|option_config
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * At this point, the config exists, so we do not need the&n;&t; * environment variable.  We actually need to unset it, too, to&n;&t; * re-enable parsing of the global configs.&n;&t; */
id|unsetenv
c_func
(paren
id|CONFIG_ENVIRONMENT
)paren
suffix:semicolon
id|git_config
c_func
(paren
id|git_default_config
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_bare
)paren
(brace
r_if
c_cond
(paren
id|option_mirror
)paren
id|src_ref_prefix
op_assign
l_string|&quot;refs/&quot;
suffix:semicolon
id|strbuf_addstr
c_func
(paren
op_amp
id|branch_top
comma
id|src_ref_prefix
)paren
suffix:semicolon
id|git_config_set
c_func
(paren
l_string|&quot;core.bare&quot;
comma
l_string|&quot;true&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|strbuf_addf
c_func
(paren
op_amp
id|branch_top
comma
l_string|&quot;refs/remotes/%s/&quot;
comma
id|option_origin
)paren
suffix:semicolon
)brace
id|strbuf_addf
c_func
(paren
op_amp
id|value
comma
l_string|&quot;+%s*:%s*&quot;
comma
id|src_ref_prefix
comma
id|branch_top.buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_mirror
op_logical_or
op_logical_neg
id|option_bare
)paren
(brace
multiline_comment|/* Configure the remote */
id|strbuf_addf
c_func
(paren
op_amp
id|key
comma
l_string|&quot;remote.%s.fetch&quot;
comma
id|option_origin
)paren
suffix:semicolon
id|git_config_set_multivar
c_func
(paren
id|key.buf
comma
id|value.buf
comma
l_string|&quot;^$&quot;
comma
l_int|0
)paren
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|key
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_mirror
)paren
(brace
id|strbuf_addf
c_func
(paren
op_amp
id|key
comma
l_string|&quot;remote.%s.mirror&quot;
comma
id|option_origin
)paren
suffix:semicolon
id|git_config_set
c_func
(paren
id|key.buf
comma
l_string|&quot;true&quot;
)paren
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|key
)paren
suffix:semicolon
)brace
)brace
id|strbuf_addf
c_func
(paren
op_amp
id|key
comma
l_string|&quot;remote.%s.url&quot;
comma
id|option_origin
)paren
suffix:semicolon
id|git_config_set
c_func
(paren
id|key.buf
comma
id|repo
)paren
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|key
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_reference.nr
)paren
id|setup_reference
c_func
(paren
)paren
suffix:semicolon
id|fetch_pattern
op_assign
id|value.buf
suffix:semicolon
id|refspec
op_assign
id|parse_fetch_refspec
c_func
(paren
l_int|1
comma
op_amp
id|fetch_pattern
)paren
suffix:semicolon
id|strbuf_reset
c_func
(paren
op_amp
id|value
)paren
suffix:semicolon
id|remote
op_assign
id|remote_get
c_func
(paren
id|option_origin
)paren
suffix:semicolon
id|transport
op_assign
id|transport_get
c_func
(paren
id|remote
comma
id|remote-&gt;url
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_local
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|transport-&gt;get_refs_list
op_logical_or
op_logical_neg
id|transport-&gt;fetch
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Don&squot;t know how to clone %s&quot;
)paren
comma
id|transport-&gt;url
)paren
suffix:semicolon
id|transport_set_option
c_func
(paren
id|transport
comma
id|TRANS_OPT_KEEP
comma
l_string|&quot;yes&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_depth
)paren
id|transport_set_option
c_func
(paren
id|transport
comma
id|TRANS_OPT_DEPTH
comma
id|option_depth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_single_branch
)paren
id|transport_set_option
c_func
(paren
id|transport
comma
id|TRANS_OPT_FOLLOWTAGS
comma
l_string|&quot;1&quot;
)paren
suffix:semicolon
id|transport_set_verbosity
c_func
(paren
id|transport
comma
id|option_verbosity
comma
id|option_progress
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_upload_pack
)paren
id|transport_set_option
c_func
(paren
id|transport
comma
id|TRANS_OPT_UPLOADPACK
comma
id|option_upload_pack
)paren
suffix:semicolon
)brace
id|refs
op_assign
id|transport_get_remote_refs
c_func
(paren
id|transport
)paren
suffix:semicolon
id|mapped_refs
op_assign
id|refs
ques
c_cond
id|wanted_peer_refs
c_func
(paren
id|refs
comma
id|refspec
)paren
suffix:colon
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * mapped_refs may be updated if transport-helper is used so&n;&t; * we need fetch it early because remote_head code below&n;&t; * relies on it.&n;&t; *&n;&t; * for normal clones, transport_get_remote_refs() should&n;&t; * return reliable ref set, we can delay cloning until after&n;&t; * remote HEAD check.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|is_local
op_logical_and
id|remote-&gt;foreign_vcs
op_logical_and
id|refs
)paren
id|transport_fetch_refs
c_func
(paren
id|transport
comma
id|mapped_refs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|refs
)paren
(brace
id|remote_head
op_assign
id|find_ref_by_name
c_func
(paren
id|refs
comma
l_string|&quot;HEAD&quot;
)paren
suffix:semicolon
id|remote_head_points_at
op_assign
id|guess_remote_head
c_func
(paren
id|remote_head
comma
id|mapped_refs
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|option_branch
)paren
(brace
id|our_head_points_at
op_assign
id|find_remote_branch
c_func
(paren
id|mapped_refs
comma
id|option_branch
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|our_head_points_at
)paren
id|die
c_func
(paren
id|_
c_func
(paren
l_string|&quot;Remote branch %s not found in upstream %s&quot;
)paren
comma
id|option_branch
comma
id|option_origin
)paren
suffix:semicolon
)brace
r_else
id|our_head_points_at
op_assign
id|remote_head_points_at
suffix:semicolon
)brace
r_else
(brace
id|warning
c_func
(paren
id|_
c_func
(paren
l_string|&quot;You appear to have cloned an empty repository.&quot;
)paren
)paren
suffix:semicolon
id|our_head_points_at
op_assign
l_int|NULL
suffix:semicolon
id|remote_head_points_at
op_assign
l_int|NULL
suffix:semicolon
id|remote_head
op_assign
l_int|NULL
suffix:semicolon
id|option_no_checkout
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|option_bare
)paren
id|install_branch_config
c_func
(paren
l_int|0
comma
l_string|&quot;master&quot;
comma
id|option_origin
comma
l_string|&quot;refs/heads/master&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_local
)paren
id|clone_local
c_func
(paren
id|path
comma
id|git_dir
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|refs
op_logical_and
op_logical_neg
id|remote-&gt;foreign_vcs
)paren
id|transport_fetch_refs
c_func
(paren
id|transport
comma
id|mapped_refs
)paren
suffix:semicolon
id|update_remote_refs
c_func
(paren
id|refs
comma
id|mapped_refs
comma
id|remote_head_points_at
comma
id|branch_top.buf
comma
id|reflog_msg.buf
)paren
suffix:semicolon
id|update_head
c_func
(paren
id|our_head_points_at
comma
id|remote_head
comma
id|reflog_msg.buf
)paren
suffix:semicolon
id|transport_unlock_pack
c_func
(paren
id|transport
)paren
suffix:semicolon
id|transport_disconnect
c_func
(paren
id|transport
)paren
suffix:semicolon
id|err
op_assign
id|checkout
c_func
(paren
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|reflog_msg
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|branch_top
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|key
)paren
suffix:semicolon
id|strbuf_release
c_func
(paren
op_amp
id|value
)paren
suffix:semicolon
id|junk_pid
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
eof
