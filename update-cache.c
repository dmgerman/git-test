multiline_comment|/*&n; * GIT - The information manager from hell&n; *&n; * Copyright (C) Linus Torvalds, 2005&n; */
macro_line|#include &quot;cache.h&quot;
DECL|function|cache_name_compare
r_static
r_int
id|cache_name_compare
c_func
(paren
r_const
r_char
op_star
id|name1
comma
r_int
id|len1
comma
r_const
r_char
op_star
id|name2
comma
r_int
id|len2
)paren
(brace
r_int
id|len
op_assign
id|len1
OL
id|len2
ques
c_cond
id|len1
suffix:colon
id|len2
suffix:semicolon
r_int
id|cmp
suffix:semicolon
id|cmp
op_assign
id|memcmp
c_func
(paren
id|name1
comma
id|name2
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmp
)paren
r_return
id|cmp
suffix:semicolon
r_if
c_cond
(paren
id|len1
OL
id|len2
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len1
OG
id|len2
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cache_name_pos
r_static
r_int
id|cache_name_pos
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|namelen
)paren
(brace
r_int
id|first
comma
id|last
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
id|last
op_assign
id|active_nr
suffix:semicolon
r_while
c_loop
(paren
id|last
OG
id|first
)paren
(brace
r_int
id|next
op_assign
(paren
id|last
op_plus
id|first
)paren
op_rshift
l_int|1
suffix:semicolon
r_struct
id|cache_entry
op_star
id|ce
op_assign
id|active_cache
(braket
id|next
)braket
suffix:semicolon
r_int
id|cmp
op_assign
id|cache_name_compare
c_func
(paren
id|name
comma
id|namelen
comma
id|ce-&gt;name
comma
id|ce-&gt;namelen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmp
)paren
r_return
id|next
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmp
OL
l_int|0
)paren
(brace
id|last
op_assign
id|next
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|first
op_assign
id|next
op_plus
l_int|1
suffix:semicolon
)brace
r_return
id|first
suffix:semicolon
)brace
DECL|function|remove_file_from_cache
r_static
r_int
id|remove_file_from_cache
c_func
(paren
r_char
op_star
id|path
)paren
(brace
r_int
id|pos
op_assign
id|cache_name_pos
c_func
(paren
id|path
comma
id|strlen
c_func
(paren
id|path
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
l_int|0
)paren
(brace
id|pos
op_assign
id|pos
op_minus
l_int|1
suffix:semicolon
id|active_nr
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|active_nr
)paren
id|memmove
c_func
(paren
id|active_cache
op_plus
id|pos
comma
id|active_cache
op_plus
id|pos
op_plus
l_int|1
comma
(paren
id|active_nr
id|pos
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|cache_entry
op_star
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|add_cache_entry
r_static
r_int
id|add_cache_entry
c_func
(paren
r_struct
id|cache_entry
op_star
id|ce
)paren
(brace
r_int
id|pos
suffix:semicolon
id|pos
op_assign
id|cache_name_pos
c_func
(paren
id|ce-&gt;name
comma
id|ce-&gt;namelen
)paren
suffix:semicolon
multiline_comment|/* existing match? Just replace it */
r_if
c_cond
(paren
id|pos
OL
l_int|0
)paren
(brace
id|active_cache
(braket
id|pos
op_minus
l_int|1
)braket
op_assign
id|ce
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Make sure the array is big enough .. */
r_if
c_cond
(paren
id|active_nr
op_eq
id|active_alloc
)paren
(brace
id|active_alloc
op_assign
id|alloc_nr
c_func
(paren
id|active_alloc
)paren
suffix:semicolon
id|active_cache
op_assign
id|realloc
c_func
(paren
id|active_cache
comma
id|active_alloc
op_star
r_sizeof
(paren
r_struct
id|cache_entry
op_star
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Add it in.. */
id|active_nr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|active_nr
OG
id|pos
)paren
id|memmove
c_func
(paren
id|active_cache
op_plus
id|pos
op_plus
l_int|1
comma
id|active_cache
op_plus
id|pos
comma
(paren
id|active_nr
id|pos
l_int|1
)paren
op_star
r_sizeof
(paren
id|ce
)paren
)paren
suffix:semicolon
id|active_cache
(braket
id|pos
)braket
op_assign
id|ce
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|index_fd
r_static
r_int
id|index_fd
c_func
(paren
r_const
r_char
op_star
id|path
comma
r_int
id|namelen
comma
r_struct
id|cache_entry
op_star
id|ce
comma
r_int
id|fd
comma
r_struct
id|stat
op_star
id|st
)paren
(brace
id|z_stream
id|stream
suffix:semicolon
r_int
id|max_out_bytes
op_assign
id|namelen
op_plus
id|st-&gt;st_size
op_plus
l_int|200
suffix:semicolon
r_void
op_star
id|out
op_assign
id|malloc
c_func
(paren
id|max_out_bytes
)paren
suffix:semicolon
r_void
op_star
id|metadata
op_assign
id|malloc
c_func
(paren
id|namelen
op_plus
l_int|200
)paren
suffix:semicolon
r_void
op_star
id|in
op_assign
id|mmap
c_func
(paren
l_int|NULL
comma
id|st-&gt;st_size
comma
id|PROT_READ
comma
id|MAP_PRIVATE
comma
id|fd
comma
l_int|0
)paren
suffix:semicolon
id|SHA_CTX
id|c
suffix:semicolon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|out
op_logical_or
(paren
r_int
)paren
(paren
r_int
)paren
id|in
op_eq
l_int|1
)paren
r_return
l_int|1
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|stream
comma
l_int|0
comma
r_sizeof
(paren
id|stream
)paren
)paren
suffix:semicolon
id|deflateInit
c_func
(paren
op_amp
id|stream
comma
id|Z_BEST_COMPRESSION
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * ASCII size + nul byte&n;&t; */
id|stream.next_in
op_assign
id|metadata
suffix:semicolon
id|stream.avail_in
op_assign
l_int|1
op_plus
id|sprintf
c_func
(paren
id|metadata
comma
l_string|&quot;blob %lu&quot;
comma
(paren
r_int
r_int
)paren
id|st-&gt;st_size
)paren
suffix:semicolon
id|stream.next_out
op_assign
id|out
suffix:semicolon
id|stream.avail_out
op_assign
id|max_out_bytes
suffix:semicolon
r_while
c_loop
(paren
id|deflate
c_func
(paren
op_amp
id|stream
comma
l_int|0
)paren
op_eq
id|Z_OK
)paren
multiline_comment|/* nothing */
suffix:semicolon
multiline_comment|/*&n;&t; * File content&n;&t; */
id|stream.next_in
op_assign
id|in
suffix:semicolon
id|stream.avail_in
op_assign
id|st-&gt;st_size
suffix:semicolon
r_while
c_loop
(paren
id|deflate
c_func
(paren
op_amp
id|stream
comma
id|Z_FINISH
)paren
op_eq
id|Z_OK
)paren
multiline_comment|/*nothing */
suffix:semicolon
id|deflateEnd
c_func
(paren
op_amp
id|stream
)paren
suffix:semicolon
id|SHA1_Init
c_func
(paren
op_amp
id|c
)paren
suffix:semicolon
id|SHA1_Update
c_func
(paren
op_amp
id|c
comma
id|out
comma
id|stream.total_out
)paren
suffix:semicolon
id|SHA1_Final
c_func
(paren
id|ce-&gt;sha1
comma
op_amp
id|c
)paren
suffix:semicolon
r_return
id|write_sha1_buffer
c_func
(paren
id|ce-&gt;sha1
comma
id|out
comma
id|stream.total_out
)paren
suffix:semicolon
)brace
DECL|function|add_file_to_cache
r_static
r_int
id|add_file_to_cache
c_func
(paren
r_char
op_star
id|path
)paren
(brace
r_int
id|size
comma
id|namelen
suffix:semicolon
r_struct
id|cache_entry
op_star
id|ce
suffix:semicolon
r_struct
id|stat
id|st
suffix:semicolon
r_int
id|fd
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|path
comma
id|O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|errno
op_eq
id|ENOENT
)paren
r_return
id|remove_file_from_cache
c_func
(paren
id|path
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fstat
c_func
(paren
id|fd
comma
op_amp
id|st
)paren
OL
l_int|0
)paren
(brace
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|namelen
op_assign
id|strlen
c_func
(paren
id|path
)paren
suffix:semicolon
id|size
op_assign
id|cache_entry_size
c_func
(paren
id|namelen
)paren
suffix:semicolon
id|ce
op_assign
id|malloc
c_func
(paren
id|size
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ce
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ce-&gt;name
comma
id|path
comma
id|namelen
)paren
suffix:semicolon
id|ce-&gt;ctime.sec
op_assign
id|st.st_ctime
suffix:semicolon
id|ce-&gt;ctime.nsec
op_assign
id|st.st_ctim.tv_nsec
suffix:semicolon
id|ce-&gt;mtime.sec
op_assign
id|st.st_mtime
suffix:semicolon
id|ce-&gt;mtime.nsec
op_assign
id|st.st_mtim.tv_nsec
suffix:semicolon
id|ce-&gt;st_dev
op_assign
id|st.st_dev
suffix:semicolon
id|ce-&gt;st_ino
op_assign
id|st.st_ino
suffix:semicolon
id|ce-&gt;st_mode
op_assign
id|st.st_mode
suffix:semicolon
id|ce-&gt;st_uid
op_assign
id|st.st_uid
suffix:semicolon
id|ce-&gt;st_gid
op_assign
id|st.st_gid
suffix:semicolon
id|ce-&gt;st_size
op_assign
id|st.st_size
suffix:semicolon
id|ce-&gt;namelen
op_assign
id|namelen
suffix:semicolon
r_if
c_cond
(paren
id|index_fd
c_func
(paren
id|path
comma
id|namelen
comma
id|ce
comma
id|fd
comma
op_amp
id|st
)paren
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|add_cache_entry
c_func
(paren
id|ce
)paren
suffix:semicolon
)brace
DECL|function|write_cache
r_static
r_int
id|write_cache
c_func
(paren
r_int
id|newfd
comma
r_struct
id|cache_entry
op_star
op_star
id|cache
comma
r_int
id|entries
)paren
(brace
id|SHA_CTX
id|c
suffix:semicolon
r_struct
id|cache_header
id|hdr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hdr.signature
op_assign
id|CACHE_SIGNATURE
suffix:semicolon
id|hdr.version
op_assign
l_int|1
suffix:semicolon
id|hdr.entries
op_assign
id|entries
suffix:semicolon
id|SHA1_Init
c_func
(paren
op_amp
id|c
)paren
suffix:semicolon
id|SHA1_Update
c_func
(paren
op_amp
id|c
comma
op_amp
id|hdr
comma
m_offsetof
(paren
r_struct
id|cache_header
comma
id|sha1
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|cache_entry
op_star
id|ce
op_assign
id|cache
(braket
id|i
)braket
suffix:semicolon
r_int
id|size
op_assign
id|ce_size
c_func
(paren
id|ce
)paren
suffix:semicolon
id|SHA1_Update
c_func
(paren
op_amp
id|c
comma
id|ce
comma
id|size
)paren
suffix:semicolon
)brace
id|SHA1_Final
c_func
(paren
id|hdr.sha1
comma
op_amp
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write
c_func
(paren
id|newfd
comma
op_amp
id|hdr
comma
r_sizeof
(paren
id|hdr
)paren
)paren
op_ne
r_sizeof
(paren
id|hdr
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|cache_entry
op_star
id|ce
op_assign
id|cache
(braket
id|i
)braket
suffix:semicolon
r_int
id|size
op_assign
id|ce_size
c_func
(paren
id|ce
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write
c_func
(paren
id|newfd
comma
id|ce
comma
id|size
)paren
op_ne
id|size
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * We fundamentally don&squot;t like some paths: we don&squot;t want&n; * dot or dot-dot anywhere, and in fact, we don&squot;t even want&n; * any other dot-files (.dircache or anything else). They&n; * are hidden, for chist sake.&n; *&n; * Also, we don&squot;t want double slashes or slashes at the&n; * end that can make pathnames ambiguous. &n; */
DECL|function|verify_path
r_static
r_int
id|verify_path
c_func
(paren
r_char
op_star
id|path
)paren
(brace
r_char
id|c
suffix:semicolon
r_goto
id|inside
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;/&squot;
)paren
(brace
id|inside
suffix:colon
id|c
op_assign
op_star
id|path
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ne
l_char|&squot;/&squot;
op_logical_and
id|c
op_ne
l_char|&squot;.&squot;
op_logical_and
id|c
op_ne
l_char|&squot;&bslash;0&squot;
)paren
r_continue
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|c
op_assign
op_star
id|path
op_increment
suffix:semicolon
)brace
)brace
DECL|function|main
r_int
id|main
c_func
(paren
r_int
id|argc
comma
r_char
op_star
op_star
id|argv
)paren
(brace
r_int
id|i
comma
id|newfd
comma
id|entries
suffix:semicolon
id|entries
op_assign
id|read_cache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entries
OL
l_int|0
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;cache corrupted&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|newfd
op_assign
id|open
c_func
(paren
l_string|&quot;.dircache/index.lock&quot;
comma
id|O_RDWR
op_or
id|O_CREAT
op_or
id|O_EXCL
comma
l_int|0600
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newfd
OL
l_int|0
)paren
(brace
id|perror
c_func
(paren
l_string|&quot;unable to create new cachefile&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|argc
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|path
op_assign
id|argv
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|verify_path
c_func
(paren
id|path
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Ignoring path %s&bslash;n&quot;
comma
id|argv
(braket
id|i
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|add_file_to_cache
c_func
(paren
id|path
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Unable to add %s to database&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|write_cache
c_func
(paren
id|newfd
comma
id|active_cache
comma
id|active_nr
)paren
op_logical_and
op_logical_neg
id|rename
c_func
(paren
l_string|&quot;.dircache/index.lock&quot;
comma
l_string|&quot;.dircache/index&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|unlink
c_func
(paren
l_string|&quot;.dircache/index.lock&quot;
)paren
suffix:semicolon
)brace
eof
