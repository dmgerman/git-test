multiline_comment|/*&n; * Converts filenames from decomposed unicode into precomposed unicode.&n; * Used on MacOS X.&n; */
DECL|macro|PRECOMPOSE_UNICODE_C
mdefine_line|#define PRECOMPOSE_UNICODE_C
macro_line|#include &quot;cache.h&quot;
macro_line|#include &quot;utf8.h&quot;
macro_line|#include &quot;precompose_utf8.h&quot;
DECL|typedef|iconv_ibp
r_typedef
r_char
op_star
id|iconv_ibp
suffix:semicolon
DECL|variable|repo_encoding
r_static
r_const
r_char
op_star
id|repo_encoding
op_assign
l_string|&quot;UTF-8&quot;
suffix:semicolon
DECL|variable|path_encoding
r_static
r_const
r_char
op_star
id|path_encoding
op_assign
l_string|&quot;UTF-8-MAC&quot;
suffix:semicolon
DECL|function|has_non_ascii
r_static
r_int
id|has_non_ascii
c_func
(paren
r_const
r_char
op_star
id|s
comma
r_int
id|maxlen
comma
r_int
op_star
id|strlen_c
)paren
(brace
r_const
r_uint8
op_star
id|ptr
op_assign
(paren
r_const
r_uint8
op_star
)paren
id|s
suffix:semicolon
r_int
id|strlen_chars
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
op_logical_or
op_logical_neg
op_star
id|ptr
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|ptr
op_logical_and
id|maxlen
)paren
(brace
r_if
c_cond
(paren
op_star
id|ptr
op_amp
l_int|0x80
)paren
id|ret
op_increment
suffix:semicolon
id|strlen_chars
op_increment
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|maxlen
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strlen_c
)paren
op_star
id|strlen_c
op_assign
id|strlen_chars
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|probe_utf8_pathname_composition
r_void
id|probe_utf8_pathname_composition
c_func
(paren
r_char
op_star
id|path
comma
r_int
id|len
)paren
(brace
r_static
r_const
r_char
op_star
id|auml_nfc
op_assign
l_string|&quot;&bslash;xc3&bslash;xa4&quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|auml_nfd
op_assign
l_string|&quot;&bslash;x61&bslash;xcc&bslash;x88&quot;
suffix:semicolon
r_int
id|output_fd
suffix:semicolon
r_if
c_cond
(paren
id|precomposed_unicode
op_ne
l_int|1
)paren
r_return
suffix:semicolon
multiline_comment|/* We found it defined in the global config, respect it */
id|strcpy
c_func
(paren
id|path
op_plus
id|len
comma
id|auml_nfc
)paren
suffix:semicolon
id|output_fd
op_assign
id|open
c_func
(paren
id|path
comma
id|O_CREAT
op_or
id|O_EXCL
op_or
id|O_RDWR
comma
l_int|0600
)paren
suffix:semicolon
r_if
c_cond
(paren
id|output_fd
op_ge
l_int|0
)paren
(brace
id|close
c_func
(paren
id|output_fd
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|path
op_plus
id|len
comma
id|auml_nfd
)paren
suffix:semicolon
id|precomposed_unicode
op_assign
id|access
c_func
(paren
id|path
comma
id|R_OK
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|git_config_set
c_func
(paren
l_string|&quot;core.precomposeunicode&quot;
comma
id|precomposed_unicode
ques
c_cond
l_string|&quot;true&quot;
suffix:colon
l_string|&quot;false&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|path
op_plus
id|len
comma
id|auml_nfc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlink
c_func
(paren
id|path
)paren
)paren
id|die_errno
c_func
(paren
id|_
c_func
(paren
l_string|&quot;failed to unlink &squot;%s&squot;&quot;
)paren
comma
id|path
)paren
suffix:semicolon
)brace
)brace
DECL|function|precompose_argv
r_void
id|precompose_argv
c_func
(paren
r_int
id|argc
comma
r_const
r_char
op_star
op_star
id|argv
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|oldarg
suffix:semicolon
r_char
op_star
id|newarg
suffix:semicolon
id|iconv_t
id|ic_precompose
suffix:semicolon
r_if
c_cond
(paren
id|precomposed_unicode
op_ne
l_int|1
)paren
r_return
suffix:semicolon
id|ic_precompose
op_assign
id|iconv_open
c_func
(paren
id|repo_encoding
comma
id|path_encoding
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic_precompose
op_eq
(paren
id|iconv_t
)paren
l_int|1
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|argc
)paren
(brace
r_int
id|namelen
suffix:semicolon
id|oldarg
op_assign
id|argv
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|has_non_ascii
c_func
(paren
id|oldarg
comma
(paren
r_int
)paren
op_minus
l_int|1
comma
op_amp
id|namelen
)paren
)paren
(brace
id|newarg
op_assign
id|reencode_string_iconv
c_func
(paren
id|oldarg
comma
id|namelen
comma
id|ic_precompose
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newarg
)paren
id|argv
(braket
id|i
)braket
op_assign
id|newarg
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
id|iconv_close
c_func
(paren
id|ic_precompose
)paren
suffix:semicolon
)brace
DECL|function|precompose_utf8_opendir
id|PREC_DIR
op_star
id|precompose_utf8_opendir
c_func
(paren
r_const
r_char
op_star
id|dirname
)paren
(brace
id|PREC_DIR
op_star
id|prec_dir
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
id|PREC_DIR
)paren
)paren
suffix:semicolon
id|prec_dir-&gt;dirent_nfc
op_assign
id|xmalloc
c_func
(paren
r_sizeof
(paren
id|dirent_prec_psx
)paren
)paren
suffix:semicolon
id|prec_dir-&gt;dirent_nfc-&gt;max_name_len
op_assign
r_sizeof
(paren
id|prec_dir-&gt;dirent_nfc-&gt;d_name
)paren
suffix:semicolon
id|prec_dir-&gt;dirp
op_assign
id|opendir
c_func
(paren
id|dirname
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prec_dir-&gt;dirp
)paren
(brace
id|free
c_func
(paren
id|prec_dir-&gt;dirent_nfc
)paren
suffix:semicolon
id|free
c_func
(paren
id|prec_dir
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_int
id|ret_errno
op_assign
id|errno
suffix:semicolon
id|prec_dir-&gt;ic_precompose
op_assign
id|iconv_open
c_func
(paren
id|repo_encoding
comma
id|path_encoding
)paren
suffix:semicolon
multiline_comment|/* if iconv_open() fails, die() in readdir() if needed */
id|errno
op_assign
id|ret_errno
suffix:semicolon
)brace
r_return
id|prec_dir
suffix:semicolon
)brace
DECL|function|precompose_utf8_readdir
r_struct
id|dirent_prec_psx
op_star
id|precompose_utf8_readdir
c_func
(paren
id|PREC_DIR
op_star
id|prec_dir
)paren
(brace
r_struct
id|dirent
op_star
id|res
suffix:semicolon
id|res
op_assign
id|readdir
c_func
(paren
id|prec_dir-&gt;dirp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
r_int
id|namelenz
op_assign
id|strlen
c_func
(paren
id|res-&gt;d_name
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* &bslash;0 */
r_int
id|new_maxlen
op_assign
id|namelenz
suffix:semicolon
r_int
id|ret_errno
op_assign
id|errno
suffix:semicolon
r_if
c_cond
(paren
id|new_maxlen
OG
id|prec_dir-&gt;dirent_nfc-&gt;max_name_len
)paren
(brace
r_int
id|new_len
op_assign
r_sizeof
(paren
id|dirent_prec_psx
)paren
op_plus
id|new_maxlen
r_sizeof
(paren
id|prec_dir-&gt;dirent_nfc-&gt;d_name
)paren
suffix:semicolon
id|prec_dir-&gt;dirent_nfc
op_assign
id|xrealloc
c_func
(paren
id|prec_dir-&gt;dirent_nfc
comma
id|new_len
)paren
suffix:semicolon
id|prec_dir-&gt;dirent_nfc-&gt;max_name_len
op_assign
id|new_maxlen
suffix:semicolon
)brace
id|prec_dir-&gt;dirent_nfc-&gt;d_ino
op_assign
id|res-&gt;d_ino
suffix:semicolon
id|prec_dir-&gt;dirent_nfc-&gt;d_type
op_assign
id|res-&gt;d_type
suffix:semicolon
r_if
c_cond
(paren
(paren
id|precomposed_unicode
op_eq
l_int|1
)paren
op_logical_and
id|has_non_ascii
c_func
(paren
id|res-&gt;d_name
comma
(paren
r_int
)paren
op_minus
l_int|1
comma
l_int|NULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|prec_dir-&gt;ic_precompose
op_eq
(paren
id|iconv_t
)paren
op_minus
l_int|1
)paren
(brace
id|die
c_func
(paren
l_string|&quot;iconv_open(%s,%s) failed, but needed:&bslash;n&quot;
l_string|&quot;    precomposed unicode is not supported.&bslash;n&quot;
l_string|&quot;    If you want to use decomposed unicode, run&bslash;n&quot;
l_string|&quot;    &bslash;&quot;git config core.precomposeunicode false&bslash;&quot;&bslash;n&quot;
comma
id|repo_encoding
comma
id|path_encoding
)paren
suffix:semicolon
)brace
r_else
(brace
id|iconv_ibp
id|cp
op_assign
(paren
id|iconv_ibp
)paren
id|res-&gt;d_name
suffix:semicolon
r_int
id|inleft
op_assign
id|namelenz
suffix:semicolon
r_char
op_star
id|outpos
op_assign
op_amp
id|prec_dir-&gt;dirent_nfc-&gt;d_name
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|outsz
op_assign
id|prec_dir-&gt;dirent_nfc-&gt;max_name_len
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|errno
op_assign
l_int|0
suffix:semicolon
id|cnt
op_assign
id|iconv
c_func
(paren
id|prec_dir-&gt;ic_precompose
comma
op_amp
id|cp
comma
op_amp
id|inleft
comma
op_amp
id|outpos
comma
op_amp
id|outsz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errno
op_logical_or
id|inleft
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * iconv() failed and errno could be E2BIG, EILSEQ, EINVAL, EBADF&n;&t;&t;&t;&t;&t; * MacOS X avoids illegal byte sequemces.&n;&t;&t;&t;&t;&t; * If they occur on a mounted drive (e.g. NFS) it is not worth to&n;&t;&t;&t;&t;&t; * die() for that, but rather let the user see the original name&n;&t;&t;&t;&t;&t;*/
id|namelenz
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* trigger strlcpy */
)brace
)brace
)brace
r_else
id|namelenz
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|namelenz
)paren
id|strlcpy
c_func
(paren
id|prec_dir-&gt;dirent_nfc-&gt;d_name
comma
id|res-&gt;d_name
comma
id|prec_dir-&gt;dirent_nfc-&gt;max_name_len
)paren
suffix:semicolon
id|errno
op_assign
id|ret_errno
suffix:semicolon
r_return
id|prec_dir-&gt;dirent_nfc
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|precompose_utf8_closedir
r_int
id|precompose_utf8_closedir
c_func
(paren
id|PREC_DIR
op_star
id|prec_dir
)paren
(brace
r_int
id|ret_value
suffix:semicolon
r_int
id|ret_errno
suffix:semicolon
id|ret_value
op_assign
id|closedir
c_func
(paren
id|prec_dir-&gt;dirp
)paren
suffix:semicolon
id|ret_errno
op_assign
id|errno
suffix:semicolon
r_if
c_cond
(paren
id|prec_dir-&gt;ic_precompose
op_ne
(paren
id|iconv_t
)paren
op_minus
l_int|1
)paren
id|iconv_close
c_func
(paren
id|prec_dir-&gt;ic_precompose
)paren
suffix:semicolon
id|free
c_func
(paren
id|prec_dir-&gt;dirent_nfc
)paren
suffix:semicolon
id|free
c_func
(paren
id|prec_dir
)paren
suffix:semicolon
id|errno
op_assign
id|ret_errno
suffix:semicolon
r_return
id|ret_value
suffix:semicolon
)brace
eof
