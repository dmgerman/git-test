macro_line|#include &quot;../git-compat-util.h&quot;
multiline_comment|/* Adapted from libiberty&squot;s mkstemp.c. */
DECL|macro|TMP_MAX
macro_line|#undef TMP_MAX
DECL|macro|TMP_MAX
mdefine_line|#define TMP_MAX 16384
DECL|function|gitmkstemps
r_int
id|gitmkstemps
c_func
(paren
r_char
op_star
id|pattern
comma
r_int
id|suffix_len
)paren
(brace
r_static
r_const
r_char
id|letters
(braket
)braket
op_assign
l_string|&quot;abcdefghijklmnopqrstuvwxyz&quot;
l_string|&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;
l_string|&quot;0123456789&quot;
suffix:semicolon
r_static
r_const
r_int
id|num_letters
op_assign
l_int|62
suffix:semicolon
r_uint64
id|value
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
r_char
op_star
r_template
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|fd
comma
id|count
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|pattern
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|6
op_plus
id|suffix_len
)paren
(brace
id|errno
op_assign
id|EINVAL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
op_amp
id|pattern
(braket
id|len
l_int|6
id|suffix_len
)braket
comma
l_string|&quot;XXXXXX&quot;
comma
l_int|6
)paren
)paren
(brace
id|errno
op_assign
id|EINVAL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Replace pattern&squot;s XXXXXX characters with randomness.&n;&t; * Try TMP_MAX different filenames.&n;&t; */
id|gettimeofday
c_func
(paren
op_amp
id|tv
comma
l_int|NULL
)paren
suffix:semicolon
id|value
op_assign
(paren
(paren
r_int
)paren
(paren
id|tv.tv_usec
op_lshift
l_int|16
)paren
)paren
op_xor
id|tv.tv_sec
op_xor
id|getpid
c_func
(paren
)paren
suffix:semicolon
r_template
op_assign
op_amp
id|pattern
(braket
id|len
l_int|6
id|suffix_len
)braket
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|TMP_MAX
suffix:semicolon
op_increment
id|count
)paren
(brace
r_uint64
id|v
op_assign
id|value
suffix:semicolon
multiline_comment|/* Fill in the random bits. */
r_template
(braket
l_int|0
)braket
op_assign
id|letters
(braket
id|v
op_mod
id|num_letters
)braket
suffix:semicolon
id|v
op_div_assign
id|num_letters
suffix:semicolon
r_template
(braket
l_int|1
)braket
op_assign
id|letters
(braket
id|v
op_mod
id|num_letters
)braket
suffix:semicolon
id|v
op_div_assign
id|num_letters
suffix:semicolon
r_template
(braket
l_int|2
)braket
op_assign
id|letters
(braket
id|v
op_mod
id|num_letters
)braket
suffix:semicolon
id|v
op_div_assign
id|num_letters
suffix:semicolon
r_template
(braket
l_int|3
)braket
op_assign
id|letters
(braket
id|v
op_mod
id|num_letters
)braket
suffix:semicolon
id|v
op_div_assign
id|num_letters
suffix:semicolon
r_template
(braket
l_int|4
)braket
op_assign
id|letters
(braket
id|v
op_mod
id|num_letters
)braket
suffix:semicolon
id|v
op_div_assign
id|num_letters
suffix:semicolon
r_template
(braket
l_int|5
)braket
op_assign
id|letters
(braket
id|v
op_mod
id|num_letters
)braket
suffix:semicolon
id|v
op_div_assign
id|num_letters
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|pattern
comma
id|O_CREAT
op_or
id|O_EXCL
op_or
id|O_RDWR
comma
l_int|0600
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OG
l_int|0
)paren
r_return
id|fd
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Fatal error (EPERM, ENOSPC etc).&n;&t;&t; * It doesn&squot;t make sense to loop.&n;&t;&t; */
r_if
c_cond
(paren
id|errno
op_ne
id|EEXIST
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This is a random value.  It is only necessary that&n;&t;&t; * the next TMP_MAX values generated by adding 7777 to&n;&t;&t; * VALUE are different with (module 2^32).&n;&t;&t; */
id|value
op_add_assign
l_int|7777
suffix:semicolon
)brace
multiline_comment|/* We return the null string if we can&squot;t find a unique file name.  */
id|pattern
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|errno
op_assign
id|EINVAL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
